# Cipher-IM Docker Compose Configuration
#
# Complete stack: 3x cipher-im (1 SQLite, 2 PostgreSQL) + PostgreSQL 18.1 + OpenTelemetry + Grafana
# Follows KMS compose patterns for production-like multi-instance deployment.
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose ps                       # Check status
#   docker compose logs -f cipher-im-sqlite # View SQLite instance logs
#   docker compose logs -f cipher-im-pg-1   # View PostgreSQL instance 1 logs
#   docker compose logs -f cipher-im-pg-2   # View PostgreSQL instance 2 logs
#   docker compose down                     # Stop and remove
#   docker compose down -v                  # Stop and remove volumes
#
# Services:
#   - cipher-im-sqlite: https://localhost:8888 (public) - Standalone SQLite
#   - cipher-im-pg-1: https://localhost:8889 (public) - Shared PostgreSQL
#   - cipher-im-pg-2: https://localhost:8890 (public) - Shared PostgreSQL
#   - postgres: localhost:5432 (PostgreSQL 18.1)
#   - otel-collector: (internal only, no host ports)
#   - grafana: http://localhost:3000 (admin/admin)
#
# Health Checks:
#   - Public health endpoint: https://localhost:8888/health (external clients)
#   - Admin livez endpoint: https://127.0.0.1:9090/admin/api/v1/livez (internal container only)

name: cipher-im

services:
  # PostgreSQL 18.1 Database (shared by cipher-im-pg-1 and cipher-im-pg-2)
  postgres:
    image: postgres:18.1-alpine
    container_name: cipher-im-postgres
    hostname: cipher-im-postgres
    secrets:
      - postgres_database.secret
      - postgres_username.secret
      - postgres_password.secret
    environment:
      POSTGRES_DB_FILE: /run/secrets/postgres_database.secret
      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cipher_user -d cipher_im"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cipher-im-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # OpenTelemetry Collector
  # Note: No healthcheck - otel-collector-contrib image is minimal (no curl/wget).
  # Services depend on it with service_started (not service_healthy) which is sufficient.
  opentelemetry-collector-contrib:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: cipher-im-otel-collector
    hostname: cipher-im-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    networks:
      - cipher-im-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'

  # Grafana OTEL LGTM Stack
  grafana-otel-lgtm:
    image: grafana/otel-lgtm:latest
    container_name: cipher-im-grafana
    hostname: cipher-im-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin  # pragma: allowlist secret
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3000:3000"    # Grafana UI
      - "14317:4317"   # OTLP gRPC
      - "14318:4318"   # OTLP HTTP
    volumes:
      - grafana_data:/var/lib/grafana
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:3000/api/health"]
      start_period: 15s
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - cipher-im-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Cipher-IM Service - SQLite Standalone Instance
  cipher-im-sqlite:
    build:
      context: ../..
      dockerfile: cmd/cipher-im/Dockerfile
      args:
        GO_VERSION: 1.25.5
        ALPINE_VERSION: 3.19
    image: cipher-im:local
    container_name: cipher-im-sqlite
    hostname: cipher-im-sqlite
    ports:
      - "8888:8888"  # Public HTTPS API ONLY - external access
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file::memory:?cache=shared"
      - "--config=/etc/cipher-im/config-sqlite.yml"
    volumes:
      - ../../configs/cipher/im/config-sqlite.yml:/etc/cipher-im/config-sqlite.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cipher-im-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "cipher-im"
      com.cryptoutil.backend: "sqlite"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Cipher-IM Service - PostgreSQL Instance 1
  cipher-im-pg-1:
    image: cipher-im:local  # Reuse built image from cipher-im-sqlite
    container_name: cipher-im-pg-1
    hostname: cipher-im-pg-1
    secrets:
      - postgres_url.secret
    ports:
      - "8889:8888"  # Public HTTPS API ONLY - external access (mapped to different host port)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/cipher-im/config-pg-1.yml"
    volumes:
      - ../../configs/cipher/im/config-pg-1.yml:/etc/cipher-im/config-pg-1.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      cipher-im-sqlite:
        condition: service_healthy  # Wait for first instance to complete schema init
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cipher-im-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "cipher-im"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Cipher-IM Service - PostgreSQL Instance 2
  cipher-im-pg-2:
    image: cipher-im:local  # Reuse built image from cipher-im-sqlite
    container_name: cipher-im-pg-2
    hostname: cipher-im-pg-2
    secrets:
      - postgres_url.secret
    ports:
      - "8890:8888"  # Public HTTPS API ONLY - external access (mapped to different host port)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/cipher-im/config-pg-2.yml"
    volumes:
      - ../../configs/cipher/im/config-pg-2.yml:/etc/cipher-im/config-pg-2.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      cipher-im-pg-1:
        condition: service_healthy  # Wait for first PostgreSQL instance
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cipher-im-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "cipher-im"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "2"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

secrets:
  postgres_database.secret:
    file: ./secrets/postgres_database.secret
  postgres_username.secret:
    file: ./secrets/postgres_username.secret
  postgres_password.secret:
    file: ./secrets/postgres_password.secret
  postgres_url.secret:
    file: ./secrets/postgres_url.secret

networks:
  cipher-im-network:
    driver: bridge
    name: cipher-im-network

volumes:
  postgres_data:
    name: cipher-im-postgres-data
  grafana_data:
    name: cipher-im-grafana-data
