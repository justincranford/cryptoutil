# Cipher-IM Docker Compose Configuration
#
# Complete stack: cipher-im + PostgreSQL + OpenTelemetry + Grafana
# Follows KMS compose patterns for production-like deployment.
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose ps                       # Check status
#   docker compose logs -f cipher-im        # View logs
#   docker compose down                     # Stop and remove
#   docker compose down -v                  # Stop and remove volumes
#
# Services:
#   - cipher-im: https://localhost:8888 (public), https://localhost:9090 (admin)
#   - postgres: localhost:5432
#   - otel-collector: (internal only, no host ports)
#   - grafana: http://localhost:3000 (admin/admin)

name: cipher-im

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: cipher-im-postgres
    hostname: cipher-im-postgres
    environment:
      POSTGRES_DB: cipher_im
      POSTGRES_USER: cipher_user
      POSTGRES_PASSWORD: cipher_pass  # pragma: allowlist secret
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cipher_user -d cipher_im"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cipher-im-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # OpenTelemetry Collector
  opentelemetry-collector-contrib:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: cipher-im-otel-collector
    hostname: cipher-im-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    networks:
      - cipher-im-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'

  # Grafana OTEL LGTM Stack
  grafana-otel-lgtm:
    image: grafana/otel-lgtm:latest
    container_name: cipher-im-grafana
    hostname: cipher-im-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin  # pragma: allowlist secret
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3000:3000"    # Grafana UI
      - "14317:4317"   # OTLP gRPC
      - "14318:4318"   # OTLP HTTP
    volumes:
      - grafana_data:/var/lib/grafana
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:3000/api/health"]
      start_period: 15s
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - cipher-im-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Cipher-IM Service
  cipher-im:
    build:
      context: ../..
      dockerfile: cmd/cipher-im/Dockerfile
      args:
        GO_VERSION: 1.25.5
        ALPINE_VERSION: 3.19
    image: cipher-im:local
    container_name: cipher-im
    hostname: cipher-im
    ports:
      - "8888:8888"  # Public HTTPS API
      - "9090:9090"  # Admin HTTPS API
    environment:
      # Database configuration (commented out - using SQLite default for now)
      # DATABASE_DSN: "postgres://cipher_user:cipher_pass@cipher-im-postgres:5432/cipher_im?sslmode=disable"
      # OpenTelemetry configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://cipher-im-otel-collector:4317"
      OTEL_SERVICE_NAME: "cipher-im"
      OTEL_RESOURCE_ATTRIBUTES: "service.version=1.0.0,deployment.environment=development"
    command:
      - "server"
      # Using SQLite for now due to PostgreSQL timestamp int4/int8 schema issue
      # TODO: Fix barrier_root_keys.created_at/updated_at to use bigint (int8) not integer (int4)
      # - "--database-url=postgres://cipher_user:cipher_pass@cipher-im-postgres:5432/cipher_im?sslmode=disable"
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cipher-im-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "cipher-im"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

networks:
  cipher-im-network:
    driver: bridge
    name: cipher-im-network

volumes:
  postgres_data:
    name: cipher-im-postgres-data
  grafana_data:
    name: cipher-im-grafana-data
