# run-act-dast.ps1 - Act DAST Workflow Runner

## Overview

Automated script for running and monitoring GitHub Actions DAST workflows locally with `act`. Eliminates common mistakes like premature timeouts, manual log monitoring, and missing result analysis.

## Key Features

- **Automated Background Execution**: Runs act workflow in background with proper output redirection
- **Real-time Progress Monitoring**: Tails log file every 10 seconds showing last 20 lines
- **Automatic Completion Detection**: Detects when workflow finishes (success or failure)
- **Comprehensive Result Analysis**: Validates both workflow status and individual task completion
- **Artifact Verification**: Checks for generated scan reports (Nuclei, ZAP, headers)
- **Summary Report Generation**: Creates `act-status.txt` with full execution details

## Usage

### Quick Scan (3-5 minutes)
```powershell
.\scripts\run-act-dast.ps1
```

### Full Scan (10-15 minutes)
```powershell
.\scripts\run-act-dast.ps1 -ScanProfile full -Timeout 900
```

### Deep Scan (20-25 minutes)
```powershell
.\scripts\run-act-dast.ps1 -ScanProfile deep -Timeout 1500
```

## Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `ScanProfile` | string | `quick` | Scan profile: `quick`, `full`, or `deep` |
| `Timeout` | int | `600` | Maximum wait time in seconds (10 minutes default) |
| `TailLines` | int | `20` | Number of log lines to show during monitoring |
| `OutputDir` | string | `dast-reports` | Output directory for reports and logs |
| `Help` | switch | - | Show help message |

## Output Files

All files are written to `dast-reports/` directory:

### Generated by Script
- `act-dast.log` - Full workflow execution log (UTF-8)
- `act-status.txt` - Summary of workflow and task results

### Generated by Workflow
- `nuclei.log` - Nuclei scan output
- `nuclei.sarif` - Nuclei SARIF report
- `response-headers.txt` - Security headers baseline
- `zap-report.html` - ZAP Full Scan report (if run)
- `zap-api-report.html` - ZAP API Scan report (if run)

## Workflow Behavior

### Monitoring Loop
1. Starts act workflow in background PowerShell job
2. Waits for log file creation (max 30 seconds)
3. Tails log every 10 seconds showing progress
4. Checks for completion markers in log
5. Stops when workflow completes or timeout reached

### Result Analysis
Script analyzes both workflow-level and task-level success:

**Workflow Level**:
- Searches for `Job succeeded` or `Job failed` in log
- Reports overall workflow status

**Task Level**:
- **Nuclei Scan**: Checks for `nuclei.log` / `nuclei.sarif` generation
- **ZAP Full Scan**: Checks for `zap-report` generation
- **ZAP API Scan**: Checks for `zap-api-report` generation  
- **Header Capture**: Checks for `response-headers.txt` generation

### Exit Codes
- `0` - All checks passed (workflow succeeded, all tasks completed)
- `1` - Failures detected (workflow failed or tasks incomplete)

## Example Output

```
===================================================================
 Validating Prerequisites
===================================================================

[10:23:45] Checking for act...
[10:23:45] [OK] act is installed: act version 0.2.68
[10:23:45] Checking for Docker...
[10:23:45] [OK] Docker is available

===================================================================
 Starting DAST Workflow
===================================================================

[10:23:45] Profile: quick
[10:23:45] Timeout: 600 seconds
[10:23:45] Log file: dast-reports\act-dast.log
[10:23:46] [OK] Workflow started (Job ID: 42)

===================================================================
 Monitoring Workflow Progress
===================================================================

[10:23:46] Tailing last 20 lines every 10 seconds...
[10:24:00] Progress: 10/600 seconds (1%)
...workflow log output...

[10:27:30] [OK] Workflow completion detected

===================================================================
 Analyzing Results
===================================================================

[10:27:30] Log file size: 145678 bytes

[10:27:30] Scan Results:
[10:27:30] ---------------------------------------------------------------
[10:27:30] [OK] Nuclei Scan: Completed
[10:27:30] [OK] ZAP Full Scan: Completed
[10:27:30] [OK] ZAP API Scan: Completed
[10:27:30] [OK] Header Capture: Completed

[10:27:30] Generated Artifacts:
[10:27:30] ---------------------------------------------------------------
[10:27:30]   - nuclei.log (12345 bytes)
[10:27:30]   - nuclei.sarif (23456 bytes)
[10:27:30]   - response-headers.txt (1234 bytes)

===================================================================
 Summary
===================================================================

[10:27:30] Workflow: [OK] SUCCESS
[10:27:30] Tasks: 4/4 succeeded, 0 failed
[10:27:30] Duration: 225 seconds
[10:27:30] Status summary saved to: dast-reports\act-status.txt

[10:27:30] [OK] All checks passed!
```

## Troubleshooting

### Log File Not Created
If log file isn't created within 30 seconds:
- Verify `act` is installed and in PATH
- Check Docker is running
- Ensure workflow file exists at `.github/workflows/dast.yml`

### Timeout Reached
If timeout is reached before completion:
- Increase timeout value (especially for `full` or `deep` profiles)
- Check log file for error messages
- Workflow may still be running in Docker containers

### Tasks Not Completed
If tasks show as FAILED:
- Review `act-dast.log` for error messages
- Check Docker container logs
- Verify application started successfully
- Ensure scan tools (ZAP, Nuclei) are working

## Best Practices

1. **Always use this script** instead of running act commands directly
2. **Match timeout to profile**: quick=600s, full=900s, deep=1500s
3. **Review act-status.txt** for quick results summary
4. **Check act-dast.log** for detailed error messages if failures occur
5. **No Unicode characters** in PowerShell scripts per project guidelines

## Related Documentation

- `.github/instructions/act-testing.instructions.md` - Comprehensive act testing guidelines
- `.github/workflows/dast.yml` - DAST workflow definition
- `scripts/dast.ps1` - Direct DAST execution (non-act)

## Common Mistakes to Avoid

See `.github/instructions/act-testing.instructions.md` for complete list of common mistakes and best practices.
