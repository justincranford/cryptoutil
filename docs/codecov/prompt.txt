# CRYPTOUTIL PROJECT - REMAINING TASKS

## PRIORITY 1: Fix os.Exit() Architecture to Enable 96% Coverage

### Task 1.1: Add Copilot Instruction for os.Exit() Usage
- Add instruction to .github/copilot-instructions.md:
  - NEVER invoke os.Exit() in main or test code
  - ONLY exception: main() functions or cmd pattern entry functions
  - ALWAYS return wrapped errors all the way up, so os.Exit() is only called at the command entry point
  - REASON: Support maximum unit testing, because os.Exit() calls halt unit tests which is undesirable
- Commit: "docs(copilot): add os.Exit() usage restrictions for testability"

### Task 1.2: Refactor cicd Package to Remove os.Exit() Calls
- Fix internal/cmd/cicd/*.go code that calls os.Exit() and blocks maximizing code coverage in unit tests
- Specifically refactor:
  - cicd_workflow_lint.go: checkWorkflowLintWithError() - return error instead of os.Exit(1)
  - cicd_workflow_lint.go: validateAndGetWorkflowActionsDetails() - return error instead of os.Exit(0)/os.Exit(1)
  - cicd_github_api_cache.go: getLatestTag() - any os.Exit() calls
- Update cmd/cicd/main.go to handle returned errors and call os.Exit() at entry point only
- Verify tests pass
- Commit: "refactor(cicd): remove os.Exit() calls from library code for testability"

### Task 1.3: Reorganize cicd Package into Command Subdirectories
- Move CICD command-specific main and test code to subdirectories: internal/cmd/cicd/<COMMAND>/
  - cicd_check_circular_deps/ (cicd_check_circular_deps.go + tests)
  - cicd_enforce_any/ (cicd_enforce_any.go + tests)
  - cicd_enforce_test_patterns/ (cicd_enforce_test_patterns.go + tests)
  - cicd_enforce_utf8/ (cicd_enforce_utf8.go + tests)
  - cicd_update_deps/ (cicd_update_deps.go + tests)
  - cicd_workflow_lint/ (cicd_workflow_lint.go + cicd_github_api_cache.go + tests)
- Keep shared utilities in internal/cmd/cicd/ root: cicd.go, cicd_log.go
- REASON: Simplify exclusion pattern for cicd_enforce_any command to ignore all main and test files in that subdirectory
- Update import paths in all files
- Simplify exclusion pattern for cicd_enforce_any command in magic_cicd.go
- Verify tests pass
- Commit: "refactor(cicd): reorganize into command subdirectories for better organization"

### Task 1.4: Achieve 96%+ Coverage for cicd Package
- Add comprehensive tests for previously untestable functions (now testable after os.Exit() removal)
- Add tests for checkWorkflowLintWithError() error paths
- Add tests for validateAndGetWorkflowActionsDetails() validation scenarios
- Target: 96% or higher coverage
- Verify tests pass
- Commit: "test(cicd): achieve 96%+ coverage after os.Exit() refactoring"

## PRIORITY 2: Database Performance Optimization (4 packages)

### Task 2.1: Optimize internal/server/repository/sqlrepository
- Add parameterized happy and sad path tests
- Optimize connection concurrency with robustness (SQLite special handling for write concurrency)
- Performance: Maximum performance for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Latency: Minimize latency for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Throughput: Maximum throughput for bulk transactions and CRUD statements (SQLite + PostgreSQL)
- Document findings in docs/DB-PERF-kms-sql.md (pros, cons, what went well, what needs improvement)
- Verify tests pass
- Commit: "perf(sqlrepository): optimize performance and add comprehensive tests"

### Task 2.2: Optimize internal/server/repository/orm
- Add parameterized happy and sad path tests
- Optimize connection concurrency with robustness (SQLite special handling for write concurrency)
- Performance: Maximum performance for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Latency: Minimize latency for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Throughput: Maximum throughput for bulk transactions and CRUD statements (SQLite + PostgreSQL)
- Document findings in docs/DB-PERF-kms-orm.md (pros, cons, what went well, what needs improvement)
- Verify tests pass
- Commit: "perf(orm): optimize performance and add comprehensive tests"

### Task 2.3: Optimize internal/identity/repository
- Add parameterized happy and sad path tests
- Optimize connection concurrency with robustness (SQLite special handling for write concurrency)
- Performance: Maximum performance for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Latency: Minimize latency for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Throughput: Maximum throughput for bulk transactions and CRUD statements (SQLite + PostgreSQL)
- Document findings in docs/DB-PERF-identity-sql.md (pros, cons, what went well, what needs improvement)
- Verify tests pass
- Commit: "perf(identity/repository): optimize performance and add comprehensive tests"

### Task 2.4: Optimize internal/identity/repository/orm
- Add parameterized happy and sad path tests
- Optimize connection concurrency with robustness (SQLite special handling for write concurrency)
- Performance: Maximum performance for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Latency: Minimize latency for individual transactions and CRUD statements (SQLite + PostgreSQL)
- Throughput: Maximum throughput for bulk transactions and CRUD statements (SQLite + PostgreSQL)
- Document findings in docs/DB-PERF-identity-orm.md (pros, cons, what went well, what needs improvement)
- Verify tests pass
- Commit: "perf(identity/orm): optimize performance and add comprehensive tests"

### Task 2.5: Create Database Performance Summary
- Create docs/DB-PERF-SUMMARY.md
- Compare and contrast approaches taken in each of the 4 DB packages
- Document similarities, differences, pros/cons of each approach
- Recommend improvements or optimizations that can be applied from each package to the other 3 DB-related packages
- Commit: "docs(db-perf): add comprehensive performance analysis summary"

## PRIORITY 3: Add Tests to 22 Additional Packages (one at a time)

### Task 3.1: internal/common/util
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(common/util): add comprehensive parameterized tests"

### Task 3.2: internal/common/config
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(common/config): add comprehensive parameterized tests"

### Task 3.3: internal/common/crypto/asn1
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(common/crypto/asn1): add comprehensive parameterized tests"

### Task 3.4: internal/common/telemetry
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(common/telemetry): add comprehensive parameterized tests"

### Task 3.5: internal/server/handler
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(server/handler): add comprehensive parameterized tests"

### Task 3.6: internal/server/barrier/unsealkeysservice
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(server/barrier/unsealkeysservice): add comprehensive parameterized tests"

### Task 3.7: internal/server/barrier/rootkeysservice
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(server/barrier/rootkeysservice): add comprehensive parameterized tests"

### Task 3.8: internal/server/barrier/intermediatekeysservice
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(server/barrier/intermediatekeysservice): add comprehensive parameterized tests"

### Task 3.9: internal/server/barrier/contentkeysservice
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(server/barrier/contentkeysservice): add comprehensive parameterized tests"

### Task 3.10: internal/server/application
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(server/application): add comprehensive parameterized tests"

### Task 3.11: internal/identity/authz/clientauth
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/authz/clientauth): add comprehensive parameterized tests"

### Task 3.12: internal/identity/authz/pkce
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/authz/pkce): add comprehensive parameterized tests"

### Task 3.13: internal/identity/authz
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/authz): add comprehensive parameterized tests"

### Task 3.14: internal/identity/domain
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/domain): add comprehensive parameterized tests"

### Task 3.15: internal/identity/idp
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/idp): add comprehensive parameterized tests"

### Task 3.16: internal/identity/idp/auth
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/idp/auth): add comprehensive parameterized tests"

### Task 3.17: internal/identity/idp/userauth
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/idp/userauth): add comprehensive parameterized tests"

### Task 3.18: internal/identity/issuer
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/issuer): add comprehensive parameterized tests"

### Task 3.19: internal/identity/rs
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/rs): add comprehensive parameterized tests"

### Task 3.20: internal/identity/security
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/security): add comprehensive parameterized tests"

### Task 3.21: internal/identity/server
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/server): add comprehensive parameterized tests"

### Task 3.22: internal/identity/storage/fixtures
- Add parameterized happy and sad path tests
- Verify tests pass
- Commit: "test(identity/storage/fixtures): add comprehensive parameterized tests"

## COMPLETED TASKS (for reference)

✅ Task 0.1: Refactor cicd.go cache outputs to .cicd/ subdirectory
✅ Task 0.2: Optimize go-update-direct-dependencies performance (5.86s → 3.2s, 46% improvement)
✅ Task 0.3: Enhanced cicd coverage from 53.0% to 82.4% (+29.4%)
  - Note: 96% was blocked by os.Exit() calls (now being addressed in Priority 1)
