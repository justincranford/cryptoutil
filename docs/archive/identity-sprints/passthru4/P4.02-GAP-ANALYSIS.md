# Task P4.02 Gap Analysis - Requirements Coverage

**Target**: ≥90% (59/65 requirements)
**Current**: 58.5% (38/65 requirements)
**Gap**: 27 uncovered requirements

## Uncovered Requirements by Priority

### CRITICAL (7 uncovered)

| ID | Category | Description | Effort | Implementation Status |
|----|----------|-------------|--------|----------------------|
| R02-03 | oidc_core | Discovery endpoint exposes OIDC metadata | 2h | **MISSING** - No discovery handler |
| R02-01 | oidc_core | UserInfo endpoint returns authenticated user profile | 0h | ✅ DONE (handlers_userinfo.go exists) |
| R05-06 | token_lifecycle | Token expiration enforcement | 1h | **NEEDS VALIDATION** - Enforcement exists, needs test |
| R05-04 | token_lifecycle | Token revocation endpoint | 0h | ✅ DONE (handlers_introspect_revoke.go exists) |
| R08-03 | documentation | Swagger UI reflects real API | 1h | **NEEDS VALIDATION** - Routes exist, needs manual test |
| R11-04 | governance | Security scanning clean | 1h | **NEEDS CI/CD** - Add SAST/DAST validation |
| R11-12 | governance | Production readiness report approved | 0.5h | **DEFERRED** - P4.08 final task |

**Subtotal**: 5.5 hours (2 DONE, 1 DEFERRED, 4 NEEDS WORK)

### HIGH (13 uncovered)

| ID | Category | Description | Effort | Implementation Status |
|----|----------|-------------|--------|----------------------|
| R02-06 | oidc_core | Discovery metadata includes all required OIDC fields | 1h | **DEPENDS** - Blocked by R02-03 |
| R02-05 | oidc_core | UserInfo response includes all required OIDC claims | 0.5h | **NEEDS TEST** - Implementation exists |
| R02-07 | oidc_core | Integration tests validate OIDC endpoints | 2h | **NEEDS TEST** - E2E tests needed |
| R04-05 | security | Security tests validate attack prevention | 2h | **NEEDS TEST** - Add attack simulation tests |
| R07-02 | testing | Repository tests run against PostgreSQL | 1h | **NEEDS TEST** - Add PostgreSQL integration tests |
| R07-05 | testing | Repository tests achieve 85%+ coverage | 0h | ✅ COVERED IN P4.04 |
| R08-06 | documentation | API documentation includes OAuth 2.1 security schemes | 1h | **NEEDS OPENAPI** - Add security schemes to specs |
| R08-02 | code_generation | Generated client libraries functional | 0h | ✅ COVERED IN P4.06 |
| R08-01 | documentation | OpenAPI specs match actual endpoint implementations | 0h | ✅ COVERED IN P4.06 |
| R11-03 | code_quality | Zero CRITICAL/HIGH TODO comments | 0h | ✅ COVERED IN P4.03 |
| R11-11 | documentation | Documentation completeness | 2h | **NEEDS DOCS** - Update README, add guides |
| R11-09 | operations | Production deployment checklist | 1h | **NEEDS DOCS** - Create deployment guide |
| R11-07 | governance | DAST scanning clean | 0h | **NEEDS CI/CD** - Add DAST validation |

**Subtotal**: 10.5 hours (4 DONE, 9 NEEDS WORK)

### MEDIUM (6 uncovered)

| ID | Category | Description | Effort | Implementation Status |
|----|----------|-------------|--------|----------------------|
| R03-05 | testing | Integration tests run in parallel safely | 0.5h | **NEEDS TEST** - Verify t.Parallel() works |
| R04-06 | security | Client secret rotation support | 4h | **NEEDS IMPL** - Add rotation endpoints/logic |
| R08-05 | testing | OpenAPI schema validation in tests | 1h | **NEEDS TEST** - Add schema validation tests |
| R08-04 | documentation | No placeholder or TODO endpoints in specs | 0.5h | **NEEDS CLEANUP** - Remove placeholders from OpenAPI |
| R09-04 | documentation | Configuration documentation completeness | 1h | **NEEDS DOCS** - Document all config options |
| R11-10 | operations | Observability configured | 0h | ✅ DONE (telemetry already configured) |

**Subtotal**: 7 hours (1 DONE, 5 NEEDS WORK)

### LOW (1 uncovered)

| ID | Category | Description | Effort | Implementation Status |
|----|----------|-------------|--------|----------------------|
| R09-03 | configuration | Configuration hot-reload for development | 0h | **DEFERRED** - Low priority, skip for production |

**Subtotal**: 0 hours (DEFERRED)

---

## Summary by Work Type

### Already Implemented (8 requirements) ✅

- R02-01: UserInfo endpoint (handlers_userinfo.go)
- R05-04: Token revocation (handlers_introspect_revoke.go)
- R07-05: Test coverage (P4.04)
- R08-02: Generated clients (P4.06)
- R08-01: OpenAPI sync (P4.06)
- R11-03: Zero TODOs (P4.03)
- R11-10: Observability (telemetry configured)
- R09-03: Hot-reload (DEFERRED, low priority)

### Needs Testing Only (6 requirements) - 6.5 hours → 3 hours (3.5h complete)

- ✅ R02-07: OIDC integration tests (0.5h) - **DONE** (Commit f3822181)
- R02-05: UserInfo claims (0.5h)
- R03-05: Parallel test safety (0.5h)
- R04-05: Security attack tests (2h) ← NEXT
- R07-02: PostgreSQL integration tests (1h)
- R08-05: OpenAPI schema validation (0.5h)

### Needs Implementation (5 requirements) - 11 hours → 8 hours (3h complete)

- ✅ R02-03: Discovery endpoint (2h) - **DONE** (Commit 7467dd4e)
- ✅ R02-06: Discovery metadata (1h) - **DONE** (Commit 7467dd4e)
- R05-06: Token expiration enforcement (1h)
- R04-06: Client secret rotation (4h)
- R08-06: OAuth 2.1 security schemes in OpenAPI (1h)

### Needs Documentation (5 requirements) - 4.5 hours

- R08-04: Remove OpenAPI placeholders (0.5h)
- R09-04: Configuration docs (1h)
- R11-11: Documentation completeness (2h)
- R11-09: Deployment checklist (1h)

### Needs CI/CD Validation (2 requirements) - 1 hour

- R11-04: SAST scanning (0.5h - add workflow gate)
- R11-07: DAST scanning (0.5h - add workflow gate)

### Deferred to Other Tasks (2 requirements) - 0 hours

- R11-12: Production readiness (P4.08)

---

## Proposed Implementation Order

### Phase 1: OIDC Discovery (HIGHEST PRIORITY) - 3 hours

1. **R02-03: Discovery endpoint** (2h)
   - Create `internal/identity/idp/handlers_discovery.go`
   - Implement `handleDiscovery()` returning OIDC metadata JSON
   - Register route: `GET /.well-known/openid-configuration`
   - **Evidence**: `curl https://127.0.0.1:8080/.well-known/openid-configuration` returns JSON

2. **R02-06: Discovery metadata completeness** (1h)
   - Add all required fields (issuer, authorization_endpoint, token_endpoint, userinfo_endpoint, jwks_uri, scopes_supported, response_types_supported, grant_types_supported, etc.)
   - Validate against OIDC spec: <https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata>
   - **Evidence**: JSON includes all 20+ required OIDC fields

### Phase 2: Testing - 6.5 hours

1. **R02-07: OIDC integration tests** (2h)
2. **R04-05: Security attack tests** (2h)
3. **R07-02: PostgreSQL integration tests** (1h)
4. **R02-05: UserInfo claims test** (0.5h)
5. **R03-05: Parallel test safety** (0.5h)
6. **R08-05: OpenAPI schema validation** (0.5h)

### Phase 3: Implementation - 6 hours

1. **R05-06: Token expiration enforcement** (1h)
2. **R08-06: OAuth 2.1 security schemes** (1h)
3. **R04-06: Client secret rotation** (4h)

### Phase 4: Documentation - 4.5 hours

1. **R08-04: Remove OpenAPI placeholders** (0.5h)
2. **R09-04: Configuration docs** (1h)
3. **R11-11: Documentation completeness** (2h)
4. **R11-09: Deployment checklist** (1h)

### Phase 5: CI/CD Validation - 1 hour

1. **R11-04: SAST scanning** (0.5h)
2. **R11-07: DAST scanning** (0.5h)

---

## Total Effort: 21 hours

**Breakdown**:

- Phase 1 (Discovery): 3 hours
- Phase 2 (Testing): 6.5 hours
- Phase 3 (Implementation): 6 hours
- Phase 4 (Documentation): 4.5 hours
- Phase 5 (CI/CD): 1 hour

**Coverage Impact**:

- Starting: 38/65 (58.5%)
- After Phase 1: 40/65 (61.5%)
- After Phase 2: 46/65 (70.8%)
- After Phase 3: 49/65 (75.4%)
- After Phase 4: 54/65 (83.1%)
- After Phase 5: 56/65 (86.2%)
- After P4.08 (R11-12): 57/65 (87.7%)

**Gap to 90%**: Need 59/65 = 90.8%
**Remaining after 21 hours**: 57/65 = 87.7%
**Additional work needed**: 2 more requirements (~2 hours)

---

**Next Action**: Implement R02-03 Discovery endpoint (highest priority CRITICAL requirement)
