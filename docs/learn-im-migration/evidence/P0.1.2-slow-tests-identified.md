# P0.1.2: Top 10 Slowest Tests Identified

**Date**: 2025-12-31
**Phase**: P0.1 - Test Performance Optimization
**Task**: P0.1.2 - Identify top 10 slowest tests

## Summary

Analyzed test timing and identified the 10 slowest tests in internal/learn.

## Top 10 Slowest Tests

| Rank | Test | Time (s) | Package | Category |
|------|------|----------|---------|----------|
| 1 | TestVerifyPassword_Success | 1.41 | crypto | Password hashing |
| 2 | TestHashPassword_DifferentSalts | 1.41 | crypto | Password hashing |
| 3 | TestHashPassword_EmptyPassword | 1.41 | crypto | Password hashing |
| 4 | TestVerifyPassword_WrongPassword | 1.40 | crypto | Password hashing |
| 5 | TestHandleBrowserHealth_WhileRunning | 1.07 | server | HTTP handler |
| 6 | TestHandleServiceHealth_WhileRunning | 0.96 | server | HTTP handler |
| 7 | TestShutdown_MultipleCalls | 0.79 | server | Server lifecycle |
| 8 | TestShutdown_DuplicateCall | 0.79 | server | Server lifecycle |
| 9 | TestE2E_BrowserFullEncryptionFlow | 0.76 | e2e | End-to-end |
| 10 | TestHashPassword | 0.71 | crypto | Password hashing |

## Analysis by Category

### 1. Password Hashing Tests (5 tests, ~7.04s total)

**Root Cause**: PBKDF2 with 600,000 iterations (OWASP recommendation)

**Tests Affected**:
- TestVerifyPassword_Success (1.41s)
- TestHashPassword_DifferentSalts (1.41s)
- TestHashPassword_EmptyPassword (1.41s)
- TestVerifyPassword_WrongPassword (1.40s)
- TestHashPassword (0.71s)

**Why Slow**: Intentionally slow for security (prevents brute force attacks)

**Optimization Options**:
1. **Reduce iterations in tests** - Use lower iteration count (e.g., 10,000) for tests
   - Pros: 60× faster (~23ms per hash instead of 1.4s)
   - Cons: Tests don't match production behavior
   - Recommendation: ⚠️ MAYBE (document difference)

2. **Parallel execution** - Already using t.Parallel()
   - Status: ✅ IMPLEMENTED
   - Benefit: Tests run concurrently

3. **Shared password hasher** - Reuse PBKDF2 parameters
   - Status: ✅ IMPLEMENTED
   - Benefit: No re-initialization overhead

**Verdict**: These tests SHOULD be slow for security. Consider test-specific iteration count with big warning comment.

### 2. HTTP Handler Tests (2 tests, ~2.03s total)

**Root Cause**: Server startup + HTTP request + graceful shutdown

**Tests Affected**:
- TestHandleBrowserHealth_WhileRunning (1.07s)
- TestHandleServiceHealth_WhileRunning (0.96s)

**Optimization Options**:
1. **Reuse server across tests** - Use TestMain to start server once
   - Pros: Amortize startup cost across all tests
   - Cons: Tests share state (must isolate)
   - Recommendation: ✅ YES (Phase P0.2 addresses this)

2. **Faster health check intervals** - Reduce polling intervals in tests
   - Pros: Faster response times
   - Cons: Less production-realistic
   - Recommendation: ⚠️ MAYBE

**Verdict**: TestMain pattern (P0.2) will improve this significantly.

### 3. Server Lifecycle Tests (2 tests, ~1.58s total)

**Root Cause**: Graceful shutdown timeout (500ms-1s)

**Tests Affected**:
- TestShutdown_MultipleCalls (0.79s)
- TestShutdown_DuplicateCall (0.79s)

**Optimization Options**:
1. **Reduce shutdown timeout in tests** - Use shorter timeout for tests
   - Pros: Faster test execution
   - Cons: May not catch slow shutdown bugs
   - Recommendation: ✅ YES (use 100ms in tests, 5s in production)

**Verdict**: Reduce test shutdown timeout to 100ms.

### 4. E2E Tests (1 test, 0.76s)

**Root Cause**: Full server lifecycle + multiple HTTP requests + encryption operations

**Test**: TestE2E_BrowserFullEncryptionFlow (0.76s)

**Optimization Options**:
1. **TestMain server reuse** - Already planned in P0.2
   - Recommendation: ✅ YES (in progress)

2. **Reduce encryption iterations** - Use test-specific PBKDF2 iterations
   - Recommendation: ✅ YES (combine with crypto test optimization)

**Verdict**: Defer to P0.2 TestMain pattern + crypto iteration reduction.

## Summary of Recommended Optimizations

### High Priority (P0.1.3)

1. **Reduce PBKDF2 iterations in tests**: 600,000 → 10,000
   - Add `cryptoutilMagic.TestPBKDF2Iterations = 10000`
   - Document difference with `//nolint:mnd` pragma
   - Expected speedup: 60× (~23ms per hash)
   - Affected tests: 5 password hashing tests

2. **Reduce shutdown timeout in tests**: 5s → 100ms
   - Add test-specific timeout configuration
   - Expected speedup: 50× (5s → 100ms)
   - Affected tests: 2 shutdown tests

### Medium Priority (P0.2 - TestMain Pattern)

3. **Implement TestMain for server tests**
   - Reuse server across HTTP handler tests
   - Expected speedup: 2-3× (amortize startup cost)
   - Affected tests: 2 HTTP handler tests + future tests

## Expected Results After Optimization

| Test Category | Before | After | Speedup |
|---------------|--------|-------|---------|
| Password hashing (5 tests) | ~7.04s | ~0.12s | 60× |
| Shutdown tests (2 tests) | ~1.58s | ~0.20s | 8× |
| HTTP handler tests (2 tests) | ~2.03s | ~1.00s | 2× (via TestMain) |
| E2E tests (1 test) | ~0.76s | ~0.20s | 4× (combined) |
| **Total Top 10** | **~11.41s** | **~1.52s** | **7.5×** |

## Files Generated

- `./test-output/p0.1.1_test_timing.txt` - Raw timing data
- This evidence file

## Next Steps

1. P0.1.3: Implement recommended optimizations
2. P0.1.4: Re-run tests and measure improvements
3. P0.2: Continue with TestMain pattern implementation
