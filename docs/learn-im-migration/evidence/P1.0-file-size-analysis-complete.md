# P1.0: File Size Analysis - COMPLETE

**Date**: 2025-12-31
**Phase**: P1.0
**Status**: ✅ COMPLETE

## Summary
Scanned internal/learn and internal/template directories for Go files exceeding 400-line soft limit and 500-line hard limit. Identified 4 files requiring attention.

## Files Analyzed

### internal/learn
Total files scanned: All .go files in internal/learn tree

**Files exceeding 400 lines**:
1. `internal/learn/e2e/helpers_e2e_test.go` - 449 lines (MEDIUM, within acceptable range)

**Analysis**: Only 1 file in 400-500 range, no files exceeding hard limit

### internal/template
Total files scanned: All .go files in internal/template tree

**Files exceeding 400 lines**:
1. `internal/template/server/listener/admin_test.go` - **797 lines** (CRITICAL - 1.6× hard limit)
2. `internal/template/server/listener/public_test.go` - **520 lines** (VIOLATION - 1.04× hard limit)
3. `internal/template/server/repository/application_table_test.go` - 404 lines (MEDIUM, within acceptable range)

**Analysis**: 2 files violate 500-line hard limit, 1 file in acceptable range

## Findings Summary

### Critical Issues (Hard Limit Violations)
**internal/template/server/listener/admin_test.go (797 lines)**:
- Severity: CRITICAL
- Violation: 1.6× hard limit (500 lines)
- Impact: Slow LLM processing, difficult maintenance
- Root Cause: Comprehensive admin server testing with many test cases

**internal/template/server/listener/public_test.go (520 lines)**:
- Severity: HIGH
- Violation: 1.04× hard limit (500 lines)
- Impact: Exceeds hard limit, needs refactoring
- Root Cause: Extensive public server test coverage

### Medium Issues (Soft Limit Exceeded, Under Hard Limit)
**internal/learn/e2e/helpers_e2e_test.go (449 lines)**:
- Severity: MEDIUM
- Status: Within acceptable range (400-500 lines)
- Justification: E2E test helpers, acceptable with documentation
- Action: Monitor, refactor if approaching 500 lines

**internal/template/server/repository/application_table_test.go (404 lines)**:
- Severity: MEDIUM  
- Status: Within acceptable range (400-500 lines)
- Justification: Application lifecycle tests, acceptable
- Action: Monitor, refactor if approaching 500 lines

## Refactoring Plan

### Priority 1: internal/template/server/listener/admin_test.go (797 lines)
**Target**: Reduce to <300 lines (ideal) or <400 lines (acceptable)

**Proposed Split**:
1. `admin_test.go` (core lifecycle tests, ~200 lines):
   - NewAdminHTTPServer basic tests
   - Start/Shutdown/Restart tests
   - Error handling tests

2. `admin_healthchecks_test.go` (health endpoint tests, ~200 lines):
   - /admin/v1/livez tests
   - /admin/v1/readyz tests
   - /admin/v1/shutdown tests

3. `admin_tls_test.go` (TLS configuration tests, ~200 lines):
   - TLS handshake tests
   - Certificate validation tests
   - mTLS tests

4. `admin_integration_test.go` (integration scenarios, ~200 lines):
   - End-to-end admin workflows
   - Complex error scenarios
   - Performance tests

**Rationale**: Logical grouping by functionality, easier navigation, better test parallelization

### Priority 2: internal/template/server/listener/public_test.go (520 lines)
**Target**: Reduce to <400 lines

**Proposed Split**:
1. `public_test.go` (core lifecycle tests, ~200 lines):
   - NewPublicHTTPServer basic tests
   - Start/Shutdown/Restart tests
   - Error handling tests

2. `public_routes_test.go` (routing tests, ~200 lines):
   - /service/** path tests
   - /browser/** path tests
   - Middleware chain tests

3. `public_tls_test.go` (TLS configuration tests, ~120 lines):
   - TLS handshake tests
   - Certificate validation tests
   - Client authentication tests

**Rationale**: Clear separation between server lifecycle, routing logic, and security tests

### Priority 3: Monitor Medium Files
**internal/learn/e2e/helpers_e2e_test.go (449 lines)**:
- Action: Monitor only, no immediate refactoring
- Threshold: Refactor if exceeds 475 lines (buffer before hard limit)

**internal/template/server/repository/application_table_test.go (404 lines)**:
- Action: Monitor only, no immediate refactoring
- Threshold: Refactor if exceeds 450 lines

## Recommendations

### Immediate Actions
1. Split admin_test.go into 4 files (Priority 1)
2. Split public_test.go into 3 files (Priority 2)
3. Run tests to verify no breakage
4. Update imports and references

### Prevention Strategy
1. Add pre-commit hook to detect files >400 lines
2. Add CI check to fail on files >500 lines
3. Document file size guidelines in contributor docs
4. Regular audits during code reviews

### Long-Term Improvements
1. Create test helper utilities to reduce duplication
2. Use table-driven tests for similar test cases
3. Extract common setup/teardown to TestMain or helper functions
4. Consider test subpackages for large test suites

## Evidence

### Scan Commands
```powershell
# Scan internal/learn
Get-ChildItem -Recurse -Filter "*.go" -Path internal/learn | Where-Object { (Get-Content $_.FullName).Count -gt 400 } | Select-Object FullName, @{Name="Lines";Expression={(Get-Content $_.FullName).Count}} | Sort-Object Lines -Descending

# Scan internal/template
Get-ChildItem -Recurse -Filter "*.go" -Path internal/template | Where-Object { (Get-Content $_.FullName).Count -gt 400 } | Select-Object FullName, @{Name="Lines";Expression={(Get-Content $_.FullName).Count}} | Sort-Object Lines -Descending
```

### Scan Results
```
internal/learn:
  helpers_e2e_test.go: 449 lines

internal/template:
  admin_test.go: 797 lines (CRITICAL)
  public_test.go: 520 lines (VIOLATION)
  application_table_test.go: 404 lines (MEDIUM)
```

## Metrics

### File Size Distribution
- Files >500 lines (hard limit): 2 (CRITICAL)
- Files 400-500 lines (medium): 2 (acceptable with justification)
- Files <400 lines: All others (compliant)

### Refactoring Impact
- Files to split: 2 (admin_test.go, public_test.go)
- Estimated new files: 7 (4 + 3)
- Estimated time: 1-2 hours
- Estimated LOC reduction: ~600 lines across 2 files

## Next Steps

1. Create P1.0 post-mortem
2. Execute refactoring plan (or defer to later phase)
3. Continue with P2.0 (Hardcoded Password Fixes)
4. Monitor medium files during future development

## Completion Checklist

- [x] P1.0.1: Run file size scan for files >400 lines
- [x] P1.0.2: Document files approaching 500-line hard limit
- [x] P1.0.3: Create refactoring plan for oversized files
- [x] Evidence file created
- [ ] Post-mortem created (to be done)
- [ ] SERVICE-TEMPLATE.md updated (to be done)
- [ ] Git commit (to be done)

## Status
✅ ANALYSIS COMPLETE
⏳ REFACTORING DEFERRED (can be executed during later phase or as separate task)

Rationale for deferral: Files are test files, not production code. While they exceed size limits, they don't block functionality. Refactoring can be done as part of P10+ cleanup phases.
