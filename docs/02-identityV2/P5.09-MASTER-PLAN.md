# P5.09 Master Plan - Automation and Evidence (Phase 5-6 Complete)

## Objectives

Complete P5.08 Phase 5 (Automation) and Phase 6 (Testing and Evidence) to finish the secret rotation system.

## Phase 5: Automation Workflows

### Step 1: Scheduled Rotation Job

**Goal**: Implement cron-based automatic rotation for secrets approaching expiration

**Implementation**:

- Create `internal/identity/jobs/scheduled_rotation.go`
- Cron scheduler integration (hourly check)
- Auto-rotate secrets expiring within threshold (e.g., 7 days)
- Audit logging for automated rotations
- Tests for scheduler triggers

**Acceptance Criteria**:

- Scheduler runs every hour
- Secrets expiring in ≤7 days rotated automatically
- KeyRotationEvent created for each rotation (event_type=secret_rotated)
- All tests passing (≥85% coverage)

### Step 2: Pre-Expiration Notifications

**Goal**: Notify administrators when secrets approaching expiration

**Implementation**:

- Create `internal/identity/notifications/service.go`
- Notification service interface (webhook/email/log)
- Check secrets expiring in 7, 3, 1 days
- Configurable notification channels
- Tests for notification triggers

**Acceptance Criteria**:

- Notifications sent at 7, 3, 1 day thresholds
- Multiple channels supported (webhook, email, log)
- Configuration-driven notification settings
- All tests passing (≥85% coverage)

### Step 3: Commit Phase 5

**Commit Message**:

```text
feat(rotation): add automation workflows (P5.08 Phase 5 COMPLETE)

- Scheduled rotation job (hourly cron)
- Pre-expiration notifications (7/3/1 day thresholds)
- Notification service interface (webhook/email/log)
- All automation tests passing (≥85% coverage)

Relates-To: P5.08 Phase 5 - Automation Workflows
```

---

## Phase 6: Testing and Evidence

### Step 1: E2E Integration Tests

**Goal**: Comprehensive end-to-end testing of complete rotation workflow

**Implementation**:

- Create `internal/identity/authz/e2e/rotation_test.go`
- Test complete rotation lifecycle (create → rotate → cleanup → rotate again)
- Multi-client concurrent rotation scenarios
- Grace period overlap edge cases
- Database state verification

**Test Scenarios**:

1. **Complete Rotation Lifecycle**:
   - Create client (version 1 secret)
   - Rotate to version 2 (24h grace)
   - Wait for expiration + cleanup
   - Rotate to version 3 (24h grace)
   - Verify versions 1 (expired), 2 (active), 3 (active)

2. **Multi-Client Concurrent Rotation**:
   - Create 5 clients concurrently
   - Rotate all 5 concurrently
   - Verify no race conditions
   - Verify each client has 2 active secrets

3. **Grace Period Overlap**:
   - Rotate client A (24h grace)
   - 12 hours later: rotate client A again (24h grace)
   - Verify 3 active secrets for 12 hours
   - Verify cleanup removes oldest secret after 24h

**Acceptance Criteria**:

- All E2E scenarios passing
- No race conditions detected
- Database state correct after each step
- All tests passing (≥85% coverage)

### Step 2: Evidence Checklist

**Goal**: Document compliance and test coverage metrics

**Implementation**:

- Create `docs/02-identityV2/P5.08-EVIDENCE.md`
- NIST compliance documentation
- Audit log verification (all rotation events logged)
- Test coverage report (≥85% target met)
- Requirements coverage (≥90% for P5.08 tasks)

**Evidence Categories**:

1. **NIST Compliance**:
   - SP 800-57 Part 1 Rev. 5 (key rotation requirements)
   - Grace period implementation (smooth transitions)
   - Audit logging (complete lifecycle tracking)

2. **Audit Log Verification**:
   - All rotation events logged (secret_created, secret_rotated, secret_revoked)
   - Metadata captured (initiator, reason, timestamps, versions)
   - Log query examples

3. **Test Coverage**:
   - Overall: ≥85% (infrastructure code standard)
   - Rotation service: ≥90%
   - Integration tests: 100% of scenarios covered

4. **Requirements Coverage**:
   - P5.08 requirements: ≥90% validated
   - Cross-reference to REQUIREMENTS-COVERAGE.md
   - Gap analysis for any missing requirements

**Acceptance Criteria**:

- Evidence document complete
- NIST compliance demonstrated
- Test coverage ≥85% verified
- Requirements coverage ≥90% verified

### Step 3: Commit Phase 6

**Commit Message**:

```text
feat(rotation): complete testing and evidence (P5.08 Phase 6 COMPLETE)

P5.08 Secret Rotation System COMPLETE:
- Phase 1: Domain Models ✅
- Phase 2: Rotation Service ✅
- Phase 3: CLI Tool ✅
- Phase 4: Backward Compatibility ✅
- Phase 5: Automation Workflows ✅
- Phase 6: Testing and Evidence ✅

Total: 6 phases, 10+ commits, ~2000+ insertions
Test coverage: ≥85% (infrastructure standard)
Requirements coverage: ≥90%
All validation criteria met
NIST SP 800-57 compliance demonstrated

Relates-To: P5.08 Complete - Secret Rotation System
```

---

## Summary

**Phase 5 Deliverables**:

- Scheduled rotation job (automatic rotation)
- Pre-expiration notifications (7/3/1 day alerts)
- Notification service interface

**Phase 6 Deliverables**:

- E2E integration tests (complete lifecycle)
- Evidence documentation (NIST compliance, coverage, requirements)
- Final validation checklist

**Success Criteria**:

- All automation workflows functional
- All E2E tests passing
- Coverage ≥85% verified
- Requirements ≥90% validated
- NIST compliance documented
