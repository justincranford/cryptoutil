# Task P4.04 Baseline - Test Coverage Analysis

**Date**: 2025-11-25
**Status**: üìä BASELINE ESTABLISHED
**Target**: ‚â•85% test coverage for infrastructure code

## Executive Summary

**Current Coverage Status** (infrastructure code):
- **authz**: 24.3% ‚ùå (target: 85%, gap: -60.7%)
- **authz/clientauth**: 35.9% ‚ùå (target: 85%, gap: -49.1%)
- **idp**: 53.5% ‚ùå (target: 85%, gap: -31.5%)
- **idp/auth**: 0.0% ‚ùå (target: 85%, gap: -85.0%)
- **issuer**: 58.7% ‚ùå (target: 85%, gap: -26.3%)

**Test Execution Status**:
- **Total tests run**: ~150+ tests
- **Failing tests**: 46 failures detected
- **Critical failures**: 3 test functions
  - `TestSecurityValidation_InputSanitization/XSS_attack_in_username_field`
  - `TestYAMLPolicyLoader_HotReload`
  - `TestOAuth2AuthorizationCodeFlow`

**Coverage Exceptions** (already meeting target):
- **authz/pkce**: 95.5% ‚úÖ (exceeds 85% target)
- **idp/userauth/mocks**: 84.1% ‚ö†Ô∏è (just below 85% target, acceptable for mocks)

## Detailed Coverage Analysis

### Package: internal/identity/authz
**Current**: 24.3%
**Target**: 85%
**Gap**: -60.7%

**Untested Areas** (estimated from code structure):
- Token lifecycle management
- Authorization code generation/validation
- PKCE validation integration
- Error handling paths
- Token refresh logic
- Token revocation logic
- Authorization request processing

**Priority Areas for Testing**:
1. Token issuance flows (HIGH)
2. Authorization code exchange (HIGH)
3. Token validation/introspection (HIGH)
4. Error paths (MEDIUM)
5. Edge cases (MEDIUM)

### Package: internal/identity/authz/clientauth
**Current**: 35.9%
**Target**: 85%
**Gap**: -49.1%

**Existing Coverage** (from test runs):
- Basic authenticator: TESTED ‚úÖ
- POST authenticator: TESTED ‚úÖ
- Client secret JWT: TESTED ‚úÖ
- Private key JWT: TESTED ‚úÖ
- TLS client auth: TESTED ‚úÖ
- Self-signed auth: TESTED ‚úÖ
- Registry: TESTED ‚úÖ

**Untested Areas** (estimated):
- **PBKDF2 hasher**: 0% ‚ùå (NEW FILE from P4.01, no tests yet)
- Certificate validation edge cases
- Error handling paths
- Concurrent authentication scenarios
- Secret rotation flows
- Hash migration logic

**Priority Areas for Testing**:
1. **PBKDF2Hasher** (CRITICAL - new code from P4.01)
   - HashSecret() positive/negative cases
   - CompareSecret() positive/negative cases
   - Salt generation uniqueness
   - Hash format validation
   - Edge cases (empty password, max length)
2. Secret rotation (HIGH)
3. Concurrent auth (MEDIUM)

### Package: internal/identity/idp
**Current**: 53.5%
**Target**: 85%
**Gap**: -31.5%

**Untested Areas** (estimated):
- Discovery endpoint edge cases
- Login handler error paths
- Consent handler validation
- Logout cleanup logic
- Userinfo response formatting
- Session management
- Challenge lifecycle

**Priority Areas for Testing**:
1. Login/consent/logout handlers (HIGH - production critical)
2. Discovery endpoint validation (MEDIUM)
3. Session lifecycle (HIGH)
4. Error handling (MEDIUM)

### Package: internal/identity/idp/auth
**Current**: 0.0% ‚ùå CRITICAL GAP
**Target**: 85%
**Gap**: -85.0%

**Files in Package** (from grep results):
- `totp.go` (3 TODOs - MFA placeholder)
- `passkey.go` (4 TODOs - WebAuthn placeholder)
- `otp.go` (5 TODOs - OTP placeholder)

**Analysis**: **ALL PLACEHOLDER CODE** - deferred MFA features
- No production usage yet
- TODOs indicate incomplete implementation
- Low priority for initial launch

**Recommendation**:
- **DEFER testing** until MFA features implemented
- **NOT a P4.04 blocker** (placeholder code, not production paths)
- Add to backlog: "Implement MFA auth package + tests"

### Package: internal/identity/issuer
**Current**: 58.7%
**Target**: 85%
**Gap**: -26.3%

**Existing Coverage** (from grep results):
- JWS/JWE fuzz tests: IMPLEMENTED ‚úÖ
- UUID issuer: IMPLEMENTED ‚úÖ
- Token service: PARTIAL ‚ö†Ô∏è

**Untested Areas** (estimated):
- Token service edge cases
- Key rotation scenarios
- Issuer initialization paths
- Error handling
- Legacy issuer compatibility

**Priority Areas for Testing**:
1. Token service (HIGH)
2. Key rotation (MEDIUM)
3. Issuer initialization (LOW)

## Test Failure Analysis

### Critical Failing Tests (3 test functions, 46 sub-test failures)

#### 1. TestSecurityValidation_InputSanitization (HIGH priority)
**File**: `internal/identity/idp/handlers_security_validation_test.go`
**Failure**: XSS attack in username field sub-test failing
**Impact**: Security validation not working correctly
**Priority**: üî¥ CRITICAL (security regression)

#### 2. TestYAMLPolicyLoader_HotReload (MEDIUM priority)
**File**: `internal/identity/idp/userauth/*` (policy loader)
**Failure**: Hot-reload mechanism not working
**Impact**: Runtime policy updates not functional
**Priority**: ‚ö†Ô∏è HIGH (operational feature)

#### 3. TestOAuth2AuthorizationCodeFlow (HIGH priority)
**File**: `internal/identity/test/e2e/oauth_flows_test.go`
**Failure**: E2E OAuth flow failing
**Impact**: Core OAuth functionality broken in E2E context
**Priority**: üî¥ CRITICAL (core functionality)

### Failure Impact on Coverage

**BLOCKER**: Cannot accurately measure coverage until tests pass
- Failing tests may terminate early (incomplete coverage data)
- Coverage reports unreliable with failures
- Must fix failures BEFORE addressing coverage gaps

**Dependency**: P4.05 (Zero Test Failures) is prerequisite for P4.04

## Task P4.04 Revised Strategy

### Phase 1: Fix Test Failures (P4.05 prerequisite)
**Effort**: 4-6 hours
**Deliverables**:
1. Fix `TestSecurityValidation_InputSanitization` (XSS validation)
2. Fix `TestYAMLPolicyLoader_HotReload` (policy reload)
3. Fix `TestOAuth2AuthorizationCodeFlow` (E2E OAuth)
4. Verify all 46 failures resolved
5. Confirm clean test run: `go test ./internal/identity/... -count=1`

### Phase 2: Add Coverage for NEW Code (P4.01 deliverables)
**Effort**: 2-3 hours
**Deliverables**:
1. **PBKDF2Hasher tests** (CRITICAL - 0% coverage currently)
   - File: `internal/identity/authz/clientauth/pbkdf2_hasher_test.go`
   - Tests: HashSecret, CompareSecret, salt uniqueness, format validation
   - Target: ‚â•90% coverage for new hasher
2. **CleanupService tests** (if not already covered)
   - File: `internal/identity/authz/cleanup_test.go`
   - Tests: Start, Stop, cleanup loop, graceful shutdown
   - Target: ‚â•85% coverage for new service

### Phase 3: Address Largest Coverage Gaps
**Effort**: 6-8 hours
**Deliverables**:
1. **authz package** (24.3% ‚Üí 85%): +60.7% needed
   - Token lifecycle tests
   - Authorization code tests
   - Token refresh/revocation tests
2. **authz/clientauth package** (35.9% ‚Üí 85%): +49.1% needed
   - Already have PBKDF2 tests from Phase 2
   - Add secret rotation tests
   - Add concurrent auth tests
3. **idp package** (53.5% ‚Üí 85%): +31.5% needed
   - Login/consent/logout handler tests
   - Session lifecycle tests
4. **issuer package** (58.7% ‚Üí 85%): +26.3% needed
   - Token service edge case tests
   - Key rotation scenario tests

### Phase 4: Verify Coverage Targets Met
**Effort**: 1 hour
**Deliverables**:
1. Run coverage for all packages: `go test ./internal/identity/... -cover`
2. Validate authz ‚â•85%
3. Validate authz/clientauth ‚â•85%
4. Validate idp ‚â•85%
5. Validate issuer ‚â•85%
6. Create P4.04-POSTMORTEM.md

## Task Sequencing Recommendation

**CRITICAL CHANGE**: Swap P4.04 and P4.05 order
- **Original**: P4.04 (coverage) ‚Üí P4.05 (fix failures)
- **Revised**: P4.05 (fix failures) ‚Üí P4.04 (coverage)

**Rationale**:
- Cannot measure accurate coverage with 46 failing tests
- Failing tests may terminate early (incomplete coverage data)
- Clean test run required for reliable coverage reports
- P4.05 is prerequisite for P4.04, not the other way around

**Recommended Order**:
1. ‚úÖ P4.01: Fix production blockers (COMPLETE)
2. ‚úÖ P4.02: Requirements coverage ‚â•90% (COMPLETE)
3. ‚úÖ P4.03: Resolve HIGH TODOs (COMPLETE)
4. **‚û°Ô∏è P4.05: Zero test failures (NEXT - prerequisite for P4.04)**
5. ‚è≥ P4.04: Test coverage ‚â•85% (after P4.05)
6. ‚è≥ P4.06: OpenAPI synchronization
7. ‚è≥ P4.07: Resolve MEDIUM TODOs
8. ‚è≥ P4.08: Final verification

## Coverage Exclusions (Acceptable <85%)

**Package**: `internal/identity/idp/auth` (0.0%)
- **Reason**: Placeholder MFA code (not production paths)
- **Status**: DEFERRED to backlog
- **Action**: Add backlog issue "Implement MFA auth package + tests"

**Package**: `internal/identity/idp/userauth/mocks` (84.1%)
- **Reason**: Mock implementations (close to target, acceptable)
- **Status**: ACCEPTABLE (mocks don't require 100% coverage)
- **Action**: None required

## Next Steps

1. ‚úÖ Document baseline coverage (this file)
2. ‚è© **PIVOT TO P4.05**: Fix 46 failing tests FIRST
3. ‚è∏Ô∏è **PAUSE P4.04**: Resume after P4.05 complete
4. üîÑ Revise todo list to reflect new ordering

## Lessons Learned

1. **Test failures block coverage measurement**: Must have clean test run first
2. **Task dependencies matter**: P4.05 is prerequisite for P4.04, not parallel
3. **New code needs tests immediately**: PBKDF2Hasher has 0% coverage (P4.01 deliverable)
4. **Placeholder code skews metrics**: idp/auth 0% is NOT a blocker (deferred MFA)
5. **Coverage targets vary by code type**: Infrastructure 85%, mocks 80%, placeholders 0% (acceptable)

## Acceptance Criteria (for P4.04 - AFTER P4.05)

- [ ] authz package: ‚â•85% coverage
- [ ] authz/clientauth package: ‚â•85% coverage
- [ ] idp package: ‚â•85% coverage
- [ ] issuer package: ‚â•85% coverage
- [ ] PBKDF2Hasher: ‚â•90% coverage (new code from P4.01)
- [ ] CleanupService: ‚â•85% coverage (new code from P4.01)
- [ ] All tests passing (0 failures)
- [ ] Post-mortem created: `P4.04-POSTMORTEM.md`
- [ ] Coverage report: `go test ./internal/identity/... -cover > P4.04-COVERAGE-REPORT.txt`
