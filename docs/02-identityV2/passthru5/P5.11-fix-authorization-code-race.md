# P5.11 Fix Authorization Code Race Condition

**Priority**: HIGH
**Estimated Effort**: 30 minutes
**Dependencies**: P5.10 (COMPLETED - token issuers working)

---

## Problem Statement

Parallel tests are hitting UNIQUE constraint violations on `authorization_requests.code` column when running concurrently.

**Error**:
```
ERROR Failed to store authorization request error="database_query: Database query failed 
(internal: failed to create authorization request: constraint failed: UNIQUE constraint 
failed: authorization_requests.code (2067))" request_id=019ac3a0-89ad-7355-b477-6584d1137010
```

**Observed Behavior**:
- `TestHandleAuthorizeGET_HappyPath` **passes** when run in isolation
- **Fails** with UNIQUE constraint error when run in parallel (`-count=3`)
- Error appears intermittently (race condition, not deterministic)

---

## Root Cause Analysis

### Current Authorization Code Generation

**File**: `internal/identity/authz/handlers_authorize.go` (or test helpers)

**Hypothesis**: Authorization code generation is not time-ordered or uses sequential values that collide under parallel execution

**Need to investigate**:
1. How are authorization codes generated? (UUID, random string, sequential?)
2. Are test helpers creating codes with predictable patterns?
3. Is `googleUuid.New()` being used instead of `googleUuid.NewV7()`? (UUIDv4 has collision risk)

---

## Investigation Steps

### 1. Find Authorization Code Creation Logic

```bash
# Search production code
grep -r "Code.*googleUuid\|authorization.*code.*=" ./internal/identity/authz/handlers_authorize.go

# Search test helpers
grep -r "createTestAuthorizationCode\|Code:.*googleUuid" ./internal/identity/authz/*_test.go
```

### 2. Check UUID Version Usage

```bash
# Find all UUID generation in authz tests
grep -r "googleUuid\.New()\|googleUuid\.NewV7()" ./internal/identity/authz/
```

**Expected**: All should use `googleUuid.NewV7()` (time-ordered, collision-resistant)
**If found**: Instances of `googleUuid.New()` (UUIDv4 - higher collision risk)

### 3. Review Test Helper Code Generation

**File**: `handlers_authorize_comprehensive_test.go` or similar
**Lines**: Where authorization requests are created in tests

**Look for**:
```go
// WRONG (collision-prone):
Code: googleUuid.New().String()  // UUIDv4 - random, collision possible

// RIGHT (time-ordered uniqueness):
Code: googleUuid.NewV7().String()  // UUIDv7 - time-ordered, unique across parallel tests
```

---

## Solution Options

### Option A: Use UUIDv7 for Authorization Codes (PREFERRED)

**Change**:
```go
// Before (collision-prone):
authRequest := &domain.AuthorizationRequest{
    Code: googleUuid.New().String(),  // UUIDv4
    // ...
}

// After (time-ordered uniqueness):
authRequest := &domain.AuthorizationRequest{
    Code: googleUuid.NewV7().String(),  // UUIDv7
    // ...
}
```

**Rationale**:
- UUIDv7 includes timestamp + randomness (collision-resistant in parallel tests)
- Follows project pattern (UUIDv7 preferred for all identifiers)
- Zero configuration changes needed

### Option B: Add Test-Specific Unique Prefix

**Change**:
```go
// In test helpers:
func createTestAuthorizationCode(t *testing.T) string {
    t.Helper()
    // Use test name + UUID for guaranteed uniqueness
    return fmt.Sprintf("%s-%s", t.Name(), googleUuid.NewV7().String())
}
```

**Rationale**:
- Explicitly ties code to test (debugging easier)
- 100% guaranteed unique (even if UUIDv7 collides)
- May exceed column length limits (check schema)

### Option C: Use Database Sequence (NOT RECOMMENDED)

**Change**: Use database auto-increment for authorization codes

**Rationale**: **DON'T DO THIS**
- Predictable codes are security vulnerability
- Breaks existing UUIDv7 pattern
- Requires migration (high effort)

---

## Implementation Plan

### Step 1: Audit Current Code Generation (5 min)

```bash
# Find all authorization code assignments
grep -rn "\.Code = " ./internal/identity/authz/
```

**Expected Output**: List of all locations where `Code` field is set
**Action**: Identify production code vs test code

### Step 2: Update Production Code (if needed) (10 min)

**File**: `internal/identity/authz/handlers_authorize.go`

**IF production code uses UUIDv4**:
```go
// Change this:
Code: googleUuid.New().String(),

// To this:
Code: googleUuid.NewV7().String(),
```

### Step 3: Update Test Helpers (10 min)

**Files**: `handlers_authorize_comprehensive_test.go`, `handlers_token_comprehensive_test.go`

**Search for**:
```go
Code: googleUuid.New().String()  // or any other pattern
```

**Replace with**:
```go
Code: googleUuid.NewV7().String()
```

### Step 4: Verify Fix (5 min)

```bash
# Run tests 10 times to detect race conditions
go test ./internal/identity/authz -run=TestHandleAuthorizeGET_HappyPath -count=10 -timeout=60s

# Run full authz suite in parallel
go test ./internal/identity/authz -count=3 -timeout=120s
```

**Expected**:
- Zero "UNIQUE constraint failed: authorization_requests.code" errors
- All tests pass consistently across multiple runs

---

## Acceptance Criteria

| Criterion | Test Command | Expected Result |
|-----------|--------------|-----------------|
| No UNIQUE constraint errors | `go test ./internal/identity/authz -count=10` | Zero constraint violations |
| Happy path passes consistently | `go test -run=TestHandleAuthorizeGET_HappyPath -count=10` | 10/10 passes |
| Full suite passes | `go test ./internal/identity/authz -count=3` | PASS (no flakiness) |
| Code uses UUIDv7 | `grep "Code.*NewV7" ./internal/identity/authz/` | All code generation uses NewV7 |

---

## Risks and Mitigations

### Risk 1: UUIDv7 Collision (VERY LOW)

**Probability**: Near-zero (128-bit random + timestamp)
**Impact**: Test failure (non-critical)
**Mitigation**: Use Option B (test name prefix) if collisions observed

### Risk 2: Column Length Limit (LOW)

**Scenario**: Authorization code column too short for UUIDv7 string
**Check**:
```sql
-- Review migration schema
cat ./internal/identity/repository/migrations/*.sql | grep "authorization_requests"
```

**Expected**: `code TEXT` or `code VARCHAR(255)` (UUIDv7 = 36 chars)
**Mitigation**: If `VARCHAR(36)`, no change needed; if shorter, Option B won't work

### Risk 3: Production Code Already Correct (LIKELY)

**Scenario**: Only test code has issue
**Verification**: Grep for NewV7 usage in production handlers
**Action**: Update only test code if production already uses NewV7

---

## Testing Strategy

### Phase 1: Isolated Test (5 min)

```bash
# Run single test 10 times
go test ./internal/identity/authz -run=TestHandleAuthorizeGET_HappyPath -count=10 -v
```

**Expected**: 10/10 passes, zero UNIQUE constraint errors

### Phase 2: Parallel Test Suite (10 min)

```bash
# Run full suite 3 times in parallel
go test ./internal/identity/authz -count=3 -timeout=120s
```

**Expected**: PASS with zero flaky failures

### Phase 3: Targeted Race Detection (5 min)

```bash
# Run specific tests prone to race
go test ./internal/identity/authz -run='TestHandleAuthorize.*HappyPath' -count=5 -v
```

**Expected**: All happy path tests pass consistently

---

## Success Metrics

- ✅ Zero UNIQUE constraint violations in 10+ consecutive test runs
- ✅ All authorization tests pass in `-count=10` runs (no flakiness)
- ✅ Code audit shows 100% UUIDv7 usage for authorization codes
- ✅ Test execution time unchanged (UUIDv7 generation is fast)

---

## Dependencies

- **Requires**: P5.10 complete (token issuers working)
- **Blocks**: P5.13 (IDP coverage improvement - needs stable authz tests)
- **Related**: P5.12 (migration race - separate issue)

---

## Rollback Plan

**IF UUIDv7 migration causes unexpected issues**:

1. Revert changes:
   ```bash
   git diff HEAD~1 -- internal/identity/authz/
   git checkout HEAD~1 -- internal/identity/authz/
   ```

2. Fall back to Option B (test name prefix):
   ```go
   Code: fmt.Sprintf("test-%s-%s", t.Name(), googleUuid.New().String())
   ```

3. Re-run tests to verify rollback success

---

## References

- **UUIDv7 Spec**: https://www.ietf.org/archive/id/draft-peabody-dispatch-new-uuid-format-04.html#name-uuidv7-layout-and-bit-order
- **Project Pattern**: `internal/identity/magic/magic_test.go` - TestUsername uses UUIDv7 suffix
- **Parallel Testing**: `internal/identity/repository/migrations.go` - Mutex pattern for concurrent operations
- **Error Log**: P5.10-POSTMORTEM.md section "Authorization Code UNIQUE Constraint Race"
