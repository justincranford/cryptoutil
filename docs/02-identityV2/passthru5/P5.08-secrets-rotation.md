# P5.08: Secrets Rotation and Key Management

## Overview

**Category**: Security Enhancement

**Priority**: HIGH

**Estimated Effort**: 2.5 hours

**Status**: NOT STARTED

---

## Objective

Implement automated secrets rotation and comprehensive key management for the identity module, including client secrets, signing keys, encryption keys, and API keys. Ensure secure key generation, storage, rotation, and revocation with audit logging.

---

## Scope

### In Scope

- Client secret rotation with backward compatibility
- JWK rotation (signing and encryption keys)
- API key rotation for service-to-service auth
- Audit logging for all rotation events
- Key versioning and multi-key support
- Graceful key rollover (old keys valid during transition)
- Automated rotation workflows (scheduled and manual)

### Out of Scope

- Database encryption key rotation (deferred to P5.10)
- Certificate rotation (PKI infrastructure, deferred)
- User password rotation policies (existing in domain layer)

---

## Requirements

### Functional Requirements

#### R08.01: Client Secret Rotation (HIGH)

**Description**: Support rotating client secrets while maintaining backward compatibility during transition period.

**Acceptance Criteria**:

- [ ] Client repository supports multiple active secrets per client
- [ ] Old secret valid for configurable grace period (default: 24 hours)
- [ ] New secret immediately valid upon rotation
- [ ] Audit log records secret rotation events (client ID, timestamp, initiator)
- [ ] API endpoint: `POST /api/v1/clients/{id}/rotate-secret` (returns new secret)
- [ ] Tests: rotation success, grace period validation, audit logging

#### R08.02: JWK Rotation (HIGH)

**Description**: Rotate JSON Web Keys (JWKs) for signing and encryption operations with multi-key support.

**Acceptance Criteria**:

- [ ] JWKS endpoint exposes multiple active keys with `kid` (key ID)
- [ ] New key generation updates JWKS with new `kid`
- [ ] Old keys retained for signature verification (configurable retention: default 7 days)
- [ ] Token signing uses latest key (newest `kid`)
- [ ] Token verification accepts any active key from JWKS
- [ ] Audit log records key rotation events
- [ ] Tests: multi-key validation, signature verification with old keys, JWKS endpoint updates

#### R08.03: API Key Rotation (MEDIUM)

**Description**: Support API key rotation for service-to-service authentication with graceful rollover.

**Acceptance Criteria**:

- [ ] API key repository supports multiple active keys per service
- [ ] Old key valid for configurable grace period (default: 7 days)
- [ ] New key immediately valid upon rotation
- [ ] Audit log records API key rotation events
- [ ] API endpoint: `POST /api/v1/api-keys/{id}/rotate` (returns new key)
- [ ] Tests: rotation success, grace period validation, multi-key authentication

#### R08.04: Automated Rotation Workflows (MEDIUM)

**Description**: Automated and manual rotation workflows with scheduling support.

**Acceptance Criteria**:

- [ ] Job scheduler for periodic rotation (configurable intervals)
- [ ] Manual rotation endpoint for emergency rotation
- [ ] Rotation policy configuration (intervals, grace periods, retention)
- [ ] Notification system for pre-expiration warnings (7 days, 3 days, 1 day)
- [ ] Tests: scheduled rotation, manual rotation, notification triggers

#### R08.05: Key Versioning and Multi-Key Support (HIGH)

**Description**: Comprehensive key versioning with metadata and lifecycle management.

**Acceptance Criteria**:

- [ ] Key metadata: version, created_at, expires_at, rotated_at, status (active/expired/revoked)
- [ ] Key status transitions: active → expired (after grace period), active → revoked (manual)
- [ ] Key lookup by version or `kid`
- [ ] Automatic cleanup of expired keys (configurable retention: default 30 days)
- [ ] Tests: key versioning, status transitions, cleanup scheduler

### Non-Functional Requirements

#### R08.06: Audit Logging (HIGH)

**Description**: Comprehensive audit logging for all key management operations.

**Acceptance Criteria**:

- [ ] Log events: key rotation, key revocation, key expiration, failed rotation attempts
- [ ] Log fields: event type, key ID, timestamp, initiator (user/system), old/new key metadata
- [ ] Audit logs stored in dedicated audit table (separate from application logs)
- [ ] Tests: audit log creation, query by event type, query by key ID

#### R08.07: Security Best Practices (HIGH)

**Description**: Follow security best practices for key generation and storage.

**Acceptance Criteria**:

- [ ] Keys generated using crypto/rand (CSPRNG)
- [ ] Secrets stored as bcrypt/PBKDF2 hashes (never plaintext)
- [ ] JWKs use approved algorithms (RS256, ES256, EdDSA)
- [ ] Key material never logged (only key IDs logged)
- [ ] Tests: key generation randomness, hash validation, algorithm compliance

---

## Implementation Plan

### Phase 1: Client Secret Rotation (1.0 hour)

**Objective**: Implement multi-secret support and rotation API for OAuth2 clients.

**Tasks**:

1. Extend `Client` domain model with `secrets` field (array of secret objects)
2. Add `SecretVersion` struct: `{Hash string, CreatedAt time.Time, ExpiresAt time.Time, Status string}`
3. Implement `RotateClientSecret(clientID string, gracePeriod time.Duration)` service method
4. Add `POST /api/v1/clients/{id}/rotate-secret` endpoint
5. Implement grace period validation in client authentication
6. Add audit logging for rotation events
7. Write tests: rotation success, grace period validation, multi-secret auth
8. Update client fixtures for testing

**Exit Criteria**:

- Client secret rotation functional with grace period
- Audit logging captures rotation events
- Tests pass (≥85% coverage)

### Phase 2: JWK Rotation (0.75 hour)

**Objective**: Implement JWK rotation with multi-key support in JWKS endpoint.

**Tasks**:

1. Extend JWKS store to support multiple active keys
2. Add `kid` generation (UUID or timestamp-based)
3. Implement `RotateSigningKey()` method (generates new RSA/EC/EdDSA key)
4. Update JWKS endpoint to expose all active keys
5. Update token signing to use latest `kid`
6. Retain old keys for signature verification (configurable retention)
7. Add audit logging for JWK rotation
8. Write tests: multi-key JWKS, signature verification with old keys, rotation audit

**Exit Criteria**:

- JWKS endpoint exposes multiple keys with `kid`
- Token verification accepts any active key
- Tests pass (≥85% coverage)

### Phase 3: API Key Rotation and Automation (0.75 hour)

**Objective**: Implement API key rotation and automated rotation workflows.

**Tasks**:

1. Create `APIKey` domain model: `{ID, ServiceID, KeyHash, CreatedAt, ExpiresAt, Status}`
2. Implement `RotateAPIKey(serviceID string, gracePeriod time.Duration)` service method
3. Add `POST /api/v1/api-keys/{id}/rotate` endpoint
4. Implement automated rotation scheduler (job scheduler integration)
5. Add rotation policy configuration (intervals, grace periods, retention)
6. Add pre-expiration notification system (webhook/email)
7. Write tests: API key rotation, scheduled rotation, notification triggers

**Exit Criteria**:

- API key rotation functional with grace period
- Automated rotation scheduler running
- Tests pass (≥85% coverage)

---

## Testing Strategy

### Unit Tests

- Client secret rotation logic
- JWK generation and rotation
- API key rotation logic
- Grace period validation
- Key versioning and status transitions
- Audit log creation

### Integration Tests

- Client authentication with multiple secrets (old + new)
- Token verification with multiple JWKs
- API key authentication with multiple keys
- Rotation scheduler integration
- Notification delivery

### Security Tests

- Key generation randomness (entropy validation)
- Secret hashing (bcrypt/PBKDF2 compliance)
- JWK algorithm compliance (RS256, ES256, EdDSA)
- Audit log completeness (all events logged)

---

## Dependencies

### Internal Dependencies

- `internal/identity/domain`: Client, APIKey models
- `internal/identity/repository/orm`: Client, APIKey repositories
- `internal/identity/jwks`: JWKS store
- `internal/identity/jobs`: Rotation scheduler
- `internal/identity/authz`: Client authentication

### External Dependencies

- `crypto/rand`: Secure random number generation
- `golang.org/x/crypto/bcrypt`: Password hashing
- `github.com/go-jose/go-jose/v4`: JWK generation

---

## Risks and Mitigations

### Risk 1: Key Rotation During Active Sessions

**Risk**: Rotating keys invalidates active sessions using old keys.

**Mitigation**: Multi-key support (keep old keys valid during grace period).

### Risk 2: Clock Skew Between Services

**Risk**: Expiration times differ between services due to clock skew.

**Mitigation**: Use grace periods (overlap old/new key validity).

### Risk 3: Audit Log Storage Growth

**Risk**: Audit logs grow unbounded.

**Mitigation**: Implement retention policy (default: 90 days), archive old logs.

---

## Acceptance Criteria

### Overall Acceptance Criteria

- [ ] All requirements implemented and tested (7/7 requirements)
- [ ] Test coverage ≥85% for rotation logic
- [ ] Audit logging functional for all key operations
- [ ] Documentation updated (API docs, README)
- [ ] Pre-commit hooks passing
- [ ] CI/CD workflow passing (ci-identity-validation.yml)

### Evidence Checklist

- [ ] Commit: Client secret rotation implementation
- [ ] Commit: JWK rotation implementation
- [ ] Commit: API key rotation and automation
- [ ] Test output: Rotation tests passing (client, JWK, API key)
- [ ] Test output: Audit logging tests passing
- [ ] Coverage report: ≥85% for rotation modules
- [ ] API documentation: Rotation endpoints documented
- [ ] Security audit: Key generation and storage compliance

---

## Expected Benefits

- **Security**: Reduced risk of compromised secrets (regular rotation)
- **Compliance**: Meets security standards for key rotation (NIST, PCI DSS)
- **Automation**: Eliminates manual key rotation (100% automation)
- **Audit Trail**: Complete audit history for security investigations

---

**Created**: 2025-11-26
**Updated**: 2025-11-26
**Author**: GitHub Copilot (Agent)
**Review Status**: Awaiting Implementation
