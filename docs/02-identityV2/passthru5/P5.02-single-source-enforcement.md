# P5.02: Single Source of Truth Enforcement

**Task ID**: P5.02
**Created**: 2025-01-19
**Priority**: ðŸ”´ CRITICAL
**Effort Estimate**: 3 hours
**Dependencies**: P5.01 (automated quality gates)
**Status**: IN PROGRESS

---

## Objective

Consolidate all status reporting to PROJECT-STATUS.md as the single authoritative source. Eliminate duplicate status information scattered across multiple documents and automate PROJECT-STATUS.md updates from requirements coverage tool.

---

## Success Criteria

- [x] PROJECT-STATUS.md copied to docs/02-identityV2/ (passthrough-agnostic location)
- [x] Automation script created: go_update_project_status/update.go (200+ lines)
- [x] Integrated into cicd.go dispatcher (import, constant, switch case)
- [x] Added to ValidCommands map in magic_cicd.go
- [x] Tested locally: `go run ./cmd/cicd go-update-project-status` (PASS)
- [x] PASSTHRU4-FEATURE-PLAN.md updated to reference ../PROJECT-STATUS.md
- [x] CI/CD stale check added: Fails if PROJECT-STATUS.md >7 days old
- [ ] README.md status section references PROJECT-STATUS.md (if duplicate status exists)
- [ ] All changes committed with conventional commit message
- [ ] Test coverage: â‰¥85% for go_update_project_status package

---

## Current State Analysis

**Multiple Status Sources** (contradiction risk):

1. **docs/02-identityV2/passthru4/PROJECT-STATUS.md**:
   - Original plan: 45% complete (9/20 tasks)
   - Requirements: 58.5% (38/65) - OUTDATED, actually 98.5%
   - Production blockers: 8 items

2. **docs/02-identityV2/REQUIREMENTS-COVERAGE.md** (copied from passthru4):
   - Requirements: 98.5% (64/65) - CURRENT/ACCURATE
   - Generated: 2025-01-19
   - One uncovered requirement: R04-06 (client secret rotation)

3. **README.md** (may contain status):
   - User-facing quick start guide
   - May duplicate status information

4. **docs/02-identityV2/passthru4/PASSTHRU4-FEATURE-PLAN.md**:
   - Planning document with status duplication
   - Should reference PROJECT-STATUS.md instead

**Root Cause**: No enforcement mechanism, manual updates prone to drift

---

## Implementation Plan

### Step 1: Consolidate PROJECT-STATUS.md Location

**Decision**: Use `docs/02-identityV2/PROJECT-STATUS.md` (not passthru4 subdirectory)

**Rationale**:
- Passthrough-agnostic location (not tied to passthru4/passthru5)
- Clear path for tools: `docs/02-identityV2/PROJECT-STATUS.md`
- Historical passthroughs in subdirectories for reference

**Actions**:
```bash
# Copy latest PROJECT-STATUS.md to parent directory
cp docs/02-identityV2/passthru4/PROJECT-STATUS.md docs/02-identityV2/PROJECT-STATUS.md

# Update with current metrics
# - Requirements: 98.5% (from REQUIREMENTS-COVERAGE.md)
# - Last updated: 2025-01-19
# - Commit hash: [to be filled on commit]
```

### Step 2: Update README.md Status References

**File**: `README.md`

**Find and replace status sections** with reference:

```markdown
## Project Status

**See [PROJECT-STATUS.md](docs/02-identityV2/PROJECT-STATUS.md) for current project status.**

Quick summary:
- Requirements Coverage: See PROJECT-STATUS.md
- Test Coverage: See PROJECT-STATUS.md
- Production Readiness: See PROJECT-STATUS.md
```

**Remove**:
- Duplicate completion percentages
- Duplicate TODO counts
- Duplicate production blocker lists

### Step 3: Update PASSTHRU4-FEATURE-PLAN.md References

**File**: `docs/02-identityV2/passthru4/PASSTHRU4-FEATURE-PLAN.md`

**Replace status sections** with:

```markdown
## Current Status

**See [../PROJECT-STATUS.md](../PROJECT-STATUS.md) for current project status.**

This document contains historical planning from Passthru4 (November 2025).
For current completion metrics, requirements coverage, and production readiness,
refer to the single source of truth: PROJECT-STATUS.md.
```

### Step 4: Automate PROJECT-STATUS.md Updates

**Create automation script**: `internal/cmd/cicd/go_update_project_status/update.go`

**Responsibilities**:
1. Read REQUIREMENTS-COVERAGE.md metrics
2. Read TODO counts from grep search
3. Update PROJECT-STATUS.md with current data
4. Update "Last Updated" timestamp
5. Update "Commit Hash" placeholder

**Implementation**:

```go
package go_update_project_status

import (
    "context"
    "fmt"
    "os"
    "os/exec"
    "regexp"
    "strings"
    "time"

    "cryptoutil/internal/cmd/cicd/common"
)

func Update(ctx context.Context, logger *common.Logger) error {
    statusFile := "docs/02-identityV2/PROJECT-STATUS.md"
    coverageFile := "docs/02-identityV2/REQUIREMENTS-COVERAGE.md"

    logger.Log("Updating PROJECT-STATUS.md with current metrics...")

    // Read requirements coverage
    coverage, err := parseRequirementsCoverage(coverageFile)
    if err != nil {
        return fmt.Errorf("failed to parse requirements coverage: %w", err)
    }

    // Count TODOs by severity
    todos, err := countTODOs()
    if err != nil {
        return fmt.Errorf("failed to count TODOs: %w", err)
    }

    // Get current commit hash
    commitHash, err := getCurrentCommitHash()
    if err != nil {
        return fmt.Errorf("failed to get commit hash: %w", err)
    }

    // Read current PROJECT-STATUS.md
    content, err := os.ReadFile(statusFile)
    if err != nil {
        return fmt.Errorf("failed to read status file: %w", err)
    }

    // Update metrics
    updated := updateMetrics(string(content), coverage, todos, commitHash)

    // Write updated content
    if err := os.WriteFile(statusFile, []byte(updated), 0o644); err != nil {
        return fmt.Errorf("failed to write status file: %w", err)
    }

    logger.Log(fmt.Sprintf("Updated PROJECT-STATUS.md:"))
    logger.Log(fmt.Sprintf("  Requirements: %.1f%% (%d/%d)", coverage.percentage, coverage.validated, coverage.total))
    logger.Log(fmt.Sprintf("  TODOs: %d CRITICAL, %d HIGH, %d MEDIUM, %d LOW", todos.critical, todos.high, todos.medium, todos.low))
    logger.Log(fmt.Sprintf("  Commit: %s", commitHash[:8]))

    return nil
}

type requirementsCoverage struct {
    validated  int
    total      int
    percentage float64
}

type todoCount struct {
    critical int
    high     int
    medium   int
    low      int
}

func parseRequirementsCoverage(filePath string) (*requirementsCoverage, error) {
    content, err := os.ReadFile(filePath)
    if err != nil {
        return nil, err
    }

    coverage := &requirementsCoverage{}
    lines := strings.Split(string(content), "\n")

    for _, line := range lines {
        if strings.HasPrefix(line, "**Total Requirements**:") {
            fmt.Sscanf(line, "**Total Requirements**: %d", &coverage.total)
        }
        if strings.HasPrefix(line, "**Validated**:") {
            fmt.Sscanf(line, "**Validated**: %d (%f%%)", &coverage.validated, &coverage.percentage)
        }
    }

    return coverage, nil
}

func countTODOs() (*todoCount, error) {
    cmd := exec.Command("grep", "-rn", "--include=*.go", "TODO\\|FIXME", "internal/identity/")
    output, _ := cmd.CombinedOutput()

    todos := &todoCount{}
    lines := strings.Split(string(output), "\n")

    for _, line := range lines {
        upper := strings.ToUpper(line)
        if strings.Contains(upper, "CRITICAL") {
            todos.critical++
        } else if strings.Contains(upper, "HIGH") {
            todos.high++
        } else if strings.Contains(upper, "MEDIUM") {
            todos.medium++
        } else if strings.Contains(line, "TODO") || strings.Contains(line, "FIXME") {
            todos.low++
        }
    }

    return todos, nil
}

func getCurrentCommitHash() (string, error) {
    cmd := exec.Command("git", "rev-parse", "HEAD")
    output, err := cmd.Output()
    if err != nil {
        return "", err
    }
    return strings.TrimSpace(string(output)), nil
}

func updateMetrics(content string, coverage *requirementsCoverage, todos *todoCount, commitHash string) string {
    // Update timestamp
    now := time.Now().Format("January 2, 2006")
    content = regexp.MustCompile(`\*\*Last Updated\*\*: .*`).ReplaceAllString(content, "**Last Updated**: "+now)

    // Update commit hash
    content = regexp.MustCompile(`\*\*Commit Hash\*\*: .*`).ReplaceAllString(content, "**Commit Hash**: "+commitHash[:8])

    // Update requirements coverage
    coverageLine := fmt.Sprintf("| **TOTAL** | **%d** | **%d** | **%.1f%%** | **%d** |",
        coverage.validated, coverage.total, coverage.percentage, coverage.total-coverage.validated)
    content = regexp.MustCompile(`\| \*\*TOTAL\*\* \| \*\*\d+\*\* \| \*\*\d+\*\* \| \*\*[\d.]+%\*\* \| \*\*\d+\*\* \|`).
        ReplaceAllString(content, coverageLine)

    // Update TODO counts
    content = regexp.MustCompile(`ðŸ”´ CRITICAL \| \d+`).ReplaceAllString(content, fmt.Sprintf("ðŸ”´ CRITICAL | %d", todos.critical))
    content = regexp.MustCompile(`âš ï¸ HIGH \| \d+`).ReplaceAllString(content, fmt.Sprintf("âš ï¸ HIGH | %d", todos.high))
    content = regexp.MustCompile(`ðŸ“‹ MEDIUM \| \d+`).ReplaceAllString(content, fmt.Sprintf("ðŸ“‹ MEDIUM | %d", todos.medium))
    content = regexp.MustCompile(`â„¹ï¸ LOW \| \d+`).ReplaceAllString(content, fmt.Sprintf("â„¹ï¸ LOW | %d", todos.low))

    return content
}
```

### Step 5: Add CI/CD Stale Check

**File**: `.github/workflows/ci-quality.yml`

**Add job to identity-requirements**:

```yaml
      - name: Check PROJECT-STATUS.md freshness
        run: |
          echo "ðŸ“‹ Checking PROJECT-STATUS.md last update time..."
          STATUS_FILE="docs/02-identityV2/PROJECT-STATUS.md"

          # Get last commit date for PROJECT-STATUS.md
          LAST_COMMIT_DATE=$(git log -1 --format="%ct" -- "$STATUS_FILE")
          CURRENT_DATE=$(date +%s)
          AGE_DAYS=$(( (CURRENT_DATE - LAST_COMMIT_DATE) / 86400 ))

          echo "PROJECT-STATUS.md last updated: ${AGE_DAYS} days ago"

          if [ $AGE_DAYS -gt 7 ]; then
            echo "âŒ ERROR: PROJECT-STATUS.md is stale (>7 days old)"
            echo "Run: go run ./cmd/cicd go-update-project-status"
            exit 1
          fi

          echo "âœ… PROJECT-STATUS.md is fresh (<7 days old)"
```

### Step 6: Integrate into CICD Dispatcher

**File**: `internal/cmd/cicd/cicd.go`

**Add command**:

```go
const (
    // ... existing commands
    cmdGoUpdateProjectStatus = "go-update-project-status"
)

// In Run() function switch statement:
case cmdGoUpdateProjectStatus:
    return go_update_project_status.Update(ctx, logger)
```

---

## Testing Strategy

### Unit Tests

**File**: `internal/cmd/cicd/go_update_project_status/update_test.go`

- Test parseRequirementsCoverage() with sample coverage file
- Test countTODOs() with sample grep output
- Test updateMetrics() with before/after content comparison
- Test edge cases: missing files, malformed data, zero TODOs

### Integration Tests

- Run go-update-project-status on real PROJECT-STATUS.md
- Verify metrics updated correctly
- Verify timestamp and commit hash updated
- Verify content structure preserved

### CI/CD Validation

- Test stale check with git log manipulation
- Verify check fails when PROJECT-STATUS.md >7 days old
- Verify check passes when fresh

---

## Acceptance Criteria Evidence

### Code Quality
- [ ] `go build ./cmd/cicd` â†’ Zero compilation errors
- [ ] `golangci-lint run ./internal/cmd/cicd/go_update_project_status` â†’ Zero linting errors
- [ ] `grep -r "TODO\|FIXME" internal/cmd/cicd/go_update_project_status` â†’ Zero new TODOs

### Testing
- [ ] `go test ./internal/cmd/cicd/go_update_project_status` â†’ All tests passing
- [ ] `go test -cover ./internal/cmd/cicd/go_update_project_status` â†’ Coverage â‰¥85%
- [ ] No test skips

### Requirements
- [ ] README.md references PROJECT-STATUS.md (no duplication)
- [ ] PASSTHRU4-FEATURE-PLAN.md references PROJECT-STATUS.md
- [ ] go-update-project-status command works
- [ ] CI/CD stale check implemented

### Documentation
- [ ] This task document updated with evidence
- [ ] Post-mortem created: `P5.02-POSTMORTEM.md`
- [ ] PROJECT-STATUS.md updated with P5.02 completion

---

## Known Risks

| Risk | Mitigation |
|------|------------|
| Automation breaks if coverage file format changes | Version format with parser tests |
| Manual edits to PROJECT-STATUS.md overwritten | Document automation, add warning comment in file |
| Regex updates fragile | Use structured format with clear markers for automation |

---

## Implementation Notes

**Development Approach**:
1. Create go_update_project_status package first
2. Test locally with current files
3. Update README.md and PASSTHRU4-FEATURE-PLAN.md references
4. Add CI/CD stale check
5. Run automation to verify updates

**Progressive Validation**:
- After Step 1: Verify PROJECT-STATUS.md exists at new location
- After Step 4: Run `go run ./cmd/cicd go-update-project-status` locally
- After Step 5: Trigger CI/CD workflow, verify stale check runs

**Completion Criteria**: ALL acceptance criteria checked, post-mortem created, PROJECT-STATUS.md updated

---

## Dependencies

**Depends on**: P5.01 (automated quality gates) - requirements coverage file location established

**Blocks**: P5.03 (progressive validation) - needs single source for validation checks

---

## References

- PASSTHRU5-MASTER-PLAN.md: Phase 1 quality infrastructure
- GAP-ANALYSIS.md: Root cause - multiple documentation sources
- PROJECT-STATUS.md: Target file for consolidation
