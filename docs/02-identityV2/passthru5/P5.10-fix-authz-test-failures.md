# P5.10 Fix Remaining AuthZ Test Failures

**Task ID**: P5.10
**Priority**: HIGH
**Created**: 2025-11-26 23:15 UTC
**Status**: NOT STARTED
**Depends On**: P5.09 (completed - migration fixes)
**Estimated Effort**: 2-3 hours

## Problem Statement

After fixing migration infrastructure (P5.09), 4 authz comprehensive tests still fail with authentication/authorization errors, preventing full test suite from passing.

## Evidence

```bash
# Full identity test suite results
go test ./internal/identity/... -count=1 -timeout=180s

# FAILURES:
FAIL  cryptoutil/internal/identity/authz          # Token endpoint tests
FAIL  cryptoutil/internal/identity/authz/clientauth  # Client authentication
FAIL  cryptoutil/internal/identity/idp            # Consent/security tests
FAIL  cryptoutil/internal/identity/integration    # Resource server tests
FAIL  cryptoutil/internal/identity/test/contract  # Contract tests
FAIL  cryptoutil/internal/identity/test/e2e       # E2E integration tests

# PASSES:
✅ authz/pkce (95.5% coverage)
✅ domain (92.3% coverage)
✅ jobs (89.0% coverage)
✅ rotation (83.5% coverage)
✅ security (100.0% coverage)
✅ 15+ other packages
```

## Failure Categories

### Category 1: AuthZ Token Endpoint Tests

**Package**: `cryptoutil/internal/identity/authz`

**Likely Failures**:

- `TestHandleTokenPOST_AuthorizationCode`
- `TestHandleTokenPOST_ClientCredentials`
- `TestHandleTokenPOST_RefreshToken`

**Symptoms**: Authentication errors, missing client credentials, invalid token format

**Root Cause Hypothesis**: Test setup missing client authentication configuration or session state

### Category 2: Client Authentication Tests

**Package**: `cryptoutil/internal/identity/authz/clientauth`

**Likely Failures**:

- Client secret validation
- Client certificate authentication
- JWT bearer token authentication

**Symptoms**: Unauthorized, missing credentials, hash verification failure

**Root Cause Hypothesis**: Client secret hashing mismatch (bcrypt→PBKDF2 migration) or missing auth headers

### Category 3: IDP Consent/Security Tests

**Package**: `cryptoutil/internal/identity/idp`

**Failures** (from previous output):

- `TestHandleConsentSubmit_POST`
- `TestParallelTestSafety`
- `TestOIDCFlow_IDPEndpointsIntegration`
- `TestSecurityAttacks_CSRFProtection`
- `TestSecurityValidation_RateLimiting`
- `TestSecurityValidation_InputSanitization`

**Symptoms**: Consent flow errors, CSRF validation failures, rate limiting issues

**Root Cause Hypothesis**: Session management, CSRF token generation, or request context setup

### Category 4: Integration Tests

**Package**: `cryptoutil/internal/identity/integration`

**Failures** (from previous output):

- `TestResourceServerScopeEnforcement`
- `TestUnauthorizedAccess`
- `TestGracefulShutdown`

**Symptoms**: Scope validation failures, authorization errors

**Root Cause Hypothesis**: Missing JWT token validation setup or scope configuration

### Category 5: E2E Tests

**Package**: `cryptoutil/internal/identity/test/e2e`

**Symptoms**: Services fail to start (port conflicts, missing certs)

**Root Cause**: Dynamic port allocation issues, TLS certificate generation

## Investigation Plan

### Phase 1: Identify Specific Failures (30 min)

```bash
# Run each failing package with verbose output
go test ./internal/identity/authz -v -timeout=60s 2>&1 | tee authz_failures.log
go test ./internal/identity/authz/clientauth -v -timeout=60s 2>&1 | tee clientauth_failures.log
go test ./internal/identity/idp -v -timeout=60s 2>&1 | tee idp_failures.log
go test ./internal/identity/integration -v -timeout=60s 2>&1 | tee integration_failures.log
go test ./internal/identity/test/e2e -v -timeout=60s 2>&1 | tee e2e_failures.log

# Extract FAIL lines with context
Select-String -Path "*_failures.log" -Pattern "FAIL: Test" -Context 0,5
```

### Phase 2: Fix AuthZ Token Tests (1 hour)

**Files to investigate**:

- `internal/identity/authz/handlers_token_test.go`
- `internal/identity/authz/service.go` (token generation)
- `internal/identity/authz/testutils.go` (test helpers)

**Common Issues**:

1. Missing authorization code in test setup
2. Client secret hash mismatch (bcrypt vs PBKDF2)
3. Missing session state
4. Invalid redirect URI
5. Expired authorization request

**Fix Strategy**:

```go
// Ensure client uses PBKDF2-hashed secret
client := &domain.Client{
    ClientID:     "test-client",
    ClientSecret: hashedSecret,  // Use cryptoutilCrypto.HashSecret()
    // ...
}

// Create valid authorization code
authCode := &domain.AuthorizationCode{
    Code:      googleUuid.NewV7().String(),
    ClientID:  client.ClientID,
    UserID:    user.Sub,
    ExpiresAt: time.Now().Add(10 * time.Minute),
    // ...
}

// Authenticate request with client credentials
req := httptest.NewRequest("POST", "/token", body)
req.SetBasicAuth(client.ClientID, plainSecret)  // Use plain secret for auth
```

### Phase 3: Fix Client Authentication Tests (45 min)

**Files to investigate**:

- `internal/identity/authz/clientauth/*_test.go`
- `internal/identity/authz/clientauth/authenticator.go`

**Common Issues**:

1. Secret verification using wrong hash algorithm
2. Missing Authorization header
3. Certificate validation failures
4. JWT signature verification errors

**Fix Strategy**:

```go
// Verify client secret uses PBKDF2
match, err := cryptoutilCrypto.VerifySecret(client.ClientSecret, providedSecret)
require.NoError(t, err)
require.True(t, match)

// Set proper auth headers
req.Header.Set("Authorization", "Basic " + base64.StdEncoding.EncodeToString([]byte(clientID+":"+secret)))
```

### Phase 4: Fix IDP Tests (45 min)

**Files to investigate**:

- `internal/identity/idp/handlers_consent_test.go`
- `internal/identity/idp/handlers_security_test.go`
- `internal/identity/idp/service.go` (session/CSRF management)

**Common Issues**:

1. CSRF token generation/validation failures
2. Session cookie not set/parsed correctly
3. Rate limiting state not reset between tests
4. Input sanitization regex issues

**Fix Strategy**:

```go
// Create valid session with CSRF token
session := &domain.Session{
    ID:        googleUuid.NewV7(),
    UserID:    user.Sub,
    CSRFToken: generateCSRFToken(),  // Use service method
    ExpiresAt: time.Now().Add(1 * time.Hour),
}

// Set session cookie
cookie := &http.Cookie{
    Name:  "session_id",
    Value: session.ID.String(),
}
req.AddCookie(cookie)

// Include CSRF token in form
form := url.Values{
    "csrf_token": {session.CSRFToken},
    // ... other form fields
}
```

### Phase 5: Fix Integration Tests (30 min)

**Files to investigate**:

- `internal/identity/integration/*_test.go`
- `internal/identity/rs/middleware.go` (resource server middleware)

**Common Issues**:

1. Missing JWT token in request
2. Invalid token signature
3. Scope mismatch
4. Expired token

**Fix Strategy**:

```go
// Create valid JWT token with required scopes
token := generateJWT(user.Sub, client.ClientID, []string{"openid", "profile", "resource:read"})

// Set Authorization header
req.Header.Set("Authorization", "Bearer " + token)
```

### Phase 6: Fix E2E Tests (30 min)

**Files to investigate**:

- `internal/identity/test/e2e/setup.go`
- `internal/identity/test/e2e/infrastructure.go`

**Common Issues**:

1. Port 8080 already in use
2. Missing TLS certificates
3. Health check timeouts

**Fix Strategy**:

```go
// Use dynamic port allocation
func allocatePort(t *testing.T) int {
    listener, _ := net.Listen("tcp", ":0")
    port := listener.Addr().(*net.TCPAddr).Port
    listener.Close()
    return port
}

// Generate self-signed certs
func setupTestCerts(t *testing.T) (certFile, keyFile string) {
    cert, key := generateSelfSignedCert(t)
    certFile = filepath.Join(t.TempDir(), "test_cert.pem")
    keyFile = filepath.Join(t.TempDir(), "test_key.pem")
    os.WriteFile(certFile, cert, 0644)
    os.WriteFile(keyFile, key, 0600)
    return
}
```

## Acceptance Criteria

- [ ] All authz token endpoint tests pass (authorization_code, client_credentials, refresh_token)
- [ ] All clientauth tests pass (basic auth, client secret, JWT bearer)
- [ ] All IDP consent tests pass (consent flow, CSRF protection)
- [ ] All IDP security tests pass (rate limiting, input sanitization)
- [ ] All integration tests pass (scope enforcement, unauthorized access)
- [ ] All E2E tests pass (service startup, health checks, full flow)
- [ ] Full identity test suite passes: `go test ./internal/identity/... -count=3`
- [ ] Coverage remains ≥80% for all packages (no regression)
- [ ] Post-mortem documents all fixes with evidence

## Testing Strategy

```bash
# Progressive testing (fix one category at a time)
go test ./internal/identity/authz -v -count=1                    # Phase 2
go test ./internal/identity/authz/clientauth -v -count=1         # Phase 3
go test ./internal/identity/idp -v -count=1                      # Phase 4
go test ./internal/identity/integration -v -count=1              # Phase 5
go test ./internal/identity/test/e2e -v -count=1                 # Phase 6

# Final validation (all packages, 3 runs for stability)
go test ./internal/identity/... -count=3 -timeout=300s

# Regression check (no coverage loss)
go test ./internal/identity/... -coverprofile=coverage_final.out
go tool cover -func=coverage_final.out | Select-String -Pattern "total:"
```

## Related Files

- `internal/identity/authz/handlers_token_test.go` - Token endpoint tests
- `internal/identity/authz/clientauth/*_test.go` - Client auth tests
- `internal/identity/idp/handlers_consent_test.go` - Consent flow tests
- `internal/identity/idp/handlers_security_test.go` - Security tests
- `internal/identity/integration/*_test.go` - Integration tests
- `internal/identity/test/e2e/setup.go` - E2E infrastructure

## Next Steps

After P5.10 completion:

- **P5.11**: Increase coverage to 85%+ (focus on idp 44% → 85%, idp/userauth 37% → 85%)
- **P5.12**: Production readiness checks (SAST, DAST, load tests)
- **P5.13**: Deployment planning (rollout strategy, rollback plan)

## References

- **P5.08**: bcrypt→PBKDF2 migration (completed)
- **P5.09**: Mutex-protected migrations (completed)
- **R07-POSTMORTEM**: sync.Once pattern for shared DB tests
- **04-01.sqlite-gorm.instructions.md**: SQLite concurrency patterns
