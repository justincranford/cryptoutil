# P5.01: Automated Quality Gate Enforcement

**Task ID**: P5.01
**Created**: 2025-01-19
**Priority**: ðŸ”´ CRITICAL
**Effort Estimate**: 4 hours
**Dependencies**: None
**Status**: IN PROGRESS

---

## Objective

Add automated quality gate enforcement to CI/CD pipeline to prevent gap accumulation. Implement strict threshold validation for requirements coverage, TODO severity checks, and automated quality gate dashboard.

---

## Success Criteria

- [ ] `identity-requirements-check --strict` mode implemented with threshold enforcement
- [ ] CI/CD fails on coverage < 90% per-task or < 85% overall
- [ ] Pre-commit hook enforces TODO severity (fails on CRITICAL/HIGH)
- [ ] Quality gate dashboard visible in GitHub Actions summary
- [ ] All quality gates documented in `.github/workflows/ci-quality.yml`
- [ ] Test coverage: â‰¥85% for new code

---

## Implementation Plan

### Step 1: Add --strict Mode to Requirements Check Tool

**File**: `internal/cmd/cicd/identity-requirements-check/main.go`

**Changes**:
1. Add `--strict` flag to command-line arguments
2. Add `--task-threshold=90` and `--overall-threshold=85` flags
3. Implement threshold validation logic:
   - Calculate per-task coverage percentage
   - Calculate overall coverage percentage
   - Exit with code 1 if below thresholds
   - Exit with code 0 if passing

**Example**:
```go
func main() {
    strictMode := flag.Bool("strict", false, "Fail if coverage below thresholds")
    taskThreshold := flag.Int("task-threshold", 90, "Per-task coverage threshold (%)")
    overallThreshold := flag.Int("overall-threshold", 85, "Overall coverage threshold (%)")
    flag.Parse()

    report := generateCoverageReport()

    if *strictMode {
        exitCode := validateThresholds(report, *taskThreshold, *overallThreshold)
        os.Exit(exitCode)
    }

    printReport(report)
}

func validateThresholds(report CoverageReport, taskMin, overallMin int) int {
    // Check per-task coverage
    for _, task := range report.Tasks {
        coverage := (task.Validated * 100) / task.Total
        if coverage < taskMin {
            fmt.Fprintf(os.Stderr, "FAIL: Task %s coverage %d%% < %d%%\n", task.ID, coverage, taskMin)
            return 1
        }
    }

    // Check overall coverage
    overallCoverage := (report.TotalValidated * 100) / report.TotalRequirements
    if overallCoverage < overallMin {
        fmt.Fprintf(os.Stderr, "FAIL: Overall coverage %d%% < %d%%\n", overallCoverage, overallMin)
        return 1
    }

    fmt.Println("PASS: All coverage thresholds met")
    return 0
}
```

### Step 2: Integrate into CI/CD Workflow

**File**: `.github/workflows/ci-quality.yml`

**Add new job**:
```yaml
  identity-requirements-check:
    name: Identity Requirements Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run requirements coverage check (strict mode)
        run: |
          echo "ðŸ“‹ Checking requirements coverage with strict thresholds..."
          go run ./cmd/cicd identity-requirements-check --strict \
            --task-threshold=90 \
            --overall-threshold=85

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: identity-requirements-coverage
          path: |
            docs/02-identityV2/passthru5/REQUIREMENTS-COVERAGE.md
          retention-days: 30
```

### Step 3: Add TODO Severity Enforcement Hook

**File**: `.pre-commit-config.yaml`

**Add new hook**:
```yaml
  - repo: local
    hooks:
      - id: check-todo-severity
        name: Check TODO/FIXME severity
        entry: bash -c 'if grep -rn --include="*.go" "TODO.*CRITICAL\|FIXME.*CRITICAL\|TODO.*HIGH\|FIXME.*HIGH" internal/identity/; then echo "ERROR: Found CRITICAL or HIGH severity TODOs - must be resolved before commit"; exit 1; fi'
        language: system
        types: [go]
        pass_filenames: false
```

**Alternative: Go-based hook** (more portable):
```yaml
  - repo: local
    hooks:
      - id: check-todo-severity
        name: Check TODO/FIXME severity
        entry: go run ./cmd/cicd check-todo-severity
        language: system
        types: [go]
        pass_filenames: false
```

**Implementation**: `cmd/cicd/check-todo-severity/main.go`
```go
package main

import (
    "fmt"
    "os"
    "os/exec"
    "strings"
)

func main() {
    // Search for CRITICAL/HIGH TODOs
    cmd := exec.Command("grep", "-rn", "--include=*.go",
        "TODO.*CRITICAL\\|FIXME.*CRITICAL\\|TODO.*HIGH\\|FIXME.*HIGH",
        "internal/identity/")

    output, err := cmd.CombinedOutput()
    if err == nil {
        // Found matches
        fmt.Fprintf(os.Stderr, "ERROR: Found CRITICAL or HIGH severity TODOs:\n%s\n", output)
        fmt.Fprintln(os.Stderr, "These must be resolved before commit.")
        os.Exit(1)
    }

    // No matches found (grep exits with code 1 when no matches)
    if exitErr, ok := err.(*exec.ExitError); ok && exitErr.ExitCode() == 1 {
        fmt.Println("PASS: No CRITICAL or HIGH severity TODOs found")
        os.Exit(0)
    }

    // Other error (grep failed)
    fmt.Fprintf(os.Stderr, "ERROR: Failed to check TODOs: %v\n", err)
    os.Exit(1)
}
```

### Step 4: Quality Gate Dashboard (Optional)

**File**: `.github/workflows/ci-quality.yml`

**Add job summary step**:
```yaml
      - name: Generate quality gate summary
        if: always()
        run: |
          echo "## Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Requirements coverage
          COVERAGE=$(go run ./cmd/cicd identity-requirements-check --json | jq -r '.overall_percentage')
          echo "- **Requirements Coverage**: $COVERAGE% (Threshold: 85%)" >> $GITHUB_STEP_SUMMARY

          # TODO counts
          CRITICAL_TODOS=$(grep -rc "TODO.*CRITICAL\|FIXME.*CRITICAL" internal/identity/ | awk -F: '{sum+=$2} END {print sum}')
          HIGH_TODOS=$(grep -rc "TODO.*HIGH\|FIXME.*HIGH" internal/identity/ | awk -F: '{sum+=$2} END {print sum}')
          echo "- **CRITICAL TODOs**: $CRITICAL_TODOS" >> $GITHUB_STEP_SUMMARY
          echo "- **HIGH TODOs**: $HIGH_TODOS" >> $GITHUB_STEP_SUMMARY

          # Test coverage
          TEST_COVERAGE=$(go test ./internal/identity/... -coverprofile=coverage.out 2>&1 | grep "coverage:" | awk '{print $5}')
          echo "- **Test Coverage**: $TEST_COVERAGE (Threshold: 85%)" >> $GITHUB_STEP_SUMMARY
```

---

## Testing Strategy

### Unit Tests
- Test `validateThresholds()` function with various coverage values
- Test edge cases: 0%, 100%, exactly at threshold
- Test per-task vs overall threshold logic

### Integration Tests
- Run requirements-check --strict in test environment
- Verify exit codes: 0 for pass, 1 for fail
- Test with coverage above/below thresholds

### Pre-commit Hook Testing
- Add CRITICAL TODO to test file, verify hook fails
- Add HIGH TODO to test file, verify hook fails
- Add MEDIUM TODO, verify hook passes
- Remove TODO, verify hook passes

### CI/CD Validation
- Run workflow with coverage above thresholds (should pass)
- Simulate coverage drop below threshold (should fail)
- Verify quality gate dashboard appears in Actions summary

---

## Acceptance Criteria Evidence

### Code Quality
- [ ] `go build ./cmd/cicd/identity-requirements-check` â†’ Zero compilation errors
- [ ] `golangci-lint run ./cmd/cicd/identity-requirements-check` â†’ Zero linting errors
- [ ] `grep -r "TODO\|FIXME" cmd/cicd/identity-requirements-check` â†’ Zero new TODOs

### Testing
- [ ] `go test ./cmd/cicd/identity-requirements-check` â†’ All tests passing
- [ ] `go test -cover ./cmd/cicd/identity-requirements-check` â†’ Coverage â‰¥85%
- [ ] No test skips: `grep -r "t.Skip" cmd/cicd/identity-requirements-check` â†’ 0 results

### Requirements
- [ ] All success criteria checked above
- [ ] Quality gate dashboard visible in GitHub Actions
- [ ] Pre-commit hook blocks CRITICAL/HIGH TODOs

### Documentation
- [ ] This task document updated with implementation evidence
- [ ] Post-mortem created: `P5.01-POSTMORTEM.md`
- [ ] PROJECT-STATUS.md updated with P5.01 completion

---

## Known Risks

| Risk | Mitigation |
|------|------------|
| Quality gates too strict (block legitimate work) | Start in warning-only mode, graduate to fail-fast after team validation |
| False positives in TODO detection | Use precise regex patterns, document exceptions |
| CI/CD performance impact | Cache requirements check results, only re-run on requirements.yml changes |

---

## Implementation Notes

**Development Approach**:
1. Implement --strict mode in identity-requirements-check first
2. Test locally with various threshold values
3. Add pre-commit hook (test locally with `pre-commit run`)
4. Add CI/CD integration
5. Add quality gate dashboard last (optional enhancement)

**Progressive Validation**:
- After Step 1: Run `go test ./cmd/cicd/identity-requirements-check`
- After Step 2: Trigger CI/CD workflow manually, verify quality gate runs
- After Step 3: Run `pre-commit run check-todo-severity` locally
- After Step 4: Check GitHub Actions summary for dashboard

**Completion Criteria**: ALL acceptance criteria checked, post-mortem created, PROJECT-STATUS.md updated

---

## Dependencies

**No dependencies** - This is Phase 1 foundation task

---

## References

- PASSTHRU5-MASTER-PLAN.md: Phase 1 quality infrastructure
- GAP-ANALYSIS.md: Root cause - no automated quality gate enforcement
- TEMPLATE-IMPROVEMENTS.md: Evidence-based validation requirements
