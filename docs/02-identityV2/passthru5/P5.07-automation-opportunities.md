# P5.07: Automation Opportunities Implementation

**Task ID**: P5.07
**Category**: Infrastructure
**Objective**: Implement high-priority automation tools identified in P5.06 post-mortem analysis to reduce manual documentation effort and improve development velocity.

---

## Success Criteria

**ALL of the following MUST be met:**

1. **Post-Mortem Generation Tool**: `cmd/cicd/go-generate-postmortem` created and functional
2. **PROJECT-STATUS.md Auto-Update Tool**: `cmd/cicd/go-update-project-status` created and functional
3. **CI/CD Integration Workflow**: `.github/workflows/ci-identity-validation.yml` created and functional

## Implementation Plan

### Phase 1: Post-Mortem Generation Tool (2.0 hours)

**Tool**: `cmd/cicd/go-generate-postmortem`

**Inputs**:

- Commit history: `git log --format="%H|%s|%b" <start>..<end>`
- Task documents: `docs/02-identityV2/passthru5/P5.XX-*.md`
- Evidence commits: Extracted from task documents (regex: `Commit: ([0-9a-f]{8})`)
- REQUIREMENTS-COVERAGE.md: Requirements metrics
- PROJECT-STATUS.md: Status transitions

**Outputs**:

- Post-mortem markdown file: `docs/02-identityV2/passthru5/P5.XX-P5.YY-POSTMORTEM.md`
- Sections generated:
  1. Executive Summary (tasks, requirements, production readiness)
  2. Task-by-Task Analysis (outcomes, durations, challenges, lessons)
  3. Pattern Validations (evidence-based, progressive, foundation-first, continuous work)
  4. Process Improvements (from commit messages, challenges sections)
  5. Gap Analysis (from task documents, challenges sections)
  6. Template Improvements (recommendations based on gaps)
  7. Automation Opportunities (prioritized list)
  8. Evidence Quality Assessment (completeness, traceability, actionability)

**Implementation Steps**:

1. Create package structure: `internal/cmd/cicd/go_generate_postmortem/`
2. Implement commit history parser (git log parsing)
3. Implement task document parser (markdown parsing, extract evidence sections)
4. Implement metrics extractor (requirements coverage, status transitions)
5. Implement section generators (8 sections, markdown formatting)
6. Implement main command (CLI flags: --start-task, --end-task, --output)
7. Add tests (parser tests, generator tests, end-to-end tests)
8. Update .golangci.yml with importas entry for package
9. Update cicd.go dispatcher with new command
10. Test with P5.01-P5.05 data (verify output matches P5.01-P5.05-POSTMORTEM.md)

**Expected Benefit**: 50% reduction in post-mortem creation time (15 min → 7.5 min)

**Exit Criteria**:

- Tool generates post-mortem matching P5.06 post-mortem structure
- All 8 sections present and populated with correct data
- Tests pass (≥85% coverage)
- Documentation updated (TOOLS.md entry)

### Phase 2: PROJECT-STATUS.md Auto-Update Tool (1.5 hours)

**Tool**: `cmd/cicd/go-update-project-status`

**Inputs**:

- REQUIREMENTS-COVERAGE.md: Coverage metrics (total, by priority, task-specific)
- Test results: `go test -json ./internal/identity/... | jq`
- Coverage reports: `go test -coverprofile=coverage.out ./internal/identity/...`
- Commit history: Recent activity (last 7 days)
- Task documents: Completion status

**Outputs**:

- Updated PROJECT-STATUS.md:
  - Requirements Coverage table (totals, priorities, uncovered)
  - Task-Specific Coverage list
  - Production Readiness indicator (❌/⚠️/✅)
  - Recent Activity section (last 7 days)
  - Next Steps (updated based on remaining tasks)

**Implementation Steps**:

1. Create package structure: `internal/cmd/cicd/go_update_project_status/`
2. Implement REQUIREMENTS-COVERAGE.md parser (regex: `Total: X/Y \(Z%\)`, `### Task PX.XX Coverage`)
3. Implement test results parser (go test -json output)
4. Implement coverage parser (go test -coverprofile output)
5. Implement commit history parser (git log --since="7 days ago")
6. Implement PROJECT-STATUS.md updater (replace sections: Requirements, Task-Specific, Production, Recent Activity)
7. Implement production readiness logic (requirements ≥85% → READY, <85% → CONDITIONAL)
8. Add tests (parser tests, updater tests, production readiness tests)
9. Update .golangci.yml with importas entry
10. Update cicd.go dispatcher with new command
11. Test with current PROJECT-STATUS.md (verify updates match manual updates from P5.05)

**Expected Benefit**: Eliminates manual PROJECT-STATUS.md updates (5 min → 0 min)

**Exit Criteria**:

- Tool updates PROJECT-STATUS.md correctly (requirements, production, recent activity)
- Production readiness logic correct (≥85% → READY, <85% → CONDITIONAL)
- Tests pass (≥85% coverage)
- Documentation updated (TOOLS.md entry)

### Phase 3: CI/CD Integration Workflow (1.5 hours)

**Workflow**: `.github/workflows/ci-identity-validation.yml`

**Triggers**:

- `pull_request`: `paths: ['internal/identity/**', 'docs/02-identityV2/**']`
- `push`: `branches: [main]`, `paths: ['internal/identity/**']`

**Jobs**:

1. **validate-requirements**:
   - Run: `go run ./cmd/cicd go-identity-requirements-check --strict`
   - Fail if: Coverage <85% or task coverage <90%
   - Upload: Validation report artifact

2. **validate-tests**:
   - Run: `go test ./internal/identity/... -cover -json > test-results.json`
   - Fail if: Any test fails or coverage <85%
   - Upload: Test results artifact, coverage report artifact

3. **validate-todos**:
   - Run: `go run ./cmd/cicd go-check-todos --severity=CRITICAL,HIGH`
   - Fail if: CRITICAL or HIGH TODOs found
   - Upload: TODO scan artifact

4. **update-project-status** (only on push to main):
   - Run: `go run ./cmd/cicd go-update-project-status`
   - Commit: Updated PROJECT-STATUS.md if changes detected
   - Push: Commit back to main

**Implementation Steps**:

1. Create workflow file: `.github/workflows/ci-identity-validation.yml`
2. Configure triggers (pull_request, push, paths filters)
3. Add validate-requirements job (requirements check, artifact upload)
4. Add validate-tests job (test execution, coverage, artifact upload)
5. Add validate-todos job (TODO scan, artifact upload)
6. Add update-project-status job (conditional: push to main, commit changes)
7. Add job dependencies (validate-* jobs parallel, update-project-status after all)
8. Test workflow with act (local testing): `go run ./cmd/workflow -workflows=identity-validation`
9. Test workflow on PR (create test PR with identity changes)
10. Verify artifact uploads (test results, coverage, validation reports)

**Expected Benefit**: Automatic validation on every PR, reduces manual QA by ~50%

**Exit Criteria**:

- Workflow triggers correctly on PR and push
- All validation jobs pass for current codebase
- PROJECT-STATUS.md auto-updated on push to main
- Artifacts uploaded correctly
- Documentation updated (WORKFLOWS.md entry)

### Phase 4: Markdown Auto-Fix Pre-commit Hook (0.5 hours)

**Hook**: markdownlint-cli2 with --fix flag

**Configuration**:

- File: `.markdownlint-cli2.yaml`
- Rules enabled: MD032, MD022, MD040, MD031 (from P5.06 post-mortem)
- Exclusions: `node_modules/`, `vendor/`, `.git/`, `test-output/`

**Implementation Steps**:

1. Create .markdownlint-cli2.yaml configuration file
2. Enable rules: MD032 (blanks around lists), MD022 (blanks around headings), MD040 (fenced code language), MD031 (blanks around fences)
3. Add exclusions (node_modules, vendor, .git, test-output)
4. Update .pre-commit-config.yaml with markdownlint-cli2 hook
5. Configure hook with --fix flag (auto-fix on commit)
6. Test hook on P5.06 task document (verify auto-fixes MD032/MD022/MD031/MD040)
7. Update DEV-SETUP.md with markdownlint-cli2 installation instructions
8. Update pre-commit-hooks.md with markdownlint-cli2 documentation

**Expected Benefit**: 50% reduction in markdown linting iterations (2-3 min → 1 min)

**Exit Criteria**:

- Hook auto-fixes MD032/MD022/MD040/MD031 on commit
- Pre-commit passes without manual markdown fixes
- Documentation updated (DEV-SETUP.md, pre-commit-hooks.md)

### Phase 5: Documentation Updates (0.5 hours)

**Files to Update**:

1. **TOOLS.md**:
   - Add section: "Post-Mortem Generation" (go-generate-postmortem)
   - Add section: "PROJECT-STATUS.md Auto-Update" (go-update-project-status)
   - Update existing sections with new automation

2. **DEV-SETUP.md**:
   - Add markdownlint-cli2 installation instructions
   - Update pre-commit hook setup section
   - Add CI/CD validation workflow documentation

3. **WORKFLOWS.md**:
   - Add section: "Identity Validation Workflow" (ci-identity-validation.yml)
   - Document triggers, jobs, artifacts

4. **README.md**:
   - Update "Development Automation" section
   - Add references to new tools

**Implementation Steps**:

1. Update TOOLS.md with 2 new tool sections
2. Update DEV-SETUP.md with markdownlint-cli2 setup
3. Update WORKFLOWS.md with ci-identity-validation.yml
4. Update README.md with automation references
5. Test documentation links (internal references)
6. Commit documentation updates

**Exit Criteria**:

- All 4 files updated with new automation
- Internal links working
- Documentation tested (commands verified)

### Phase 6: Testing and Evidence (1.0 hours)

**Testing Steps**:

1. **Test go-generate-postmortem**:
   - Generate post-mortem for P5.01-P5.05
   - Verify output matches existing P5.01-P5.05-POSTMORTEM.md
   - Verify all 8 sections present and populated

2. **Test go-update-project-status**:
   - Run tool on current PROJECT-STATUS.md
   - Verify requirements metrics updated correctly
   - Verify production readiness logic correct

3. **Test ci-identity-validation.yml**:
   - Run workflow with act (local testing)
   - Create test PR with identity changes
   - Verify all jobs pass
   - Verify artifacts uploaded

4. **Test markdownlint-cli2 hook**:
   - Create test markdown file with MD032/MD022 violations
   - Commit file (trigger pre-commit hook)
   - Verify auto-fixes applied

**Evidence Collection**:

1. Capture tool outputs (screenshots/logs)
2. Capture workflow run results (GitHub Actions logs)
3. Capture pre-commit hook outputs
4. Update Evidence Checklist in P5.07 task document
5. Add Evidence Commits section with all commits

**Exit Criteria**:

- All tools tested and functional
- All tests pass (≥85% coverage)
- Evidence documented in P5.07 task document

---

## Exact Commands

### Phase 1: Test Post-Mortem Generation Tool

```bash
# Generate post-mortem for P5.01-P5.05
go run ./cmd/cicd go-generate-postmortem --start-task P5.01 --end-task P5.05 --output docs/02-identityV2/passthru5/TEST-P5.01-P5.05-POSTMORTEM.md

# Verify output matches existing post-mortem (manual comparison)
```

### Phase 2: Test PROJECT-STATUS.md Auto-Update Tool

```bash
# Update PROJECT-STATUS.md
go run ./cmd/cicd go-update-project-status

# Verify changes (git diff)
git diff docs/02-identityV2/PROJECT-STATUS.md
```

### Phase 3: Test CI/CD Validation Workflow

```bash
# Test workflow locally with act
go run ./cmd/workflow -workflows=identity-validation

# Create test PR (GitHub web UI)
# Verify workflow runs and passes
```

### Phase 4: Test Markdown Auto-Fix Hook

```bash
# Create test markdown file with violations
# (Create file manually with MD032/MD022 violations)

# Commit file (trigger pre-commit hook)
git add test-markdown.md
git commit -m "test: verify markdown auto-fix hook"

# Verify auto-fixes applied (git diff --cached)
```

---

## Estimated Duration

**Total**: 7.0 hours

- Phase 1: Post-mortem generation tool (2.0 hours)
- Phase 2: PROJECT-STATUS.md auto-update tool (1.5 hours)
- Phase 3: CI/CD integration workflow (1.5 hours)
- Phase 4: Markdown auto-fix hook (0.5 hours)
- Phase 5: Documentation updates (0.5 hours)
- Phase 6: Testing and evidence (1.0 hours)

**Includes**: Implementation, testing, documentation, evidence collection

---

## Dependencies

**Must complete first**:

- P5.06 (Post-Mortem Analysis) ✅

**Blocked by**:

- None

**Blocks**:

- P5.08 (Evidence Collection Automation) - depends on P5.07 automation foundation
- P5.09 (CI/CD Integration Enhancements) - extends P5.07 CI/CD workflow
- P5.10 (Final Validation) - uses P5.07 automation tools

---

## Evidence Checklist

**Before marking complete, verify:**

- [ ] go-generate-postmortem tool created and functional
- [ ] go-update-project-status tool created and functional
- [ ] ci-identity-validation.yml workflow created and functional
- [ ] markdownlint-cli2 pre-commit hook configured
- [ ] All tools tested with P5.01-P5.06 data
- [ ] Tool outputs verified correct (post-mortem, PROJECT-STATUS.md)
- [ ] Workflow runs successfully (local act + GitHub PR)
- [ ] Pre-commit hook auto-fixes markdown violations
- [ ] Documentation updated (TOOLS.md, DEV-SETUP.md, WORKFLOWS.md, README.md)
- [ ] All evidence commits documented in task document
- [ ] Conventional commit format followed

---

## Notes

### High-Priority Automation from P5.06 Post-Mortem

**From Gap Analysis**:

- Gap 4: Post-mortem automation (MEDIUM priority) → go-generate-postmortem
- Gap 6: CI/CD validation (MEDIUM priority) → ci-identity-validation.yml

**From Process Improvements**:

- Improvement 2: Markdown linting proactive fixes → markdownlint-cli2 hook
- Improvement 5: Automation tool integration → go-update-project-status

**From Automation Opportunities**:

1. **High Priority** (P5.07):
   - Automated post-mortem generation from commit history
   - PROJECT-STATUS.md auto-update on requirements validation
   - CI/CD integration for validation tools
   - Pre-commit markdown auto-fix hook

### Expected Impact

**Time Savings per Task** (estimated):

- Post-mortem generation: 50% reduction (15 min → 7.5 min)
- PROJECT-STATUS.md updates: 100% reduction (5 min → 0 min)
- Markdown linting: 50% reduction (2-3 min → 1 min)
- CI/CD validation: Automatic (0 manual time)

**Total Time Savings per Task**: ~10 minutes (15 + 5 + 2 - 7.5 - 0 - 1 = 13.5 min saved)

**Over P5.08-P5.10** (3 tasks): ~30 minutes saved

### Tool Design Principles

**All tools MUST follow these patterns**:

1. **CLI Interface**: Use flag package for command-line arguments
2. **Structured Logging**: Use slog package for logging
3. **Error Handling**: Return wrapped errors with context (fmt.Errorf with %w)
4. **Testing**: ≥85% coverage (infrastructure code standard)
5. **Documentation**: godoc comments for all exported types/functions
6. **Self-Exclusion**: Exclude own directory from file operations (prevents self-modification)
7. **Cross-Platform**: Work on Windows, Linux, macOS without shell dependencies

---

**Created**: 2025-01-26
**Updated**: 2025-01-26
**Author**: GitHub Copilot (Agent)
**Review Status**: Awaiting Implementation
