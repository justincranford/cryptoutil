# cryptoutil Implementation Tasks

**Generated**: 2025-12-24 (Updated)
**Source**: specs/002-cryptoutil/plan.md
**Status**: Phases 2-9 tasks (Phase 1 complete)

---

## Task Format

Each task includes:

- **ID**: Unique identifier (P#.#.#)
- **Title**: Brief description (3-7 words)
- **Phase**: Implementation phase (2-9)
- **Effort**: S (1-2 days), M (3-5 days), L (1-2 weeks), XL (3-4 weeks)
- **Dependencies**: Blocking tasks (must complete first)
- **Completion Criteria**: Evidence-based validation
- **Files/Packages**: Where work will be done

---

## Phase 2: Service Template Extraction (CURRENT PHASE)

**CRITICAL**: Phase 2 is BLOCKING all service migrations (Phases 3-6). Must complete before any migrations.

### P2.1: Template Extraction

#### P2.1.1: ServerTemplate Abstraction

- **Title**: Extract service template from KMS
- **Effort**: L (14-21 days)
- **Dependencies**: None (Phase 1 complete)
- **Files**:
  - `internal/template/server/dual_https.go` (create)
  - `internal/template/server/router.go` (create)
  - `internal/template/server/middleware.go` (create)
  - `internal/template/server/lifecycle.go` (create)
  - `internal/template/client/http_client.go` (create)
  - `internal/template/client/auth.go` (create)
  - `internal/template/repository/dual_db.go` (create)
  - `internal/template/repository/gorm_patterns.go` (create)
  - `internal/template/repository/transaction.go` (create)
  - `docs/template/README.md` (create)
  - `docs/template/USAGE.md` (create)
  - `docs/template/MIGRATION.md` (create)
- **Completion Criteria**:
  - ✅ Template extracted from KMS reference implementation
  - ✅ All common patterns abstracted (dual HTTPS, database, telemetry, config)
  - ✅ Constructor injection for configuration, handlers, middleware
  - ✅ Interface-based customization for business logic
  - ✅ Service-specific OpenAPI specs support
  - ✅ Documentation complete with examples
  - ✅ Tests pass: `go test ./internal/template/...`
  - ✅ Coverage ≥98%: `go test -cover ./internal/template/...`
  - ✅ Mutation score ≥98%: `gremlins unleash ./internal/template/...`
  - ✅ Ready for cipher-im validation (Phase 3)
  - ✅ Commit: `feat(template): extract service template from KMS reference implementation`

---

## Phase 3: Cipher-IM Demonstration Service

**CRITICAL**: Phase 3 is the FIRST real-world template validation. All production service migrations (Phases 4-6) depend on successful cipher-im implementation.

### P3.1: Cipher-IM Implementation

#### P3.1.1: Cipher-IM Service Implementation

- **Title**: Implement cipher-im encrypted messaging service
- **Effort**: L (21-28 days)
- **Dependencies**: P2.1.1 (template extracted)
- **Files**:
  - `internal/cipher/domain/*.go` (create - users, messages)
  - `internal/cipher/server/application.go` (create)
  - `internal/cipher/server/handlers.go` (create)
  - `internal/cipher/repository/*.go` (create)
  - `cmd/cryptoutil/cipher.go` (create)
  - `cmd/cipher-im/main.go` (create)
  - `deployments/compose/cipher-im/compose.yml` (create)
  - `api/cipher/openapi_spec_components.yaml` (create)
  - `api/cipher/openapi_spec_paths.yaml` (create)
  - `docs/cipher-im/README.md` (create)
  - `docs/cipher-im/TUTORIAL.md` (create)
- **Completion Criteria**:
  - ✅ Service name: cipher-im
  - ✅ Ports: 8888-8889 (public), 9090 (admin)
  - ✅ Encrypted messaging APIs: PUT/GET/DELETE /tx and /rx
  - ✅ Encryption: AES-256-GCM + ECDH-AESGCMKW
  - ✅ Database schema (users, messages, message_receivers)
  - ✅ cipher-im uses ONLY template infrastructure (NO custom dual-server code)
  - ✅ All business logic cleanly separated from template
  - ✅ Template supports different API patterns (PUT/GET/DELETE vs CRUD)
  - ✅ No template blockers discovered during implementation
  - ✅ Tests pass: `go test ./internal/cipher/... ./cmd/cipher-im/...`
  - ✅ Coverage ≥95%: `go test -cover ./internal/cipher/...`
  - ✅ Mutation score ≥85%: `gremlins unleash ./internal/cipher/...`
  - ✅ E2E tests pass (BOTH `/service/**` and `/browser/**` paths)
  - ✅ Docker Compose deployment works
  - ✅ Deep analysis confirms template ready for production service migrations
  - ✅ Commit: `feat(cipher-im): implement encrypted messaging demonstration service with template`

---

## Phase 4: Migrate jose-ja to Template

**CRITICAL**: First production service migration. Will drive template refinements for JOSE patterns.

### P4.1: JA Service Migration

#### P4.1.1: JA Admin Server with Template

- **Title**: Migrate jose-ja admin server to template
- **Effort**: M (5-7 days)
- **Dependencies**: P3.1.1 (template validated)
- **Files**:
  - `internal/jose/server/admin/` (create using template)
  - `cmd/cryptoutil/jose.go` (create)
  - `deployments/compose/jose/compose.yml` (update)
- **Completion Criteria**:
  - ✅ JA admin server uses template (bind 127.0.0.1:9090)
  - ✅ Admin endpoints via template: `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
  - ✅ `cryptoutil jose start` command works
  - ✅ Configuration: YAML + CLI flags + Docker secrets
  - ✅ Docker health checks pass
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Template refined if needed (ADRs documented)
  - ✅ Commit: `feat(jose): migrate JA admin server to service template`

---

## Phase 5: Migrate pki-ca to Template

**CRITICAL**: Second production service migration. Will drive template refinements for CA/PKI patterns.

### P5.1: CA Service Migration

#### P5.1.1: CA Admin Server with Template

- **Title**: Migrate pki-ca admin server to template
- **Effort**: M (5-7 days)
- **Dependencies**: P4.1.1 (JOSE migrated)
- **Files**:
  - `internal/ca/server/admin/` (create using template)
  - `cmd/cryptoutil/ca.go` (create)
  - `deployments/compose/ca/compose.yml` (update)
- **Completion Criteria**:
  - ✅ CA admin server uses template (bind 127.0.0.1:9090)
  - ✅ Admin endpoints via template: `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
  - ✅ Readyz: CA chain validation, OCSP responder check
  - ✅ `cryptoutil ca start` command works
  - ✅ Configuration: YAML + CLI flags + Docker secrets
  - ✅ Docker health checks pass
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Template refined if needed (ADRs documented)
  - ✅ Template now battle-tested with 3 different service patterns (cipher-im, JOSE, CA)
  - ✅ Commit: `feat(ca): migrate CA admin server to service template`

---

## Phase 6: Identity Services Enhancement

**CRITICAL**: Identity services migrate LAST to benefit from mature, battle-tested template refined by cipher-im, JOSE, and CA migrations.

### P6.1: Admin Server Implementation

#### P6.1.1: RP Admin Server with Template

- **Title**: Implement RP admin server with template
- **Effort**: M (3-5 days)
- **Dependencies**: P5.1.1 (CA migrated, template mature)
- **Files**:
  - `internal/identity/rp/server/admin/` (create using template)
  - `cmd/cryptoutil/identity-rp.go` (create)
- **Completion Criteria**:
  - ✅ RP admin server uses template (bind 127.0.0.1:9090)
  - ✅ Admin endpoints: livez, readyz (OAuth 2.1 provider check), shutdown
  - ✅ `cryptoutil identity-rp start` command works
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Commit: `feat(identity-rp): implement admin server with template`

#### P6.1.2: SPA Admin Server with Template

- **Title**: Implement SPA admin server with template
- **Effort**: M (3-5 days)
- **Dependencies**: P6.1.1
- **Files**:
  - `internal/identity/spa/server/admin/` (create using template)
  - `cmd/cryptoutil/identity-spa.go` (create)
- **Completion Criteria**:
  - ✅ SPA admin server uses template (bind 127.0.0.1:9090)
  - ✅ Admin endpoints: livez, readyz (backend API check), shutdown
  - ✅ `cryptoutil identity-spa start` command works
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Commit: `feat(identity-spa): implement admin server with template`

#### P6.1.3: Migrate Existing Identity Services to Template

- **Title**: Migrate authz, idp, rs to template
- **Effort**: M (4-6 days)
- **Dependencies**: P6.1.2
- **Files**:
  - `internal/identity/authz/server/` (refactor)
  - `internal/identity/idp/server/` (refactor)
  - `internal/identity/rs/server/` (refactor)
  - `cmd/cryptoutil/identity-authz.go` (create)
  - `cmd/cryptoutil/identity-idp.go` (create)
  - `cmd/cryptoutil/identity-rs.go` (create)
- **Completion Criteria**:
  - ✅ All 3 services refactored to use template infrastructure
  - ✅ Duplicate dual-server code removed
  - ✅ Template database, telemetry, config patterns used
  - ✅ All admin servers bind to 127.0.0.1:9090
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Commit: `refactor(identity): migrate authz, idp, rs to service template`

### P6.2: E2E Path Coverage

#### P6.2.1: Browser Path E2E Tests

- **Title**: Implement /browser/** E2E tests
- **Effort**: M (5-7 days)
- **Dependencies**: P6.1.3
- **Files**:
  - `internal/identity/*/e2e_browser_test.go` (create)
  - `test/e2e/identity/browser_*.go` (create)
- **Completion Criteria**:
  - ✅ BOTH `/service/**` and `/browser/**` paths tested
  - ✅ CSRF protection validation
  - ✅ CORS policy enforcement
  - ✅ CSP header verification
  - ✅ Session cookie handling
  - ✅ Middleware behavior verified for each path
  - ✅ Coverage ≥95%
  - ✅ Commit: `test(identity): add /browser/** E2E test coverage`

---

## Phase 7: Advanced Identity Features

### P7.1: Multi-Factor Authentication

#### P7.1.1: TOTP Implementation

- **Title**: Implement TOTP (Time-Based OTP)
- **Effort**: M (7-10 days)
- **Dependencies**: P6.2.1
- **Files**:
  - `internal/identity/mfa/totp.go` (create)
  - `internal/identity/mfa/backup_codes.go` (create)
  - `api/identity/openapi_spec_paths.yaml` (update - TOTP endpoints)
- **Completion Criteria**:
  - ✅ TOTP enrollment (QR code)
  - ✅ 6-digit code verification
  - ✅ Backup codes generation
  - ✅ Recovery flow
  - ✅ 30-minute MFA step-up enforced
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Commit: `feat(identity-mfa): implement TOTP multi-factor authentication`

### P7.2: WebAuthn

#### P7.2.1: WebAuthn Support

- **Title**: Implement WebAuthn registration and authentication
- **Effort**: L (14-21 days)
- **Dependencies**: P7.1.1
- **Files**:
  - `internal/identity/webauthn/registration.go` (create)
  - `internal/identity/webauthn/authentication.go` (create)
  - `internal/identity/webauthn/credentials.go` (create)
  - `api/identity/openapi_spec_paths.yaml` (update - WebAuthn endpoints)
- **Completion Criteria**:
  - ✅ WebAuthn registration ceremony
  - ✅ WebAuthn authentication ceremony
  - ✅ Credential management
  - ✅ Browser compatibility (Chrome, Firefox, Edge, Safari)
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Commit: `feat(identity-webauthn): implement WebAuthn registration and authentication`

---

## Phase 8: Scale & Multi-Tenancy

### P8.1: Database Sharding

#### P8.1.1: Tenant ID Partitioning

- **Title**: Implement database sharding with tenant ID
- **Effort**: L (14-21 days)
- **Dependencies**: P7.2.1
- **Files**:
  - `internal/shared/database/sharding.go` (create)
  - `internal/shared/database/tenant.go` (create)
  - `internal/shared/database/routing.go` (create)
- **Completion Criteria**:
  - ✅ Tenant ID-based sharding
  - ✅ Shard routing logic
  - ✅ Cross-shard queries (if needed)
  - ✅ Per-row tenant_id (PostgreSQL + SQLite)
  - ✅ Schema-level isolation (PostgreSQL only)
  - ✅ Tenant provisioning APIs
  - ✅ Sharding reduces query latency
  - ✅ Multi-tenancy isolation verified
  - ✅ Tests pass, coverage ≥95%, mutation ≥85%
  - ✅ Commit: `feat(database): implement tenant ID-based sharding and multi-tenancy isolation`

---

## Phase 9: Production Readiness

### P9.1: Security Hardening

#### P9.1.1: SAST/DAST Security Audit

- **Title**: Perform comprehensive security audit
- **Effort**: M (7-10 days)
- **Dependencies**: P8.1.1
- **Files**:
  - `docs/security/AUDIT-REPORT.md` (create)
  - `docs/security/PENTEST-REPORT.md` (create)
- **Completion Criteria**:
  - ✅ Nuclei scans (info, low, medium, high, critical)
  - ✅ OWASP ZAP active scans
  - ✅ Dependency vulnerability scans
  - ✅ Penetration testing (authn/authz bypass, injection, etc.)
  - ✅ Zero HIGH/CRITICAL vulnerabilities
  - ✅ All MEDIUM vulnerabilities mitigated or risk-accepted
  - ✅ Reports documented
  - ✅ Commit: `docs(security): add SAST/DAST audit and penetration test reports`

### P9.2: Production Monitoring

#### P9.2.1: Observability Enhancement

- **Title**: Deploy Grafana dashboards and alerting
- **Effort**: M (5-7 days)
- **Dependencies**: P9.1.1
- **Files**:
  - `deployments/telemetry/dashboards/*.json` (create)
  - `deployments/telemetry/alerts/*.yml` (create)
  - `docs/runbooks/*.md` (create)
- **Completion Criteria**:
  - ✅ Grafana dashboards (health, requests, errors, database metrics)
  - ✅ Alerts (SLA violations, error spikes, health check failures)
  - ✅ Runbooks documented
  - ✅ Commit: `feat(monitoring): add Grafana dashboards and alerting for production`

---

## Task Summary

### Phase 2: Service Template Extraction (1 task, 14-21 days)

- P2.1.1: Extract service template from KMS (L)

### Phase 3: Cipher-IM Demonstration (1 task, 21-28 days)

- P3.1.1: Implement cipher-im service (L)

### Phase 4: Migrate jose-ja (1 task, 5-7 days)

- P4.1.1: Migrate JA admin server to template (M)

### Phase 5: Migrate pki-ca (1 task, 5-7 days)

- P5.1.1: Migrate CA admin server to template (M)

### Phase 6: Identity Enhancement (4 tasks, 15-23 days)

- P6.1.1: RP admin server (M)
- P6.1.2: SPA admin server (M)
- P6.1.3: Migrate authz/idp/rs to template (M)
- P6.2.1: Browser path E2E tests (M)

### Phase 7: Advanced Features (2 tasks, 21-31 days)

- P7.1.1: TOTP implementation (M)
- P7.2.1: WebAuthn support (L)

### Phase 8: Scale & Multi-Tenancy (1 task, 14-21 days)

- P8.1.1: Database sharding (L)

### Phase 9: Production Readiness (2 tasks, 12-17 days)

- P9.1.1: Security audit (M)
- P9.2.1: Observability enhancement (M)

**Total**: 13 tasks, ~108-155 days (sequential)

**Critical Path**: Phases 2-6 (~60-85 days)

---

## Notes

- All admin ports: 127.0.0.1:9090 (NEVER exposed to host, or :0 for tests)
- Database choice: PostgreSQL (multi-service deployments), SQLite (standalone deployments) - NOT environment-based
- Multi-tenancy: Dual-layer (per-row tenant_id + schema-level for PostgreSQL only)
- CRLDP: Immediate sign+publish to HTTPS URL with base64-url-encoded serial, one serial per URL
- Service names: jose-ja (JA/JWK Authority), cipher-im (Cipher-InstantMessenger)
- Template validation: cipher-im (Phase 3) MUST succeed before production migrations (Phases 4-6)
