name: Test Suite

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'dast-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'dast-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:
    inputs:
      test_profile:
        description: 'Test profile to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - concurrency
          - fuzz
          - race

env:
  GO_VERSION: '1.25.1'

jobs:
  # Concurrency & Race Detection Testing - Comprehensive concurrent safety validation
  # Note: Tests automatically use SQLite in-memory databases for isolation and speed
  concurrency:
    name: Concurrency & Race Detection Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Set up Go
        uses: actions/setup-go@v6.0.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Clean and verify module files
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Run concurrency and race detection tests
        run: |
          echo "ðŸ”„ Running comprehensive concurrency and race detection tests..."
          go test -race -timeout=15m -count=2 -p=2 ./...

      - name: Run coverage on concurrency tests
        run: |
          echo "ðŸ“Š Generating coverage report for concurrency tests..."
          go test -count=1 -coverprofile=concurrency-coverage.out -covermode=atomic ./...

      - name: Generate concurrency coverage report
        run: go tool cover -html=concurrency-coverage.out -o concurrency-coverage.html

      - name: Upload concurrency coverage
        uses: codecov/codecov-action@v5.5.1
        with:
          files: ./concurrency-coverage.out
          flags: concurrency-tests
          name: codecov-concurrency
          fail_ci_if_error: false

      - name: Concurrency test summary
        run: |
          echo "## ðŸ”„ Concurrency & Race Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "Comprehensive concurrency and race detection tests completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: All packages" >> $GITHUB_STEP_SUMMARY
          echo "- Race detector: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- Concurrent execution: 2 runs, 2 parallel" >> $GITHUB_STEP_SUMMARY
          echo "- Timeout: 15 minutes" >> $GITHUB_STEP_SUMMARY
