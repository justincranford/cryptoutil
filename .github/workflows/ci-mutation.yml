# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# WORKFLOW: CI - Mutation Testing
# PURPOSE: Validate test quality via mutation testing (gremlins) to ensure tests catch bugs
# DEPENDENCIES: None (runs independently without external services)
# EXPECTED DURATION: 4-5 minutes (sequential gremlins execution)
# TIMEOUT: 60 minutes (targets <20min with future matrix parallelization)
# CRITICAL PATH: gremlins mutation testing on all packages sequentially
# OPTIMIZATION OPPORTUNITY: Add matrix strategy to parallelize by package (reduce to <20min total)

name: CI - Mutation Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow
# MUST use relative paths to support both GitHub Actions Ubuntu runners
# and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/cryptoutil-suite/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION
    # Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION
    # Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

env:
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5432
  POSTGRES_NAME: cryptoutil_test
  POSTGRES_USER: cryptoutil
  POSTGRES_PASS: cryptoutil_test_password

jobs:
  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: ${{ env.POSTGRES_NAME }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASS }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: Install gremlins
        run: |
          echo "ðŸ”„ Installing gremlins mutation testing tool..."
          go install github.com/go-gremlins/gremlins/cmd/gremlins@latest

      - name: Run mutation tests
        working-directory: .
        timeout-minutes: 45
        run: |
          echo "ðŸ”„ Running mutation tests..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          gremlins unleash \
            --tags=!integration,!bench,!fuzz,!e2e,!pbt,!properties
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Mutation tests completed in: ${DURATION}s"

      - name: Upload mutation test results
        if: always()
        uses: actions/upload-artifact@v5.0.0
        with:
          name: mutation-test-results
          path: |
            .gremlins/**
            mutation-report.json
          retention-days: 7
          if-no-files-found: warn

      - name: Mutation testing summary
        run: |
          echo "## ðŸ”„ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "Mutation tests completed." >> $GITHUB_STEP_SUMMARY
          echo "- Tool: gremlins" >> $GITHUB_STEP_SUMMARY
          echo "- Excluded tags: integration, bench, fuzz, e2e, pbt, \
            properties" >> $GITHUB_STEP_SUMMARY
          echo "- Target score: â‰¥80%" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: \${DURATION}s" >> $GITHUB_STEP_SUMMARY
