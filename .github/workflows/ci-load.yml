# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# WORKFLOW: Load Testing
# PURPOSE: Performance validation using Gatling load testing framework (Java 21 + Maven 3.9)
# DEPENDENCIES: Docker Compose stack (cryptoutil services + PostgreSQL), Java 21, Maven 3.9
# EXPECTED DURATION: 10-20min (Docker Compose startup + Gatling simulation execution)
# TIMEOUT: 45min (allows Docker builds + stack startup + Gatling load simulation + report generation)
# CRITICAL PATH: Docker Compose stack startup (60-150s) + Gatling simulation (5-15min depending on load profile)

name: CI - Load Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/compose/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:
    inputs:
      load_profile:
        description: 'Load test profile'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - standard
          - stress
      virtual_clients:
        description: 'Number of virtual clients (overrides profile defaults)'
        required: false
        default: '0'
        type: string
      duration_seconds:
        description: 'Test duration in seconds (overrides profile defaults)'
        required: false
        default: '0'
        type: string

env:
  LOAD_PROFILE: ${{ github.event.inputs.load_profile || 'standard' }}
  VIRTUAL_CLIENTS_OVERRIDE: ${{ github.event.inputs.virtual_clients || '0' }}
  DURATION_OVERRIDE: ${{ github.event.inputs.duration_seconds || '0' }}

jobs:
  load-testing:
    name: Load Testing with Gatling
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
      uses: actions/checkout@v6.0.0
      with:
        sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

    - name: Begin Workflow Job
      id: begin-workflow-job
      uses: ./.github/actions/workflow-job-begin

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
        go-mod-download: true
        go-mod-verify: true
        go-mod-tidy: true

    - name: Set up Java
      # https://github.com/actions/setup-java/releases (v5.0.0, 2025-04-21)
      uses: actions/setup-java@v5.0.0
      with:
        distribution: 'temurin'
        java-version: ${{ steps.begin-workflow-job.outputs.java-version }}
        cache: 'maven'

    - name: Pre-pull Docker images (parallel)
      uses: ./.github/actions/docker-images-pull
      with:
        images: |
          postgres:18
          alpine:3.19
            golang:1.25.5
          otel/opentelemetry-collector-contrib:latest
          grafana/otel-lgtm:latest

    - name: Build Docker images
      uses: ./.github/actions/docker-compose-build

    - name: Start Docker Compose services
      uses: ./.github/actions/docker-compose-up
      with:
        profiles: 'postgres'

    - name: Verify services are ready
      uses: ./.github/actions/docker-compose-verify
      with:
        endpoints: '[{"url": "https://127.0.0.1:8080/ui/swagger/doc.json", "name": "cryptoutil-sqlite"}, {"url": "https://127.0.0.1:8081/ui/swagger/doc.json", "name": "cryptoutil-postgres-1"}, {"url": "https://127.0.0.1:8082/ui/swagger/doc.json", "name": "cryptoutil-postgres-2"}]'

    - name: Set load test parameters
      id: load-params
      run: |
        echo "âš™ï¸ Setting load test parameters..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        case "${{ env.LOAD_PROFILE }}" in
          quick)
            CLIENTS=10
            DURATION=30
            ;;
          standard)
            CLIENTS=50
            DURATION=120
            ;;
          stress)
            CLIENTS=200
            DURATION=300
            ;;
          *)
            CLIENTS=10
            DURATION=30
            ;;
        esac

        # Override with manual inputs if provided
        if [ "${{ env.VIRTUAL_CLIENTS_OVERRIDE }}" != "0" ]; then
          CLIENTS="${{ env.VIRTUAL_CLIENTS_OVERRIDE }}"
        fi
        if [ "${{ env.DURATION_OVERRIDE }}" != "0" ]; then
          DURATION="${{ env.DURATION_OVERRIDE }}"
        fi

        echo "virtual_clients=$CLIENTS" >> $GITHUB_OUTPUT
        echo "duration=$DURATION" >> $GITHUB_OUTPUT

        echo "ðŸ“Š Load test configuration:"
        echo "  Profile: ${{ env.LOAD_PROFILE }}"
        echo "  Virtual Clients: $CLIENTS"
        echo "  Duration: ${DURATION}s"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Load test parameter configuration completed in: ${DURATION}s"

    - name: Start infrastructure monitoring
      run: |
        echo "ðŸ“Š Starting infrastructure monitoring..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

        # Create monitoring directory
        mkdir -p ./load-reports/infrastructure

        # Start background monitoring process
        {
          while true; do
            # Use filesystem-safe timestamp format (no colons for GitHub Actions artifact compatibility)
            TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")

            # Collect Docker stats
            docker stats --no-stream --format "table {{.Container}},{{.CPUPerc}},{{.MemUsage}},{{.MemPerc}},{{.NetIO}},{{.BlockIO}}" > "./load-reports/infrastructure/docker-stats-$TIMESTAMP.csv"

            # Collect system metrics (use ISO 8601 timestamp in CSV content, not filename)
            {
              echo "timestamp,metric,value"
              TIMESTAMP_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo "$TIMESTAMP_ISO,cpu_percent,$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')"
              echo "$TIMESTAMP_ISO,mem_used_mb,$(free -m | awk 'NR==2{print $3}')"
              echo "$TIMESTAMP_ISO,mem_total_mb,$(free -m | awk 'NR==2{print $2}')"
              echo "$TIMESTAMP_ISO,disk_used_percent,$(df -h / | awk 'NR==2{print $5}' | sed 's/%//')"
            } >> "./load-reports/infrastructure/system-metrics.csv"

            sleep 5
          done
        } &

        MONITOR_PID=$!
        echo "MONITOR_PID=$MONITOR_PID" >> $GITHUB_ENV
        echo "âœ… Infrastructure monitoring started (PID: $MONITOR_PID)"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Infrastructure monitoring startup completed in: ${DURATION}s"

    - name: Run Gatling load tests
      working-directory: ./test/load
      run: |
        echo "ðŸš€ Running Gatling load tests..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        # Set environment variable to help with debugging
        export LOAD_DEBUG=1

        # Configure JVM options for Gatling
        export MAVEN_OPTS="-Xmx2g -Xms1g"

        # Run all simulations with configured parameters
        if ./mvnw gatling:test \
          -Dgatling.runMultipleSimulations=true \
          -Dprofile=${{ env.LOAD_PROFILE }} \
          -Dport=8080 \
          -Dvirtualclients=${{ steps.load-params.outputs.virtual_clients }} \
          -DdurationSeconds=${{ steps.load-params.outputs.duration }} \
          -Dgatling.runDescription="CI Load Test - Profile: ${{ env.LOAD_PROFILE }}"; then
          echo "âœ… Gatling load tests completed successfully"
        else
          echo "âŒ Gatling load tests failed"
          exit 1
        fi
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Gatling load tests completed in: ${DURATION}s"

    - name: Stop infrastructure monitoring
      if: always()
      run: |
        echo "ðŸ›‘ Stopping infrastructure monitoring..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        if [ ! -z "$MONITOR_PID" ]; then
          echo "ðŸ›‘ Stopping infrastructure monitoring (PID: $MONITOR_PID)..."
          kill $MONITOR_PID 2>/dev/null || true
          wait $MONITOR_PID 2>/dev/null || true
          echo "âœ… Infrastructure monitoring stopped"
        fi
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Infrastructure monitoring shutdown completed in: ${DURATION}s"

    - name: Collect service logs
      if: always()
      run: |
        echo "ðŸ“‹ Collecting service logs..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        mkdir -p ./load-reports/service-logs

        # Collect logs from all cryptoutil services
        docker compose -f ./deployments/compose/compose.yml logs cryptoutil-sqlite > ./load-reports/service-logs/cryptoutil-sqlite.log 2>&1 || true
        docker compose -f ./deployments/compose/compose.yml logs cryptoutil-postgres-1 > ./load-reports/service-logs/cryptoutil-postgres-1.log 2>&1 || true
        docker compose -f ./deployments/compose/compose.yml logs cryptoutil-postgres-2 > ./load-reports/service-logs/cryptoutil-postgres-2.log 2>&1 || true
        docker compose -f ./deployments/compose/compose.yml logs postgres > ./load-reports/service-logs/postgres.log 2>&1 || true
        docker compose -f ./deployments/compose/compose.yml logs opentelemetry-collector-contrib > ./load-reports/service-logs/otel-collector.log 2>&1 || true

        echo "âœ… Service logs collected"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Service log collection completed in: ${DURATION}s"

    - name: Generate load test summary
      if: always()
      run: |
        echo "ðŸ“Š Generating load test summary..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

        cat > ./load-reports/load-test-summary.md << 'EOF'
        # Load Test Summary

        **Profile:** ${{ env.LOAD_PROFILE }}
        **Virtual Clients:** ${{ steps.load-params.outputs.virtual_clients }}
        **Duration:** ${{ steps.load-params.outputs.duration }}s
        **Triggered by:** ${{ github.event_name }}
        **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ## Test Configuration

        | Parameter | Value |
        |-----------|-------|
        | Load Profile | ${{ env.LOAD_PROFILE }} |
        | Virtual Clients | ${{ steps.load-params.outputs.virtual_clients }} |
        | Test Duration | ${{ steps.load-params.outputs.duration }}s |
        | Target Services | cryptoutil-sqlite, cryptoutil-postgres-1, cryptoutil-postgres-2 |

        ## Services Tested

        - **cryptoutil-sqlite** - https://127.0.0.1:8080/service/api/v1
        - **cryptoutil-postgres-1** - https://127.0.0.1:8081/service/api/v1
        - **cryptoutil-postgres-2** - https://127.0.0.1:8082/service/api/v1

        ## Artifacts Generated

        - Gatling HTML reports: `test/load/target/gatling/`
        - Infrastructure metrics: `load-reports/infrastructure/`
        - Service logs: `load-reports/service-logs/`

        ## Results

        See Gatling HTML reports in artifacts for detailed performance analysis.

        EOF

        echo "âœ… Load test summary generated"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Load test summary generation completed in: ${DURATION}s"

    - name: Stop services
      if: always()
      uses: ./.github/actions/docker-compose-down

    - name: Upload infrastructure metrics
      if: always()
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      with:
        name: infrastructure-metrics-${{ env.LOAD_PROFILE }}
        path: load-reports/infrastructure/
        retention-days: 1

    - name: Upload service logs
      if: always()
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      with:
        name: service-logs-${{ env.LOAD_PROFILE }}
        path: load-reports/service-logs/
        retention-days: 1

    - name: Upload load test summary
      if: always()
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      with:
        name: load-test-summary-${{ env.LOAD_PROFILE }}
        path: load-reports/load-test-summary.md
        retention-days: 1

    - name: Load test summary
      if: always()
      run: |
        echo "## ðŸš€ Load Testing Results" >> $GITHUB_STEP_SUMMARY
        cat ./load-reports/load-test-summary.md >> $GITHUB_STEP_SUMMARY

    - name: Load summary
      if: always()
      uses: ./.github/actions/workflow-job-end
