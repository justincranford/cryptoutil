# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# WORKFLOW: CI - Benchmark Testing
# PURPOSE: Track performance benchmarks for cryptographic operations (key generation, encryption, signing)
# DEPENDENCIES: None (runs independently without external services)
# EXPECTED DURATION: 10-20 seconds (fast benchmark execution)
# TIMEOUT: 15 minutes (allows for benchmark warmup and measurement)
# CRITICAL PATH: Cryptographic benchmark execution

name: CI - Benchmark Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/cryptoutil-suite/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

jobs:
  # Benchmark Testing - Performance validation and regression detection
  benchmark:
    name: Benchmark Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
      uses: actions/checkout@v6.0.0
      with:
        sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

    - name: Begin Workflow Job
      id: begin-workflow-job
      uses: ./.github/actions/workflow-job-begin

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
        go-mod-download: true
        go-mod-verify: true
        go-mod-tidy: true

    - name: Run benchmark tests
      working-directory: .
      run: |
        echo "ðŸ“Š Running benchmark tests for performance validation..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        mkdir -p workflow-reports/benchmark
        go test -bench=. -benchmem -run=^$ ./internal/common/crypto/... > workflow-reports/benchmark/benchmark-results.txt 2>&1 || true
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Benchmark tests completed in: ${DURATION}s"
        # Store as JSON for easier comparison
        echo '{"timestamp":"'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'","duration":'$DURATION'}' > workflow-reports/benchmark/benchmark-meta.json

    - name: Download previous benchmark data
      # https://github.com/actions/download-artifact/releases (v4.3.0, 2025-04-21)
      uses: actions/download-artifact@v6.0.0
      continue-on-error: true
      with:
        name: benchmark-baseline
        path: workflow-reports/benchmark/previous/

    - name: Compare benchmark results
      id: benchmark-compare
      run: |
        CURRENT_FILE="workflow-reports/benchmark/benchmark-results.txt"
        PREVIOUS_FILE="workflow-reports/benchmark/previous/benchmark-results.txt"

        echo "ðŸ“Š Comparing benchmark results..."

        if [ -f "$PREVIOUS_FILE" ]; then
          echo "ðŸ“ˆ Found previous benchmark baseline for comparison"
          echo "has_baseline=true" >> $GITHUB_OUTPUT

          # Extract key metrics from current run
          CURRENT_OPS=$(grep -E 'Benchmark.*\s+[0-9]+\s+[0-9]+' "$CURRENT_FILE" | head -5 || echo "")
          PREVIOUS_OPS=$(grep -E 'Benchmark.*\s+[0-9]+\s+[0-9]+' "$PREVIOUS_FILE" | head -5 || echo "")

          # Simple comparison output
          echo "### Current Benchmarks:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 "$CURRENT_FILE" >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "### Previous Benchmarks:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 "$PREVIOUS_FILE" >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Note: Full statistical regression detection would use benchstat
          echo "regression_detected=false" >> $GITHUB_OUTPUT
        else
          echo "ðŸ“Š No previous baseline found, establishing new baseline"
          echo "has_baseline=false" >> $GITHUB_OUTPUT
          echo "regression_detected=false" >> $GITHUB_OUTPUT
        fi

    - name: Display benchmark results
      run: |
        echo "## ðŸ“Š Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat workflow-reports/benchmark/benchmark-results.txt >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Upload benchmark results
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      with:
        name: benchmark-results
        path: |
          workflow-reports/benchmark/benchmark-results.txt
          workflow-reports/benchmark/benchmark-meta.json
        retention-days: 1

    - name: Upload benchmark baseline for next run
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      if: always()
      with:
        name: benchmark-baseline
        path: workflow-reports/benchmark/benchmark-results.txt
        retention-days: 7

    - name: Benchmark test summary
      run: |
        echo "## ðŸ“Š Benchmark Testing Results" >> $GITHUB_STEP_SUMMARY
        echo "Performance benchmark tests completed successfully." >> $GITHUB_STEP_SUMMARY
        echo "- Coverage: Key generation and cryptographic operations" >> $GITHUB_STEP_SUMMARY
        echo "- Output: Memory allocation statistics included" >> $GITHUB_STEP_SUMMARY
        echo "- Upload: Results artifact with 1-day retention" >> $GITHUB_STEP_SUMMARY
        echo "- Purpose: Performance validation and regression detection" >> $GITHUB_STEP_SUMMARY

    - name: Benchmark summary
      if: always()
      uses: ./.github/actions/workflow-job-end
