name: CI - Quality Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/compose/compose.yml'

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'

env:
  GO_VERSION: '1.25.3'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Code Quality and Formatting
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Start - CI - Quality Testing / code-quality (ci-quality.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-quality.yml"
          echo "Job: code-quality"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: Run golangci-lint
        uses: ./.github/actions/golangci-lint

      - name: Run custom cicd linting and validation
        uses: ./.github/actions/custom-cicd-lint

  # Build and Container Security
  build:
    name: Build & Container Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - name: Workflow Start - CI - Quality Testing / build (ci-quality.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-quality.yml"
          echo "Job: build"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: Build binary
        run: |
          echo "ðŸ”¨ Building application binary..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          # Build with static linking and minimal symbol stripping for CI/testing
          # -s: Strip symbol table for smaller binary size (keeps debug symbols for diagnostics)
          # -extldflags '-static': Force static linking for maximum portability
          # Performance and diagnostics prioritized over size; debug symbols retained for troubleshooting
          go build -v -ldflags="-s -extldflags '-static'" -o cryptoutil ./cmd/cryptoutil
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Binary build completed in: ${DURATION}s"

      - name: Test binary
        run: |
          echo "ðŸ§ª Testing binary execution..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          # Test that the binary was built successfully
          ls -la ./cryptoutil
          file ./cryptoutil
          # Test basic execution (expect it to show usage and exit with error since no valid command given)
          ./cryptoutil || echo "Binary executed successfully (expected error due to no command)"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Binary test completed in: ${DURATION}s"

      - name: Set up Docker Buildx
        run: |
          echo "ðŸ³ Setting up Docker Buildx..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          docker buildx create --use
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Docker Buildx setup completed in: ${DURATION}s"

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=sha-

      - name: Build Docker image
        run: |
          echo "ðŸ—ï¸ Building Docker image..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          docker buildx build \
            --load \
            --tag ${{ steps.meta.outputs.tags }} \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.version=${{ github.sha }}" \
            --build-arg APP_VERSION=${{ github.sha }} \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg BUILD_DATE=1970-01-01T00:00:00Z \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -f ./deployments/Dockerfile \
            .
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Docker image build completed in: ${DURATION}s"

      - name: Get first Docker tag for Trivy scan
        id: first-tag
        run: echo "tag=$(echo '${{ steps.meta.outputs.tags }}' | head -n1)" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner on image
        run: |
          echo "ðŸ” Running Trivy vulnerability scan..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $HOME/.cache/trivy:/root/.cache/trivy \
            aquasecurity/trivy:latest image \
            --format sarif \
            --output /tmp/trivy-results.sarif \
            ${{ steps.first-tag.outputs.tag }}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Trivy scan completed in: ${DURATION}s"

      - name: Copy Trivy results
        run: docker cp $(docker create --name trivy-temp aquasecurity/trivy:latest):/tmp/trivy-results.sarif ./trivy-image.sarif

      - name: Upload Trivy image scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image.sarif'
        if: always() && hashFiles('trivy-image.sarif') != ''

      # Docker Scout vulnerability scanning
      - name: Check Docker Scout authentication
        id: scout-auth
        run: |
          echo "ðŸ” Checking Docker Scout authentication..."
          if docker scout version >/dev/null 2>&1; then
            echo "authenticated=true" >> $GITHUB_OUTPUT
            echo "âœ… Docker Scout is authenticated and available"
          else
            echo "authenticated=false" >> $GITHUB_OUTPUT
            echo "âŒ Docker Scout authentication failed - skipping Docker Scout scans"
          fi
        continue-on-error: true

      - name: Enable Docker Scout
        uses: docker/scout-action@v1
        with:
          command: version
        if: steps.scout-auth.outputs.authenticated == 'true'

      - name: Docker Scout - Quick Overview
        uses: docker/scout-action@v1
        with:
          command: quickview
          image: ${{ steps.first-tag.outputs.tag }}
          only-severities: critical,high,medium
          write-comment: false
        if: steps.scout-auth.outputs.authenticated == 'true'

      - name: Docker Scout - CVE Analysis
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.first-tag.outputs.tag }}
          format: sarif
          output: docker-scout-cves.sarif
          only-severities: critical,high,medium
        continue-on-error: true
        if: steps.scout-auth.outputs.authenticated == 'true'

      - name: Upload Docker Scout CVE results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'docker-scout-cves.sarif'
        if: steps.scout-auth.outputs.authenticated == 'true' && hashFiles('docker-scout-cves.sarif') != ''

      - name: Docker Scout - Security Recommendations
        uses: docker/scout-action@v1
        with:
          command: recommendations
          image: ${{ steps.first-tag.outputs.tag }}
          only-severities: critical,high,medium
        continue-on-error: true
        if: steps.scout-auth.outputs.authenticated == 'true'

      - name: Push Docker image
        if: github.event_name != 'pull_request'
        run: |
          echo "ðŸ“¤ Pushing Docker image..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          docker buildx build \
            --push \
            --tag ${{ steps.meta.outputs.tags }} \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.version=${{ github.sha }}" \
            --build-arg APP_VERSION=${{ github.sha }} \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg BUILD_DATE=1970-01-01T00:00:00Z \
            -f ./deployments/Dockerfile \
            .
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Docker image push completed in: ${DURATION}s"

  # SBOM Generation
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Start - CI - Quality Testing / sbom (ci-quality.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-quality.yml"
          echo "Job: sbom"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: Generate SBOM with syft
        run: |
          echo "ðŸ“¦ Generating SBOM with syft..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          syft packages . --output spdx-json=sbom.spdx.json
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ SBOM generation completed in: ${DURATION}s"

      - name: Upload SBOM
        uses: actions/upload-artifact@v5.0.0
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 2

      - name: Upload SBOM to dependency graph
        uses: anchore/sbom-action@v0
        with:
          path: ./
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false
          dependency-snapshot: true

  # Mutation Testing - Quality Assessment
  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # Only on main branch
    steps:
      - name: Workflow Start - CI - Quality Testing / mutation-testing (ci-quality.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-quality.yml"
          echo "Job: mutation-testing"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: Install Gremlins
        run: |
          echo "ðŸ§¬ Installing Gremlins mutation testing tool..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          go install github.com/go-gremlins/gremlins/cmd/gremlins@latest
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Gremlins installation completed in: ${DURATION}s"

      - name: Run mutation testing on high-coverage packages
        run: |
          echo "ðŸ§ª Running mutation testing on packages with high test coverage..."
          OVERALL_START=$(date +%s)
          echo "ðŸ“… Mutation testing start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          # Test packages with excellent coverage
          HIGH_COVERAGE_PACKAGES=(
            "./internal/common/util/datetime/"
            "./internal/common/util/thread/"
            "./internal/common/util/sysinfo/"
          )

          TOTAL_KILLED=0
          TOTAL_LIVED=0
          TOTAL_NOT_COVERED=0
          MUTATION_REPORTS=""

          for package in "${HIGH_COVERAGE_PACKAGES[@]}"; do
            echo "ðŸŽ¯ Testing package: $package"
            START_TIME=$(date +%s)

            # Run mutation testing with reasonable settings
            OUTPUT=$(gremlins unleash "$package" \
              --workers 2 \
              --timeout-coefficient 3 \
              --threshold-efficacy 70.0 \
              --threshold-mcover 60.0 \
              --output "mutation-$(basename "$package").json" 2>&1) || true

            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "â±ï¸ Package $package completed in: ${DURATION}s"

            echo "$OUTPUT"
            MUTATION_REPORTS="$MUTATION_REPORTS mutation-$(basename "$package").json"

            # Extract metrics from output
            KILLED=$(echo "$OUTPUT" | grep -o "Killed: [0-9]*" | grep -o "[0-9]*" || echo "0")
            LIVED=$(echo "$OUTPUT" | grep -o "Lived: [0-9]*" | grep -o "[0-9]*" || echo "0")
            NOT_COVERED=$(echo "$OUTPUT" | grep -o "Not covered: [0-9]*" | grep -o "[0-9]*" || echo "0")

            TOTAL_KILLED=$((TOTAL_KILLED + KILLED))
            TOTAL_LIVED=$((TOTAL_LIVED + LIVED))
            TOTAL_NOT_COVERED=$((TOTAL_NOT_COVERED + NOT_COVERED))

            echo "Package results - Killed: $KILLED, Lived: $LIVED, Not covered: $NOT_COVERED"
            echo ""
          done

          OVERALL_END=$(date +%s)
          TOTAL_DURATION=$((OVERALL_END - OVERALL_START))

          # Calculate overall metrics
          TOTAL_TESTED=$((TOTAL_KILLED + TOTAL_LIVED))
          if [ $TOTAL_TESTED -gt 0 ]; then
            EFFICACY=$(( (TOTAL_KILLED * 100) / TOTAL_TESTED ))
          else
            EFFICACY=0
          fi

          echo "ðŸ“Š MUTATION TESTING SUMMARY"
          echo "========================="
          echo "Total Killed: $TOTAL_KILLED"
          echo "Total Lived: $TOTAL_LIVED"
          echo "Total Not Covered: $TOTAL_NOT_COVERED"
          echo "Test Efficacy: ${EFFICACY}%"
          echo "Total Duration: ${TOTAL_DURATION}s"

          # Set up summary for GitHub
          echo "## ðŸ§¬ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Killed | $TOTAL_KILLED |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§Ÿ Lived | $TOTAL_LIVED |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš« Not Covered | $TOTAL_NOT_COVERED |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ Test Efficacy | ${EFFICACY}% |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ Total Duration | ${TOTAL_DURATION}s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL_LIVED -gt 0 ]; then
            echo "âš ï¸ **Warning**: $TOTAL_LIVED mutations survived testing" >> $GITHUB_STEP_SUMMARY
            echo "This indicates potential gaps in test coverage or assertion quality." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Excellent**: All testable mutations were killed by the test suite!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload mutation testing reports
        uses: actions/upload-artifact@v5.0.0
        if: always()
        with:
          name: mutation-testing-reports
          path: mutation-*.json
          retention-days: 2
