# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

name: CI - SAST Security Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/compose/compose.yml'

# Covers: Go, JavaScript (embedded + shell scripts), Python
# Jobs: security (Staticcheck, Govulncheck, Trivy), codeql (multi-language analysis)

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

jobs:
  # Security Scanning
  # Multiple SAST tools run sequentially in one job for efficiency
  # Tools: Staticcheck (Go linter), Govulncheck (Go vuln scanner), Trivy (dependency scanner)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Workflow Begin Summary
        uses: ./.github/actions/workflow-job-begin

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: '1.25.3'
          go-mod-download: false  # SAST only needs Go tools, not module operations
          go-mod-verify: false    # SAST only needs Go tools, not module operations
          go-mod-tidy: false      # SAST only needs Go tools, not module operations

      # Security Static Analysis with Staticcheck
      - name: Install Staticcheck
        run: |
          echo "ðŸ”§ Installing Staticcheck security analysis tool..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          go install honnef.co/go/tools/cmd/staticcheck@latest
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Staticcheck installation completed in: ${DURATION}s"

      - name: Run Staticcheck Security Analysis
        run: |
          echo "ðŸ” Running Staticcheck security analysis..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          staticcheck -f sarif ./... > staticcheck.sarif 2>/dev/null || true

          if [ -f staticcheck.sarif ] && [ -s staticcheck.sarif ]; then
            echo "âœ… Staticcheck SARIF file created successfully"
            ls -la staticcheck.sarif
            # Validate SARIF format
            if jq -e '.version' staticcheck.sarif >/dev/null 2>&1; then
              echo "âœ… SARIF file format is valid"
            else
              echo "âš ï¸ SARIF file format may be invalid, but proceeding with upload"
            fi
          else
            echo "â„¹ï¸ Staticcheck produced no issues, generating minimal SARIF for GitHub Security tab"
            cat > staticcheck.sarif << 'EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Staticcheck",
                    "version": "2025.1.1",
                    "informationUri": "https://staticcheck.dev"
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          fi
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Staticcheck analysis completed in: ${DURATION}s"

      - name: Upload Staticcheck results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: staticcheck.sarif
        if: always() && hashFiles('staticcheck.sarif') != ''

      # Govulncheck - Official Go vulnerability scanner
      - name: Install Govulncheck
        run: |
          echo "ðŸ”§ Installing Govulncheck vulnerability scanner..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          go install golang.org/x/vuln/cmd/govulncheck@latest
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Govulncheck installation completed in: ${DURATION}s"

      - name: Run Go Vulnerability Check
        run: |
          echo "ðŸ” Running Go vulnerability check..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          govulncheck ./...
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Go vulnerability check completed in: ${DURATION}s"

      # Trivy - Vulnerability scanner for dependencies
      - name: Run Trivy vulnerability scanner in repo mode
        uses: ./.github/actions/security-scan-trivy
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-sarif-output: 'trivy-results.sarif'
          scan-name: 'Repository Security Scan'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

      - name: Workflow End Summary
        uses: ./.github/actions/workflow-job-end
        if: always()

  # CodeQL Analysis
  # Multi-language security analysis using CodeQL
  # Matrix covers: Go (primary), JavaScript (embedded JS + shell scripts), Python
  # Note: 'javascript' pack includes shell script analysis (bash/sh/zsh)
  # No separate 'bash' entry needed - bundled in javascript language pack
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['go', 'javascript', 'python']  # go: Go code, javascript: JS+shell scripts, python: Python scripts
    steps:
      - name: Workflow Begin Summary
        uses: ./.github/actions/workflow-job-begin

      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Initialize CodeQL
        run: |
          echo "ðŸ”§ Initializing CodeQL for language: ${{ matrix.language }}..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      - name: Execute CodeQL initialization
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Complete CodeQL initialization timing
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ CodeQL initialization completed in: ${DURATION}s"

      - name: Autobuild
        run: |
          echo "ðŸ”¨ Running CodeQL autobuild for ${{ matrix.language }}..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      - name: Execute CodeQL autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Complete CodeQL autobuild timing
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ CodeQL autobuild completed in: ${DURATION}s"

      - name: Perform CodeQL Analysis
        run: |
          echo "ðŸ” Performing CodeQL analysis for ${{ matrix.language }}..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      - name: Execute CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

      - name: Complete CodeQL analysis timing
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ CodeQL analysis completed in: ${DURATION}s"

      - name: Workflow End Summary
        uses: ./.github/actions/workflow-job-end
        if: always()
