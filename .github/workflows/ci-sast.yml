# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax
# WORKFLOW: CI - SAST Security Analysis
# PURPOSE: Static application security testing with gosec, upload SARIF to GitHub Security tab
# DEPENDENCIES: None (runs independently without external services)
# EXPECTED DURATION: 3-4 minutes (gosec analysis + SARIF upload)
# TIMEOUT: 15 minutes (generous for GitHub Actions shared CPU + SARIF processing)
# CRITICAL PATH: gosec security scanning
name: CI - SAST Security Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/cryptoutil-suite/compose.yml'

# Covers: Go, JavaScript (embedded + shell scripts), Java
# Jobs: security (Staticcheck, Govulncheck, Trivy), codeql (multi-language analysis)

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

jobs:
  # Java SAST Analysis
  # Dedicated Java security analysis for load testing code
  # Tools: SpotBugs (with FindSecBugs), OWASP Dependency Check, License Check, Versions Check
  java-sast:
    name: Java SAST Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Java
        # https://github.com/actions/setup-java/releases (v5.0.0, 2025-04-21)
        uses: actions/setup-java@v5.0.0
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        # https://github.com/actions/cache/releases (v4.3.0, 2025-04-18)
        uses: actions/cache@v4.3.0
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # SpotBugs Static Analysis with FindSecBugs
      - name: Run SpotBugs Security Analysis
        run: |
          echo "ðŸ” Running SpotBugs security analysis with FindSecBugs..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          cd test/load
          # Ensure mvnw is executable and run plugin locally
          chmod +x ./mvnw || true
          ./mvnw spotbugs:check -Dspotbugs.skip=false
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ SpotBugs analysis completed in: ${DURATION}s"

      # OWASP Dependency Check
      - name: Check effective maven plugin config for dependency-check (diagnostic)
        run: |
          echo "ðŸ” Checking effective pom for dependency-check plugin config (no secrets will be printed):"
          cd test/load
          chmod +x ./mvnw || true
          # Output the effective pom (plugin configuration should show ${env.NVD_API_KEY} if present in plugin config)
          ./mvnw org.apache.maven.plugins:maven-help-plugin:3.2.0:effective-pom -Doutput=effective-pom.xml || true
          grep -n "nvdApiKey" effective-pom.xml || echo "â„¹ï¸ nvdApiKey not configured in effective POM"

      - name: Cache dependency-check data
        # https://github.com/actions/cache/releases (v4.3.0, 2025-04-18)
        uses: actions/cache@v4.3.0
        with:
          path: test/load/target/dependency-check/data
          key: ${{ runner.os }}-dependency-check-data-${{ hashFiles('test/load/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-dependency-check-data-

      - name: Update NVD data (dependency-check update-only)
        # Inject NVD API key securely from repository secrets. If not defined, the step runs without the key.
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          echo "ðŸ”„ Updating NVD data for dependency-check (update-only)..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          cd test/load
          chmod +x ./mvnw || true
          EXTRA_ARGS=""
          if [ -n "${NVD_API_KEY}" ]; then
            EXTRA_ARGS="-DnvdApiKey=${NVD_API_KEY} -Dnvd.apiKey=${NVD_API_KEY}"
          fi
          # Pass explicit H2 connectionString so the plugin uses project-local DB and doesn't default to ~/.m2
          ./mvnw org.owasp:dependency-check-maven:update-only $EXTRA_ARGS -Ddependency-check.dataDirectory=${{ github.workspace }}/test/load/target/dependency-check/data -Ddependency-check.connectionString=jdbc:h2:file:${{ github.workspace }}/test/load/target/dependency-check/data/dependency-check-db;DB_CLOSE_ON_EXIT=FALSE
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ NVD update-only completed in: ${DURATION}s"

      - name: Show dependency-check data directory (debug)
        run: |
          echo "Dependency-check data dir contents:"
          ls -la test/load/target/dependency-check || true
          echo "Size summary (if du available):"
          if command -v du >/dev/null 2>&1; then du -sh test/load/target/dependency-check || true; fi

      - name: Verify H2 database exists before check
        run: |
          echo "ðŸ” Verifying H2 database was populated by update-only step..."
          DB_FILE="test/load/target/dependency-check/data/dependency-check-db.mv.db"
          if [ -f "$DB_FILE" ]; then
            DB_SIZE=$(du -h "$DB_FILE" | cut -f1)
            echo "âœ… Database file exists: $DB_SIZE"
          else
            echo "::error::âŒ Database file not found at $DB_FILE"
            echo "::error::The update-only step may have failed to populate the NVD database."
            echo "::error::Check the update-only step logs for errors."
            exit 1
          fi

      - name: Run OWASP Dependency Check
        # Inject NVD API key securely from repository secrets. If not defined, the step runs without the key.
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          echo "ðŸ” Running OWASP dependency vulnerability check..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          cd test/load
          chmod +x ./mvnw || true
          # Build extra args dynamically: pass -Dnvd.apiKey only if a key is available.
          EXTRA_ARGS=""
          if [ -n "${NVD_API_KEY}" ]; then
            echo "ðŸ” NVD API key detected; running with NVD API key (value is masked)."
            # Pass multiple possible property names to be compatible with different plugin versions.
            # cspell:ignore nvdApiKey nvd.apiKey
            EXTRA_ARGS="-DnvdApiKey=${NVD_API_KEY} -Dnvd.apiKey=${NVD_API_KEY}"
          else
            echo "â„¹ï¸ NVD API key not set; running without it (this may be slower)."
          fi
          # Always avoid failing entire CI job if the dependency-check plugin fails to parse the NVD feed.
          # This happens when NVD adds new enum values (e.g., 'SAFETY' for CVSSv4) and the client library is older.
          # Ensure we use a project-local data directory and do not auto-update during analysis.
          EXTRA_ARGS="$EXTRA_ARGS -Ddependency-check.failOnError=false -Ddependency-check.skipRebuild=false -Ddependency-check.dataDirectory=${{ github.workspace }}/test/load/target/dependency-check/data -Ddependency-check.autoUpdate=false -Ddependency-check.connectionString=jdbc:h2:file:${{ github.workspace }}/test/load/target/dependency-check/data/dependency-check-db;DB_CLOSE_ON_EXIT=FALSE"
          ./mvnw org.owasp:dependency-check-maven:check ${EXTRA_ARGS}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ OWASP dependency check completed in: ${DURATION}s"

      # Outdated Dependencies Check
      - name: Check for Outdated Dependencies
        run: |
          echo "ðŸ” Checking for outdated dependencies..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          cd test/load
          chmod +x ./mvnw || true
          ./mvnw versions:display-dependency-updates versions:display-plugin-updates
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Dependency version check completed in: ${DURATION}s"

      # Generate SARIF reports for GitHub Security tab
      - name: Generate SpotBugs SARIF Report
        run: |
          echo "ðŸ“‹ Generating SpotBugs SARIF report..."
          cd test/load
          if [ -f target/spotbugsXml.xml ]; then
            # Convert SpotBugs XML to SARIF if converter is available
            echo "âœ… SpotBugs XML report found"
            # Note: SARIF conversion would require additional tooling
            # For now, we'll rely on the Maven plugin output
          else
            echo "â„¹ï¸ No SpotBugs issues found or report not generated"
          fi

      - name: Upload OWASP Dependency Check results
        # https://github.com/github/codeql-action/releases (v3.28.19, 2025-11-06)
        uses: github/codeql-action/upload-sarif@v3.28.19
        with:
          sarif_file: test/load/target/dependency-check/dependency-check-report.sarif
        if: always() && hashFiles('test/load/target/dependency-check/dependency-check-report.sarif') != ''

      - name: Workflow End Summary
        uses: ./.github/actions/workflow-job-end
        if: always()

  # Security Scanning
  # Multiple SAST tools run sequentially in one job for efficiency
  # Tools: Staticcheck (Go linter), Govulncheck (Go vuln scanner), Trivy (dependency scanner)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
          go-mod-download: true   # govulncheck needs modules to load packages
          go-mod-verify: false    # SAST only needs Go tools, not module operations
          go-mod-tidy: false      # SAST only needs Go tools, not module operations

      # Security Static Analysis with Staticcheck
      - name: Install Staticcheck
        run: |
          echo "ðŸ”§ Installing Staticcheck security analysis tool..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          go install honnef.co/go/tools/cmd/staticcheck@latest
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Staticcheck installation completed in: ${DURATION}s"

      - name: Run Staticcheck Security Analysis
        run: |
          echo "ðŸ” Running Staticcheck security analysis..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          staticcheck -f sarif ./... > staticcheck.sarif 2>/dev/null || true

          if [ -f staticcheck.sarif ] && [ -s staticcheck.sarif ]; then
            echo "âœ… Staticcheck SARIF file created successfully"
            ls -la staticcheck.sarif
            # Validate SARIF format
            if jq -e '.version' staticcheck.sarif >/dev/null 2>&1; then
              echo "âœ… SARIF file format is valid"
            else
              echo "âš ï¸ SARIF file format may be invalid, but proceeding with upload"
            fi

            # Fix SARIF format: Add artifactLocation to all physicalLocation entries
            echo "ðŸ”§ Adding artifact locations to SARIF..."
            jq '.runs[].results[].locations[]? |= (
              if .physicalLocation.artifactLocation? == null then
                .physicalLocation.artifactLocation = {
                  "uri": (if .physicalLocation.region.uri? then .physicalLocation.region.uri else "unknown" end),
                  "uriBaseId": "%SRCROOT%"
                }
              else
                .
              end |
              if .physicalLocation.region.startLine? == 0 then
                .physicalLocation.region.startLine = 1
              else
                .
              end |
              if .physicalLocation.region.startColumn? == 0 then
                .physicalLocation.region.startColumn = 1
              else
                .
              end
            )' staticcheck.sarif > staticcheck-sanitized.sarif
            mv staticcheck-sanitized.sarif staticcheck.sarif
            echo "âœ… SARIF format fixed"
          else
            echo "â„¹ï¸ Staticcheck produced no issues, generating minimal SARIF for GitHub Security tab"
            cat > staticcheck.sarif << 'EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Staticcheck",
                    "version": "2025.1.1",
                    "informationUri": "https://staticcheck.dev"
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          fi
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Staticcheck analysis completed in: ${DURATION}s"

      - name: Upload Staticcheck results to GitHub Security tab
        # https://github.com/github/codeql-action/releases (v3.28.19, 2025-11-06)
        uses: github/codeql-action/upload-sarif@v3.28.19
        with:
          sarif_file: staticcheck.sarif
        if: always() && hashFiles('staticcheck.sarif') != ''

      # Govulncheck - Official Go vulnerability scanner
      - name: Install Govulncheck
        run: |
          echo "ðŸ”§ Installing Govulncheck vulnerability scanner..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          go install golang.org/x/vuln/cmd/govulncheck@latest
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Govulncheck installation completed in: ${DURATION}s"

      - name: Run Go Vulnerability Check
        run: |
          echo "ðŸ” Running Go vulnerability check..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          govulncheck ./...
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Go vulnerability check completed in: ${DURATION}s"

      # Trivy - Vulnerability scanner for dependencies
      - name: Run Trivy vulnerability scanner in repo mode
        uses: ./.github/actions/security-scan-trivy
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-sarif-output: 'trivy-results.sarif'
          scan-name: 'Repository Security Scan'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

      - name: Workflow End Summary
        uses: ./.github/actions/workflow-job-end
        if: always()

  # CodeQL Analysis
  # Multi-language security analysis using CodeQL
  # Matrix covers: Go (primary), JavaScript (embedded JS + shell scripts)
  # Note: 'javascript' pack includes shell script analysis (bash/sh/zsh)
  # No separate 'bash' entry needed - bundled in javascript language pack
  # Java analysis moved to dedicated java-sast job for comprehensive Maven-based analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['go', 'javascript']  # go: Go code, javascript: JS+shell scripts (Java moved to dedicated job)
    steps:
      - name: Checkout repository
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Initialize CodeQL
        run: |
          echo "ðŸ”§ Initializing CodeQL for language: ${{ matrix.language }}..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      - name: Execute CodeQL initialization
        # https://github.com/github/codeql-action/releases (v3.28.19, 2025-11-06)
        uses: github/codeql-action/init@v3.28.19
        with:
          languages: ${{ matrix.language }}

      - name: Complete CodeQL initialization timing
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ CodeQL initialization completed in: ${DURATION}s"

      - name: Autobuild
        run: |
          echo "ðŸ”¨ Running CodeQL autobuild for ${{ matrix.language }}..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      - name: Execute CodeQL autobuild
        # https://github.com/github/codeql-action/releases (v3.28.19, 2025-11-06)
        uses: github/codeql-action/autobuild@v3.28.19

      - name: Complete CodeQL autobuild timing
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ CodeQL autobuild completed in: ${DURATION}s"

      - name: Perform CodeQL Analysis
        run: |
          echo "ðŸ” Performing CodeQL analysis for ${{ matrix.language }}..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      - name: Execute CodeQL analysis
        # https://github.com/github/codeql-action/releases (v3.28.19, 2025-11-06)
        uses: github/codeql-action/analyze@v3.28.19
        with:
          category: "/language:${{matrix.language}}"

      - name: Complete CodeQL analysis timing
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ CodeQL analysis completed in: ${DURATION}s"

      - name: Workflow End Summary
        uses: ./.github/actions/workflow-job-end
        if: always()
