# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# WORKFLOW: CI - Fuzz Testing
# PURPOSE: Fuzz test parsers, validators, and input handlers for unexpected inputs
# DEPENDENCIES: None (runs independently without external services)
# EXPECTED DURATION: 3-4 minutes (15 seconds per fuzz test target)
# TIMEOUT: 15 minutes (allows for fuzz corpus generation and execution)
# CRITICAL PATH: Fuzz test execution across multiple targets

name: CI - Fuzz Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/cryptoutil-suite/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:
    inputs:
      test_profile:
        description: 'Test profile to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - fuzz-keygen
          - fuzz-digests
      gomaxprocs:
        description: 'GOMAXPROCS for fuzz tests'
        required: false
        default: '4'
        type: string
      rsa_fuzztime:
        description: 'RSA fuzz test duration (seconds)'
        required: false
        default: '30'
        type: string
      rsa_timeout:
        description: 'RSA fuzz test timeout (seconds)'
        required: false
        default: '120'
        type: string
      keygen_fuzztime:
        description: 'Keygen fuzz test duration for non-RSA tests (seconds)'
        required: false
        default: '15'
        type: string
      keygen_timeout:
        description: 'Keygen fuzz test timeout for non-RSA tests (seconds)'
        required: false
        default: '60'
        type: string
      digest_fuzztime:
        description: 'Digest fuzz test duration (seconds)'
        required: false
        default: '20'
        type: string
      digest_timeout:
        description: 'Digest fuzz test timeout (seconds)'
        required: false
        default: '120'
        type: string

jobs:
  # Fuzz Testing - Keygen Package - Property-based testing for cryptographic key generation
  fuzz-keygen:
    name: Fuzz Tests - Keygen
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_profile == 'all' || github.event_name != 'workflow_dispatch' }}

    env:
      RSA_FUZZTIME: ${{ github.event.inputs.rsa_fuzztime || '30' }}
      RSA_TIMEOUT: ${{ github.event.inputs.rsa_timeout || '120' }}
      KEYGEN_FUZZTIME: ${{ github.event.inputs.keygen_fuzztime || '15' }}
      KEYGEN_TIMEOUT: ${{ github.event.inputs.keygen_timeout || '60' }}
      GOMAXPROCS: ${{ github.event.inputs.gomaxprocs || '4' }}

    steps:
    - name: Checkout code
      # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
      uses: actions/checkout@v6.0.0
      with:
        sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

    - name: Begin Workflow Job
      id: begin-workflow-job
      uses: ./.github/actions/workflow-job-begin

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
        go-mod-download: true
        go-mod-verify: true
        go-mod-tidy: true

    - name: RSA Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateRSAKeyPair
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.RSA_FUZZTIME }}
        timeout_seconds: ${{ env.RSA_TIMEOUT }}

    - name: ECDSA Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateECDSAKeyPair
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.KEYGEN_FUZZTIME }}
        timeout_seconds: ${{ env.KEYGEN_TIMEOUT }}

    - name: ECDH Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateECDHKeyPair
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.KEYGEN_FUZZTIME }}
        timeout_seconds: ${{ env.KEYGEN_TIMEOUT }}

    - name: EdDSA Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateEDDSAKeyPair
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.KEYGEN_FUZZTIME }}
        timeout_seconds: ${{ env.KEYGEN_TIMEOUT }}

    - name: AES Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateAESKey
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.KEYGEN_FUZZTIME }}
        timeout_seconds: ${{ env.KEYGEN_TIMEOUT }}

    - name: AES-HS Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateAESHSKey
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.KEYGEN_FUZZTIME }}
        timeout_seconds: ${{ env.KEYGEN_TIMEOUT }}

    - name: HMAC Keygen Fuzz Test
      uses: ./.github/actions/fuzz-test
      with:
        fuzz_function_name: FuzzGenerateHMACKey
        package_path: ./internal/shared/crypto/keygen
        gomaxprocs: ${{ env.GOMAXPROCS }}
        fuzztime_seconds: ${{ env.KEYGEN_FUZZTIME }}
        timeout_seconds: ${{ env.KEYGEN_TIMEOUT }}

    - name: Keygen fuzz test summary
      run: |
          echo "## ðŸ” Keygen Fuzz Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "Fuzz tests for cryptographic key generation completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: 7 key generation functions" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: RSA=${{ env.RSA_FUZZTIME }}s, Others=${{ env.KEYGEN_FUZZTIME }}s each (parallel steps)" >> $GITHUB_STEP_SUMMARY
          echo "- Purpose: Property-based testing for secure key generation" >> $GITHUB_STEP_SUMMARY

    - name: Keygen fuzz summary
      if: always()
      uses: ./.github/actions/workflow-job-end

  # Fuzz Testing - Digests Package - Property-based testing for cryptographic hash functions
  fuzz-digests:
    name: Fuzz Tests - Digests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_profile == 'all' || github.event_name != 'workflow_dispatch' }}

    env:
      DIGEST_FUZZTIME: ${{ github.event.inputs.digest_fuzztime || '20' }}
      DIGEST_TIMEOUT: ${{ github.event.inputs.digest_timeout || '120' }}
      GOMAXPROCS: ${{ github.event.inputs.gomaxprocs || '4' }}

    steps:
      - name: Checkout code
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: HKDF All Variants Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzHKDFAllVariants
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: HKDF SHA256 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzHKDFwithSHA256
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: HKDF SHA384 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzHKDFwithSHA384
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: HKDF SHA512 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzHKDFwithSHA512
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: HKDF SHA224 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzHKDFwithSHA224
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: SHA512 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzSHA512
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: SHA384 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzSHA384
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: SHA256 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzSHA256
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: SHA224 Fuzz Test
        uses: ./.github/actions/fuzz-test
        with:
          fuzz_function_name: FuzzSHA224
          package_path: ./internal/shared/crypto/digests
          gomaxprocs: ${{ env.GOMAXPROCS }}
          fuzztime_seconds: ${{ env.DIGEST_FUZZTIME }}
          timeout_seconds: ${{ env.DIGEST_TIMEOUT }}

      - name: Digests fuzz test summary
        run: |
          echo "## ðŸ” Digests Fuzz Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "Fuzz tests for cryptographic digest functions completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: 9 digest functions (HKDF variants + SHA-2 family)" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${{ env.DIGEST_FUZZTIME }}s each (parallel steps)" >> $GITHUB_STEP_SUMMARY
          echo "- Purpose: Property-based testing for secure hash operations" >> $GITHUB_STEP_SUMMARY

      - name: Digests fuzz summary
        if: always()
        uses: ./.github/actions/workflow-job-end
