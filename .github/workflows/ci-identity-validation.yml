name: CI - Identity Validation

on:
  pull_request:
    paths:
      - 'internal/identity/**'
      - 'docs/02-identityV2/**'
      - '.github/workflows/ci-identity-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'internal/identity/**'
      - 'docs/02-identityV2/**'
      - '.github/workflows/ci-identity-validation.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.25.4'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-requirements:
    name: Validate Requirements Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run requirements validation
        run: go run ./cmd/cicd go-identity-requirements-check --strict

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: requirements-validation-report
          path: |
            docs/02-identityV2/REQUIREMENTS-COVERAGE.md
            .cicd/requirements-*.json
          retention-days: 30

  validate-tests:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests with coverage
        run: |
          mkdir -p test-output
          go test ./internal/identity/... -cover -coverprofile=test-output/identity-coverage.out -json > test-output/identity-test-results.json

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=test-output/identity-coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below 85% threshold"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: identity-test-results
          path: test-output/identity-test-results.json
          retention-days: 30

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: identity-coverage-report
          path: test-output/identity-coverage.out
          retention-days: 30

  validate-todos:
    name: Validate TODO Severity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check for CRITICAL/HIGH TODOs
        run: |
          if grep -r "TODO.*CRITICAL\|TODO.*HIGH" internal/identity/ docs/02-identityV2/; then
            echo "::error::Found CRITICAL or HIGH severity TODOs - must be resolved before merge"
            exit 1
          fi
          echo "No CRITICAL/HIGH TODOs found"

      - name: Scan all TODOs
        if: always()
        run: |
          mkdir -p test-output
          grep -rn "TODO\|FIXME" internal/identity/ docs/02-identityV2/ > test-output/todo-scan.txt || true

      - name: Upload TODO scan
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: todo-scan-results
          path: test-output/todo-scan.txt
          retention-days: 7
