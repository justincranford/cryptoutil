# WORKFLOW: Identity Service Validation
# PURPOSE: Validate Identity service implementation (authz, idp, rs, rp, spa) E2E integration
# DEPENDENCIES: None (no Docker Compose stack, direct Go test execution only)
# EXPECTED DURATION: 2-5min (Go test execution for Identity domain tests)
# TIMEOUT: 15min (allows test execution + shared CPU latency)
# CRITICAL PATH: Go test execution for all Identity packages

name: CI - Identity Validation

on:
  pull_request:
    paths:
      - 'internal/identity/**'
      - 'docs/02-identityV2/**'
      - '.github/workflows/ci-identity-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'internal/identity/**'
      - 'docs/02-identityV2/**'
      - '.github/workflows/ci-identity-validation.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.25.7'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-tests:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go
        # https://github.com/actions/setup-go/releases (v6.0.0, 2025-11-11)
        uses: actions/setup-go@v6.0.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests with coverage
        run: |
          mkdir -p test-output
          go test ./internal/identity/... -cover -coverprofile=test-output/identity-coverage.out -json > test-output/identity-test-results.json

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=test-output/identity-coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below 95% threshold"
            exit 1
          fi

      - name: Upload test results
        if: always()
        # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-11-11)
        uses: actions/upload-artifact@v5.0.0
        with:
          name: identity-test-results
          path: test-output/identity-test-results.json
          retention-days: 30

      - name: Upload coverage report
        if: always()
        # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-11-11)
        uses: actions/upload-artifact@v5.0.0
        with:
          name: identity-coverage-report
          path: test-output/identity-coverage.out
          retention-days: 30

  validate-todos:
    name: Validate TODO Severity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
        uses: actions/checkout@v6.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Begin Workflow Job
        id: begin-workflow-job
        uses: ./.github/actions/workflow-job-begin

      - name: Set up Go
        # https://github.com/actions/setup-go/releases (v6.0.0, 2025-11-11)
        uses: actions/setup-go@v6.0.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check for CRITICAL/HIGH TODOs
        run: |
          if grep -r "TODO.*CRITICAL\|TODO.*HIGH" internal/identity/ docs/02-identityV2/; then
            echo "::error::Found CRITICAL or HIGH severity TODOs - must be resolved before merge"
            exit 1
          fi
          echo "No CRITICAL/HIGH TODOs found"

      - name: Scan all TODOs
        if: always()
        run: |
          mkdir -p test-output
          grep -rn "TODO\|FIXME" internal/identity/ docs/02-identityV2/ > test-output/todo-scan.txt || true

      - name: Upload TODO scan
        if: always()
        # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-11-11)
        uses: actions/upload-artifact@v5.0.0
        with:
          name: todo-scan-results
          path: test-output/todo-scan.txt
          retention-days: 7
