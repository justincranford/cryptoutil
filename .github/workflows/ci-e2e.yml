# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

name: CI - End-to-End Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/compose/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

env:
  GO_VERSION: '1.25.3'

jobs:
  # End-to-End Testing - Full system validation with Docker Compose
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest

    steps:
      - name: Workflow begin summary
        uses: ./.github/actions/workflow-begin-summary
        with:
          job-name: 'e2e'

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}
          go-mod-download: true
          go-mod-verify: true
          go-mod-tidy: true

      - name: Pre-pull Docker images (parallel)
        uses: ./.github/actions/docker-images-pull
        with:
          images: |
            golang:1.25.3
            postgres:18
            alpine:latest
            otel/opentelemetry-collector-contrib:latest
            grafana/otel-lgtm:latest

      - name: Build Docker images
        uses: ./.github/actions/docker-compose-build

      - name: Run E2E tests
        run: |
          echo "üß™ Running end-to-end tests..."
          START_TIME=$(date +%s)
          echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          # Set environment variable to help with debugging
          export E2E_DEBUG=1

          # Run the tests and capture output
          if go test -tags=e2e -v -timeout=30m ./internal/test/e2e/ 2>&1; then
            echo "‚úÖ E2E tests completed successfully"
          else
            echo "‚ùå E2E tests failed"
            exit 1
          fi
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "‚è±Ô∏è E2E tests completed in: ${DURATION}s"

      - name: Collect service logs
        if: always()
        run: |
          echo "üìã Collecting service logs..."
          START_TIME=$(date +%s)
          echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          mkdir -p ./workflow-reports/e2e

          # Collect logs from all cryptoutil services
          docker compose -f ./deployments/compose/compose.yml logs cryptoutil-sqlite > ./workflow-reports/e2e/cryptoutil-sqlite.log 2>&1 || true
          docker compose -f ./deployments/compose/compose.yml logs cryptoutil-postgres-1 > ./workflow-reports/e2e/cryptoutil-postgres-1.log 2>&1 || true
          docker compose -f ./deployments/compose/compose.yml logs cryptoutil-postgres-2 > ./workflow-reports/e2e/cryptoutil-postgres-2.log 2>&1 || true
          docker compose -f ./deployments/compose/compose.yml logs postgres > ./workflow-reports/e2e/postgres.log 2>&1 || true
          docker compose -f ./deployments/compose/compose.yml logs opentelemetry-collector-contrib > ./workflow-reports/e2e/otel-collector.log 2>&1 || true

          echo "‚úÖ Service logs collected"
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "‚è±Ô∏è Service log collection completed in: ${DURATION}s"

      - name: Display container logs
        if: always()
        uses: ./.github/actions/docker-compose-logs
        with:
          log-directory: ./workflow-reports/e2e

      - name: Upload container logs
        if: always()
        uses: actions/upload-artifact@v5.0.0
        with:
          name: e2e-container-logs-${{ github.run_id }}
          path: ./workflow-reports/e2e/
          if-no-files-found: ignore
          retention-days: 1

      - name: E2E test summary
        if: always()
        uses: ./.github/actions/workflow-end-summary
        with:
          job-name: 'e2e'

      - name: Stop services
        if: always()
        uses: ./.github/actions/docker-compose-down
