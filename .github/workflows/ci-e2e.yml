name: CI - End-to-End Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/compose/compose.yml'

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'dast-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'dast-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

env:
  GO_VERSION: '1.25.3'

jobs:
  # End-to-End Testing - Full system validation with Docker Compose
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest

    steps:
      - name: Workflow Start - CI - End-to-End Testing (ci-e2e.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-e2e.yml"
          echo "Job: e2e"
          echo "Triggered by: ${{ github.event_name }}"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false

      - name: Set up Go
        uses: actions/setup-go@v6.0.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download dependencies
        run: go mod download

      - name: Pre-pull Docker images (parallel)
        run: |
          echo "ðŸ³ Pre-pulling Docker images in parallel..."

          # Array of all images used in this workflow (both runtime and build-time)
          IMAGES=(
            "postgres:18"
            "otel/opentelemetry-collector-contrib:latest"
            "grafana/otel-lgtm:latest"
            "alpine:latest"
            "golang:1.25.3"
            "alpine:3.19"
          )

          # Pull all images concurrently
          for image in "${IMAGES[@]}"; do
            echo "Pulling $image..."
            docker pull "$image" &
          done

          # Wait for all pulls to complete
          wait

          echo "âœ… All images pre-pulled successfully"

      - name: Verify dependencies
        run: go mod verify

      - name: Clean and verify module files
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Build Docker images
        run: |
          echo "ðŸ—ï¸ Building Docker images for end-to-end testing..."
          docker compose -f ./deployments/compose/compose.yml build

      - name: Run E2E tests
        run: |
          echo "ðŸ§ª Running end-to-end tests..."
          go test -tags=e2e -v -timeout=30m ./internal/test/e2e/

      - name: Display container logs
        if: always()
        run: |
          echo "ðŸ“‹ Displaying captured container logs..."
          LOG_DIR="./workflow-reports/e2e"
          if [ -d "$LOG_DIR" ]; then
            echo "Found log directory: $LOG_DIR"
            # List all zip files
            if ls ${LOG_DIR}/*.zip 1> /dev/null 2>&1; then
              echo "Container log archives found:"
              ls -la ${LOG_DIR}/*.zip

              # Extract and display logs from the most recent zip file
              LATEST_ZIP=$(ls -t ${LOG_DIR}/*.zip | head -1)
              echo "ðŸ“¦ Extracting and displaying logs from: $LATEST_ZIP"
              echo "=========================================="

              # Create temp directory for extraction
              TEMP_DIR=$(mktemp -d)
              unzip -q "$LATEST_ZIP" -d "$TEMP_DIR"

              # Display logs for each service
              for log_file in "$TEMP_DIR"/*.log; do
                if [ -f "$log_file" ]; then
                  SERVICE_NAME=$(basename "$log_file" .log)
                  echo "ðŸ” Logs for service: $SERVICE_NAME"
                  echo "----------------------------------------"
                  cat "$log_file"
                  echo ""
                  echo "=========================================="
                fi
              done

              # Clean up temp directory
              rm -rf "$TEMP_DIR"
            else
              echo "No container log archives found in $LOG_DIR"
            fi
          else
            echo "Log directory $LOG_DIR does not exist"
          fi

      - name: Upload container logs
        if: always()
        uses: actions/upload-artifact@v5.0.0
        with:
          name: e2e-container-logs-${{ github.run_id }}
          path: ./workflow-reports/e2e/
          if-no-files-found: ignore
          retention-days: 30

      - name: E2E test summary
        if: always()
        run: |
          echo "## ðŸ§ª End-to-End Testing Results" >> $GITHUB_STEP_SUMMARY
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… End-to-end tests completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ End-to-end tests failed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stop services
        if: always()
        run: |
          echo "ðŸ§¹ Stopping services..."
          docker compose -f ./deployments/compose/compose.yml down -v
