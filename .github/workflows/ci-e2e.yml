# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# WORKFLOW: End-to-End Testing
# PURPOSE: E2E integration tests with full Docker Compose stack (cryptoutil services + dependencies)
# DEPENDENCIES: Docker Compose stack (cryptoutil-sqlite/postgres, PostgreSQL, OTEL collector)
# EXPECTED DURATION: 5-10min (Docker Compose startup + Go E2E test execution)
# TIMEOUT: 30min (allows Docker image builds + stack startup + E2E tests + shared CPU latency)
# CRITICAL PATH: Docker Compose stack startup (60-150s latency hiding strategies) + Go test execution

name: CI - End-to-End Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/sm-kms/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

jobs:
  # End-to-End Testing - Full system validation with Docker Compose
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
      uses: actions/checkout@v6.0.0
      with:
        sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

    - name: Begin Workflow Job
      id: begin-workflow-job
      uses: ./.github/actions/workflow-job-begin

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
        go-mod-download: true
        go-mod-verify: true
        go-mod-tidy: true

    - name: Pre-pull Docker images (parallel)
      uses: ./.github/actions/docker-images-pull
      with:
        images: |
          golang:1.25.5
          postgres:18
          alpine:latest
          otel/opentelemetry-collector-contrib:latest
          grafana/otel-lgtm:latest

    - name: Build Docker images
      uses: ./.github/actions/docker-compose-build

    - name: Deploy CA services
      run: |
        echo "üöÄ Deploying CA services..."
        START_TIME=$(date +%s)
        echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        docker compose -f ./deployments/pki-ca/compose.yml --profile dev up -d
        echo "‚è±Ô∏è Waiting for CA services to be healthy..."
        sleep 45
        echo "‚úÖ CA services deployed"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "‚è±Ô∏è CA deployment completed in: ${DURATION}s"

    - name: Deploy JOSE services
      run: |
        echo "üöÄ Deploying JOSE services..."
        START_TIME=$(date +%s)
        echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        docker compose -f ./deployments/jose/compose.yml --profile dev up -d
        echo "‚è±Ô∏è Waiting for JOSE services to be healthy..."
        sleep 35
        echo "‚úÖ JOSE services deployed"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "‚è±Ô∏è JOSE deployment completed in: ${DURATION}s"

    - name: Verify CA services
      run: |
        echo "üîç Verifying CA services..."
        curl -k https://localhost:9090/admin/api/v1/livez || echo "CA SQLite not ready"
        docker compose -f ./deployments/pki-ca/compose.yml ps

    - name: Verify JOSE services
      run: |
        echo "üîç Verifying JOSE services..."
        curl -k https://localhost:9090/admin/api/v1/livez || echo "JOSE server not ready"
        docker compose -f ./deployments/jose/compose.yml ps

    - name: Run E2E tests
      run: |
        echo "üß™ Running end-to-end tests..."
        START_TIME=$(date +%s)
        echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

        # Stop CA and JOSE services to free ports for E2E tests
        echo "üõë Stopping CA and JOSE services to free ports..."
        docker compose -f ./deployments/pki-ca/compose.yml down -v || true
        docker compose -f ./deployments/jose/compose.yml down -v || true
        sleep 5

        # Set environment variable to help with debugging
        export E2E_DEBUG=1

        # Run the tests and capture output
        # Test cipher-im E2E
        if go test -tags=e2e -v -timeout=30m ./internal/apps/cipher/im/e2e/... 2>&1; then
          echo "‚úÖ cipher-im E2E tests completed successfully"
        else
          echo "‚ùå cipher-im E2E tests failed"
          exit 1
        fi

        # Test identity E2E
        if go test -tags=e2e -v -timeout=30m ./internal/apps/identity/e2e/... 2>&1; then
          echo "‚úÖ identity E2E tests completed successfully"
        else
          echo "‚ùå identity E2E tests failed"
          exit 1
        fi

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "‚è±Ô∏è E2E tests completed in: ${DURATION}s"

    - name: Collect service logs
      if: always()
      run: |
        echo "üìã Collecting service logs..."
        START_TIME=$(date +%s)
        echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        mkdir -p ./workflow-reports/e2e

        # Collect logs from all cryptoutil services
          docker compose -f ./deployments/sm-kms/compose.yml logs sm-kms-app-sqlite-1 > ./workflow-reports/e2e/sm-kms-sqlite.log 2>&1 || true
          docker compose -f ./deployments/sm-kms/compose.yml logs sm-kms-app-postgres-1 > ./workflow-reports/e2e/sm-kms-postgres-1.log 2>&1 || true
          docker compose -f ./deployments/sm-kms/compose.yml logs sm-kms-app-postgres-2 > ./workflow-reports/e2e/sm-kms-postgres-2.log 2>&1 || true
          docker compose -f ./deployments/sm-kms/compose.yml logs sm-kms-db-postgres-1 > ./workflow-reports/e2e/sm-kms-db-postgres.log 2>&1 || true
          docker compose -f ./deployments/sm-kms/compose.yml logs opentelemetry-collector-contrib > ./workflow-reports/e2e/otel-collector.log 2>&1 || true

        # Collect CA service logs
          docker compose -f ./deployments/pki-ca/compose.yml logs pki-ca-app-sqlite-1 > ./workflow-reports/e2e/pki-ca-sqlite.log 2>&1 || true
        # Collect JOSE service logs
          docker compose -f ./deployments/jose/compose.yml logs jose-ja-app-sqlite-1 > ./workflow-reports/e2e/jose-ja.log 2>&1 || true
        echo "‚úÖ Service logs collected"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "‚è±Ô∏è Service log collection completed in: ${DURATION}s"

    - name: Display container logs
      if: always()
      uses: ./.github/actions/docker-compose-logs
      with:
        log-directory: ./workflow-reports/e2e

    - name: Upload container logs
      if: always()
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      with:
        name: e2e-container-logs-${{ github.run_id }}
        path: ./workflow-reports/e2e/
        if-no-files-found: ignore
        retention-days: 1

    - name: E2E test summary
      if: always()
      uses: ./.github/actions/workflow-job-end

    - name: Stop services
      if: always()
      run: |
        echo "üõë Stopping all services..."
          docker compose -f ./deployments/sm-kms/compose.yml down -v --remove-orphans || true
          docker compose -f ./deployments/pki-ca/compose.yml down -v --remove-orphans || true
          docker compose -f ./deployments/jose/compose.yml down -v --remove-orphans || true
          echo "‚úÖ All services stopped"
