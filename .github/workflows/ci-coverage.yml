# $schema: https://json.schemastore.org/github-workflow.json
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax

# WORKFLOW: CI - Coverage Collection
# PURPOSE: Measure test coverage across all packages, enforce 95%+ production / 98%+ infrastructure targets
# DEPENDENCIES: None (runs independently without external services)
# EXPECTED DURATION: 5-6 minutes (matrix parallel execution across 4-6 package groups)
# TIMEOUT: 20 minutes (allows for parallel test execution with retry overhead)
# CRITICAL PATH: Test execution for largest packages (kms, identity, jose)
# OPTIMIZATION: Uses matrix strategy for package-level parallelization

name: CI - Coverage Collection
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/cryptoutil-suite/compose.yml'

on:
  push:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with pull_request below
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    # SHARED PATHS-IGNORE CONFIGURATION - Keep synchronized with push above
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:

env:
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5432
  POSTGRES_NAME: cryptoutil_test
  POSTGRES_USER: cryptoutil
  POSTGRES_PASS: cryptoutil_test_password

jobs:
  coverage:
    name: Coverage Collection
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: ${{ env.POSTGRES_NAME }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASS }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
    - name: Checkout code
      # https://github.com/actions/checkout/releases (v6.0.0, 2025-11-11)
      uses: actions/checkout@v6.0.0
      with:
        sparse-checkout-cone-mode: false  # Disabled for cross-platform compatibility between GitHub Actions and act local runner

    - name: Begin Workflow Job
      id: begin-workflow-job
      uses: ./.github/actions/workflow-job-begin

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ steps.begin-workflow-job.outputs.go-version }}
        go-mod-download: true
        go-mod-verify: true
        go-mod-tidy: true

    - name: Run coverage on tests
      working-directory: .
      run: |
        echo "üìä Generating coverage report for tests..."
        START_TIME=$(date +%s)
        echo "üìÖ Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        mkdir -p workflow-reports/coverage
        # Exclude cmd/* packages (main packages without coverage requirements)
        # Exclude e2e/* packages (require Docker Compose, run in ci-e2e workflow)
        go test -count=1 -p=2 -coverprofile=workflow-reports/coverage/coverage.out -covermode=atomic \
          $(go list ./internal/... | grep -v '/cmd$' | grep -v '/cmd/' | grep -v '/e2e$' | grep -v '/e2e/') \
          2>&1 | tee workflow-reports/coverage/coverage-per-pkg.txt
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "üìÖ End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "‚è±Ô∏è Coverage tests completed in: ${DURATION}s"

    - name: Generate coverage report
      run: go tool cover -html=workflow-reports/coverage/coverage.out -o workflow-reports/coverage/coverage.html

    - name: Generate function-level coverage report
      run: go tool cover -func=workflow-reports/coverage/coverage.out > workflow-reports/coverage/coverage-func.txt

    - name: Enforce per-package coverage threshold
      continue-on-error: true  # Informational until all packages reach targets
      run: |
        echo "## üîç Per-Package Coverage Enforcement" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        FAILED=0
        # internal/apps/cicd infrastructure packages require >=98%
        # All other production packages require >=95%
        while IFS= read -r line; do
          PKG=$(echo "$line" | grep -oP '(?<=ok\s{1,10})[\w./\-]+' || true)
          PCT=$(echo "$line" | grep -oP '[\d.]+(?=% of statements)' || true)
          if [ -z "$PKG" ] || [ -z "$PCT" ]; then continue; fi
          # Determine threshold: 98% for cicd infra, 95% for all others
          THRESHOLD=95.0
          if echo "$PKG" | grep -q '/apps/cicd'; then THRESHOLD=98.0; fi
          STATUS="‚úÖ PASS"
          if awk "BEGIN {exit !($PCT < $THRESHOLD)}"; then
            STATUS="‚ùå FAIL"
            FAILED=1
          fi
          echo "| \`$PKG\` | ${PCT}% | $STATUS (min ${THRESHOLD}%) |" >> $GITHUB_STEP_SUMMARY
        done < workflow-reports/coverage/coverage-per-pkg.txt
        if [ "$FAILED" -eq 1 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ùå One or more packages are below the required coverage threshold." >> $GITHUB_STEP_SUMMARY
          echo "‚ùå Per-package coverage gate failed ‚Äî see table above for details"
          exit 1
        else
          echo "‚úÖ All packages meet per-package coverage thresholds"
        fi

    - name: Scan coverage artifacts for vulnerabilities
      uses: ./.github/actions/security-scan-trivy2
      with:
        scan-name: 'coverage'
        scan-type: 'fs'
        scan-ref: 'workflow-reports/coverage'
        trivy-sarif-output: 'coverage-upload-artifacts-trivy.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'

    - name: Display function-level coverage
      run: |
        echo "## üìä Function-Level Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat workflow-reports/coverage/coverage-func.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Calculate coverage trend
      id: coverage-trend
      run: |
        # Extract current coverage percentage from coverage-func.txt
        CURRENT_COVERAGE=$(grep -oP 'total:\s+\(statements\)\s+\K[\d.]+' workflow-reports/coverage/coverage-func.txt || echo "0.0")
        echo "current_coverage=$CURRENT_COVERAGE" >> $GITHUB_OUTPUT
        echo "üìã Current coverage: ${CURRENT_COVERAGE}%"

        # Coverage threshold enforcement (95% required, matching architecture.md quality gates)
        MINIMUM_COVERAGE=95.0
        if (( $(echo "$CURRENT_COVERAGE < $MINIMUM_COVERAGE" | bc -l) )); then
          echo "‚ùå Coverage ${CURRENT_COVERAGE}% is below minimum threshold ${MINIMUM_COVERAGE}%"
          echo "coverage_passed=false" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ Coverage ${CURRENT_COVERAGE}% meets minimum threshold ${MINIMUM_COVERAGE}%"
          echo "coverage_passed=true" >> $GITHUB_OUTPUT
        fi

        # Try to download previous coverage data
        PREVIOUS_COVERAGE="baseline"
        TREND_INDICATOR="üìä"
        TREND_TEXT="baseline"

        if [ -f workflow-reports/coverage/previous-coverage.txt ]; then
          PREVIOUS_COVERAGE=$(cat workflow-reports/coverage/previous-coverage.txt)
          echo "üìà Previous coverage: ${PREVIOUS_COVERAGE}%"

          # Calculate difference using bc for floating point math
          DIFF=$(echo "$CURRENT_COVERAGE - $PREVIOUS_COVERAGE" | bc)

          # Determine trend indicator
          if (( $(echo "$DIFF > 0.1" | bc -l) )); then
            TREND_INDICATOR="üìà"
            TREND_TEXT="increased"
          elif (( $(echo "$DIFF < -0.1" | bc -l) )); then
            TREND_INDICATOR="üìâ"
            TREND_TEXT="decreased"
          else
            TREND_INDICATOR="‚û°Ô∏è"
            TREND_TEXT="unchanged"
          fi

          echo "trend_indicator=$TREND_INDICATOR" >> $GITHUB_OUTPUT
          echo "trend_text=$TREND_TEXT" >> $GITHUB_OUTPUT
          echo "coverage_diff=$DIFF" >> $GITHUB_OUTPUT
          echo "previous_coverage=$PREVIOUS_COVERAGE" >> $GITHUB_OUTPUT

          echo "$TREND_INDICATOR Coverage $TREND_TEXT: ${CURRENT_COVERAGE}% (${DIFF:+${DIFF}%})"
        else
          echo "trend_indicator=$TREND_INDICATOR" >> $GITHUB_OUTPUT
          echo "trend_text=$TREND_TEXT" >> $GITHUB_OUTPUT
          echo "coverage_diff=0.0" >> $GITHUB_OUTPUT
          echo "previous_coverage=0.0" >> $GITHUB_OUTPUT
          echo "$TREND_INDICATOR Coverage baseline: ${CURRENT_COVERAGE}%"
        fi

        # Store current coverage for next run
        echo "$CURRENT_COVERAGE" > workflow-reports/coverage/current-coverage.txt

    - name: Download previous coverage data
      # https://github.com/actions/download-artifact/releases (v4.3.0, 2025-04-21)
      uses: actions/download-artifact@v6.0.0
      continue-on-error: true
      with:
        name: coverage-trend-data
        path: workflow-reports/coverage/

    - name: Display coverage trend
      run: |
        echo "## üìà Coverage Trend Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Current Coverage | ${{ steps.coverage-trend.outputs.current_coverage }}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Minimum Threshold | 95.0% |" >> $GITHUB_STEP_SUMMARY
        echo "| Threshold Status | ${{ steps.coverage-trend.outputs.coverage_passed == 'true' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.coverage-trend.outputs.trend_text }}" != "baseline" ]; then
          echo "| Previous Coverage | ${{ steps.coverage-trend.outputs.previous_coverage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Trend | ${{ steps.coverage-trend.outputs.trend_indicator }} ${{ steps.coverage-trend.outputs.trend_text }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Difference | ${{ steps.coverage-trend.outputs.coverage_diff }}% |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Trend | ${{ steps.coverage-trend.outputs.trend_indicator }} ${{ steps.coverage-trend.outputs.trend_text }} |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Enforce coverage threshold
      if: steps.coverage-trend.outputs.coverage_passed == 'false'
      continue-on-error: true  # Informational until codebase reaches 95% target
      run: |
        echo "‚ö†Ô∏è Coverage below minimum threshold of 95%"
        echo "Current coverage: ${{ steps.coverage-trend.outputs.current_coverage }}%"
        echo "Improve test coverage to meet the ‚â•95% quality gate"
        exit 1

    - name: Upload coverage
      # https://github.com/codecov/codecov-action/releases (v5.5.1, 2025-11-15)
      uses: codecov/codecov-action@v5.5.1
      with:
        files: ./workflow-reports/coverage/coverage.out
        flags: coverage-tests  # Group uploads under "coverage-tests"
        name: codecov-coverage
        fail_ci_if_error: false

    - name: Upload coverage artifacts
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      with:
        name: coverage-reports
        path: |
          workflow-reports/coverage/coverage.out
          workflow-reports/coverage/coverage.html
          workflow-reports/coverage/coverage-func.txt
          workflow-reports/coverage/coverage-per-pkg.txt
          coverage-upload-artifacts-trivy.sarif
        retention-days: 1

    - name: Upload coverage trend data for next run
      # https://github.com/actions/upload-artifact/releases (v5.0.0, 2025-04-21)
      uses: actions/upload-artifact@v5.0.0
      if: always()
      with:
        name: coverage-trend-data
        path: workflow-reports/coverage/current-coverage.txt
        retention-days: 7

    - name: Coverage test summary
      uses: ./.github/actions/workflow-job-end
