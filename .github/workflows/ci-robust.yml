name: CI - Robustness Testing
# CROSS-PLATFORM COMPATIBILITY: All file references in this workflow MUST use relative paths
# to support both GitHub Actions Ubuntu runners and Windows `act` local runner testing.
# Absolute paths (e.g., C:\...) break cross-platform compatibility.
# Example: Use './deployments/compose/compose.yml'

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
      - 'workflow-reports/**'
      - 'nohup.out'
      - 'LICENSE'
      - '.editorconfig'
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.github/dependabot.yml'
      - '**/*.log'
      - '**/*.sarif'
  workflow_dispatch:
    inputs:
      test_profile:
        description: 'Test profile to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - concurrency
          - fuzz
          - fuzz-keygen
          - fuzz-digests
          - benchmark
          - race

env:
  GO_VERSION: '1.25.3'

jobs:
  concurrency-race:
    name: Concurrency & Race Detection Tests
    runs-on: ubuntu-latest

    steps:
    - name: Workflow Start - CI - Robustness Testing / concurrency-race (ci-robust.yml)
      run: |
        echo "=========================================="
        echo "Workflow: ${{ github.workflow }}"
        echo "File: .github/workflows/ci-robust.yml"
        echo "Job: concurrency-race"
        echo "Triggered by: ${{ github.event_name }}"
        echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "=========================================="

    - name: Checkout code
      uses: actions/checkout@v5.0.0
      with:
        sparse-checkout-cone-mode: false

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run concurrency and race detection tests
      working-directory: .
      run: |
        echo "ðŸ”„ Running comprehensive concurrency and race detection tests..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        go test -race -timeout=15m -count=2 ./internal/... ./scripts/...
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Race detection tests completed in: ${DURATION}s"

    - name: Race detection test summary
      run: |
        echo "## ðŸ”„ Concurrency & Race Detection Results" >> $GITHUB_STEP_SUMMARY
        echo "Comprehensive concurrency and race detection tests completed successfully." >> $GITHUB_STEP_SUMMARY
        echo "- Coverage: All packages" >> $GITHUB_STEP_SUMMARY
        echo "- Race detector: Enabled (sequential for better detection)" >> $GITHUB_STEP_SUMMARY
        echo "- Concurrent execution: 2 runs" >> $GITHUB_STEP_SUMMARY
        echo "- Timeout: 15 minutes" >> $GITHUB_STEP_SUMMARY
        echo "- Duration: \${DURATION}s" >> $GITHUB_STEP_SUMMARY

  concurrency-coverage:
    name: Concurrency Coverage Collection
    runs-on: ubuntu-latest

    steps:
    - name: Workflow Start - CI - Robustness Testing / concurrency-coverage (ci-robust.yml)
      run: |
        echo "=========================================="
        echo "Workflow: ${{ github.workflow }}"
        echo "File: .github/workflows/ci-robust.yml"
        echo "Job: concurrency-coverage"
        echo "Triggered by: ${{ github.event_name }}"
        echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "=========================================="

    - name: Checkout code
      uses: actions/checkout@v5.0.0
      with:
        sparse-checkout-cone-mode: false

    - name: Set up Go and validate dependencies
      uses: ./.github/actions/go-setup
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run coverage on concurrency tests
      working-directory: .
      run: |
        echo "ðŸ“Š Generating coverage report for concurrency tests..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        go test -count=1 -p=2 -coverprofile=concurrency-coverage.out -covermode=atomic ./internal/... ./scripts/...
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Coverage tests completed in: ${DURATION}s"

    - name: Generate concurrency coverage report
      run: go tool cover -html=concurrency-coverage.out -o concurrency-coverage.html

    - name: Upload concurrency coverage
      uses: codecov/codecov-action@v5.5.1
      with:
        files: ./concurrency-coverage.out
        flags: concurrency-tests
        name: codecov-concurrency
        fail_ci_if_error: false

    - name: Concurrency coverage test summary
      run: |
        echo "## ï¿½ Concurrency Coverage Collection Results" >> $GITHUB_STEP_SUMMARY
        echo "Concurrency coverage collection completed successfully." >> $GITHUB_STEP_SUMMARY
        echo "- Coverage: All packages" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage collection: 2 parallel packages" >> $GITHUB_STEP_SUMMARY
        echo "- Output: HTML report and coverage profile" >> $GITHUB_STEP_SUMMARY
        echo "- Duration: \${DURATION}s" >> $GITHUB_STEP_SUMMARY

  # Fuzz Testing - Keygen Package - Property-based testing for cryptographic key generation
  fuzz-keygen:
    name: Fuzz Tests - Keygen
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_profile == 'all' || github.event.inputs.test_profile == 'fuzz' || github.event_name != 'workflow_dispatch' }}

    steps:
      - name: Workflow Start - CI - Robustness Testing / fuzz-keygen (ci-robust.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-robust.yml"
          echo "Job: fuzz-keygen"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run keygen fuzz tests
        working-directory: .
        run: |
          echo "ï¿½ Running keygen fuzz tests..."
          OVERALL_START=$(date +%s)
          echo "ðŸ“… Keygen fuzz tests start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          # RSA keygen fuzz test (longer duration)
          echo "ðŸ”‘ Running RSA keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateRSAKeyPair -fuzztime=30s -timeout=60s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… RSA fuzz test completed in: ${DURATION}s"

          # ECDSA keygen fuzz test
          echo "ðŸ” Running ECDSA keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateECDSAKeyPair -fuzztime=15s -timeout=30s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… ECDSA fuzz test completed in: ${DURATION}s"

          # ECDH keygen fuzz test
          echo "ðŸ” Running ECDH keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateECDHKeyPair -fuzztime=15s -timeout=30s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… ECDH fuzz test completed in: ${DURATION}s"

          # EdDSA keygen fuzz test
          echo "ðŸ” Running EdDSA keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateEDDSAKeyPair -fuzztime=15s -timeout=30s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… EdDSA fuzz test completed in: ${DURATION}s"

          # AES keygen fuzz test
          echo "ðŸ” Running AES keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateAESKey -fuzztime=15s -timeout=30s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… AES fuzz test completed in: ${DURATION}s"

          # AES-HS keygen fuzz test
          echo "ðŸ” Running AES-HS keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateAESHSKey -fuzztime=15s -timeout=30s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… AES-HS fuzz test completed in: ${DURATION}s"

          # HMAC keygen fuzz test
          echo "ðŸ” Running HMAC keygen fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzGenerateHMACKey -fuzztime=15s -timeout=30s ./internal/common/crypto/keygen
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… HMAC fuzz test completed in: ${DURATION}s"

          OVERALL_END=$(date +%s)
          TOTAL_DURATION=$((OVERALL_END - OVERALL_START))
          echo "ðŸ“… Keygen fuzz tests end: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ All keygen fuzz tests completed in: ${TOTAL_DURATION}s"

      - name: Keygen fuzz test summary
        run: |
          echo "## ðŸ” Keygen Fuzz Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "Fuzz tests for cryptographic key generation completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: 7 key generation functions" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: RSA=30s, Others=15s each (sequential)" >> $GITHUB_STEP_SUMMARY
          echo "- Total Duration: \${TOTAL_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "- Purpose: Property-based testing for secure key generation" >> $GITHUB_STEP_SUMMARY

  # Fuzz Testing - Digests Package - Property-based testing for cryptographic hash functions
  fuzz-digests:
    name: Fuzz Tests - Digests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_profile == 'all' || github.event.inputs.test_profile == 'fuzz' || github.event_name != 'workflow_dispatch' }}

    steps:
      - name: Workflow Start - CI - Robustness Testing / fuzz-digests (ci-robust.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-robust.yml"
          echo "Job: fuzz-digests"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run digests fuzz tests
        working-directory: .
        run: |
          echo "ðŸ” Running digests fuzz tests..."
          OVERALL_START=$(date +%s)
          echo "ðŸ“… Digests fuzz tests start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          # HKDF fuzz tests
          echo "ðŸ” Running HKDF All Variants fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzHKDFAllVariants -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… HKDF All Variants fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running HKDF-SHA256 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzHKDFwithSHA256 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… HKDF-SHA256 fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running HKDF-SHA384 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzHKDFwithSHA384 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… HKDF-SHA384 fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running HKDF-SHA512 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzHKDFwithSHA512 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… HKDF-SHA512 fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running HKDF-SHA224 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzHKDFwithSHA224 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… HKDF-SHA224 fuzz test completed in: ${DURATION}s"

          # SHA-2 fuzz tests
          echo "ðŸ” Running SHA512 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzSHA512 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… SHA512 fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running SHA384 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzSHA384 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… SHA384 fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running SHA256 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzSHA256 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… SHA256 fuzz test completed in: ${DURATION}s"

          echo "ðŸ” Running SHA224 fuzz test..."
          START_TIME=$(date +%s)
          go test -fuzz=FuzzSHA224 -fuzztime=15s -timeout=30s ./internal/common/crypto/digests
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… SHA224 fuzz test completed in: ${DURATION}s"

          OVERALL_END=$(date +%s)
          TOTAL_DURATION=$((OVERALL_END - OVERALL_START))
          echo "ðŸ“… Digests fuzz tests end: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ All digests fuzz tests completed in: ${TOTAL_DURATION}s"

      - name: Digests fuzz test summary
        run: |
          echo "## ðŸ” Digests Fuzz Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "Fuzz tests for cryptographic digest functions completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: 9 digest functions (HKDF variants + SHA-2 family)" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: 15s each (sequential)" >> $GITHUB_STEP_SUMMARY
          echo "- Total Duration: \${TOTAL_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "- Purpose: Property-based testing for secure hash operations" >> $GITHUB_STEP_SUMMARY

  # Benchmark Testing - Performance validation and regression detection
  benchmark:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_profile == 'all' || github.event_name != 'workflow_dispatch' }}

    steps:
      - name: Workflow Start - CI - Robustness Testing / benchmark (ci-robust.yml)
        run: |
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "File: .github/workflows/ci-robust.yml"
          echo "Job: benchmark"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          sparse-checkout-cone-mode: false

      - name: Set up Go and validate dependencies
        uses: ./.github/actions/go-setup
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run benchmark tests
        working-directory: .
        run: |
          echo "ðŸ“Š Running benchmark tests for performance validation..."
          START_TIME=$(date +%s)
          echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          go test -bench=. -benchmem -run=^$ ./internal/common/crypto/... > benchmark-results.txt
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â±ï¸ Benchmark tests completed in: ${DURATION}s"

      - name: Display benchmark results
        run: |
          echo "## ðŸ“Š Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat benchmark-results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5.0.0
        with:
          name: benchmark-results
          path: benchmark-results.txt
          retention-days: 2

      - name: Benchmark test summary
        run: |
          echo "## ðŸ“Š Benchmark Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "Performance benchmark tests completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: Key generation and cryptographic operations" >> $GITHUB_STEP_SUMMARY
          echo "- Output: Memory allocation statistics included" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: \${DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "- Purpose: Performance validation and regression detection" >> $GITHUB_STEP_SUMMARY
