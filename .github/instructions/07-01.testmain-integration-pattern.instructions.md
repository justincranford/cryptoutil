---
description: Integration test pattern using TestMain for GORM databases
applyTo: "**"
---
# TestMain Integration Pattern

## CRITICAL RULE

**ALWAYS use TestMain pattern for integration tests with GORM databases**

**NEVER create GORM mocking infrastructure (interfaces, mocks) for integration tests**

## Required Pattern

```go
var (
    testDB     *gorm.DB
    testSQLDB  *sql.DB
    testServer *Server
)

func TestMain(m *testing.M) {
    // Setup heavyweight resources ONCE
    ctx := context.Background()
    sqlDB, _ := sql.Open("sqlite", ":memory:")
    testSQLDB = sqlDB
    testDB, _ = gorm.Open(sqlite.Dialector{Conn: testSQLDB}, &gorm.Config{})

    // Run migrations
    testDB.AutoMigrate(&Model{})

    // Start server
    testServer, _ = NewServer(testDB)
    go testServer.Start()
    defer testServer.Shutdown(ctx)

    exitCode := m.Run()
    testSQLDB.Close()
    os.Exit(exitCode)
}

func TestSomething(t *testing.T) {
    // Use shared testDB - NO per-test setup
    // Use UUIDv7 for orthogonal test data
    id := googleUuid.NewV7()
    err := testServer.Create(ctx, &Model{ID: id})
    require.NoError(t, err)
}
```

## FORBIDDEN Pattern

**NEVER do this**:

```go
//  WRONG - per-test DB creation
func setupTestDB(t *testing.T) *gorm.DB {
    db := createDatabase()
    return db
}

func TestSomething(t *testing.T) {
    db := setupTestDB(t)  //  Repeated overhead
}
```

## When to Use TestMain

- Integration tests with GORM repositories
- API tests requiring full server
- Service tests with database dependencies
- Any test requiring >100ms setup

## Correct Examples

- internal/apps/template/service/server/apis/test_main_test.go
- internal/apps/jose/ja/service/testmain_test.go
- internal/apps/cipher/im/repository/testmain_test.go

## Database Error Testing

NO mocking needed - use real database constraints:

```go
func TestCreate_DuplicateKey(t *testing.T) {
    id := googleUuid.NewV7()
    testRepo.Create(ctx, &Model{ID: id})

    // Real constraint violation
    err := testRepo.Create(ctx, &Model{ID: id})
    require.Error(t, err)
}
```
