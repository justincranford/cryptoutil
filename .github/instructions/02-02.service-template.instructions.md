---
description: "Service template requirements and patterns for all cryptoutil services"
applyTo: "**"
---
# Service Template Requirements - MANDATORY

Two HTTPS Endpoints, Public vs Private. See `.github\instructions\02-03.https-ports.instructions.md` for details.

Two client-types on Public HTTPS Endpoint, Browser-client vs Headless-client. See `.github\instructions\02-03.https-ports.instructions.md` for details.

## Service Template Pattern (Phase 6)

**Template Components** (extract from KMS reference implementation):

- **Two HTTPS Servers**: Public HTTPS Binding + Private API Binding. See `.github\instructions\02-03.https-ports.instructions.md` for details.
- **Two Public API Paths**: `/browser/api/v1/*` (session-based) vs `/service/api/v1/*` (token-based) See `.github\instructions\02-03.https-ports.instructions.md` for details.
- **Three Private APIs**: `/admin/v1/livez` (liveness), `/admin/v1/readyz` (readiness), `/admin/v1/shutdown` (orchestration)
- **Database Abstraction**: PostgreSQL || SQLite dual support, with GORM
- **OpenTelemetry Integration**: OTLP traces, metrics, logs
- **Config Management**: YAML files + CLI flags, Docker secrets support, File dereference

**Template Parameterization**:

- Constructor injection of parameters for the configuration, handlers, middleware
- Service-specific OpenAPI specs passed to template
- Business logic separated from infrastructure concerns

**Mandatory Usage**:

- MUST extract reusable template before implementing new services
- ALL new services MUST use template (consistency, reduced duplication, validate before migrating existing services)
- ALL existing services MUST be refactored to use template (consistency, reduced duplication, iterative adjustments to support additional service patterns)
- Template success criteria: learn-ps service is implemented using the template, and passes all unit/integration/e2e/workflows, and deep analysis shows no blockers to migrate one existing service to it

**NEVER DO**:

- ❌ Copy-paste service infrastructure code between services
- ❌ Duplicate dual-server pattern, health checks, shutdown logic
- ❌ Reimplement middleware pipeline, telemetry integration, crypto, sql/gorm setup

**ALWAYS DO**:

- ✅ Extract from proven KMS implementation and parameterize it
- ✅ Parameterize template for service-specific customization
- ✅ Validate template reusability via Learn-PS demonstration

**Service Template Migration Priority** (HIGH PRIORITY):

1. **learn-ps FIRST**: CRITICAL - implement and validate ALL template requirements before production services
2. **One service at a time** (excludes sm-kms): Sequentially refactor jose-ja, pki-ca, identity services
3. **sm-kms LAST**: Only after ALL other services running excellently on template
