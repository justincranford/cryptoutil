---
description: "Service template requirements and patterns for all cryptoutil services"
applyTo: "**"
---
# Service Template Requirements - MANDATORY

**Service Template Implementation Details**:

- **Admin Endpoints** (127.0.0.1:9090):
  - `/livez`, `/readyz`, `/shutdown` endpoints MANDATORY
  - Admin prefix MUST be configurable (default: `/admin/v1`)
  - Implementation: gofiber middleware (reference: sm-kms `internal/kms/server/application/application_listener.go`)
- **Health Check Requirements**:
  - OpenTelemetry Collector Contrib MUST use separate health check job (does NOT expose external health endpoint)
  - Reference: KMS Docker Compose `deployments/compose/compose.yml` (working pattern)
- **Docker Secrets Validation**:
  - Docker Compose MUST include dedicated job to validate Docker Secrets presence and mounting
  - Fast-fail check before starting all other jobs and services

## Service Template Pattern (Phase 6)

**Template Components** (extract from KMS reference implementation):

- **Dual HTTPS Servers**: Public API (<configurable_address>:<configurable_port>) + Admin API (127.0.0.1:9090)
- **Dual API Paths**: `/browser/api/v1/*` (session-based) vs `/service/api/v1/*` (token-based)
- **Middleware Pipeline**: CORS/CSRF/CSP (browser), rate limiting, IP allowlist, auth
- **Database Abstraction**: PostgreSQL + SQLite dual support with GORM
- **OpenTelemetry Integration**: OTLP traces, metrics, logs
- **Health Check Endpoints**: `/admin/v1/livez` (liveness), `/admin/v1/readyz` (readiness)
- **Graceful Shutdown**: `/admin/v1/shutdown` endpoint with context cancellation
- **Config Management**: YAML files + CLI flags, Docker secrets support
- **TLS Configuration**: Separate public/admin TLS, client cert authentication

**Template Parameterization**:

- Constructor injection for handlers, middleware, configuration
- Service-specific OpenAPI specs passed to template
- Business logic separated from infrastructure concerns

**Mandatory Usage**:

- MUST extract reusable template before implementing new services
- ALL new services MUST use template (consistency, reduced duplication)
- ALL existing services MUST be refactored to use template (consistency, reduced duplication)
- Template success criteria: Service implementation <500 lines

**NEVER DO**:

- ❌ Copy-paste service infrastructure code between services
- ❌ Duplicate dual-server pattern, health checks, shutdown logic
- ❌ Reimplement middleware pipeline, telemetry integration, crypto, sql/gorm setup

**ALWAYS DO**:

- ✅ Extract template from proven KMS implementation
- ✅ Parameterize template for service-specific customization
- ✅ Validate template reusability via Learn-PS demonstration

**Service Template Migration Priority** (HIGH PRIORITY):

1. **learn-ps FIRST** (Phase 7): CRITICAL - implement and validate ALL template requirements before production services
2. **One service at a time** (Phase 8+, excludes sm-kms): Sequentially refactor jose-ja, pki-ca, identity services
3. **sm-kms LAST** (Phase 10): Only after ALL other services running excellently on template
