---
description: "Cryptographic patterns and FIPS compliance"
applyTo: "**"
---
# Cryptography

# Cryptography Instructions - CRITICAL

## FIPS 140-3 Compliance - MANDATORY

**CRITICAL: FIPS 140-3 mode is ALWAYS enabled by default and MUST NEVER be disabled**

- All cryptographic operations use FIPS-approved algorithms
- **ONLY use NIST FIPS 140-3 approved algorithms**
- **NEVER use non-FIPS algorithms**

### Approved Algorithms (NIST FIPS 140-3)

**Asymmetric**: RSA ≥2048, ECDSA (P-256/384/521), ECDH (P-256/384/521), EdDSA (25519/448)
**Symmetric**: AES ≥128 (GCM, CBC+HMAC)
**Digest**: SHA-256/384/512, HMAC-SHA256/384/512
**KDF**: PBKDF2-HMAC-SHA256/384/512, HKDF-SHA256/384/512

### BANNED Algorithms

❌ bcrypt, scrypt, Argon2 (use PBKDF2) | MD5, SHA-1 (use SHA-256+) | RSA <2048 | DES, 3DES

---

## Algorithm Agility - MANDATORY

**All cryptographic operations MUST support configurable algorithms with FIPS-approved defaults**

- Key generation: Support RSA (2048/3072/4096), ECDSA (P-256/384/521), EdDSA (25519/448)
- Encryption: Support AES-GCM (128/192/256 bit keys) AES-HS (256/384/512 bit keys)
- Digests: Support SHA-256/384/512, HMAC-SHA256/384/512
- Key derivation: Support PBKDF2-HMAC-SHA256/384/512, HKDF-SHA256/384/512
- Configuration-driven algorithm selection with FIPS-approved defaults

**Pattern**: Use config structs with Algorithm and KeySize fields, switch on algorithm type

---

## Unseal Key Management - MANDATORY

### Unseal Key Derivation - CRITICAL

**ALWAYS derive unseal keys deterministically for interoperability**

All cryptoutil instances using the same set of shared unseal secrets MUST derive the same unseal JWKs, including KIDs and key materials, for cryptographic interoperability between instances.

**Pattern**: Use HKDF with master secret, salt, and purpose-specific info for deterministic key derivation

### Unseal Secrets Pattern - MANDATORY

**Support BOTH derivation and pre-generated JWKs**:

- **Derivation Mode** (default): Derive JWKs from master secret using HKDF
- **Pre-generated Mode**: Load JWKs directly from config/secrets (for HSM-backed keys)
- Configuration MUST support both modes with automatic detection

## Pepper Rotation - MANDATORY

**Lazy Migration Pattern**:

- Old hashes remain on old pepper (version prefix identifies pepper)
- New hashes use new pepper (version bump)
- Re-hash on next authentication (gradual migration)
- NEVER force bulk re-hash (causes service disruption)

## Elastic Key Rotation

**Key versioning pattern**: Elastic Keys are key rings with active Material Key for encrypting||signing, and historical Material Keys for decrypting||verifying

- Encryption: Always use active key, embed key ID with ciphertext||signature
- Decryption: Use key matching on embedded key ID, to deterministically identify the historical to use for decrypting||verifying
- Rotation: Generate new Material Key, identify it as the active key ID, and keep all old keys for decrypting||verifying

---

## Secure Random Generation - MANDATORY

**ALWAYS use crypto/rand, NEVER use math/rand**

**Pattern**: Use `crypto/rand.Read()` for all random generation (tokens, nonces, salts, IVs)

---

## Cryptographic Libraries - MANDATORY

**Prefer standard library crypto packages**:

- `crypto/rand`, `crypto/rsa`, `crypto/ecdsa`, `crypto/ed25519` - Key generation
- `crypto/aes`, `crypto/cipher` - Symmetric encryption
- `crypto/sha256`, `crypto/sha512`, `crypto/hmac` - Hashing
- `crypto/tls` - TLS connections
- `golang.org/x/crypto/pbkdf2`, `golang.org/x/crypto/hkdf` - Key derivation

**Avoid third-party crypto libraries unless necessary** (review required)

## Key Takeaways

1. **FIPS 140-3 ALWAYS enabled** - No exceptions, ONLY approved algorithms
2. **Password hashing: PBKDF2-HMAC-SHA256** - See [02-08.hashes.instructions.md](.github/instructions/02-08.hashes.instructions.md) for hash registry patterns
3. **Algorithm agility: Configurable with FIPS defaults** - Support multiple key sizes
4. **Deterministic key derivation: HKDF** - For instance interoperability
5. **crypto/rand ALWAYS** - Never math/rand for cryptographic operations
6. **Standard library preferred** - Avoid third-party crypto unless necessary
7. **Elastic keys**: Active key for encrypt, historical keys for decrypt, rotation preserves old keys
8. **Certificate validation** - See [02-09.pki.instructions.md](.github/instructions/02-09.pki.instructions.md) for TLS certificate requirements
