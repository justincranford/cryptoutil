---
description: "Instructions for testing"
applyTo: "**"
---
# Testing Instructions

## Core Rules
- Run `go test ./... -cover` for automated tests; use testify `require` for assertions
- Target coverage: 80%+ production, 85%+ infrastructure (cicd), 95%+ utility code
- ALWAYS use table-driven tests with `t.Parallel()` - reveals real concurrency bugs
- NEVER hardcode test values - use magic package constants OR runtime-generated UUIDv7
- NEVER create temporary test files requiring deletion - create permanent tests only

## Test Values
**Option A**: Magic values from `internal/identity/magic` package
**Option B**: Generate once, reuse: `id := googleUuid.NewV7()` then use `id` in test cases
**NEVER**: Hardcoded UUIDs, strings, or calling `NewV7()` twice expecting same result

## Table-Driven Pattern (Mandatory)
```go
func TestMyFunction(t *testing.T) {
    t.Parallel()
    tests := []struct{ name string; input string; wantErr bool }{
        {"valid", "good", false},
        {"invalid", "", true},
    }
    for _, tc := range tests {
        tc := tc
        t.Run(tc.name, func(t *testing.T) {
            t.Parallel()
            // test using tc fields
        })
    }
}
```
**WRONG**: Separate `TestX_Case1`, `TestX_Case2` functions for same functionality

## Test File Organization
| Type | Suffix | Example |
|------|--------|---------|
| Unit | `_test.go` | `calc_test.go` |
| Bench | `_bench_test.go` | `calc_bench_test.go` |
| Fuzz | `_fuzz_test.go` | `calc_fuzz_test.go` |
| Integration | `_integration_test.go` | `api_integration_test.go` |

## Fuzz Testing
- Fuzz test names MUST be unique, NOT substrings of others (e.g., `FuzzHKDFAllVariants` not `FuzzHKDF`)
- ALWAYS run from project root: `go test -fuzz=FuzzXXX -fuzztime=15s ./path`
- Use unquoted names, PowerShell `;` for chaining

## Test Execution
- Place coverage files in `/test-output/`: `go test ./pkg -coverprofile=test-output/coverage_pkg.out`
- Long-running suites (orm, client, server) can take 5-10+ min - use targeted runs: `-run=TestSpecific`

## cicd Utility Testing
- Commands organized as `internal/cmd/cicd/<snake_case>/` subdirectories
- EVERY command MUST exclude its own subdirectory (self-exclusion pattern)
- Define exclusion in `internal/common/magic/magic_cicd.go`
- Add self-exclusion test to verify pattern works
- Target 85%+ coverage per command subdirectory

## Parallel Testing Philosophy
- `t.Parallel()` is a FEATURE - reveals race conditions sequential tests hide
- Failing parallel tests = production bugs to fix (don't remove `t.Parallel()`)
- Use UUIDv7 for test data isolation between concurrent tests
