---
description: "Instructions for VS Code Copilot customization"
applyTo: "**"
---
# VS Code Copilot Customization Instructions

## General Principles

- Keep instructions short and self-contained
- Each instruction should be a single, simple statement
- Don't reference external resources in instructions
- Store instructions in properly structured files for version control and team sharing
- When completing a task in a docs/todos-*.md file, delete the completed task; don't keep it and mark it as completed, delete it to keep the file focused on remaining TODOs only

## CRITICAL: Git Operations

- **ALWAYS use terminal git commands** (git status, git add, git commit, git push)
- **NEVER USE GitKraken MCP Server tools (mcp_gitkraken_*) in GitHub Copilot chat sessions**
- **GitKraken is ONLY for manual GUI operations** - never automated in chat
- **NEVER use python in chat sessions** - python is not installed in Windows PowerShell or Alpine container images
- **NEVER use bash in chat sessions** - bash is not available in Windows PowerShell
- **NEVER use powershell.exe in chat sessions** - powershell.exe is not needed when already in PowerShell
- **NEVER use -SkipCertificateCheck in PowerShell commands** - this parameter only exists in PowerShell 6+; use `[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}` for PowerShell 5.1

## Curl/Wget Command Usage Rules

**CRITICAL: Context-specific curl/wget restrictions**

### ❌ BANNED in Copilot Chat Sessions (Local Windows PowerShell)
- **NEVER use curl or wget in chat sessions** - not installed in Windows path
- **Alternative**: Use PowerShell `Invoke-WebRequest`
- **Exception**: Examples in documentation showing CI/CD usage are acceptable if clearly marked as workflow-only

### ✅ ALLOWED in GitHub Actions Workflows (.github/workflows/*.yml)
- **curl and wget are both available** in GitHub Actions Ubuntu runners and act containers
- **Preferred**: wget with "--no-check-certificate" option for HTTPS endpoints
- **Why**: GitHub runners and act containers have both tools preinstalled

### ✅ ALLOWED in Docker Compose Healthchecks (compose.yml)
- **Preferred**: Use `wget` (available in Alpine/busybox containers)
- **Fallback**: Use `curl` if container includes it (e.g., grafana-otel-lgtm)
- **Pattern**: `test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/livez"]`
- **Why**: Most containers use Alpine base which includes wget via busybox

## Text File Encoding Critical Guidelines

- **ALWAYS use UTF-8 without BOM for ALL text files** - this is enforced by cicd all-enforce-utf8 command; PowerShell's default UTF-16 LE encoding breaks Docker Compose secrets (e.g. PostgreSQL secrets)
- **PowerShell file creation**: `$utf8NoBom = New-Object System.Text.UTF8Encoding $false; [System.IO.File]::WriteAllText("file.txt", "content", $utf8NoBom)` (creates UTF-8 without BOM)
- **NEVER use `Out-File`, `Set-Content`, or `>` redirection** for text files - they default to UTF-16 LE with BOM; use `[System.IO.File]::WriteAllText()` with UTF8Encoding(false) instead

## Lint Critical Guidelines

- **ALWAYS rely on golangci-lint exclusions defined in .golangci-lint.yml** - never use --skip-files or --skip-dirs command line flags
- **ALWAYS use `golangci-lint run --fix` FIRST for auto-fixing before any manual lint error fixing** - this ensures all auto-fixable issues are resolved automatically before attempting manual fixes - this single command handles formatting (gofumpt), imports (goimports), and all other auto-fixable linters in one pass
- **CRITICAL: gofumpt is ALWAYS preferred over gofmt in ALL SITUATIONS** - gofumpt is a stricter superset of gofmt with additional formatting rules; NEVER use `gofmt` directly, even if you see a "gofmt" lint error from any tool including golangci-lint
- **Pre-commit hooks automatically run `golangci-lint run --fix`** - no need to run standalone gofumpt or goimports commands separately
- **ALWAYS declare values as constants near the top of the file** to proactively mitigate "mnd" (magic number detector) linter errors in .golangci-lint.yml:
  - **HTTP status codes**: `http.StatusOK`, `http.StatusNotFound`, `http.StatusForbidden` instead of `200`, `404`, `403`
  - **Durations**: `timeout = 30 * time.Second`, `delay = 100 * time.Millisecond` instead of inline `30000`, `100`
  - **Special strings**: `statusPass = "PASS"`, `statusFail = "FAIL"`` instead of inline strings
  - **Special numbers**: `rsaKeySize2048 = 2048`, `aes256KeySize = 256` instead of magic numbers
  - **Port numbers**: `publicPort = 8080`, `privateAdminPort = 9090` instead of `8080`, `9090`
  - **Common counts/limits**: `maxRetries = 3` instead of `3`
  - **File permissions**: `fileMode = 0o600`, `dirMode = 0o755` instead of `0o600`, `0o755`
- **CRITICAL: cicd.go and cicd_test.go contains deliberate lint violations for testing purposes** - these files MUST exclude themselves from their own directory walks, to avoid self-referencing and modifying themselves during auto-fixing; all other validations in golangci-lint must still be performed on both files

## Additional Critical Guidelines

- **ALWAYS use HTTPS 127.0.0.1:9090 for admin APIs** (/shutdown, /livez, /readyz) - these are private server endpoints, not public server endpoints
- **ALWAYS run Go fuzz tests from project root** - never use `cd` commands before `go test -fuzz` (causes module detection failures)
- **ALWAYS use PowerShell `;` for command chaining** - never use bash `&&` syntax (PowerShell 5.1 doesn't support it)
- **STOP MODIFYING DOCKER COMPOSE SECRETS** - Docker Compose secrets in `deployments/compose/` are carefully configured for security best practices; NEVER create, modify, or delete secret files as this breaks the cryptographic key hierarchy and causes test failures
- **PREFER SWITCH STATEMENTS WHERE POSSIBLE** - Use `switch variable { case value: ... }` over `if/else if/else` chains for cleaner, more maintainable code; when switch is not possible, prefer `if/elseif/else` pattern over separate `if` or `if/else` statements

## Authorized Commands for Chat Sessions Reference

### Git Commands
- `git status` - Show repository status
- `git add <files>` - Stage files for commit
- `git commit -m <message>` - Commit staged changes
- `git log --oneline -<n>` - Show recent commit history
- `git diff` - Show unstaged changes
- `git checkout <branch>` - Switch branches

### Go Commands
- `go test ./<path>` - Run tests in specified path
- `go build ./<path>` - Build packages
- `go mod tidy` - Clean up module dependencies
- `go run ./<path>` - Run Go program
- `golangci-lint run` - Run linter (relies on exclusions in .golangci-lint.yml)
- `go test -fuzz=. -fuzztime=15s ./<path>` - Run fuzz tests for 15 seconds (ALWAYS run from project root, NEVER use cd commands)
- `go test -run=FuzzXXX -fuzz=FuzzXXX -fuzztime=15s ./<path>` - Run specific fuzz test (use PowerShell `;` not bash `&&` for command chaining)

### Docker Compose Commands
- `docker compose ps` - List container status
- `docker compose logs <service>` - View service logs
- `docker compose logs <service> --tail <n>` - View recent service logs
- `docker compose exec <service> <command>` - Execute command in container
- `docker compose build <services>` - Build services
- `docker compose up -d <services>` - Start services in background
- `docker compose down -v` - Stop services and remove volumes

### Docker Commands
- `docker inspect <container>` - Inspect container (use without --format to avoid authorization)
- `docker ps` - List containers (use without --filter/--format to avoid authorization)
- `docker stats` - Show container resource usage
- `docker top` - Show container processes
- `docker inspect --format` - Inspect with custom formatting

### File/Directory Operations
- `pwd` - Show current working directory
- `ls -la <path>` - List directory contents with details
- `dir` - List directory contents (PowerShell equivalent)
- `find <path> -name <pattern>` - Find files by name pattern
- `cat <file>` - Display file contents
- `type <file>` - Display file contents (PowerShell equivalent)
- `head -n <lines> <file>` - Show first N lines of file
- `tail -n <lines> <file>` - Show last N lines of file
- `grep <pattern> <file>` - Search for patterns in files
- `Select-String <pattern> <file>` - Search for patterns in files (PowerShell equivalent)

### Build/Test Tools
- `make <target>` - Run Makefile targets
- `npm run <script>` - Run npm scripts
- `python -m <module>` - Run Python modules
- `pytest <path>` - Run Python tests
- `./mvnw <goals>` - Run Maven goals with Maven Wrapper
- `mvnw.cmd <goals>` - Run Maven goals with Maven Wrapper on Windows

### System Commands
- `which <command>` - Find command location
- `echo <text>` - Display text
- `date` - Show current date/time
- `sleep <seconds>` - Pause execution

## Commands Requiring Manual Authorization

These commands require manual authorization and should be avoided when possible:

### Directory Navigation
- `cd` commands - Change directory context
- `Set-Location` commands - Change directory context (PowerShell equivalent)

### Git Operations
- `git -C <path>` - Specify git repository path (avoid when possible)

### Network Commands
- `curl.exe` - Make HTTP requests (use docker compose exec instead for container access)
- `tee` - Output redirection to files (E2E tests already log automatically)

## VS Code Go Development Settings

### Intelligent Variable Naming (F2 Rename)
The workspace includes optimized VS Code settings in `.vscode/settings.json` (JSONC format) that enable IntelliJ-like intelligent variable naming.

**Key Settings for F2 Rename:**
```jsonc
{
  "go.useLanguageServer": true,  // Enable gopls language server
  "gopls": {
    "formatting.gofumpt": true,  // Use gofumpt for formatting
    "formatting.local": "cryptoutil",  // Local import prefix
    "ui.inlayhint.hints": {
      "parameterNames": true,  // Show parameter names
      "assignVariableTypes": true,  // Show variable types
      "rangeVariableTypes": true  // Show range variable types
    }
  }
}
```

**Usage:**
- Press `F2` on any variable/function to rename with intelligent, context-aware suggestions
- Inlay hints show parameter names and types for better context
- See `.vscode/settings.json` for complete Go extension configuration

## Git Workflow

### Commit and Push Strategy
- **Commit vs Push**: Commit frequently for logical units of work; push only when ready for CI/CD and peer review
- **Pre-push hooks**: Run automatically before push to enforce quality gates (dependency checks, linting)
- **Dependency management**: Update dependencies incrementally with test validation between updates
- **Branch strategy**: Use feature branches for development; merge to main only after CI passes
- **Commit hygiene**: Keep commits atomic and focused; use conventional commit messages
- **Push readiness**: Ensure all pre-commit checks pass before pushing; resolve any hook failures

### Conventional Commits
- Follow [Conventional Commits](https://www.conventionalcommits.org/) spec
- Format: `<type>[optional scope]: <description>`
- Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
- Use imperative mood, lowercase, no period at end
- For breaking changes: add `!` after type or use `BREAKING CHANGE:`
- Keep subject ≤72 chars; explain what/why in body if needed

## Terminal Command Auto-Approval

### Pattern Checking Workflow
When executing terminal commands through Copilot:
1. **Check Pattern Match**: Verify if command matches `chat.tools.terminal.autoApprove` patterns in `.vscode/settings.json`
2. **Track Unmatched**: Maintain list of unmatched commands during session
3. **End-of-Session Review**: Ask user if they'd like to add new auto-approve patterns
4. **Pattern Recommendations**:
   - **Auto-Enable (true)**: Safe, informational, build commands
   - **Auto-Disable (false)**: Destructive, dangerous, system-altering commands

### Auto-Enable Candidates
- Read-only operations (status, list, inspect, logs, history)
- Build and test commands (build, test, format, lint)
- Safe informational commands (version, info, df)
- Development workflow commands (fetch, status, diff)

### Auto-Disable Candidates
- Destructive operations (rm, delete, prune, reset, kill)
- Network operations (push, pull from remotes)
- System modifications (install, update, edit configurations)
- File system changes (create, update, delete files/directories)
- Container execution (exec, run interactive containers)

### Pattern Format
- Use established regex: `"/^command (sub1|sub2)/": true|false`
- Group related subcommands with alternation `(cmd1|cmd2|cmd3)`
- Use `^` for start anchor and appropriate word boundaries
- Include comments explaining security rationale

## Maintenance for TODO Docs

### Critical Requirements
- **Delete completed tasks immediately** - don't mark as done, remove from file
- Review ./docs/todos-*.md files for completed items before ending sessions
- Always ensure files contain ONLY active, actionable tasks

### Implementation Guidelines
- **Large cleanups**: Use create_file to rewrite entire file with only active tasks
- **Failed replacements**: Create clean version in new file, then replace original
- **Avoid complex replace_string_in_file**: Large text blocks often fail due to whitespace mismatches
