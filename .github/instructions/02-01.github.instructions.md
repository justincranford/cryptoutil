---
description: "Instructions for CI/CD workflow configuration, service connectivity verification, and diagnostic logging"
applyTo: "**"
---
# CI/CD Workflow Instructions

## Cost Efficiency

- Use path filters to trigger workflows only on relevant changes
- Minimal matrix builds; skip jobs for docs-only changes
- Use `cache: true` on `actions/setup-go@v6` (not manual cache actions)

## PostgreSQL Service Requirements - CRITICAL

**MANDATORY: All workflows that run Go tests MUST include PostgreSQL service**

Any workflow running `go test` on packages that use sqlrepository (KMS, Identity)
MUST configure PostgreSQL service container:

```yaml
env:
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5432
  POSTGRES_NAME: cryptoutil_test
  POSTGRES_USER: cryptoutil
  POSTGRES_PASS: cryptoutil_test_password

jobs:
  test-job:
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: ${{ env.POSTGRES_NAME }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASS }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
```

**Why Required:**

- Tests in `internal/kms/server/repository/sqlrepository` require PostgreSQL
- Tests will fail with "connection refused" error without database service
- Affects: ci-race, ci-mutation, ci-coverage workflows

## Workflow Matrix

| Workflow | Services | Purpose |
|----------|----------|---------|
| ci-quality | None | Linting, formatting, builds |
| ci-coverage | None | Test coverage |
| ci-benchmark | None | Performance benchmarks |
| ci-fuzz | None | Fuzz testing |
| ci-race | None | Race detection |
| ci-sast | None | Static security analysis |
| ci-gitleaks | None | Secrets scanning |
| ci-dast | PostgreSQL | Dynamic security testing |
| ci-e2e | Full Docker stack | E2E integration |
| ci-load | Full Docker stack | Load testing |

## Service Connectivity Patterns

**No services**: ci-quality, ci-coverage, ci-benchmark, ci-fuzz, ci-race, ci-sast, ci-gitleaks
**Go-based E2E**: ci-e2e uses `internal/test/e2e/` infrastructure (Docker Compose + health checks)
**Bash verification**: ci-dast, ci-load use `curl -k https://127.0.0.1:808X/ui/swagger/doc.json`

## Configuration Management

- ALWAYS use config files for production/CI (not environment variables)
- Tests use SQLite in-memory (`--dev` flag)
- NEVER use environment variables for secrets

## Artifact Management

- Upload artifacts with `actions/upload-artifact@v5.0.0` + `if: always()`
- Upload SARIF to Security tab with `github/codeql-action/upload-sarif@v3`
- Retention: 1 day temporary, 1-30 days valuable reports

## Act Workflow Testing

```bash
go run ./cmd/workflow -workflows=dast -inputs="scan_profile=quick"  # 3-5 min
go run ./cmd/workflow -workflows=dast -inputs="scan_profile=full"   # 10-15 min
go run ./cmd/workflow -workflows=e2e,dast                            # Multiple
```

NEVER use `-t` timeout flag; ALWAYS let cmd/workflow complete

## Diagnostic Logging

Steps >10s MUST include timing: `START_TIME=$(date +%s)` ... `DURATION=$((END_TIME - START_TIME))`
Emojis: üìã start, üìÖ timestamps, ‚è±Ô∏è duration, ‚úÖ success, ‚ùå error

## GitHub CLI for Workflow Diagnostics

**ALWAYS use `gh` CLI** to diagnose or fix workflow issues:

```bash
# List recent workflow runs
gh run list --limit 10

# View specific workflow run details
gh run view <run-id>

# View failed workflow logs
gh run view <run-id> --log-failed

# Download workflow artifacts
gh run download <run-id>

# Watch a running workflow
gh run watch <run-id>

# Re-run failed jobs
gh run rerun <run-id> --failed

# List workflows
gh workflow list

# View workflow file
gh workflow view <workflow-name>
```

**Common Diagnostic Commands:**

```bash
# Find recent failures on main
gh run list --branch main --status failure --limit 5

# Get full logs for debugging
gh run view <run-id> --log

# Cancel stuck runs
gh run cancel <run-id>
```
