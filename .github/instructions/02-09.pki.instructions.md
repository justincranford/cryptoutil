---
description: "PKI and certificate management"
applyTo: "**"
---
# Pki

# PKI and Certificate Management - Tactical Guidance

## Quick Reference: Certificate Validation

```go
// ✅ CORRECT: Strict TLS configuration
tlsConfig := &tls.Config{
    MinVersion:         tls.VersionTLS13,
    InsecureSkipVerify: false,  // ALWAYS validate certs
    RootCAs:            certPool,
    ClientCAs:          certPool,
    ClientAuth:         tls.RequireAndVerifyClientCert,
}
```

## CA Architecture

3-tier (Offline→Online→Issuing): Max security | 2-tier (Online→Issuing): Balanced | 1-tier: Dev/test only

## Certificate Compliance Checklist

**Subscriber Certificates**:

- ✅ Serial ≥64 bits CSPRNG, >0, <2^159
- ✅ RSA ≥2048, ECDSA P-256/384/521, EdDSA
- ✅ SHA-256/384/512 (NEVER MD5/SHA-1)
- ✅ Validity ≤398 days
- ✅ Extensions: Key Usage (critical), EKU, SAN, AKI, SKI
- ✅ CRL/OCSP URIs present
- ✅ Audit logs 7 years

**Validation**:

- ✅ DV: Within 30 days
- ✅ OV/EV: Within 13 months
- ✅ CAA checked before issuance

## TLS Configuration - MANDATORY

**Full cert chain validation, TLS 1.3+, NEVER InsecureSkipVerify**

```go
tlsConfig := &tls.Config{
    MinVersion:         tls.VersionTLS13,
    InsecureSkipVerify: false,  // ALWAYS validate
    RootCAs:            certPool,
    ClientCAs:          certPool,
    ClientAuth:         tls.RequireAndVerifyClientCert,
}
```

**See**: `02-07.cryptography.instructions.md`

---

## CA/Browser Forum Baseline Requirements

**MANDATORY: Adhere to latest [CA/Browser Forum Baseline Requirements](https://cabforum.org/baseline-requirements/)**

### Certificate Profile Requirements (Section 7)

**Serial Number** (Section 7.1): ≥64 bits CSPRNG, non-sequential, >0, <2^159, unique per CA, no reuse

**Algorithms & Key Sizes**:

| Algorithm | Min Key Size | Recommended | Hash Algorithm |
|-----------|--------------|-------------|----------------|
| RSA | 2048 bits | 3072/4096 bits | SHA-256/384/512 |
| ECDSA | P-256 (256 bits) | P-384 (384 bits) | SHA-256/384/512 |
| EdDSA | Ed25519 (256 bits) | Ed448 (448 bits) | Built-in |

**Prohibited**: ❌ MD5, SHA-1, RSA <2048 bits

**Validity Periods**:

| Certificate Type | Maximum Validity |
|------------------|------------------|
| Subscriber | 398 days (post-2020-09-01) |
| Intermediate CA | 5-10 years |
| Root CA | 20-25 years |

**Required Extensions**:

1. **Key Usage** (critical): Digital Signature, Key Encipherment (TLS Server); Certificate Sign, CRL Sign (CA)
2. **Extended Key Usage**: `id-kp-serverAuth` (TLS Server), `id-kp-clientAuth` (TLS Client)
3. **Basic Constraints** (critical for CA): CA=TRUE, path length constraint
4. **SAN** (MUST for subscriber): DNS names, IP addresses
5. **Authority Key Identifier** (MUST)
6. **Subject Key Identifier** (MUST)
7. **CRL Distribution Points** (MUST if CRL supported)
8. **Authority Information Access** (MUST): OCSP responder URI, CA Issuers URI

**Subject Name Encoding**:

| Component | Format | Notes |
|-----------|--------|-------|
| C (Country) | 2 characters | ISO 3166-1 alpha-2 |
| O (Organization) | Full legal name | |
| CN (Common Name) | FQDN | Deprecated (use SAN) |
| ST (State/Province) | Full name | No abbreviations |
| L (Locality) | Full name | City or locality |

**Signature Algorithms Approved**: RSA with SHA-256/384/512, ECDSA with SHA-256/384/512, EdDSA
**Signature Algorithms Prohibited**: ❌ MD5 with RSA, SHA-1 with RSA

**CRL/OCSP Requirements**:

- **CRL Update**: Maximum 7 days
- **OCSP Response**: Maximum 7 days validity (10 days with nextUpdate)
- **CRL Fields**: Next Update (MUST), CRL Number (MUST, monotonic), Revocation Reason (SHOULD)
- **OCSP Fields**: Must return `good`, `revoked`, or `unknown`; nonce extension SHOULD be supported

**Audit Logging** (Section 5.4.1):

- Events: Certificate issuance/revocations, key generation/destruction, CA access, config changes
- Retention: Minimum 7 years after certificate expiration
- Properties: Tamper-evident, append-only, restricted access, regular backups

**Validation Requirements** (Section 3.2.2):

- **Domain Validation (DV)**: Within 30 days of issuance (DNS, HTTP, Email methods)
- **Organization Validation (OV)**: Within 13 months (legal existence, operational existence, domain control)
- **Extended Validation (EV)**: Within 13 months (OV + enhanced identity, physical address, operational presence)

---

## CA Architecture Patterns

**TLS Issuing CA Configurations** (highest to lowest preference):

1. **Offline Root CA → Online Root CA → Online Issuing CA** (Recommended): Maximum security
2. **Online Root CA → Online Issuing CA** (Balanced): Simpler operations, acceptable security
3. **Online Root CA** (Simple): Simplest, acceptable for dev/testing
4. **Online Root CA → Policy Root CA → Online Issuing CA** (Policy-Driven): Supports multiple policies (DV/OV/EV)
5. **Offline Root CA → Online Root CA → Policy CA → Online Issuing CA** (Enterprise): Maximum security + policy flexibility

**Certificate Lifecycle**:

- **Issuance**: CSR validation, identity verification, generation, signing, publication
- **Renewal**: Pre-expiration notification (60/30/7 days), re-validation if required, new serial number
- **Revocation**: Request validation, reason determination, database update, CRL/OCSP publication, notification

**Key Ceremony Best Practices**:

- **Generation**: Multi-person control (≥3 custodians), ceremony script, witnessed, split knowledge, secure storage (HSM)
- **Backup**: Encrypted, split across locations, tamper-evident packaging, dual control access, regular testing
- **Destruction**: Multi-person authorization, secure deletion, audit trail, revoke all certificates

---

## Certificate Transparency (CT)

**MANDATORY for Public CAs**: Pre-certificate submission, SCT embedding (≥2 SCTs from different operators), CT log monitoring

---

## OCSP Stapling and Must-Staple

**OCSP Stapling**: Server fetches OCSP from CA, includes in TLS handshake (reduces client queries, improves performance/privacy)
**Must-Staple**: TLS Feature extension (id-pe-tlsfeature:5), forces OCSP stapling, client rejects if missing

---

## Certificate Pinning

**HPKP** (Public Key Pinning): ❌ DEPRECATED - Use Certificate Transparency + CAA DNS records + Expect-CT header instead

---

## CAA DNS Records - RECOMMENDED

**Certification Authority Authorization**: DNS record restricting which CAs can issue for domain, reduces mis-issuance risk

```dns
example.com. CAA 0 issue "ca.example.com"
example.com. CAA 0 issuewild "ca.example.com"
example.com. CAA 0 iodef "mailto:security@example.com"
```

CAs MUST check CAA before issuance (full domain hierarchy)

---

## Compliance Summary

**Subscriber Certificates MUST**:
✅ Serial ≥64 bits CSPRNG, non-sequential, >0, <2^159
✅ RSA ≥2048, ECDSA P-256/384, EdDSA, SHA-256/384/512 (NEVER MD5/SHA-1)
✅ Validity ≤398 days (post-2020-09-01)
✅ Extensions: Key Usage (critical), Extended Key Usage, SAN, AKI, SKI
✅ CRL/OCSP: Distribution points, update ≤7 days
✅ Audit logs: 7-year retention, tamper-evident

**CA Certificates MUST**:
✅ Basic Constraints: CA=TRUE, path length constraint
✅ Key Usage: Certificate Sign, CRL Sign (critical)
✅ AKI/SKI for chain validation

**Validation MUST**:
✅ Domain control: Within 30 days
✅ Organization identity: Within 13 months (OV/EV)
✅ CAA records: Checked before issuance
