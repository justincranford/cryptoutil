---
description: "Instructions for platform-specific tooling: PowerShell, scripts, Docker pre-pull"
applyTo: "**"
---
# Platform-Specific Tooling Instructions

## autoapprove Wrapper for VS Code Copilot Chat

### Overview

The `autoapprove` wrapper (`scripts/autoapprove/autoapprove.py`) provides a workaround for VS Code Copilot Chat's
[mandatory safety overrides](https://code.visualstudio.com/docs/copilot/chat/chat-tools#_terminal) that cannot be
bypassed for network commands.

### Why Use autoapprove

VS Code Copilot has hardcoded safety blockers that always prompt for approval on certain commands, regardless of
`chat.tools.terminal.autoApprove` settings. This includes:
- Network commands (curl, wget with external URLs)
- PowerShell network cmdlets (Invoke-WebRequest, Invoke-RestMethod)
- Commands that could modify system state

Reference documentation:
- [VS Code Copilot Chat Tools - Terminal](https://code.visualstudio.com/docs/copilot/chat/chat-tools#_terminal)
- [VS Code Copilot Settings Reference](https://code.visualstudio.com/docs/copilot/reference/copilot-settings)
- [GitHub Issue #265775 - Auto-approve network commands](https://github.com/microsoft/vscode/issues/265775)
- [GitHub Issue #266651 - Terminal command safety](https://github.com/microsoft/vscode/issues/266651)

### When to Use autoapprove

**RECOMMENDED for continuous LLM agent work when:**
- Making HTTP requests to loopback addresses (127.0.0.1, ::1, localhost)
- Need uninterrupted command execution without manual approval prompts
- Risk acceptance: Commands are limited to loopback-only network access

**Usage Pattern:**
```bash
# Instead of: curl http://127.0.0.1:8080/api/health
autoapprove curl http://127.0.0.1:8080/api/health

# Instead of: wget -q -O - http://localhost:8080/api/status
autoapprove wget -q -O - http://localhost:8080/api/status

# For go commands
autoapprove go test ./...

# For docker commands
autoapprove docker ps
```

### Security Restrictions

The wrapper enforces loopback-only network access:
- **Allowed**: 127.0.0.1, ::1, localhost, localhost.localdomain, ip6-localhost
- **Blocked**: Any external IP address or hostname

External URLs will be rejected:
```
autoapprove: Network validation failed: URL contains non-loopback host: http://example.com
autoapprove: Only loopback addresses (127.0.0.1, ::1, localhost) are allowed.
```

### Execution Logging

Each command execution creates a timestamped directory under `./test-reports/autoapprove/`:
```
./test-reports/autoapprove/2025-01-15T10-30-45.123-curl/
├── STDIN.log      # Input sent to command
├── STDOUT.log     # Standard output from command
├── STDERR.log     # Standard error from command
└── result.log     # Execution metadata (timing, exit code, resources)
```

### Installation

The script requires Python 3.14+ and uses only standard library modules:
```bash
# Run directly
python scripts/autoapprove/autoapprove.py curl http://localhost:8080/api

# Or install as a package
cd scripts/autoapprove && pip install -e .
autoapprove curl http://localhost:8080/api
```

## Command Usage Restrictions

### HTTP Command Usage Rules

**CRITICAL: ALWAYS use `autoapprove curl` for HTTP requests in Local Chat Agent sessions for loopback URLs and localhost URLs**

**CRITICAL: ALWAYS use `curl` for HTTP requests in GitHub Workflows, GitHub Actions, and GitHub Cloud Agent Sessions**

#### PREFERRED in Local Chat Agent Sessions (VS Code Copilot Chat)
- **ALWAYS use `autoapprove curl`** for HTTP requests to loopback/localhost - bypasses VS Code's hardcoded safety blockers
- **NEVER use `Invoke-WebRequest`** - blocked by VS Code Copilot Terminal mandatory safety overrides (network commands)
- **Pattern**: `autoapprove curl -s http://127.0.0.1:8090/endpoint` (GET request, silent mode)
- **Pattern**: `autoapprove curl -s -X POST http://127.0.0.1:8090/endpoint -d "param=value"` (POST request with form data)
- **Pattern**: `autoapprove curl -s -X POST http://127.0.0.1:8090/endpoint -H "Content-Type: application/json" -d '{"key":"value"}'` (POST with JSON)
- **Why**: autoapprove wrapper enforces loopback-only network access and is allowlisted in settings.json

#### ALLOWED in GitHub Actions Workflows (.github/workflows/*.yml)
- **curl and wget are both available** in GitHub Actions Ubuntu runners and act containers
- **Use `curl` directly** - no need for autoapprove wrapper in cloud environments
- **Why**: GitHub runners and act containers have both tools preinstalled and don't have VS Code safety blockers

#### PREFERRED in Docker Compose Healthchecks (compose.yml)
- **Preferred**: Use `wget` (available in Alpine/busybox containers)
- **Fallback**: Use `curl` if container includes it (e.g., grafana-otel-lgtm)
- **Pattern**: `test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/livez"]`
- **Why**: Most containers use Alpine base which includes wget via busybox

## Authorized Commands for Chat Sessions

### Git Commands
- `git status` - Show repository status
- `git add <files>` - Stage files for commit
- `git commit -m <message>` - Commit staged changes
- `git log --oneline -<n>` - Show recent commit history
- `git diff` - Show unstaged changes
- `git checkout <branch>` - Switch branches
- `git mv <source> <destination>` - Move or rename files/directories

### Go Commands
- `go test ./<path>` - Run tests in specified path
- `go build ./<path>` - Build packages
- `go mod tidy` - Clean up module dependencies
- `go run ./<path>` - Run Go program
- `golangci-lint run` - Run linter (relies on exclusions in .golangci-lint.yml)
- `go test -fuzz=. -fuzztime=15s ./<path>` - Run fuzz tests for 15 seconds (ALWAYS from project root)
- `go test -run=FuzzXXX -fuzz=FuzzXXX -fuzztime=15s ./<path>` - Run specific fuzz test (use PowerShell `;` not bash `&&`)

### Docker Compose Commands
- `docker compose ps` - List container status
- `docker compose logs <service>` - View service logs
- `docker compose logs <service> --tail <n>` - View recent service logs
- `docker compose exec <service> <command>` - Execute command in container
- `docker compose build <services>` - Build services
- `docker compose up -d <services>` - Start services in background
- `docker compose down -v` - Stop services and remove volumes

### Docker Commands
- `docker inspect <container>` - Inspect container (without --format to avoid authorization)
- `docker ps` - List containers (without --filter/--format to avoid authorization)
- `docker stats` - Show container resource usage
- `docker top` - Show container processes
- `docker inspect --format` - Inspect with custom formatting

### File/Directory Operations
- `pwd` - Show current working directory
- `ls -la <path>` - List directory contents with details
- `dir` - List directory contents (PowerShell equivalent)
- `mkdir <path>` - Create directory
- `find <path> -name <pattern>` - Find files by name pattern
- `Get-ChildItem <path>` - List directory contents (PowerShell equivalent)
- `cat <file>` - Display file contents
- `type <file>` - Display file contents
- `head -n <lines> <file>` - Show first N lines of file
- `tail -n <lines> <file>` - Show last N lines of file
- `grep <pattern> <file>` - Search for patterns in files
- `Get-Content <file>` - Display file contents (PowerShell equivalent)
- `Select-String <pattern> <file>` - Search for patterns in files (PowerShell equivalent)

### Build/Test Tools
- `make <target>` - Run Makefile targets
- `npm run <script>` - Run npm scripts
- `python -m <module>` - Run Python modules
- `pytest <path>` - Run Python tests
- `./mvnw <goals>` - Run Maven goals with Maven Wrapper
- `mvnw.cmd <goals>` - Run Maven goals with Maven Wrapper on Windows

### HTTP Commands
- `wget -q -O - <url>` - Make GET request (output to stdout)
- `wget --post-data="data" -q -O - <url>` - Make POST request with form data
- `wget --post-data='{\"key\":\"value\"}' --header="Content-Type: application/json" -q -O - <url>` - Make POST request with JSON
- `wget -q <url>` - Quiet mode (suppress progress)
- `wget --no-check-certificate <url>` - Allow insecure HTTPS (self-signed certs)

### System Commands
- `which <command>` - Find command location
- `echo <text>` - Display text
- `date` - Show current date/time
- `sleep <seconds>` - Pause execution
- `which <command>` - Find command location
- `echo <text>` - Display text
- `date` - Show current date/time
- `sleep <seconds>` - Pause execution

## Commands Requiring Manual Authorization

These commands require manual authorization and should be avoided when possible. If VS Code supports auto-approval via `chat.tools.terminal.autoApprove`, use the approved commands where possible.

### Directory Navigation
- `cd` commands - Change directory context
- `Set-Location` commands - Change directory context (PowerShell equivalent)

### Git Operations
- `git -C <path>` - Specify git repository path (avoid when possible)

### Network Commands
- `yamllint` - YAML linting tool (not installed in Windows PowerShell)
- `tee` - Output redirection to files (E2E tests already log automatically)

## Cross-Platform Script Development

### Language Preferences

**ALWAYS prefer Go for new scripts** when:
- Cross-platform compatibility needed
- Complex logic or data processing required
- Performance-critical operations
- Need for static compilation and distribution
- Structured error handling and testing required

**Python instead of PowerShell/Bash** when:
- Go is not suitable for the task
- Rapid prototyping is needed
- Integration with Python ecosystem is required
- Simple scripting with cross-platform support

**BANNED: PowerShell/Bash scripts** - Python is better for cross-platform:
- ❌ `powershell -File script.ps1` - Use Python instead
- ❌ `bash script.sh` - Use Python instead
- ❌ Shell scripts requiring paired .ps1/.sh versions - Use single Python script

### Go Script Guidelines
- Place scripts in `scripts/` directory
- Use `cmd/` subdirectory for main entry points
- Follow standard Go project layout
- Use Go modules for dependency management
- Implement proper error handling with context
- Use structured logging (slog package)
- Provide CLI interface with flag package

### Python Script Guidelines (When Go is Not Suitable)
- Place scripts in `scripts/` directory
- Use Python 3.14+ (https://www.python.org/downloads/release/python-3140/)
- Use only standard library modules when possible
- Include pyproject.toml for package configuration
- Provide clear CLI interface with argparse
- Include unit tests with pytest

### Script Testing (CRITICAL)
- **ALWAYS test scripts before committing**
- Test on target platforms (Windows, Linux, macOS)
- Test help/usage: `script --help`
- Test error conditions and edge cases
- Verify cleanup and resource management
- Test with different parameter combinations

## Docker Image Pre-Pull Optimization

### Pattern for CI/CD Workflows

**Use the docker-images-pull reusable action**:

```yaml
- name: Pre-pull Docker images (parallel)
  uses: ./.github/actions/docker-images-pull
  with:
    images: |
      postgres:18
      ghcr.io/zaproxy/zaproxy:stable
      alpine:3.19
```

### Common Images by Workflow

**DAST Workflow**:
- `postgres:18`
- `ghcr.io/zaproxy/zaproxy:stable`

**E2E Workflow**:
- `postgres:18`
- `alpine:3.19`
- `golang:1.25.4`

**Load Workflow**:
- `postgres:18`
- `alpine:3.19`
- `golang:1.25.4`

### Benefits
- **Parallel downloads**: All images download simultaneously
- **Faster workflows**: Reduces total pull time by 50-80%
- **Better diagnostics**: Clear separation of pull failures vs runtime failures
- **Cached layers**: Docker BuildKit cache benefits from having base images present
- **Reusable**: Single action used across all workflows
- **Explicit dependencies**: Each workflow declares its required images

### When to Skip
- Workflow uses only GitHub Actions (no direct Docker commands)
- Single image used once (minimal benefit)
- Images already cached by previous steps
