---
description: "Instructions for platform-specific tooling: PowerShell, scripts, Docker pre-pull"
applyTo: "**"
---
# Platform-Specific Tooling Instructions

## Command Usage Restrictions

### HTTP Command Usage Rules

**CRITICAL: ALWAYS use curl for HTTP requests in Copilot Chat sessions**

#### PREFERRED in Copilot Chat Sessions (Local Windows PowerShell)
- **ALWAYS use `curl`** for HTTP requests - allowlisted, auto-approved, and installed on Windows at `C:\Windows\System32\curl.exe`
- **NEVER use `Invoke-WebRequest`** - blocked by VS Code Copilot Terminal mandatory safety overrides (network commands)
- **NEVER use `wget`** - not installed on Windows by default
- **Pattern**: `curl -s http://127.0.0.1:8090/endpoint` (GET request, silent mode)
- **Pattern**: `curl -s -X POST http://127.0.0.1:8090/endpoint -d "param=value"` (POST request with form data)
- **Pattern**: `curl -s -X POST http://127.0.0.1:8090/endpoint -H "Content-Type: application/json" -d '{"key":"value"}'` (POST with JSON)
- **Why**: curl is allowlisted in settings.json, installed on Windows 10+, Invoke-WebRequest triggers VS Code mandatory safety overrides

#### ALLOWED in GitHub Actions Workflows (.github/workflows/*.yml)
- **curl and wget are both available** in GitHub Actions Ubuntu runners and act containers
- **Preferred**: wget with "--no-check-certificate" option for HTTPS endpoints
- **Why**: GitHub runners and act containers have both tools preinstalled

####  ALLOWED in Docker Compose Healthchecks (compose.yml)
- **Preferred**: Use `wget` (available in Alpine/busybox containers)
- **Fallback**: Use `curl` if container includes it (e.g., grafana-otel-lgtm)
- **Pattern**: `test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/livez"]`
- **Why**: Most containers use Alpine base which includes wget via busybox

## Authorized Commands for Chat Sessions

### Git Commands
- `git status` - Show repository status
- `git add <files>` - Stage files for commit
- `git commit -m <message>` - Commit staged changes
- `git log --oneline -<n>` - Show recent commit history
- `git diff` - Show unstaged changes
- `git checkout <branch>` - Switch branches
- `git mv <source> <destination>` - Move or rename files/directories

### Go Commands
- `go test ./<path>` - Run tests in specified path
- `go build ./<path>` - Build packages
- `go mod tidy` - Clean up module dependencies
- `go run ./<path>` - Run Go program
- `golangci-lint run` - Run linter (relies on exclusions in .golangci-lint.yml)
- `go test -fuzz=. -fuzztime=15s ./<path>` - Run fuzz tests for 15 seconds (ALWAYS from project root)
- `go test -run=FuzzXXX -fuzz=FuzzXXX -fuzztime=15s ./<path>` - Run specific fuzz test (use PowerShell `;` not bash `&&`)

### Docker Compose Commands
- `docker compose ps` - List container status
- `docker compose logs <service>` - View service logs
- `docker compose logs <service> --tail <n>` - View recent service logs
- `docker compose exec <service> <command>` - Execute command in container
- `docker compose build <services>` - Build services
- `docker compose up -d <services>` - Start services in background
- `docker compose down -v` - Stop services and remove volumes

### Docker Commands
- `docker inspect <container>` - Inspect container (without --format to avoid authorization)
- `docker ps` - List containers (without --filter/--format to avoid authorization)
- `docker stats` - Show container resource usage
- `docker top` - Show container processes
- `docker inspect --format` - Inspect with custom formatting

### File/Directory Operations
- `pwd` - Show current working directory
- `ls -la <path>` - List directory contents with details
- `dir` - List directory contents (PowerShell equivalent)
- `mkdir <path>` - Create directory
- `find <path> -name <pattern>` - Find files by name pattern
- `Get-ChildItem <path>` - List directory contents (PowerShell equivalent)
- `cat <file>` - Display file contents
- `type <file>` - Display file contents
- `head -n <lines> <file>` - Show first N lines of file
- `tail -n <lines> <file>` - Show last N lines of file
- `grep <pattern> <file>` - Search for patterns in files
- `Get-Content <file>` - Display file contents (PowerShell equivalent)
- `Select-String <pattern> <file>` - Search for patterns in files (PowerShell equivalent)

### Build/Test Tools
- `make <target>` - Run Makefile targets
- `npm run <script>` - Run npm scripts
- `python -m <module>` - Run Python modules
- `pytest <path>` - Run Python tests
- `./mvnw <goals>` - Run Maven goals with Maven Wrapper
- `mvnw.cmd <goals>` - Run Maven goals with Maven Wrapper on Windows

### HTTP Commands
- `wget -q -O - <url>` - Make GET request (output to stdout)
- `wget --post-data="data" -q -O - <url>` - Make POST request with form data
- `wget --post-data='{\"key\":\"value\"}' --header="Content-Type: application/json" -q -O - <url>` - Make POST request with JSON
- `wget -q <url>` - Quiet mode (suppress progress)
- `wget --no-check-certificate <url>` - Allow insecure HTTPS (self-signed certs)

### System Commands
- `which <command>` - Find command location
- `echo <text>` - Display text
- `date` - Show current date/time
- `sleep <seconds>` - Pause execution
- `which <command>` - Find command location
- `echo <text>` - Display text
- `date` - Show current date/time
- `sleep <seconds>` - Pause execution

## Commands Requiring Manual Authorization

These commands require manual authorization and should be avoided when possible:

### Directory Navigation
- `cd` commands - Change directory context
- `Set-Location` commands - Change directory context (PowerShell equivalent)

### Git Operations
- `git -C <path>` - Specify git repository path (avoid when possible)

### Network Commands
- `yamllint` - YAML linting tool (not installed in Windows PowerShell)
- `tee` - Output redirection to files (E2E tests already log automatically)

## PowerShell Command Restrictions

**CRITICAL: NEVER use PowerShell scripts or complex command chaining in Copilot Chat sessions**

### BANNED Patterns (Require Manual Authorization)
- ❌ `powershell -File script.ps1` - PowerShell scripts require authorization
- ❌ `Set-ExecutionPolicy` - Policy changes require authorization
- ❌ Multi-command chaining with `;` - Complex chains require authorization
- ❌ Variable assignments in commands: `$var = cmd; $var` - Requires authorization
- ❌ Conditional execution: `if ($LASTEXITCODE -eq 0) { cmd2 }` - Requires authorization
- ❌ Pipeline to file: `cmd > file.txt` - Redirection requires authorization
- ❌ `Test-Path` in command chains - Requires authorization
- ❌ `Select-String` in pipelines - Requires authorization
- ❌ `Select-Object` filtering - Requires authorization

### ALLOWED Patterns (Auto-Approved)
- ✅ Single direct commands: `go test ./path`
- ✅ Commands with simple args: `go test ./path -v`
- ✅ Commands with single flag: `git status`
- ✅ `mkdir directory-name` - Simple directory creation
- ✅ `go tool cover -func=file` - Single tool invocation

### Workarounds for Complex Operations
- **Instead of**: `$coverage = go tool cover -func=file.out | Select-String pattern`
- **Use**: `go tool cover -func=file.out` (view full output, no filtering)
- **Instead of**: `if (!(Test-Path dir)) { mkdir dir }; go test`
- **Use**: Two separate tool calls: `mkdir dir` then `go test`
- **Instead of**: `cmd1; cmd2; cmd3` chaining
- **Use**: Three separate `run_in_terminal` calls

## Cross-Platform Script Development

### Language Preferences

**ALWAYS prefer Go for new scripts** when:
- Cross-platform compatibility needed
- Complex logic or data processing required
- Performance-critical operations
- Need for static compilation and distribution
- Structured error handling and testing required

**PowerShell/Bash appropriate** when:
- Platform-specific system administration tasks
- Quick automation of platform-specific workflows
- Simple file operations or environment setup

### Go Script Guidelines
- Place scripts in `scripts/` directory
- Use `cmd/` subdirectory for main entry points
- Follow standard Go project layout
- Use Go modules for dependency management
- Implement proper error handling with context
- Use structured logging (slog package)
- Provide CLI interface with flag package

### PowerShell/Bash Script Pairings
- Always provide both .ps1 and .sh versions
- Follow existing patterns (lint.ps1/lint.sh model)
- Ensure consistent functionality and parameter naming
- Provide consistent help/usage information
- Ensure executable permissions for Unix scripts

### Script Testing (CRITICAL)
- **ALWAYS test scripts before committing**
- Test both PowerShell and Bash versions on their platforms
- For PowerShell: Test with execution policy restrictions
- Test help/usage: `script.ps1 -Help` and `script.sh --help`
- Test error conditions and edge cases
- Verify cleanup and resource management
- Test with different parameter combinations

## Docker Image Pre-Pull Optimization

### Pattern for CI/CD Workflows

**Use the docker-images-pull reusable action**:

```yaml
- name: Pre-pull Docker images (parallel)
  uses: ./.github/actions/docker-images-pull
  with:
    images: |
      postgres:18
      ghcr.io/zaproxy/zaproxy:stable
      alpine:3.19
```

### Common Images by Workflow

**DAST Workflow**:
- `postgres:18`
- `ghcr.io/zaproxy/zaproxy:stable`

**E2E Workflow**:
- `postgres:18`
- `alpine:3.19`
- `golang:1.25.4`

**Load Workflow**:
- `postgres:18`
- `alpine:3.19`
- `golang:1.25.4`

### Benefits
- **Parallel downloads**: All images download simultaneously
- **Faster workflows**: Reduces total pull time by 50-80%
- **Better diagnostics**: Clear separation of pull failures vs runtime failures
- **Cached layers**: Docker BuildKit cache benefits from having base images present
- **Reusable**: Single action used across all workflows
- **Explicit dependencies**: Each workflow declares its required images

### When to Skip
- Workflow uses only GitHub Actions (no direct Docker commands)
- Single image used once (minimal benefit)
- Images already cached by previous steps
