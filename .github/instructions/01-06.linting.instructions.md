---
description: "Instructions for code quality, linting, and maintenance standards"
applyTo: "**"
---
# Linting and Code Quality Instructions

## MANDATORY: ALL Code Must Pass Linting

**ALL linting/formatting errors are MANDATORY to fix - NO EXCEPTIONS**
- Production code, test code, demos, examples, utilities - ALL must pass
- NEVER use `//nolint:` directives except for documented linter bugs
- NEVER downplay linting errors in tests/demos - fix them all
- wsl, errcheck, godot, etc apply equally to ALL code

## Core Rules
- UTF-8 without BOM for ALL text files (enforced by `cicd all-enforce-utf8`)
- Use `any` not `interface{}`; gofumpt (not gofmt); 4 spaces Go, 2 spaces YAML/JSON
- ALWAYS run `golangci-lint run --fix` FIRST - handles formatting, imports, auto-fixable linters
- FIX ALL issues before committing - no exceptions for tests, configs, docs

## golangci-lint v2 (v2.6.2)
**v2 Changes**:
- `wsl` → `wsl_v5` config key
- Removed: `wsl.force-err-cuddling`, `misspell.ignore-words`, `wrapcheck.ignoreSigs`
- gofumpt/goimports built-in with `--fix`

**Domain Isolation**: `go run ./cmd/cicd go-check-identity-imports` (identity module cannot import server/client/api packages)

## Critical Linter Rules
**wsl**: NEVER use `//nolint:wsl` - restructure code instead
- Group related statements without blank lines
- Add blank lines between different statement types

**godot**: ALWAYS end comments with periods
```go
// Package cryptoutil provides utilities.  // ✓
// NewCipher creates a cipher instance.    // ✓
```

**mnd**: Declare magic values as constants in `internal/common/magic/` or identity-specific `magic*.go`
```go
const defaultPort = 8080  // ✓
// NOT: server.Start(8080)  // ✗
```

## Linters with --fix Support
wsl, gofmt, goimports, gofumpt, godot, goconst, importas, copyloopvar, testpackage, revive

## Linters Requiring Manual Fix
errcheck, gosimple, govet, ineffassign, staticcheck, unused, gosec, noctx, wrapcheck, thelper, tparallel, gomodguard, prealloc, bodyclose, errorlint, stylecheck

## Batch Lint Fixing Strategy
When fixing many lint issues, use `multi_replace_string_in_file` tool for efficiency:
- Group similar fixes (e.g., all copyright headers, all godot comment fixes)
- Apply up to 10 related replacements per tool call
- Verify with `golangci-lint run --fix` after batch edits

## detect-secrets (prefer gosec)
Inline allowlist: `// pragma: allowlist secret`

## Pre-commit Hook Doc Maintenance
When modifying `.pre-commit-config.yaml`, `.golangci.yml`, or `internal/cmd/cicd/cicd.go`, update `docs/pre-commit-hooks.md`
