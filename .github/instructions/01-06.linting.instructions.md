---
description: "Instructions for code quality, linting, and maintenance standards"
applyTo: "**"
---
# Linting and Code Quality Instructions

## Text File Encoding

**CRITICAL: UTF-8 without BOM for ALL text files**

- **Enforced by**: `cicd all-enforce-utf8` command
- **Why**: PowerShell's default UTF-16 LE breaks Docker Compose secrets (PostgreSQL secrets)
- **PowerShell file creation**:
  ```powershell
  $utf8NoBom = New-Object System.Text.UTF8Encoding $false
  [System.IO.File]::WriteAllText("file.txt", "content", $utf8NoBom)
  ```
- **NEVER use**: `Out-File`, `Set-Content`, or `>` redirection (default to UTF-16 LE with BOM)

## Go Formatting Standards

- **Encoding**: UTF-8 without BOM, single newline at EOF, no trailing whitespace
- **Indentation**: 4 spaces (Go), 2 spaces (YAML, JSON, Markdown, Dockerfile)
- **Types**: Use `any` not `interface{}`
- **Tool**: gofumpt (strict superset of gofmt)
- **Auto-formatting**: Use `golangci-lint run --fix` (runs gofumpt automatically)

## Linter Compliance

### Critical Rules

- **ALWAYS rely on golangci-lint exclusions in `.golangci.yml`** - never use --skip-files or --skip-dirs flags
- **ALWAYS use `golangci-lint run --fix` FIRST** before manual fixing - handles formatting, imports, and auto-fixable linters in one pass
- **gofumpt is ALWAYS preferred over gofmt** - stricter superset with additional rules; NEVER use `gofmt` directly
- **Pre-commit hooks automatically run `golangci-lint run --fix`** - no need for standalone gofumpt/goimports commands

### Automatic Fixing with --fix

**Primary auto-fix tool** - runs all auto-fixable linters:

```bash
# Fix all auto-fixable linting issues
golangci-lint run --fix

# Fix specific linters only
golangci-lint run --enable-only=wsl,gofmt,goimports,gofumpt --fix

# Fix issues in specific files
golangci-lint run --fix path/to/file.go
```

**Pre-commit hooks handle formatting/imports automatically. Manual usage for:**
- Quick fixes during development
- Testing specific linter configurations
- Debugging linting issues

### CRITICAL: wsl Linter Compliance - NO SUPPRESSIONS ALLOWED

**NEVER use `//nolint:wsl` directives** - strictly prohibited

**WHY**:
- Enforces consistent whitespace that improves readability
- Suppressions hide code style issues and create technical debt
- Proper code structure satisfies wsl without suppressions

**REQUIRED APPROACH**:
1. **Restructure code** to satisfy wsl requirements (primary solution)
2. **Group related statements** without blank lines (assignments with assignments, declarations with declarations)
3. **Add blank lines** between different statement types for clarity
4. **Never suppress** - if wsl complains, the code structure needs improvement

**COMMON wsl PATTERNS**:
- Group variable declarations together without blank lines between them
- Separate variable declarations from other statement types with blank lines
- Keep error checks immediately after function calls without blank lines
- Separate logical blocks of code with blank lines for readability

**RATIONALE**: Code that satisfies wsl is more readable and maintainable

### CRITICAL: godot Comment Period Requirements

**ALWAYS end comments with periods**:

- **Package comments**: `// Package cryptoutil provides cryptographic utilities.`
- **Function comments**: `// NewCipher creates a new cipher instance.`
- **Variable comments**: `// defaultTimeout is the default request timeout.`
- **Constant group comments**: `// HTTP status codes.`
- **Struct field comments**: `// Name is the user's full name.`

**Pattern for constant groups:**
```go
const (
    // HTTP status codes.
    statusOK    = 200
    statusError = 500

    // Database connection settings.
    maxConnections = 10
    timeoutSeconds = 30
)
```

**NEVER use incomplete sentences** - always ensure complete thoughts ending with periods

### Magic Number Detector (mnd)

**ALWAYS declare values as constants near top of file** to mitigate mnd linter errors:

- **HTTP status codes**: `http.StatusOK`, `http.StatusNotFound` instead of `200`, `404`
- **Durations**: `timeout = 30 * time.Second` instead of inline `30000`
- **Special strings**: `statusPass = "PASS"` instead of inline strings
- **Special numbers**: `rsaKeySize2048 = 2048`, `aes256KeySize = 256`
- **Port numbers**: `publicPort = 8080`, `privateAdminPort = 9090`
- **Common counts**: `maxRetries = 3` instead of `3`
- **File permissions**: `fileMode = 0o600`, `dirMode = 0o755`

**Magic values management**: Define in `cryptoutilMagic` package files (`internal/common/magic/magic_*.go`)

### Linters Supporting Automatic Fixing

- **wsl**: Whitespace consistency (blank lines between statements)
- **gofmt**: Go code formatting
- **goimports**: Import organization and formatting
- **godot**: Adds missing periods to documentation comments
- **goconst**: Creates named constants for repeated strings
- **importas**: Fixes import aliases to match configured rules
- **copyloopvar**: Fixes loop variable capture issues
- **testpackage**: Renames test packages to follow conventions
- **revive**: Fixes various style and code quality issues

### Linters Requiring Manual Fixing

- **errcheck**: Always check error return values. Never ignore with `_` unless documented why
- **gosimple**: Code simplifications (manual review required)
- **govet**: Reports suspicious constructs
- **ineffassign**: Detect ineffectual assignments
- **staticcheck**: Advanced static analysis checks
- **unused**: Find unused constants, variables, functions, types
- **gosec**: Security-focused analysis - **USE THIS INSTEAD OF detect-secrets**
- **noctx**: Check for missing context in HTTP requests
- **wrapcheck**: Check error wrapping consistency
- **thelper**: Check test helper functions
- **tparallel**: Check for parallel test issues
- **gomodguard**: Prevent importing blocked modules
- **prealloc**: Find slice declarations that could pre-allocate
- **bodyclose**: Check for HTTP response body closure
- **errorlint**: Find code causing problems with Go 1.13 error wrapping
- **stylecheck**: Go style guide compliance

### detect-secrets Inline Allowlisting

**When using detect-secrets (prefer gosec instead)**, use inline allowlisting:

**Preferred (Go):**
```go
intermediateCASubject, err := CreateCASubject(...) // pragma: allowlist secret
```

**Alternative:**
```go
// pragma: allowlist nextline secret
const secret = "hunter2";
```

**Supported comment styles:**
- `# pragma: allowlist secret` (Python/shell)
- `// pragma: allowlist secret` (Go/JavaScript/C++) - **PREFERRED for Go**
- `/* pragma: allowlist secret */` (multi-line)

**When to use**: Only for legitimate test code or configuration referencing cryptographic materials

### cicd.go Special Case

**CRITICAL**: `cicd.go` and `cicd_test.go` contain deliberate lint violations for testing

- These files MUST exclude themselves from directory walks
- Avoids self-referencing and self-modifying during auto-fixing
- All other golangci-lint validations still performed on both files

## Code Quality Standards

- Implement proper resource cleanup (defer statements for HTTP bodies, files, etc.)
- Maintain clear function boundaries (avoid high cyclomatic complexity)
- Remove unused code and parameters
- Validate input parameters in mapper and utility functions
- Wrap all external package errors with context using fmt.Errorf and %w verb (satisfies wrapcheck)
- Use Go context for HTTP requests and long-running operations (satisfies noctx)
- Follow maintenance guidelines: immediately remove completed/obsolete tasks from actionable lists

## Pre-commit Hook Documentation Maintenance

**CRITICAL**: When modifying these files, review and update `docs/pre-commit-hooks.md`:

- `.pre-commit-config.yaml` - Hook ordering, tool configuration, exclusions
- `.golangci.yml` - Linter configuration, enabled/disabled linters, severity
- `.gofumpt.toml` - Go formatting rules and module path
- `.gremlins.yaml` - Mutation testing configuration
- `internal/cmd/cicd/cicd.go` - Test pattern enforcement logic
- `scripts/setup-pre-commit.ps1` / `setup-pre-commit.bat` - Setup scripts
- `.vscode/settings.json` - VS Code integration with pre-commit tools

**What to update in docs/pre-commit-hooks.md:**
- Tool ordering changes in pipeline flow diagram and stage breakdown table
- New/removed tools in configuration sections
- Parameter changes in tool-specific sections (args, exclusions, files patterns)
- Integration changes (VS Code settings, golangci-lint config references)
- New troubleshooting guidance for common issues

**Pre-commit Configuration Guidelines:**
- **NEVER use shell commands** (`sh`, `bash`, `powershell`) in pre-commit configurations
- Use cross-platform tools directly (e.g., `go`, `python`) or pre-commit's built-in hooks
- Ensure all hooks work on Windows, Linux, and macOS without shell dependencies
