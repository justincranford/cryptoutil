---
description: "Instructions for Dynamic Application Security Testing (DAST): Nuclei scanning, ZAP testing, and workflow execution"
applyTo: "**"
---
# Dast

# DAST Instructions - Tactical Guidance

**This file contains ONLY tactical implementation patterns**

## Variable Expansion in Heredocs - CRITICAL

**ALWAYS use `${VAR}` syntax (curly braces), NEVER `$VAR`**:

```yaml
- name: Generate config
  run: |
    cat > config.yml <<EOF
    database-url: "postgres://${POSTGRES_USER}:${POSTGRES_PASS}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_NAME}"
    EOF

    # Verification step (MANDATORY)
    cat config.yml
```

**Historical Mistake**: ci-dast used `$POSTGRES_USER` instead of `${POSTGRES_USER}` → wrote literal "$POSTGRES_USER" to config → PostgreSQL error "role 'root' does not exist"

## Debugging PostgreSQL Issues

1. Download workflow artifacts (container logs, PostgreSQL logs)
2. Check PostgreSQL logs for "FATAL: role '<username>' does not exist"
3. Verify credentials and config generation output (`cat config.yml`)
4. Verify variable expansion (ensure `${VAR}` expanded, not literal `$VAR`)

## Nuclei Scanning Commands

**Prerequisites** (start services first):

```bash
docker compose -f ./deployments/compose/compose.yml up -d
sleep 30
```

**Quick scan** (info/low):

```bash
nuclei -target https://localhost:8080/ -severity info,low
```

**Comprehensive scan** (medium/high/critical):

```bash
nuclei -target https://localhost:8080/ -severity medium,high,critical
```

**Performance-optimized**:

```bash
nuclei -target https://localhost:8080/ -c 25 -rl 100 -severity high,critical
```

## CI-DAST Lessons Learned - CRITICAL

### Variable Expansion in Heredocs - MANDATORY

**ALWAYS use `${VAR}` (curly braces) for variable expansion in Bash heredocs**

**Rules**: ✅ Use `${VAR}`, verify expanded values, include `cat config.yml` in workflow ❌ Use `$VAR`, skip verification

**Historical Mistake**: ci-dast used `$POSTGRES_USER` → literal "$POSTGRES_USER" in config → "role 'root' does not exist" (27+ errors)

**Variables Affected**: 7 (POSTGRES_USER, POSTGRES_PASS, POSTGRES_HOST, POSTGRES_PORT, POSTGRES_NAME, APP_BIND_PUBLIC_ADDRESS, APP_BIND_PUBLIC_PORT)

## Debugging Workflow PostgreSQL Issues

**Checklist**: Download artifacts, check PostgreSQL logs for "role '<username>' does not exist", verify credentials match, check config generation for literal $VAR strings, verify variable expansion, compare with working workflows (ci-coverage, ci-mutation, ci-race)

**Evidence Pattern**: 27+ errors over 5 min (persistent config) + every 10s (health retry) + PostgreSQL startup OK (credentials issue) + literal "$VAR" in logs (expansion issue)

## Preventive Checklist

- [ ] PostgreSQL credentials: cryptoutil_test/cryptoutil/cryptoutil_test_password
- [ ] Workflow env vars match PostgreSQL service env vars
- [ ] Config generation uses `${VAR}` (curly braces) for ALL variables
- [ ] Config verification step (`cat config.yml`) in workflow
- [ ] Health check configured (pg_isready, interval 10s)

---

## Nuclei Vulnerability Scanning

**Prerequisites**: Start services first (`docker compose up -d`), wait for health checks (30s)

**Quick Scan**: `nuclei -target https://localhost:8080/ -severity info,low` (1-2 min)
**Comprehensive**: `nuclei -target https://localhost:8080/ -severity medium,high,critical` (5-15 min)
**Targeted**: `nuclei -target URL -tags cves,xss,sqli,misconfig,auth`
**Performance**: `nuclei -target URL -c 25 -rl 100 -severity high,critical`

**Update Templates**: `nuclei -update-templates` (before each scan)

## OWASP ZAP Dynamic Testing

**Baseline**: `docker run --network host owasp/zap2docker-stable zap-baseline.py -t URL -r report.html` (5-10 min, passive)
**Full Scan**: `docker run --network host owasp/zap2docker-stable zap-full-scan.py -t URL -r report.html` (30-60 min, active)
**API Scan**: `docker run --network host -v $(pwd)/api:/zap/wrk:rw owasp/zap2docker-stable zap-api-scan.py -t URL/swagger/doc.json -f openapi -r report.html`
