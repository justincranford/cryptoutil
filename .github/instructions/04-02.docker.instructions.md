---
description: "Instructions for Docker and Docker Compose configuration"
applyTo: "**"
---
# Docker Configuration Instructions - Tactical Guidance

**Reference**: See `.specify/memory/docker.md` for complete specifications (multi-stage builds, secrets validation, Docker Compose latency optimization, networking, expected startup times)

**This file contains ONLY tactical implementation patterns**

## Core Rules Quick Reference

- Use `docker compose` (NOT `docker-compose`)
- ALWAYS use relative paths in compose.yml (NEVER absolute paths)
- Docker secrets MUST have 440 permissions (r--r-----)
- ALWAYS use `127.0.0.1` in containers (NOT `localhost`)
- Use `wget` for healthchecks (available in Alpine)

## Multi-Stage Build Pattern

```dockerfile
# Global ARGs at top
ARG GO_VERSION=1.25.5
ARG VCS_REF
ARG BUILD_DATE

# Builder stage
FROM golang:${GO_VERSION}-alpine AS builder
WORKDIR /src
# Build logic...

# Validator stage (secrets validation MANDATORY)
FROM alpine:3.19 AS validator
WORKDIR /validation
RUN echo "üîç Validating Docker secrets..." && \
    # Validation logic for secrets existence and permissions

# Runtime stage
FROM alpine:3.19 AS runtime
WORKDIR /app
ARG VCS_REF
ARG BUILD_DATE
LABEL org.opencontainers.image.revision="${VCS_REF}"
COPY --from=validator /app/cryptoutil /app/cryptoutil
```

## Docker Compose Latency Optimization

**Single Build, Shared Image**:
```yaml
builder:
  build: ./
  image: cryptoutil:local

cryptoutil-postgres-1:
  image: cryptoutil:local  # Reuses built image (prevents 3√ó build time)
```

**Schema Init by First Instance**:
```yaml
cryptoutil-postgres-2:
  depends_on:
    cryptoutil-postgres-1:
      condition: service_healthy  # Waits for schema init
```

## Service Ports Quick Reference

| Service | Public API | Admin API | Backend |
|---------|-----------|-----------|---------|
| kms-sm-sqlite | 8080 | 9090 | SQLite in-memory |
| kms-sm-postgres-1 | 8081 | 9090 | PostgreSQL (APP) |
| kms-sm-postgres-2 | 8082 | 9090 | PostgreSQL (APP) |
| kms-sm-postgres | 5432 | - | PostgreSQL (DB) |
| otel-collector | 4317 (gRPC), 4318 (HTTP) | 13133 | - |
| grafana-otel-lgtm | 3000 | - | Loki/Tempo/Prometheus |

## Config Files

- `cryptoutil-common.yml`: Shared settings (TLS, unseal, security) - affects ALL instances
- `cryptoutil-sqlite.yml`, `cryptoutil-postgresql-{1,2}.yml`: Instance-specific (CORS, OTLP service/hostname)
- Instance config values MUST be unique and match service name in compose.yml
