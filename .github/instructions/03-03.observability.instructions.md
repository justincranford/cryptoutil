---
description: "Instructions for observability and monitoring implementation"
applyTo: "**"
---
# Observability and Monitoring Instructions

- Use [OpenTelemetry](https://opentelemetry.io/docs/collector/configuration/) for tracing, metrics, logging
- Use structured logging, OTLP export, health endpoints, Prometheus metrics, proper log levels, no sensitive data

## Telemetry Forwarding Architecture

**MANDATORY**: All telemetry from cryptoutil services MUST be forwarded through the otel-contrib sidecar (opentelemetry-collector-contrib) to upstream telemetry platforms (e.g., grafana-otel-lgtm).

### Push-Based Telemetry Flow

**Application Telemetry (Push-based):**
```
cryptoutil services (OTLP gRPC:4317 or HTTP:4318) → OpenTelemetry Collector Contrib → Grafana-OTEL-LGTM (OTLP gRPC:14317 or HTTP:14318)
```
- **Purpose**: Business application traces, logs, and metrics
- **Protocol**: OTLP (OpenTelemetry Protocol) - push-based
- **Supported Protocols**:
  - **GRPC Protocol**: `grpc://host:port` - Efficient binary protocol for high-performance telemetry
  - **HTTP Protocol**: `http://host:port` or `https://host:port` - Universal compatibility, firewall-friendly
- **Configuration Guidelines**:
  - Use GRPC for internal service-to-service communication (default, more efficient)
  - Use HTTP for environments with restrictive firewalls or universal compatibility needs
  - Both protocols support traces, metrics, and logs
  - Endpoint format: `protocol://hostname:port` (e.g., `grpc://otel-collector:4317`, `http://otel-collector:4318`)
- **Data**: Crypto operations, API calls, business logic telemetry

**Collector Self-Monitoring:**
```
OpenTelemetry Collector Contrib (internal) → Grafana-OTEL-LGTM (OTLP HTTP:14318)
```
- **Purpose**: Monitor collector health and performance
- **Protocol**: OTLP - push-based (collector exports its own telemetry)
- **Data**: Collector throughput, error rates, queue depths, resource usage

### Architecture Flow:
```
cryptoutil services → opentelemetry-collector (sidecar) → upstream telemetry platforms
```

### Configuration Requirements:
- `cryptoutil-otel.yml` MUST point to `opentelemetry-collector:4317`
- **NEVER** configure cryptoutil to bypass otel-collector-contrib sidecar
- The otel-contrib sidecar handles processing, filtering, and routing before forwarding to upstream platforms
- **Grafana receives telemetry only** - no Prometheus scraping of collector metrics

### Rationale:
- Ensures centralized telemetry processing and filtering
- Maintains consistent architecture across environments
- Enables future enhancements (sampling, aggregation, etc.) in the sidecar layer
- Prevents direct coupling between application services and telemetry platforms
