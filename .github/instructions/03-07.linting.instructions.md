---
description: "Code quality, linting, and maintenance"
applyTo: "**"
---
# Linting

# Linting and Code Quality - Tactical Guidance

## MANDATORY: Zero Linting Errors

**ALL code must pass linting - NO EXCEPTIONS** (production, tests, demos, examples, utilities)

- NEVER use `//nolint:` except for documented linter bugs with GitHub issue reference
- ALWAYS run `golangci-lint run --fix` FIRST (handles formatting, imports, auto-fixable linters)
- FIX ALL issues before committing (no exceptions for any code)

**Pre-Commit Hooks**: Run same linters and formatters as CI/CD workflows (golangci-lint, gofumpt, goimports). See [.pre-commit-config.yaml](.pre-commit-config.yaml) for complete hook configuration.

## Quick Reference: golangci-lint v2

**Current Version**: v2.7.2 (minimum)

**v2 Changes**:

- `wsl` → `wsl_v5` config key
- Built-in gofumpt/goimports with `--fix`
- Removed: `wsl.force-err-cuddling`, `misspell.ignore-words`, `wrapcheck.ignoreSigs`

## Critical Rules

**wsl**: NEVER use `//nolint:wsl` - restructure code to group related logic
**godot**: ALWAYS end comments with periods (auto-fixable)
**mnd**: Declare magic values in `internal/common/magic/` or package-specific `magic*.go`

## Linter Categories

**Auto-Fixable** (--fix): wsl, gofmt, gofumpt, goimports, godot, goconst, importas, copyloopvar, testpackage, revive
**Manual-Fix**: errcheck, gosimple, govet, ineffassign, staticcheck, unused, gosec, noctx, wrapcheck, thelper, tparallel, gomodguard, prealloc, bodyclose, errorlint, stylecheck

## Domain Isolation Check

```bash
# Verify identity module cannot import server/client/api
go run ./cmd/cicd go-check-identity-imports
```

## MANDATORY: Zero Linting Errors Policy

**ALL code must pass linting - NO EXCEPTIONS** (production, tests, demos, examples, utilities, config files)

**NEVER use `//nolint:`** except for documented linter bugs with GitHub issue reference
**UTF-8 without BOM**: MANDATORY for ALL text files (`cicd all-enforce-utf8` pre-commit hook)

---

## golangci-lint v2 Configuration

**v2 Breaking Changes**:

| v1.x | v2.x | Notes |
|------|------|-------|
| `wsl` | `wsl_v5` | Config key renamed |
| `wsl.force-err-cuddling` | Removed | Always enabled in v2 |
| `misspell.ignore-words` | Removed | Use allowlist |
| `wrapcheck.ignoreSigs` | Removed | Use ignorePackageGlobs |

**Built-in Formatters**: `--fix` applies gofumpt + goimports automatically

**Workflow**:

```bash
golangci-lint run --fix  # Auto-fix formatters + auto-fixable linters
golangci-lint run        # Check remaining manual fixes
git commit -m "style: fix linting issues"
```

---

## Critical Linter Rules

### wsl (whitespace linter)

**NEVER use `//nolint:wsl`** - restructure code instead

- Group related statements (no blank lines within)
- Separate different statement types (blank lines between)
- Cuddling rules enforced

### godot (comment period linter)

**ALWAYS end comments with periods** (auto-fixable with `--fix`)

### mnd (magic number detector)

**Declare magic values as named constants**:

- Shared: `internal/common/magic/magic_*.go`
- Package-specific: `internal/<package>/magic*.go`

**See**: `03-03.golang.instructions.md` for magic values organization

### importas (import alias enforcement)

**Enforce consistent aliases** (`.golangci.yml`):

```yaml
importas:
  alias:
    - pkg: crypto/rand
      alias: crand
    - pkg: github.com/google/uuid
      alias: googleUuid
    - pkg: github.com/go-jose/go-jose/v4
      alias: jose
```

**See**: `03-03.golang.instructions.md` for complete import alias conventions

---

## Linter Categories

**Auto-Fixable** (--fix support): gofmt, gofumpt, goimports, wsl, godot, goconst, importas, copyloopvar, testpackage, revive

**Manual-Fix**:

- **Error Handling**: errcheck, wrapcheck, errorlint
- **Code Quality**: gosimple, govet, ineffassign, staticcheck, unused
- **Security**: gosec
- **Testing**: thelper, tparallel, noctx
- **Dependencies**: gomodguard, prealloc
- **HTTP**: bodyclose
- **Style**: stylecheck

---

## Domain Isolation Enforcement

**Rule**: `internal/identity/*` CANNOT import `internal/server/*`, `internal/client/*`, `api/*`

```bash
go run ./cmd/cicd go-check-identity-imports  # Verify domain isolation
```

**Rationale**: Domain layer MUST NOT depend on presentation/infrastructure layers

**Allowed Identity Imports**:

- ✅ `internal/identity/*` → `internal/identity/*` (same domain)
- ✅ `internal/identity/*` → `internal/shared/*` (shared utilities)
- ✅ `internal/identity/*` → `pkg/*` (public libraries)
- ❌ `internal/identity/*` → `internal/server/*`, `api/*` (FORBIDDEN)

---

## Batch Lint Fixing

**Use `multi_replace_string_in_file` for efficiency** (up to 10 similar fixes per batch)

**Workflow**:

1. Run `golangci-lint run` → identify issues
2. Group similar issues (godot, copyright headers)
3. Apply batch replacements (≤10 files per call)
4. Verify with `golangci-lint run --fix`
5. Repeat for next batch

---

## Secret Detection

**Preference**: Use `gosec` (part of golangci-lint)

- G401: Detect weak cryptographic algorithms (MD5, DES)
- G501: Import blocklist
- G505: Detect weak random number generation (math/rand)

**Suppressions MUST include justification**:

```go
// #nosec G401 -- MD5 used for non-cryptographic checksums only
hash := md5.New()
```

---

## Pre-commit Hook Documentation

**When modifying these files, update `docs/pre-commit-hooks.md`**:

- `.pre-commit-config.yaml` - Hook configuration
- `.golangci.yml` - Linter settings
- `internal/cmd/cicd/cicd.go` - CICD tool logic

**Commit both together**:

```bash
git add .pre-commit-config.yaml docs/pre-commit-hooks.md
git commit -m "ci: update pre-commit hooks and documentation"
```

---

## Key Takeaways

1. **Zero Exceptions**: ALL code must pass linting (no special cases for demos/tests)
2. **Always --fix First**: Run `golangci-lint run --fix` before manual fixes
3. **wsl Restructure**: Never suppress wsl, restructure code to group related logic
4. **godot Periods**: Always end comments with periods (auto-fixable)
5. **Magic Constants**: Declare in `internal/common/magic/` or package `magic*.go`
6. **Domain Isolation**: Identity cannot import server/client/api (enforced by cicd check)
7. **Batch Fixes**: Use `multi_replace_string_in_file` for efficiency (≤10 similar fixes)
8. **UTF-8 without BOM**: All text files MUST be UTF-8 encoded without Byte Order Mark
