---
description: "CI/CD, Docker, and deployment patterns"
applyTo: "**"
---
# Deployment & CI/CD

## Docker Compose Rules

- Use `docker compose` (NOT `docker-compose`)
- ALWAYS relative paths in compose.yml (NEVER absolute)
- ALWAYS `127.0.0.1` in containers (NOT `localhost` - Alpine resolves to IPv6)
- Use `wget` for healthchecks (available in Alpine)
- Healthcheck fields use hyphens: `start-period` (NOT `start_period`)

## Docker Secrets - MANDATORY

**ALL credentials MUST use Docker secrets, NEVER inline env vars.**

```yaml
secrets:
  postgres_username.secret:
    file: ./secrets/postgres_username.secret

services:
  myapp-postgres:
    secrets:
      - postgres_username.secret
    environment:
      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret
```

**Permissions**: chmod 440 (r--r-----) on all .secret files.
**Unseal keys**: NEVER modify (breaks HKDF deterministic derivation).
**Validation**: ALL Dockerfiles MUST include secrets validation stage.

## Multi-Stage Dockerfile

```dockerfile
ARG GO_VERSION=1.25.5
FROM golang:\$\{GO_VERSION}-alpine AS builder
WORKDIR /src

FROM alpine:3.19 AS validator
RUN echo "Validating Docker secrets..."

FROM alpine:3.19 AS runtime
WORKDIR /app
COPY --from=validator /app/cryptoutil /app/cryptoutil
```

## Docker Compose Optimization

- **Single build, shared image**: Build once, `image: cryptoutil:local` for all services.
- **Schema init by first instance**: Others use `depends_on: service_healthy`.
- **Port conflicts**: NEVER expose container ports to host if multiple instances may run.

## PostgreSQL in Tests - MANDATORY

**ALWAYS use test-containers (NEVER service containers)**:

```go
container, _ := postgres.RunContainer(ctx,
    postgres.WithDatabase(fmt.Sprintf("test_%s", googleUuid.NewV7().String())),
    postgres.WithUsername(fmt.Sprintf("user_%s", googleUuid.NewV7().String())),
)
```

## Variable Expansion in Heredocs - CRITICAL

**ALWAYS use `\$\{VAR}` (curly braces), NEVER `\`**:

```yaml
- name: Generate config
  run: |
    cat > config.yml <<EOF
    database-url: "postgres://\$\{POSTGRES_USER}:\$\{POSTGRES_PASS}@\$\{POSTGRES_HOST}:\$\{POSTGRES_PORT}/\$\{POSTGRES_NAME}"
    EOF
    cat config.yml  # MANDATORY verification step
```

## CI/CD Workflow Matrix

| Category | Workflows |
|----------|-----------|
| CI | ci-quality, ci-test, ci-coverage, ci-benchmark, ci-mutation, ci-race |
| Security | ci-sast, ci-gitleaks, ci-dast |
| Integration | ci-e2e, ci-load |

## Docker Image Pre-Pull

**ONLY for workflows using Docker** (E2E, load tests). SKIP for unit tests, linting.

## Configuration Management

- **Production/CI**: ALWAYS config files (YAML), NEVER env vars.
- **Tests**: SQLite in-memory (`--dev`) OR test-containers for PostgreSQL.
- **Secrets**: ALWAYS Docker secrets (`file:///run/secrets/`).

## Artifact Management

- `if: always()` - upload even on failure.
- Retention: temp logs (1 day), coverage (7 days), security/benchmarks (30 days).

## Cost Efficiency

- **Path filters**: Trigger workflows only on relevant changes.
- **Caching**: `cache: true` on `actions/setup-go@v6` (NEVER manual cache actions).

## DAST - Nuclei Scanning

```bash
docker compose -f ./deployments/compose/compose.yml up -d
sleep 30
nuclei -target https://localhost:8080/ -severity medium,high,critical
```

## .dockerignore - MANDATORY

ALWAYS exclude dev/test artifacts. Build context should be <10MB.

## Cross-References

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#L2463) for CI/CD automation, multi-stage Dockerfiles, deployment patterns, and environment strategy.

See [ARCHITECTURE.md Section 12.3.3 Secrets Coordination](../../docs/ARCHITECTURE.md#L2544) for complete secrets management strategy across SUITE/PRODUCT/SERVICE deployment levels.

## Service Ports Reference

| Service | Public API | Admin API |
|---------|-----------|-----------|
| kms-sm-sqlite | 8080 | 9090 |
| kms-sm-postgres-1/2 | 8081/8082 | 9090 |
| otel-collector | 4317/4318 | 13133 |
| grafana-otel-lgtm | 3000 | - |
