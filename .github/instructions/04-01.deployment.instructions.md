---
description: "CI/CD, Docker, and deployment patterns"
applyTo: "**"
---
# Deployment & CI/CD

## Docker Compose Rules

- Use `docker compose` (NOT `docker-compose`)
- ALWAYS relative paths in compose.yml (NEVER absolute)
- ALWAYS `127.0.0.1` in containers (NOT `localhost` - Alpine resolves to IPv6)
- Use `wget` for healthchecks (available in Alpine)
- Healthcheck fields use hyphens: `start-period` (NOT `start_period`)

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#12-deployment-architecture) for Docker Compose patterns and conventions.

## Docker Secrets - MANDATORY

**ALL credentials MUST use Docker secrets, NEVER inline env vars.**

```yaml
secrets:
  postgres_username.secret:
    file: ./secrets/postgres_username.secret

services:
  myapp-postgres:
    secrets:
      - postgres_username.secret
    environment:
      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret
```

**Permissions**: chmod 440 (r--r-----) on all .secret files.
**Unseal keys**: NEVER modify (breaks HKDF deterministic derivation).
**Validation**: ALL Dockerfiles MUST include secrets validation stage.

See [ARCHITECTURE.md Section 12.3.3 Secrets Coordination Strategy](../../docs/ARCHITECTURE.md#1233-secrets-coordination-strategy) for deployment-level secrets management across SUITE/PRODUCT/SERVICE levels.

## Multi-Stage Dockerfile

```dockerfile
ARG GO_VERSION=1.25.5
FROM golang:\$\{GO_VERSION}-alpine AS builder
WORKDIR /src

FROM alpine:3.19 AS validator
RUN echo "Validating Docker secrets..."

FROM alpine:3.19 AS runtime
WORKDIR /app
COPY --from=validator /app/cryptoutil /app/cryptoutil
```

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#12-deployment-architecture) for multi-stage Dockerfile patterns and best practices.

## Docker Compose Optimization

- **Single build, shared image**: Build once, `image: cryptoutil:local` for all services.
- **Schema init by first instance**: Others use `depends_on: service_healthy`.
- **Port conflicts**: NEVER expose container ports to host if multiple instances may run.

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#12-deployment-architecture) for Docker Compose optimization strategies.

## PostgreSQL in Tests - MANDATORY

**ALWAYS use test-containers (NEVER service containers)**:

```go
container, _ := postgres.RunContainer(ctx,
    postgres.WithDatabase(fmt.Sprintf("test_%s", googleUuid.NewV7().String())),
    postgres.WithUsername(fmt.Sprintf("user_%s", googleUuid.NewV7().String())),
)
```

See [ARCHITECTURE.md Section 10.3 Integration Testing Strategy](../../docs/ARCHITECTURE.md#103-integration-testing-strategy) for test container patterns and database testing.

## Variable Expansion in Heredocs - CRITICAL

**ALWAYS use `\$\{VAR}` (curly braces), NEVER `\`**:

```yaml
- name: Generate config
  run: |
    cat > config.yml <<EOF
    database-url: "postgres://\$\{POSTGRES_USER}:\$\{POSTGRES_PASS}@\$\{POSTGRES_HOST}:\$\{POSTGRES_PORT}/\$\{POSTGRES_NAME}"
    EOF
    cat config.yml  # MANDATORY verification step
```

See [ARCHITECTURE.md Section 9.7 CI/CD Workflow Architecture](../../docs/ARCHITECTURE.md#97-cicd-workflow-architecture) for CI/CD configuration patterns.

## CI/CD Workflow Matrix

| Category | Workflows |
|----------|-----------|
| CI | ci-quality, ci-test, ci-coverage, ci-benchmark, ci-mutation, ci-race |
| Security | ci-sast, ci-gitleaks, ci-dast |
| Integration | ci-e2e, ci-load |

See [ARCHITECTURE.md Section 9.7 CI/CD Workflow Architecture](../../docs/ARCHITECTURE.md#97-cicd-workflow-architecture) for complete workflow catalog and patterns.

## Docker Image Pre-Pull

**ONLY for workflows using Docker** (E2E, load tests). SKIP for unit tests, linting.

See [ARCHITECTURE.md Section 9.7 CI/CD Workflow Architecture](../../docs/ARCHITECTURE.md#97-cicd-workflow-architecture) for workflow optimization patterns.

## Configuration Management

- **Production/CI**: ALWAYS config files (YAML), NEVER env vars.
- **Tests**: SQLite in-memory (`--dev`) OR test-containers for PostgreSQL.
- **Secrets**: ALWAYS Docker secrets (`file:///run/secrets/`).

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#12-deployment-architecture) for configuration management strategies.

## Artifact Management

- `if: always()` - upload even on failure.
- Retention: temp logs (1 day), coverage (7 days), security/benchmarks (30 days).

See [ARCHITECTURE.md Section 9.7 CI/CD Workflow Architecture](../../docs/ARCHITECTURE.md#97-cicd-workflow-architecture) for artifact management patterns.

## Cost Efficiency

- **Path filters**: Trigger workflows only on relevant changes.
- **Caching**: `cache: true` on `actions/setup-go@v6` (NEVER manual cache actions).

See [ARCHITECTURE.md Section 9.7 CI/CD Workflow Architecture](../../docs/ARCHITECTURE.md#97-cicd-workflow-architecture) for cost optimization strategies.

## DAST - Nuclei Scanning

```bash
docker compose -f ./deployments/compose/compose.yml up -d
sleep 30
nuclei -target https://localhost:8080/ -severity medium,high,critical
```

See [ARCHITECTURE.md Section 10.11 DAST Strategy](../../docs/ARCHITECTURE.md#1011-dast-strategy) for dynamic application security testing patterns.

## .dockerignore - MANDATORY

ALWAYS exclude dev/test artifacts. Build context should be <10MB.

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#12-deployment-architecture) for Dockerfile and build context optimization.

## Deployment Validation Pipeline

**CICD lint-deployments subcommands** validate deployment and config structure. Run from project root.

| Command | Purpose |
|---------|---------|
| `cicd lint-deployments generate-listings` | Generate JSON listing files for deployments/ and configs/ |
| `cicd lint-deployments validate-mirror` | Verify configs/ mirrors deployments/ structure |
| `cicd lint-deployments validate-compose <file>` | Validate compose file (ports, healthchecks, secrets, credentials, bind mounts) |
| `cicd lint-deployments validate-config <file>` | Validate config file (bind addresses, ports, protocols, admin policy, secrets, OTLP) |

**Structural Mirror**: Every `deployments/` dir MUST have `configs/` counterpart. Mapping: `PRODUCT-SERVICE` → `PRODUCT` (explicit overrides for pki→ca, sm-kms→sm). Orphaned configs archived in `configs/orphaned/`.

**Config Schema**: See [CONFIG-SCHEMA.md](../../docs/CONFIG-SCHEMA.md) for flat kebab-case YAML key reference.

See [ARCHITECTURE.md Section 12.4.8-12.4.10](../../docs/ARCHITECTURE.md#1248-config-file-content-validation) for validation implementation details.

## Deployment Validation Pipeline

**8 validators** run sequentially with aggregated error reporting via `validate-all`:

| Validator | Scope | Purpose |
|-----------|-------|---------|
| ValidateNaming | deployments/, configs/ | Kebab-case directory/file naming |
| ValidateKebabCase | configs/ YAML | Kebab-case YAML keys and compose service names |
| ValidateSchema | configs/ config-*.yml | Hardcoded schema validation for service template configs |
| ValidateTemplatePattern | deployments/template/ | Template naming, structure, placeholder values |
| ValidatePorts | deployments/ compose | PORT range enforcement (SERVICE/PRODUCT/SUITE) |
| ValidateTelemetry | configs/ YAML | OTLP endpoint consistency |
| ValidateAdmin | deployments/ compose | Admin 127.0.0.1:9090 bind policy |
| ValidateSecrets | deployments/ compose | Inline secret detection, Docker secrets enforcement |

**CI/CD**: `cicd-lint-deployments` workflow runs on every push/PR. NEVER DEFER CI/CD integration.

**Secrets in Deployments**: All secret-bearing env vars (PASSWORD, SECRET, TOKEN, KEY) MUST use Docker secrets (`/run/secrets/`). Infrastructure deployments excluded.

See [ARCHITECTURE.md Section 12.4.11](../../docs/ARCHITECTURE.md#12411-validation-pipeline-architecture) for pipeline diagram and detailed rules.

See [ARCHITECTURE.md Section 12.6](../../docs/ARCHITECTURE.md#126-secrets-management-in-deployments) for deployment secrets management.

## Cross-References

See [ARCHITECTURE.md Section 12. Deployment Architecture](../../docs/ARCHITECTURE.md#12-deployment-architecture) for CI/CD automation, multi-stage Dockerfiles, deployment patterns, and environment strategy.

See [ARCHITECTURE.md Section 12.3.3 Secrets Coordination Strategy](../../docs/ARCHITECTURE.md#1233-secrets-coordination-strategy) for complete secrets management strategy across SUITE/PRODUCT/SERVICE deployment levels.

## Service Ports Reference

| Service | Public API | Admin API |
|---------|-----------|-----------|
| kms-sm-sqlite | 8080 | 9090 |
| kms-sm-postgres-1/2 | 8081/8082 | 9090 |
| otel-collector | 4317/4318 | 13133 |
| grafana-otel-lgtm | 3000 | - |
