---
description: "Instructions for cryptographic patterns, FIPS compliance, hash versioning, and algorithm agility"
applyTo: "**"
---
# Cryptography Instructions - CRITICAL

## FIPS 140-3 Compliance - MANDATORY

**CRITICAL: FIPS 140-3 mode is ALWAYS enabled by default and MUST NEVER be disabled**

- All cryptographic operations use FIPS-approved algorithms
- **ONLY use NIST FIPS 140-3 approved algorithms**
- **NEVER use non-FIPS algorithms**

### Approved Algorithms

**Asymmetric Cryptography**:

- RSA ≥ 2048 bits (2048, 3072, 4096)
- ECDSA (NIST curves: P-256, P-384, P-521)
- ECDH (NIST curves: P-256, P-384, P-521)
- EdDSA (Ed25519, Ed448)

**Symmetric Cryptography**:

- AES ≥ 128 bits (128, 192, 256)
- AES-GCM (authenticated encryption)
- AES-CBC (with HMAC for authentication)

**Hash Functions**:

- SHA-256, SHA-384, SHA-512
- HMAC-SHA256, HMAC-SHA384, HMAC-SHA512

**Key Derivation**:

- PBKDF2-HMAC-SHA256 (MANDATORY for password hashing)
- HKDF-SHA256, HKDF-SHA384, HKDF-SHA512

### BANNED Algorithms - NEVER USE

❌ **bcrypt** - NOT FIPS-approved, use PBKDF2-HMAC-SHA256 instead
❌ **scrypt** - NOT FIPS-approved, use PBKDF2-HMAC-SHA256 instead
❌ **Argon2** - NOT FIPS-approved, use PBKDF2-HMAC-SHA256 instead
❌ **MD5** - NOT FIPS-approved, use SHA-256 or SHA-512 instead
❌ **SHA-1** - NOT FIPS-approved, use SHA-256 or SHA-512 instead
❌ **RSA < 2048 bits** - Insufficient key length
❌ **DES, 3DES** - Deprecated ciphers

---

## Algorithm Agility - MANDATORY

**All cryptographic operations MUST support configurable algorithms with FIPS-approved defaults**

- Key generation: Support RSA (2048/3072/4096), ECDSA (P-256/384/521), Ed25519
- Encryption: Support AES-GCM (128/192/256 bit keys)
- Hashing: Support SHA-256/384/512, HMAC-SHA256/384/512
- Key derivation: Support PBKDF2-HMAC-SHA256, HKDF-SHA256/384/512
- Configuration-driven algorithm selection with FIPS-approved defaults

**Pattern**: Use config structs with Algorithm and KeySize fields, switch on algorithm type

---

## Key Management - MANDATORY

### Key Derivation - CRITICAL

**ALWAYS derive keys deterministically for interoperability**

All cryptoutil instances using the same set of shared unseal secrets MUST derive the same unseal JWKs, including KIDs and key materials, for cryptographic interoperability between instances.

**Pattern**: Use HKDF with master secret, salt, and purpose-specific info for deterministic key derivation

### Key Rotation

**Key versioning pattern**: Maintain key ring with active key ID and historical keys for decryption

- Encryption: Always use active key, prefix ciphertext with key ID
- Decryption: Use historical key matching key ID prefix
- Rotation: Update active key ID, keep old keys for decryption

---

## Secure Random Generation - MANDATORY

**ALWAYS use crypto/rand, NEVER use math/rand**

**Pattern**: Use `crypto/rand.Read()` for all random generation (tokens, nonces, salts, IVs)

---

## Cryptographic Libraries - MANDATORY

**Prefer standard library crypto packages**:

- `crypto/rand`, `crypto/rsa`, `crypto/ecdsa`, `crypto/ed25519` - Key generation
- `crypto/aes`, `crypto/cipher` - Symmetric encryption
- `crypto/sha256`, `crypto/sha512`, `crypto/hmac` - Hashing
- `crypto/tls` - TLS connections
- `golang.org/x/crypto/pbkdf2`, `golang.org/x/crypto/hkdf` - Key derivation

**Avoid third-party crypto libraries unless necessary** (review required)

---

## Key Takeaways

1. **FIPS 140-3 ALWAYS enabled** - No exceptions
2. **Password hashing: PBKDF2-HMAC-SHA256** - See `02-09.hashes.instructions.md`
3. **Algorithm agility: Configurable with FIPS defaults** - Support multiple algorithms
4. **Deterministic key derivation: HKDF** - For instance interoperability
5. **crypto/rand ALWAYS** - Never math/rand
6. **Certificate validation** - See `02-10.pki.instructions.md`
