---
description: "Instructions for CI/CD workflow configuration, service connectivity verification, and diagnostic logging"
applyTo: "**"
---
# CI/CD Workflow Instructions

## Cost Efficiency

- Use path filters to trigger workflows only on relevant changes
- Minimal matrix builds; skip jobs for docs-only changes
- Use `cache: true` on `actions/setup-go@v6` (not manual cache actions)

## PostgreSQL Service Requirements - CRITICAL

**Unit/Integration Tests**: MUST use test-containers with randomized database credentials

- Use test-containers library for PostgreSQL in unit and integration tests
- Generate unique database name, username, and password per test suite
- Docker containers provide isolation, no port conflicts
- NEVER use environment variables for test database credentials
- Example pattern: `testcontainers-go` for Go tests

**E2E Tests**: MUST use Docker Compose with Docker secrets

- Use Docker Compose for full-stack E2E testing
- Configure PostgreSQL via Docker secrets, not environment variables
- Mount secrets to `/run/secrets/` in containers
- Application reads credentials from secret files
- Example: `database-url: file:///run/secrets/postgres_url`

**GitHub Workflows**: May use PostgreSQL service container for legacy tests requiring specific configuration

```yaml
# Use ONLY when test-containers not feasible
services:
  postgres:
    image: postgres:18
    env:
      POSTGRES_DB: cryptoutil_test
      POSTGRES_USER: cryptoutil
      POSTGRES_PASSWORD: cryptoutil_test_password
    options: >-
      --health-cmd pg_isready
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5
    ports:
      - 5432:5432
```

**Rationale**: Environment variables are insecure even for testing; test-containers provide isolated, randomized credentials; Docker secrets enforce secure patterns for production-like E2E tests.

## Workflow Matrix

| Workflow | Trigger | Purpose |
|----------|---------|----------|
| ci-quality | Push to main, PR | Linting, formatting, build validation |
| ci-test | Push to main, PR | Unit and integration tests |
| ci-coverage | Push to main, PR | Test coverage analysis |
| ci-benchmark | Manual, weekly | Performance benchmarks |
| ci-mutation | Manual | Mutation testing with gremlins |
| ci-race | Push to main, PR | Race condition detection |
| ci-sast | Push to main, PR | Static security analysis (gosec, semgrep) |
| ci-gitleaks | Push to main, PR | Secrets scanning |
| ci-dast | Manual | Dynamic security testing (Nuclei, ZAP) |
| ci-e2e | Manual, nightly | End-to-end integration tests |
| ci-load | Manual | Load and stress testing (Gatling) |

## Configuration Management

- ALWAYS use config files for production/CI (not environment variables)
- Tests use SQLite in-memory (`--dev` flag) or test-containers for PostgreSQL
- NEVER use environment variables for secrets

## Artifact Management

- Upload artifacts with `actions/upload-artifact@v4` + `if: always()`
- Upload SARIF to Security tab with `github/codeql-action/upload-sarif@v3`
- Retention: 1 day temporary, 1-30 days valuable reports

## Act Workflow Testing

```bash
go run ./cmd/workflow -workflows=dast -inputs="scan_profile=quick"  # 3-5 min
go run ./cmd/workflow -workflows=dast -inputs="scan_profile=full"   # 10-15 min
go run ./cmd/workflow -workflows=e2e,dast                            # Multiple
```

NEVER use `-t` timeout flag; ALWAYS let cmd/workflow complete

## Diagnostic Logging

Steps >10s MUST include timing: `START_TIME=$(date +%s)` ... `DURATION=$((END_TIME - START_TIME))`
Emojis: üìã start, üìÖ timestamps, ‚è±Ô∏è duration, ‚úÖ success, ‚ùå error

## GitHub CLI for Workflow Diagnostics

**ALWAYS use `gh` CLI** to diagnose or fix workflow issues:

```bash
# List recent workflow runs
gh run list --limit 10

# View specific workflow run details
gh run view <run-id>

# View failed workflow logs
gh run view <run-id> --log-failed

# Download workflow artifacts
gh run download <run-id>

# Watch a running workflow
gh run watch <run-id>

# Re-run failed jobs
gh run rerun <run-id> --failed

# List workflows
gh workflow list

# View workflow file
gh workflow view <workflow-name>
```

**Common Diagnostic Commands:**

```bash
# Find recent failures on main
gh run list --branch main --status failure --limit 5

# Get full logs for debugging
gh run view <run-id> --log

# Cancel stuck runs
gh run cancel <run-id>
```
