---
description: "Instructions for CI/CD workflow configuration, service connectivity verification, and diagnostic logging"
applyTo: "**"
---
# CI/CD Workflow Instructions - Tactical Guidance

**Reference**: See `.specify/memory/github.md` for complete specifications (workflow matrix, PostgreSQL patterns, artifact management, gh CLI commands, variable expansion lessons)

**This file contains ONLY tactical implementation patterns**

## PostgreSQL Service Patterns

**Unit/Integration Tests** (Recommended):
```go
container, _ := postgres.RunContainer(ctx,
    postgres.WithDatabase(fmt.Sprintf("test_%s", googleUuid.NewV7().String())),
    postgres.WithUsername(fmt.Sprintf("user_%s", googleUuid.NewV7().String())),
)
```

**E2E Tests** (Production-like):
```yaml
app:
  secrets:
    - database_url
  command: ["--database-url=file:///run/secrets/database_url"]
```

## Workflow Matrix Quick Reference

| Workflow | Trigger | Purpose |
|----------|---------|----------|
| ci-quality | Push to main, PR | Linting, formatting, build validation |
| ci-test | Push to main, PR | Unit and integration tests |
| ci-coverage | Push to main, PR | Test coverage analysis |
| ci-sast | Push to main, PR | Static security analysis (gosec, semgrep) |
| ci-race | Push to main, PR | Race condition detection |
| ci-dast | Manual | Dynamic security testing (Nuclei, ZAP) |
| ci-e2e | Manual, nightly | End-to-end integration tests |

## Variable Expansion in Heredocs - CRITICAL

```yaml
- name: Generate config
  run: |
    cat > config.yml <<EOF
    database-url: "postgres://${POSTGRES_USER}:${POSTGRES_PASS}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_NAME}"
    EOF
```

**ALWAYS use `${VAR}` (curly braces), NEVER `$VAR`**

## GitHub CLI for Workflow Diagnostics

```bash
# List recent workflow runs
gh run list --limit 10

# View failed workflow logs
gh run view <run-id> --log-failed

# Download workflow artifacts
gh run download <run-id>

# Re-run failed jobs
gh run rerun <run-id> --failed
```

## Key Takeaways

1. **Test-Containers**: Use for unit/integration tests (randomized credentials)
2. **Docker Secrets**: Use for E2E tests (production-like)
3. **Variable Expansion**: ALWAYS use `${VAR}` syntax in heredocs
4. **Artifact Upload**: ALWAYS use `if: always()` for test artifacts
5. **gh CLI**: ALWAYS use for workflow diagnostics (faster than web UI)
