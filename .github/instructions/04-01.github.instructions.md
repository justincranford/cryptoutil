---
description: "Instructions for CI/CD workflow configuration, service connectivity verification, and diagnostic logging"
applyTo: "**"
---
# Github

# CI/CD Workflow Instructions - Tactical Guidance

**This file contains ONLY tactical implementation patterns**

## PostgreSQL Service Patterns - MANDATORY

**ALWAYS use test-containers (NEVER service containers)**:

```go
container, _ := postgres.RunContainer(ctx,
    postgres.WithDatabase(fmt.Sprintf("test_%s", googleUuid.NewV7().String())),
    postgres.WithUsername(fmt.Sprintf("user_%s", googleUuid.NewV7().String())),
)
```

**Reason**: Service containers run at job level (shared state, cleanup issues), test-containers run in Go code (isolated, automatic cleanup)

**E2E Tests** (Production-like):

```yaml
app:
  secrets:
    - database_url
  command: ["--database-url=file:///run/secrets/database_url"]
```

## Docker Pre-Pull - CONDITIONAL

**ONLY pre-pull images for workflows using Docker**:

- Pre-pull for: E2E tests (Docker Compose), load tests (test-containers)
- SKIP pre-pull for: Unit tests (no containers), linting, formatting
- Pattern: `docker pull postgres:16-alpine` before `docker compose up`
- Reason: Avoid rate limits, faster startup, predictable timing

## Workflow Matrix

**ci-quality**: Linting, formatting, build | **ci-coverage/mutation/race**: Test analysis | **ci-sast/dast**: Security scanning | **ci-e2e/benchmark/load**: Integration/performance

## Variable Expansion in Heredocs - CRITICAL

```yaml
- name: Generate config
  run: |
    cat > config.yml <<EOF
    database-url: "postgres://${POSTGRES_USER}:${POSTGRES_PASS}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_NAME}"
    EOF
```

**ALWAYS use `${VAR}` (curly braces), NEVER `$VAR`**

## GitHub CLI for Workflow Diagnostics

```bash
# List recent workflow runs
gh run list --limit 10

# View failed workflow logs
gh run view <run-id> --log-failed

# Download workflow artifacts
gh run download <run-id>

# Re-run failed jobs
gh run rerun <run-id> --failed
```

## Cost Efficiency Patterns

**Path Filters**: Trigger workflows only on relevant changes, exclude docs
**Matrix Optimization**: Skip jobs for docs-only changes, conditional steps
**Caching**: Use `cache: true` on `actions/setup-go@v6` (NEVER manual cache actions)

## PostgreSQL Service Configuration - CRITICAL

**Pattern 1: Unit/Integration** (Recommended) - test-containers with randomized credentials
**Pattern 2: E2E Tests** - Docker Compose with Docker secrets (`file:///run/secrets/`)
**Pattern 3: GitHub Workflows** (Legacy) - Use ONLY when test-containers not feasible

**Rationale**: Env vars insecure, test-containers provide isolation/randomization, Docker secrets enforce secure patterns

## Workflow Matrix Reference

| Category | Workflows | Purpose |
|----------|-----------|---------|
| **CI** | ci-quality, ci-test, ci-coverage, ci-benchmark, ci-mutation, ci-race | Linting, tests, coverage, benchmarks |
| **Security** | ci-sast, ci-gitleaks, ci-dast | Static/dynamic security analysis |
| **Integration** | ci-e2e, ci-load | E2E tests, load testing |

## Configuration Management Patterns

**Production/CI**: ALWAYS use config files (YAML), NEVER env vars
**Tests**: SQLite in-memory (`--dev`) OR test-containers for PostgreSQL
**Secrets**: ALWAYS Docker secrets (`file:///run/secrets/`)

## Artifact Management

**Test Artifacts**: `if: always()`, upload even on failure
**Retention**: Temp logs (1 day), coverage (7 days), security/benchmarks (30 days)

## Act Workflow Testing (Local Execution)

**cmd/workflow Utility**: `go run ./cmd/workflow -workflows=dast,e2e -inputs="key=value"`

**Rules**: NEVER use `-t` timeout, ALWAYS specify `-workflows`, use `-inputs` for params
**Why**: Test workflows locally before push, debug without CI/CD, faster iteration

---

## Diagnostic Logging Standards

**Steps >10s MUST include timing**: Start time, end time, duration in seconds, emoji indicators (üìã start, ‚è±Ô∏è duration, ‚úÖ success)

---

## Variable Expansion in Heredocs - CRITICAL

**ALWAYS use `${VAR}`** (curly braces) for variable expansion in Bash heredocs

**Rules**: ‚úÖ `${VAR}`, verify expansion, include `cat config.yml` ‚ùå `$VAR`, skip verification

**Historical Mistake**: ci-dast `$POSTGRES_USER` ‚Üí literal "$POSTGRES_USER" ‚Üí "role 'root' does not exist"

---

## Debugging Workflow PostgreSQL Issues

**Checklist**: Download artifacts, check PostgreSQL logs ("role '<username>' does not exist"), verify credentials match, check config for literal $VAR, compare with working workflows

**Evidence Pattern**: 27+ errors (persistent) + 10s interval (health retry) + PostgreSQL OK (credentials issue) + literal $VAR (expansion issue)

**Preventive**: PostgreSQL creds cryptoutil_test/cryptoutil/cryptoutil_test_password, env vars match, `${VAR}` syntax, verification step, health check configured
