---
description: "Observability and monitoring"
applyTo: "**"
---
# Observability

# Observability and Monitoring - Tactical Guidance

## Telemetry Flow

cryptoutil services → opentelemetry-collector (sidecar, OTLP gRPC:4317 or HTTP:4318) → grafana-otel-lgtm (OTLP gRPC:14317 or HTTP:14318)
**MANDATORY**: ALWAYS forward through sidecar (NEVER bypass)

## Configuration Pattern

```yaml
# cryptoutil-otel.yml
telemetry:
  otlp_endpoint: "opentelemetry-collector:4317"  # Sidecar, not upstream
  protocol: "grpc"  # grpc (default) or http (firewall-friendly)
```

## Key Patterns

**Structured Logging**:

```go
log.Info("operation completed",
  "user_id", userID,
  "operation", "key_generation",
  "duration_ms", duration.Milliseconds(),
)
```

**Health Endpoints**:

- `/admin/api/v1/livez` - Lightweight (process alive?)
- `/admin/api/v1/readyz` - Heavyweight (dependencies healthy?)

**Health Check Failure Behavior**:

- **Kubernetes**: Return HTTP 503 (Service Unavailable), pod marked unhealthy
- **Docker Compose**: Return HTTP 503, container remains running (manual intervention)

**See**: architecture.instructions.md for detailed health check semantics

**Sampling Strategy**:

- MUST be configurable (default: probabilistic 10% sampling rate)
- Pattern: `sampling_rate: 0.1` in telemetry config

**Sensitive Data**: NEVER log passwords, keys, PII (log IDs, operations, durations only)

## Core Stack

**MANDATORY: OpenTelemetry** - Tracing, Metrics, Logging (OTLP gRPC:4317 or HTTP:4318, otel-collector-contrib, Grafana OTEL-LGTM)

---

## Telemetry Architecture - MANDATORY

**Sidecar Pattern** (ALWAYS): `cryptoutil → otel-collector → grafana-otel-lgtm`
**NEVER Direct**: ❌ `cryptoutil → grafana-otel-lgtm`

**Flow**:

```
cryptoutil (OTLP :4317/:4318) → otel-collector → grafana-otel-lgtm (:14317/:14318)
```

**Protocols**:

- **gRPC** (:4317) - Default, efficient binary protocol
- **HTTP** (:4318) - Firewall-friendly, universal compatibility

**Configuration**:

- Services: MUST point to `otel-collector:4317` (or `:4318`)
- Collector: Receives :4317/:4318, forwards to grafana :14317/:14318
- Grafana: Receives ONLY from otel-collector (no direct connections)

**Rationale**: Centralized processing, decoupling, consistent architecture, failure isolation

---

## Structured Logging - MANDATORY

**Pattern**: Key-value pairs, JSON format, trace correlation

```go
import "go.uber.org/zap"

logger.Info("Key created",
    zap.String("key_id", keyID),
    zap.String("algorithm", "RSA-2048"),
    zap.Duration("duration", elapsed),
)
```

**Standard Fields**: `timestamp`, `level`, `message`, `trace_id`, `span_id`, `service.name`, `service.version`

---

## OTLP Export Configuration

```yaml
observability:
  otlp:
    protocol: grpc  # or http
    endpoint: opentelemetry-collector:4317  # or :4318 for HTTP
    service_name: cryptoutil-kms
    service_version: 1.0.0
    insecure: true  # dev only, false for prod
```

---

## Health Endpoints - MANDATORY

**`/admin/api/v1/livez`** (Liveness):

- Purpose: Process alive?
- Check: Lightweight (goroutines not deadlocked)
- Failure: Restart container
- Response: 200 OK | 503 Unavailable

**`/admin/api/v1/readyz`** (Readiness):

- Purpose: Ready for traffic?
- Check: Heavyweight (database connected, dependencies healthy)
- Failure: Remove from LB (don't restart)
- Response: 200 OK | 503 Unavailable

**Why Separate**: Liveness (restart) vs Readiness (remove from LB) have different failure modes

---

## Prometheus Metrics - MANDATORY

| Category | Metrics |
|----------|--------|
| **HTTP** | `http_requests_total{method,path,status}`, `http_request_duration_seconds{method,path}`, `http_requests_in_flight{method,path}` |
| **Database** | `db_connections_open`, `db_connections_idle`, `db_query_duration_seconds{operation}`, `db_errors_total{operation}` |
| **Crypto** | `crypto_operations_total{algorithm,operation}`, `crypto_operation_duration_seconds{algorithm,operation}`, `crypto_errors_total{algorithm,operation}` |
| **Keys** | `keys_total{algorithm,status}`, `key_rotations_total{algorithm}`, `key_usage_total{key_id,operation}` |

---

## Log Levels - MANDATORY

| Level | Usage |
|-------|-------|
| **DEBUG** | Detailed diagnostics, function entry/exit (dev only) |
| **INFO** | Significant events (startup, config loaded, key created/rotated) |
| **WARN** | Degraded mode, recoverable errors, deprecated usage |
| **ERROR** | Unrecoverable errors, request failures, external service failures |
| **FATAL** | Unrecoverable startup errors, critical config missing, process termination |

---

## Sensitive Data Protection - MANDATORY

**NEVER Log**: Passwords, API keys, tokens, private keys, PII, credit cards, SSNs, session IDs
**Safe to Log**: Key IDs, user IDs (not usernames/emails), resource IDs, operation types, durations, counts, errors

```go
// ❌ WRONG
logger.Info("Key created", zap.Any("key", key))

// ✅ CORRECT
logger.Info("Key created", zap.String("key_id", key.ID), zap.String("algorithm", key.Algorithm))
```

---

## Cross-References

Service template: [02-02.service-template.instructions.md](.github/instructions/02-02.service-template.instructions.md), Docker: [04-02.docker.instructions.md](.github/instructions/04-02.docker.instructions.md), Security: [03-06.security.instructions.md](.github/instructions/03-06.security.instructions.md)
Tools: <https://opentelemetry.io/>, <https://github.com/grafana/docker-otel-lgtm>, <https://prometheus.io/>
