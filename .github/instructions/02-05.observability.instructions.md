---
description: "Instructions for observability and monitoring implementation"
applyTo: "**"
---
# Observability and Monitoring - Tactical Guidance

**Reference**: See `.specify/memory/observability.md` for complete specifications (OpenTelemetry stack, telemetry forwarding architecture, sidecar pattern MANDATORY, push-based flow, structured logging, OTLP export, health endpoints, Prometheus metrics, log levels, sensitive data protection)

**This file contains ONLY tactical implementation patterns**

## Telemetry Flow

cryptoutil services → opentelemetry-collector (sidecar, OTLP gRPC:4317 or HTTP:4318) → grafana-otel-lgtm (OTLP gRPC:14317 or HTTP:14318)
**MANDATORY**: ALWAYS forward through sidecar (NEVER bypass)

## Configuration Pattern

```yaml
# cryptoutil-otel.yml
telemetry:
  otlp_endpoint: "opentelemetry-collector:4317"  # Sidecar, not upstream
  protocol: "grpc"  # grpc (default) or http (firewall-friendly)
```

## Key Patterns

**Structured Logging**:

```go
log.Info("operation completed",
  "user_id", userID,
  "operation", "key_generation",
  "duration_ms", duration.Milliseconds(),
)
```

**Health Endpoints**:

- `/admin/v1/livez` - Lightweight (process alive?)
- `/admin/v1/readyz` - Heavyweight (dependencies healthy?)

**Health Check Failure Behavior**:

- **Kubernetes**: Return HTTP 503 (Service Unavailable), pod marked unhealthy
- **Docker Compose**: Return HTTP 503, container remains running (manual intervention)

**Sampling Strategy**:

- MUST be configurable (default: probabilistic 10% sampling rate)
- Pattern: `sampling_rate: 0.1` in telemetry config

**Sensitive Data**: NEVER log passwords, keys, PII (log IDs, operations, durations only)
