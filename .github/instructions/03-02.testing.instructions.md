---
description: "Instructions for testing"
applyTo: "**"
---
# Testing Instructions - Tactical Guidance

**Reference**: See `.specify/memory/testing.md` for complete specifications (coverage requirements, main() test pattern, mutation testing workflow, parallel test safety, anti-patterns)

**This file contains ONLY tactical implementation patterns**

## Coverage Targets Quick Reference

| Category | Packages | Minimum Coverage |
|----------|----------|------------------|
| Production | internal/{jose,identity,kms,ca} | 95% |
| Infrastructure | internal/cmd/cicd/* | 98% |
| Utility | internal/shared/*, pkg/* | 98% |
| Main Functions | cmd/*/main.go | 0%*(*if internalMain() ≥95%) |

## main() Pattern - MANDATORY

```go
// ✅ CORRECT: Thin main() delegates to testable internalMain()
func main() {
    os.Exit(internalMain(os.Args, os.Stdin, os.Stdout, os.Stderr))
}

// internalMain is testable - accepts injected dependencies
func internalMain(args []string, stdin io.Reader, stdout, stderr io.Writer) int {
    if len(args) < 2 {
        fmt.Fprintln(stderr, "usage: cmd <arg>")
        return 1
    }
    // ... business logic
    return 0
}
```

## Coverage Analysis - MANDATORY

**ALWAYS analyze HTML baseline before writing tests**: `go test -coverprofile=coverage.out && go tool cover -html=coverage.out` → find RED lines → write targeted tests

## Timeout Configuration - MANDATORY

```go
// ✅ DO: Use 5s+ timeouts for network operations
client := &http.Client{
    Transport: &http.Transport{TLSClientConfig: tlsConfig},
    Timeout: 5 * time.Second,
}

ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()
req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)
```

## Table-Driven Tests Pattern

```go
tests := []struct{name string; input X; want Y}{{...}}
for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { t.Parallel(); /* test */ }) }
```

## Probability-Based Execution

**Use for algorithm variants only** (RSA 2048/3072/4096, AES 128/192/256, ECDSA P-256/384/521)
**Magic Constants**: `TestProbAlways=100`, `TestProbQuarter=25`, `TestProbTenth=10`

## Test Execution Commands

```bash
# ✅ CORRECT: Concurrent with shuffle
go test ./... -cover -shuffle=on

# ❌ WRONG: Sequential execution (hides bugs)
go test ./... -p=1          # NEVER DO THIS
go test ./... -parallel=1   # NEVER DO THIS

# Race detection (requires CGO_ENABLED=1)
go test -race -count=2 ./...
```

## File Size Limits - MANDATORY

| Limit | Lines | Action Required |
|-------|-------|-----------------|
| Soft | 300 | Ideal target |
| Medium | 400 | Acceptable with justification |
| Hard | 500 | NEVER EXCEED - refactor required |
