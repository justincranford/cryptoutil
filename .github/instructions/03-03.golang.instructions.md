---
description: "Go project structure and standards"
applyTo: "**"
---
# Golang

# Go Project Standards - Tactical Guidance

## Quick Reference

**Go Version**: 1.25.5 (ALWAYS same everywhere: dev, CI/CD, Docker)
**CGO**: BANNED (CGO_ENABLED=0) except race detector
**Project Layout**: cmd, internal, pkg, api (avoid /src)

## Go Version Consistency

**MANDATORY: Use same Go version everywhere** (development, CI/CD, Docker, documentation)

**Current Version**: 1.25.5 (check `go.mod`)

**Enforcement Locations**: `go.mod`: `go 1.25.5`, `.github/workflows/*.yml`: `GO_VERSION: '1.25.5'`, `Dockerfile`: `FROM golang:1.25.5-alpine`, `README.md`: Document Go 1.25.5+ requirement

## CGO Ban - CRITICAL

**CGO_ENABLED=0 is MANDATORY** (except race detector)

**Rationale**: Maximum portability (no C toolchain), static linking (single binary), cross-compilation, no C library version conflicts

Detect CGO dependencies

```bash
go list -u -m all | grep '\[.*\]$'
```

Use CGO-free alternatives
- ✅ Pure Go crypto/networking (standard library)
- ✅ modernc.org/sqlite
- ❌ github.com/mattn/go-sqlite3

**ONLY Exception**: Race detector (`-race`) requires CGO_ENABLED=1 (Go toolchain limitation)

## Import Aliases

`cryptoutil<Package>` for internal
`<vendor><Package>` for external

## Magic Values Locations

- **Shared**: `internal/shared/magic/magic_*.go`
- **Domain-Specific**: `internal/shared/magic/magic_domain*.go`

---

## Go Project Structure

**Standard Layout** (follow [golang-standards/project-layout](https://github.com/golang-standards/project-layout)):

Expanded View:

```
cryptoutil/
├── cmd/                                   # Applications (external entry points for binary executables)
│   ├── cryptoutil/main.go                 # Cryptoutil suite: cmd/cryptoutil/main.go -> internal/apps/cryptoutil/cryptoutil.go
│   ├── cryptoutil-compose/main.go         # Cryptoutil suite, compose util: cmd/cryptoutil-compose/main.go -> internal/apps/cryptoutil-compose/compose.go
│   ├── cryptoutil-demo/main.go            # Cryptoutil suite, demo util: cmd/cryptoutil-demo/main.go -> internal/apps/cryptoutil-demo/demo.go
│   ├── cryptoutil-e2e/main.go             # Cryptoutil suite, e2e util: cmd/cryptoutil-e2e/main.go -> internal/apps/cryptoutil-e2e/e2e.go
│   ├── cipher/main.go                     # Cipher product: cmd/cipher/main.go -> internal/apps/cipher/cipher.go
│   │── cipher-im/main.go                  # Cipher product, Instant Messaging service: cmd/cipher-im/main.go -> internal/apps/cipher/im/im.go
│   ├── jose/main.go                       # JOSE product: cmd/jose/main.go -> internal/apps/jose/jose.go
│   │── jose-ja/main.go                    # JOSE product, JWK Authority service: cmd/jose-ja/main.go -> internal/apps/jose/ja/ja.go
│   ├── pki/main.go                        # PKI product: cmd/pki/main.go -> internal/apps/pki/pki.go
│   │── pki-ca/main.go                     # PKI product, Certificate Authority service: cmd/pki-ca/main.go -> internal/apps/pki/ca/ca.go
│   ├── identity/main.go                   # Identity product: cmd/identity/main.go -> internal/apps/identity/identity.go
│   │── identity-authz/main.go             # Identity product, Authorization service: cmd/identity-authz/main.go -> internal/apps/identity/authz/authz.go
│   │── identity-idp/main.go               # Identity product, Identity Provider service: cmd/identity-idp/main.go -> internal/apps/identity/idp/idp.go
│   │── identity-rp/main.go                # Identity product, Relying Party service: cmd/identity-rp/main.go -> internal/apps/identity/rp/rp.go
│   │── identity-rs/main.go                # Identity product, Resource Server service: cmd/identity-rs/main.go -> internal/apps/identity/rs/rs.go
│   │── identity-spa/main.go               # Identity product, Single Page Application service: cmd/identity-spa/main.go -> internal/apps/identity/spa/spa.go
│   │── sm/main.go                         # Secrets Manager product: cmd/sm/main.go -> internal/apps/sm/sm.go
│   └── sm-kms/main.go                     # Secrets Manager product, Key Management service: cmd/sm-kms/main.go -> internal/apps/sm/kms/kms.go
├── internal/                              # Private application code
│   │── apps/                              # Applications (Internal) - used by cmd/, organized as PRODUCT/SERVICE/
│   │   ├── cryptoutil/cryptoutil.go       # Cryptoutil suite: cmd/cryptoutil/main.go -> internal/apps/cryptoutil/cryptoutil.go
│   │   ├── cryptoutil-compose/compose.go  # Cryptoutil suite, compose util: cmd/cryptoutil-compose/main.go -> internal/apps/cryptoutil-compose/compose.go
│   │   ├── cryptoutil-demo/demo.go        # Cryptoutil suite, demo util: cmd/cryptoutil-demo/main.go -> internal/apps/cryptoutil-demo/demo.go
│   │   ├── cryptoutil-e2e/e2e.go          # Cryptoutil suite, e2e util: cmd/cryptoutil-e2e/main.go -> internal/apps/cryptoutil-e2e/e2e.go
│   │   ├── cipher/cipher.go               # Cipher product: cmd/cipher/main.go -> internal/apps/cipher/cipher.go
│   │   │── cipher-im/im.go                # Cipher product, Instant Messaging service: cmd/cipher-im/main.go -> internal/apps/cipher/im/im.go
│   │   ├── jose/jose.go                   # JOSE product: cmd/jose/main.go -> internal/apps/jose/jose.go
│   │   │── jose-ja/ja.go                  # JOSE product, JWK Authority service: cmd/jose-ja/main.go -> internal/apps/jose/ja/ja.go
│   │   ├── pki/pki.go                     # PKI product: cmd/pki/main.go -> internal/apps/pki/pki.go
│   │   │── pki-ca/ca.go                   # PKI product, Certificate Authority service: cmd/pki-ca/main.go -> internal/apps/pki/ca/ca.go
│   │   ├── identity/identity.go           # Identity product: cmd/identity/main.go -> internal/apps/identity/identity.go
│   │   │── identity-authz/authz.go        # Identity product, Authorization service: cmd/identity-authz/main.go -> internal/apps/identity/authz/authz.go
│   │   │── identity-idp/idp.go            # Identity product, Identity Provider service: cmd/identity-idp/main.go -> internal/apps/identity/idp/idp.go
│   │   │── identity-rp/rp.go              # Identity product, Relying Party service: cmd/identity-rp/main.go -> internal/apps/identity/rp/rp.go
│   │   │── identity-rs/rs.go              # Identity product, Resource Server service: cmd/identity-rs/main.go -> internal/apps/identity/rs/rs.go
│   │   │── identity-spa/spa.go            # Identity product, Single Page Application service: cmd/identity-spa/main.go -> internal/apps/identity/spa/spa.go
│   │   │── sm/sm.go                       # Secrets Manager product: cmd/sm/main.go -> internal/apps/sm/sm.go
│   │   └── sm-kms/kms.go                  # Secrets Manager product, Key Management service: cmd/sm-kms/main.go -> internal/apps/sm/kms/kms.go
│   ├── shared/                  # Shared utilities
│   │   ├── apperr/
│   │   ├── barrier/         # Encryption-at-rest (Unseal service, Hierarchal root+intermediate+content services)
│   │   ├── config/
│   │   ├── container/       # PostgreSQL, Otel Collector Contrib, Grafana LGTM
│   │   ├── crypto/
│   │   │   ├── asn1/
│   │   │   ├── certificate/ # Offline Root CA, Online Root CA, Intermediate CA, Policy CA, Leaf certificates
│   │   │   ├── digests/     # SHA2
│   │   │   ├── hash/        # Hashing utilities: {Low|High}Entropy{Random|Fixed} based on {PBKDF2|HKDF}withSHA2
│   │   │   ├── jose/        # JOSE (JWK, JWS, JWE) utilities
│   │   │   ├── keygen/
│   │   │   ├── keygenpool/  # RSA, EC, ED, AES, AESHS, HMAC, UUIDv7
│   │   │   ├── tls/         # Encryption-in-transit (TLS) utilities
│   │   ├── magic/
│   │   ├── pool/            # High-performance service for keygenpool/
│   │   ├── telemetry/       # OpenTelemetry (tracing, metrics, logging)
│   │   ├── testutil/
│   │   └── util/
├── api/                     # OpenAPI specs, generated code
├── configs/                 # Configuration files
├── deployments/             # Docker Compose, Kubernetes manifests
└── docs/                    # Documentation
├── pkg/                     # Public library code (empty)
├── scripts/                 # Build/test scripts (minimal, prefer Go applications)
├── test/                    # Additional test files: Gatling (Load tests)
```

**Key Rules**: ❌ Avoid `/src` directory (redundant in Go), ❌ Avoid deep nesting (>4 levels indicates design issue), ✅ Use `/internal` for private code (enforced by compiler), ✅ Use `/pkg` for public libraries (safe for external import)

---

## Application Architecture

**Layered Architecture**: main() [cmd/] → Application [internal/*/application/] → Business Logic [internal/*/service/, internal/*/domain/] → Repositories [internal/*/repository/] → Database/External Systems

**Configuration Management**: ✅ YAML files + CLI flags (explicit, version-controlled), ✅ Docker/Kubernetes secrets (sensitive data), ❌ Environment variables (NOT used for configuration)

**Design Patterns**: Constructor injection (`NewService(logger, repo, config)`), context propagation (pass `context.Context` to all long-running ops), graceful shutdown (listen for signals, close resources cleanly), factory pattern (create instances with dependencies injected), error propagation (wrap errors with context: `fmt.Errorf("failed to X: %w", err)`)

---

## Import Alias Conventions

**Internal Package Aliases** (Pattern: `cryptoutil<PackageName>` in camelCase, defined in `.golangci.yml` importas section):

```go
import (
    cryptoutilMagic "cryptoutil/internal/shared/magic"
    cryptoutilServer "cryptoutil/internal/server"
    cryptoutilCmdCicdCommon "cryptoutil/internal/cmd/cicd/common"
)
```

**Third-Party Package Aliases**:

```go
import (
    crand "crypto/rand"  // Avoid conflict with math/rand
    googleUuid "github.com/google/uuid"
    jose "github.com/go-jose/go-jose/v4"
)
```

**Crypto Acronym Conventions**: ALWAYS use ALL CAPS for crypto acronyms (RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER)

**Examples**: ✅ `func NewRSAKey() {}`, `func GenerateECDSAKeyPair() {}`, `func ParsePKCS8PrivateKey() {}`, ❌ `func NewRsaKey() {}`, `func GenerateEcdsaKeyPair() {}`

---

## Magic Values Management

**Storage Locations**:

- Shared Constants: `internal/shared/magic/magic_*.go` (network, database, cryptography, testing)
- Domain-Specific: `internal/<domain>/magic*.go`
