---
description: "Go project structure and standards"
applyTo: "**"
---
# Golang

# Go Project Standards - Tactical Guidance

**This file contains ONLY tactical implementation patterns**

## Quick Reference

**Go Version**: 1.25.5 (ALWAYS same everywhere: dev, CI/CD, Docker)
**CGO**: BANNED (CGO_ENABLED=0) except race detector
**Linking**: Static (`-extldflags '-static'`)
**Project Layout**: cmd, internal, pkg, api (avoid /src)

## CGO Ban - CRITICAL

```bash
# Detect CGO dependencies
go list -u -m all | grep '\[.*\]$'

# Use CGO-free alternatives
# ✅ modernc.org/sqlite
# ❌ github.com/mattn/go-sqlite3
```

**ONLY Exception**: Race detector (`-race`) requires CGO_ENABLED=1 (Go toolchain limitation)

## Import Aliases

`cryptoutil<Package>` for internal | `<vendor><Package>` for external | Crypto acronyms ALL CAPS (RSA, ECDSA, HMAC, JWK, ED25519)

## Magic Values Locations

- **Shared**: `internal/shared/magic/magic_*.go`
- **Domain-Specific**: `internal/<domain>/magic*.go`

## Go Version Consistency

**MANDATORY: Use same Go version everywhere** (development, CI/CD, Docker, documentation)

**Current Version**: 1.25.5 (check `go.mod`)

**See**: `versions.md` for version table

**Enforcement Locations**: `go.mod`: `go 1.25.5`, `.github/workflows/*.yml`: `GO_VERSION: '1.25.5'`, `Dockerfile`: `FROM golang:1.25.5-alpine`, `README.md`: Document Go 1.25.5+ requirement

---

## CGO Ban - CRITICAL

**CGO_ENABLED=0 is MANDATORY** (except race detector)

**Rationale**: Maximum portability (no C toolchain), static linking (single binary), cross-compilation, no C library version conflicts

**ONLY Exception**: Race detector (`go test -race`) requires CGO_ENABLED=1 (Go toolchain limitation using C-based ThreadSanitizer from LLVM)

**CGO-Free Alternatives**: ✅ `modernc.org/sqlite` (not `github.com/mattn/go-sqlite3`), Pure Go crypto/networking (standard library)

---

## Build Flags and Linking

**Pattern**: Static binaries with debug symbols

```go
LDFLAGS := -ldflags "-extldflags '-static' -X main.version=$(VERSION) -X main.buildDate=$(BUILD_DATE)"
go build $(LDFLAGS) -o ./bin/cryptoutil ./cmd/cryptoutil
```

**Validation**: Linux: `ldd ./bin/cryptoutil` (should show "statically linked"), Windows: `dumpbin /dependents ./bin/cryptoutil.exe`

---

## Go Project Structure

**Standard Layout** (follow [golang-standards/project-layout](https://github.com/golang-standards/project-layout)):

```
cryptoutil/
├── cmd/                     # Applications (external entry points for binary executables)
│   ├── cryptoutil/          # Cryptoutil suite CLI (main.go, external entry point for internal/apps/cryptoutil/cryptoutil.go)
│   ├── cipher/              # Cipher product CLI (main.go, external entry point for internal/apps/cipher/cipher.go)
│   │── cipher-im/           # - Instant Messaging CLI (main.go, external entry point for internal/apps/cipher/im/im.go)
│   ├── jose/                # JOSE product CLI (main.go, external entry point for internal/apps/jose/jose.go)
│   │── jose-ja/             # - JWK Authority service CLI (main.go, external entry point for internal/apps/jose/ja/ja.go)
│   ├── pki/                 # PKI product CLI (main.go, external entry point for internal/apps/pki/pki.go)
│   │── pki-ca/              # - Certificate Authority service CLI (main.go, external entry point for internal/apps/pki/ca/ca.go)
│   ├── identity/            # Identity product CLI (main.go, external entry point for internal/apps/identity/identity.go)
│   │── identity-authz/      # - Authorization service CLI (main.go, external entry point for internal/apps/identity/authz/authz.go)
│   │── identity-idp/        # - Identity Provider service CLI (main.go, external entry point for internal/apps/identity/idp/idp.go)
│   │── identity-rp/         # - Relying Party service CLI (main.go, external entry point for internal/apps/identity/rp/rp.go)
│   │── identity-rs/         # - Resource Server service CLI (main.go, external entry point for internal/apps/identity/rs/rs.go)
│   │── identity-spa/        # - SPA Hosting service CLI (main.go, external entry point for internal/apps/identity/spa/spa.go)
│   │── sm/                  # Secrets Manager product CLI (main.go, external entry point for internal/apps/sm/sm.go)
│   └── sm-kms/              # - Key Management Service CLI (main.go, external entry point for internal/apps/sm/kms/kms.go)
├── internal/                # Private application code
│   └── apps/                # Applications (Internal) - used by cmd/, organized as PRODUCT/SERVICE/
│       ├── cryptoutil/      # Cryptoutil suite (cryptoutil.go, internal entry point for cmd/cryptoutil/main.go)
│       ├── cipher/          # Cipher product (cipher.go, internal entry point for cmd/cipher/main.go)
│       │   └── im/          # - Instant Messaging (im.go, internal entry point for cmd/cipher-im/main.go)
│       ├── jose/            # JOSE product (jose.go, internal entry point for cmd/jose/main.go)
│       |   └── ja/          # - JWK Authority service (ja.go, internal entry point for cmd/jose-ja/main.go)
│       ├── pki/             # PKI product (pki.go, internal entry point for cmd/pki/main.go)
│       |   └── ca/          # - Certificate Authority service (ca.go, internal entry point for cmd/pki-ca/main.go)
│       ├── identity/        # Identity product (identity.go, internal entry point for cmd/identity/main.go)
│       │   ├── authz/       # - Authorization service (authz.go, internal entry point for cmd/identity-authz/main.go)
│       │   ├── idp/         # - Identity Provider service (idp.go, internal entry point for cmd/identity-idp/main.go)
│       │   ├── rp/          # - Relying Party service (rp.go, internal entry point for cmd/identity-rp/main.go)
│       │   ├── rs/          # - Resource Server service (rs.go, internal entry point for cmd/identity-rs/main.go)
│       |   └── spa/         # - SPA Hosting service (spa.go, internal entry point for cmd/identity-spa/main.go)
│       └── sm/              # Secrets Manager product (sm.go, internal entry point for cmd/sm/main.go)
│           └── kms/         # - Key Management Service (kms.go, internal entry point for cmd/sm-kms/main.go)
│   ├── shared/              # Shared utilities
│   │   ├── apperr/
│   │   ├── barrier/         # Encryption-at-rest (Unseal service, Hierarchal root+intermediate+content services)
│   │   ├── config/
│   │   ├── container/       # PostgreSQL, Otel Collector Contrib, Grafana LGTM
│   │   ├── crypto/
│   │   │   ├── asn1/
│   │   │   ├── certificate/ # Offline Root CA, Online Root CA, Intermediate CA, Policy CA, Leaf certificates
│   │   │   ├── digests/     # SHA2
│   │   │   ├── hash/        # Hashing utilities: {Low|High}Entropy{Random|Fixed} based on {PBKDF2|HKDF}withSHA2
│   │   │   ├── jose/        # JOSE (JWK, JWS, JWE) utilities
│   │   │   ├── keygen/
│   │   │   ├── keygenpool/  # RSA, EC, ED, AES, AESHS, HMAC, UUIDv7
│   │   │   ├── tls/         # Encryption-in-transit (TLS) utilities
│   │   ├── magic/
│   │   ├── pool/            # High-performance service for keygenpool/
│   │   ├── telemetry/       # OpenTelemetry (tracing, metrics, logging)
│   │   ├── testutil/
│   │   └── util/
├── api/                     # OpenAPI specs, generated code
├── configs/                 # Configuration files
├── deployments/             # Docker Compose, Kubernetes manifests
└── docs/                    # Documentation
├── pkg/                     # Public library code (empty)
├── scripts/                 # Build/test scripts (minimal, prefer Go applications)
├── test/                    # Additional test files: Gatling (Load tests)
```

**Key Rules**: ❌ Avoid `/src` directory (redundant in Go), ❌ Avoid deep nesting (>3 levels indicates design issue), ✅ Use `/internal` for private code (enforced by compiler), ✅ Use `/pkg` for public libraries (safe for external import)

---

## Application Architecture

**Layered Architecture**: main() [cmd/] → Application [internal/*/application/] → Business Logic [internal/*/service/, internal/*/domain/] → Repositories [internal/*/repository/] → Database/External Systems

**Configuration Management**: ✅ YAML files + CLI flags (explicit, version-controlled), ✅ Docker/Kubernetes secrets (sensitive data), ❌ Environment variables (NOT used for configuration)

**Design Patterns**: Constructor injection (`NewService(logger, repo, config)`), context propagation (pass `context.Context` to all long-running ops), graceful shutdown (listen for signals, close resources cleanly), factory pattern (create instances with dependencies injected), error propagation (wrap errors with context: `fmt.Errorf("failed to X: %w", err)`)

---

## Import Alias Conventions

**Internal Package Aliases** (Pattern: `cryptoutil<PackageName>` in camelCase, defined in `.golangci.yml` importas section):

```go
import (
    cryptoutilMagic "cryptoutil/internal/shared/magic"
    cryptoutilServer "cryptoutil/internal/server"
    cryptoutilCmdCicdCommon "cryptoutil/internal/cmd/cicd/common"
)
```

**Third-Party Package Aliases**:

```go
import (
    crand "crypto/rand"  // Avoid conflict with math/rand
    googleUuid "github.com/google/uuid"
    jose "github.com/go-jose/go-jose/v4"
)
```

**Crypto Acronym Conventions**: ALWAYS use ALL CAPS for crypto acronyms (RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER)

**Examples**: ✅ `func NewRSAKey() {}`, `func GenerateECDSAKeyPair() {}`, `func ParsePKCS8PrivateKey() {}`, ❌ `func NewRsaKey() {}`, `func GenerateEcdsaKeyPair() {}`

---

## Magic Values Management

**Storage Locations**:

- Shared Constants: `internal/shared/magic/magic_*.go` (network, database, cryptography, testing)
- Domain-Specific: `internal/<domain>/magic*.go`

**Naming Conventions** (Pattern: Descriptive names grouped by category):

```go
package magic

// Network constants
const (
    DefaultHTTPPort      = 8080
    DefaultAdminPort     = 9090
    DefaultReadTimeout   = 30 * time.Second
    IPv4Loopback        = "127.0.0.1"
)

// Database constants
const (
    DBSQLiteBusyTimeout       = 30000  // milliseconds
    SQLiteMaxOpenConnections  = 5      // GORM transaction support
    PostgreSQLMaxOpenConns    = 25
)

// Cryptography constants
const (
    DefaultPBKDF2Iterations = 600000   // OWASP 2023 recommendation
    DefaultHMACSaltLength   = 32       // 256 bits
    DefaultAESKeySize       = 256      // bits
)

// Testing constants
const (
    TestProbAlways  = 1.0   // 100% execution (base algorithms)
    TestProbQuarter = 0.25  // 25% execution (key size variants)
    TestProbTenth   = 0.1   // 10% execution (redundant variants)
)
```

---

## Key Takeaways

1. Version Consistency: Same Go version (1.25.5) everywhere (dev, CI/CD, Docker)
2. CGO Ban: CGO_ENABLED=0 always (except race detector)
3. Static Linking: Single binary deployment with debug symbols
4. Project Structure: Follow golang-standards/project-layout (cmd, internal, pkg, api)
5. Import Aliases: `cryptoutil<PackageName>` for internal, defined in `.golangci.yml`
6. Crypto Acronyms: ALL CAPS (RSA, ECDSA, HMAC, JWK, etc.)
7. Magic Values: Shared in `internal/shared/magic/`, domain-specific in `internal/<domain>/magic*.go`
8. Architecture: Layered (main → app → business → repo), dependency injection, graceful shutdown
