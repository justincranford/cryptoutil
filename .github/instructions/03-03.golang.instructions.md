---
description: "Instructions for Go project structure, architecture, and coding standards"
applyTo: "**"
---
# Golang

---

description: "Instructions for Go project structure, architecture, and coding standards"
applyTo: "**"
---

# Go Project Standards - Tactical Guidance

**This file contains ONLY tactical implementation patterns**

## Quick Reference

**Go Version**: 1.25.5 (ALWAYS same everywhere: dev, CI/CD, Docker)
**CGO**: BANNED (CGO_ENABLED=0) except race detector
**Linking**: Static (`-extldflags '-static'`)
**Project Layout**: cmd, internal, pkg, api (avoid /src)

## CGO Ban - CRITICAL

```bash
# Detect CGO dependencies
go list -u -m all | grep '\[.*\]$'

# Use CGO-free alternatives
# ✅ modernc.org/sqlite
# ❌ github.com/mattn/go-sqlite3
```

**ONLY Exception**: Race detector (`-race`) requires CGO_ENABLED=1 (Go toolchain limitation)

## Import Aliases

`cryptoutil<Package>` for internal | `<vendor><Package>` for external | Crypto acronyms ALL CAPS (RSA, ECDSA, HMAC, JWK, ED25519)

## Magic Values Locations

- **Shared**: `internal/shared/magic/magic_*.go`
- **Domain-Specific**: `internal/<domain>/magic*.go`

## Go Version Consistency

**MANDATORY: Use same Go version everywhere** (development, CI/CD, Docker, documentation)

**Current Version**: 1.25.5 (check `go.mod`)

**See**: `versions.md` for version table

**Enforcement Locations**: `go.mod`: `go 1.25.5`, `.github/workflows/*.yml`: `GO_VERSION: '1.25.5'`, `Dockerfile`: `FROM golang:1.25.5-alpine`, `README.md`: Document Go 1.25.5+ requirement

---

## CGO Ban - CRITICAL

**CGO_ENABLED=0 is MANDATORY** (except race detector)

**Rationale**: Maximum portability (no C toolchain), static linking (single binary), cross-compilation, no C library version conflicts

**ONLY Exception**: Race detector (`go test -race`) requires CGO_ENABLED=1 (Go toolchain limitation using C-based ThreadSanitizer from LLVM)

**CGO-Free Alternatives**: ✅ `modernc.org/sqlite` (not `github.com/mattn/go-sqlite3`), Pure Go crypto/networking (standard library)

---

## Build Flags and Linking

**Pattern**: Static binaries with debug symbols

```go
LDFLAGS := -ldflags "-extldflags '-static' -X main.version=$(VERSION) -X main.buildDate=$(BUILD_DATE)"
go build $(LDFLAGS) -o ./bin/cryptoutil ./cmd/cryptoutil
```

**Validation**: Linux: `ldd ./bin/cryptoutil` (should show "statically linked"), Windows: `dumpbin /dependents ./bin/cryptoutil.exe`

---

## Go Project Structure

**Standard Layout** (follow [golang-standards/project-layout](https://github.com/golang-standards/project-layout)):

```
cryptoutil/
├── cmd/                    # Main applications (entry points)
├── internal/               # Private application code
│   ├── identity/, jose/, kms/, ca/ # Domains
│   ├── shared/             # Shared utilities
│   └── cmd/                # Internal command logic
├── pkg/                    # Public library code
├── api/                    # OpenAPI specs, generated code
├── configs/                # Configuration files
├── scripts/                # Build/test scripts
├── deployments/            # Docker Compose, Kubernetes manifests
├── test/                   # Additional test files (load tests)
└── docs/                   # Documentation
```

**Key Rules**: ❌ Avoid `/src` directory (redundant in Go), ❌ Avoid deep nesting (>3 levels indicates design issue), ✅ Use `/internal` for private code (enforced by compiler), ✅ Use `/pkg` for public libraries (safe for external import)

---

## Application Architecture

**Layered Architecture**: main() [cmd/] → Application [internal/*/application/] → Business Logic [internal/*/service/, internal/*/domain/] → Repositories [internal/*/repository/] → Database/External Systems

**Configuration Management**: ✅ YAML files + CLI flags (explicit, version-controlled), ✅ Docker/Kubernetes secrets (sensitive data), ❌ Environment variables (NOT used for configuration)

**Design Patterns**: Constructor injection (`NewService(logger, repo, config)`), context propagation (pass `context.Context` to all long-running ops), graceful shutdown (listen for signals, close resources cleanly), factory pattern (create instances with dependencies injected), error propagation (wrap errors with context: `fmt.Errorf("failed to X: %w", err)`)

---

## Import Alias Conventions

**Internal Package Aliases** (Pattern: `cryptoutil<PackageName>` in camelCase, defined in `.golangci.yml` importas section):

```go
import (
    cryptoutilMagic "cryptoutil/internal/shared/magic"
    cryptoutilServer "cryptoutil/internal/server"
    cryptoutilCmdCicdCommon "cryptoutil/internal/cmd/cicd/common"
)
```

**Third-Party Package Aliases**:

```go
import (
    crand "crypto/rand"  // Avoid conflict with math/rand
    googleUuid "github.com/google/uuid"
    jose "github.com/go-jose/go-jose/v4"
)
```

**Crypto Acronym Conventions**: ALWAYS use ALL CAPS for crypto acronyms (RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER)

**Examples**: ✅ `func NewRSAKey() {}`, `func GenerateECDSAKeyPair() {}`, `func ParsePKCS8PrivateKey() {}`, ❌ `func NewRsaKey() {}`, `func GenerateEcdsaKeyPair() {}`

---

## Magic Values Management

**Storage Locations**:

- Shared Constants: `internal/shared/magic/magic_*.go` (network, database, cryptography, testing)
- Domain-Specific: `internal/<domain>/magic*.go`

**Naming Conventions** (Pattern: Descriptive names grouped by category):

```go
package magic

// Network constants
const (
    DefaultHTTPPort      = 8080
    DefaultAdminPort     = 9090
    DefaultReadTimeout   = 30 * time.Second
    IPv4Loopback        = "127.0.0.1"
)

// Database constants
const (
    DBSQLiteBusyTimeout       = 30000  // milliseconds
    SQLiteMaxOpenConnections  = 5      // GORM transaction support
    PostgreSQLMaxOpenConns    = 25
)

// Cryptography constants
const (
    DefaultPBKDF2Iterations = 600000   // OWASP 2023 recommendation
    DefaultHMACSaltLength   = 32       // 256 bits
    DefaultAESKeySize       = 256      // bits
)

// Testing constants
const (
    TestProbAlways  = 1.0   // 100% execution (base algorithms)
    TestProbQuarter = 0.25  // 25% execution (key size variants)
    TestProbTenth   = 0.1   // 10% execution (redundant variants)
)
```

---

## Key Takeaways

1. Version Consistency: Same Go version (1.25.5) everywhere (dev, CI/CD, Docker)
2. CGO Ban: CGO_ENABLED=0 always (except race detector)
3. Static Linking: Single binary deployment with debug symbols
4. Project Structure: Follow golang-standards/project-layout (cmd, internal, pkg, api)
5. Import Aliases: `cryptoutil<PackageName>` for internal, defined in `.golangci.yml`
6. Crypto Acronyms: ALL CAPS (RSA, ECDSA, HMAC, JWK, etc.)
7. Magic Values: Shared in `internal/shared/magic/`, domain-specific in `internal/<domain>/magic*.go`
8. Architecture: Layered (main → app → business → repo), dependency injection, graceful shutdown
