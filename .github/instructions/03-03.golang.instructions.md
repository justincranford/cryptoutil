---
description: "Go project structure and standards"
applyTo: "**"
---
# Golang

# Go Project Standards - Tactical Guidance

## Quick Reference

**Go Version**: 1.25.5 (ALWAYS same everywhere: dev, CI/CD, Docker)
**CGO**: BANNED (CGO_ENABLED=0) except race detector
**Project Layout**: cmd, internal, pkg, api (avoid /src)

## Go Version Consistency

**MANDATORY: Use same Go version everywhere** (development, CI/CD, Docker, documentation)

**Current Version**: 1.25.5 (check `go.mod`)

**Enforcement Locations**: `go.mod`: `go 1.25.5`, `.github/workflows/*.yml`: `GO_VERSION: '1.25.5'`, `Dockerfile`: `FROM golang:1.25.5-alpine`, `README.md`: Document Go 1.25.5+ requirement

## CGO Ban - CRITICAL

**CGO_ENABLED=0 is MANDATORY** (except race detector)

**Rationale**: Maximum portability (no C toolchain), static linking (single binary), cross-compilation, no C library version conflicts

Detect CGO dependencies

```bash
go list -u -m all | grep '\[.*\]$'
```

Use CGO-free alternatives

- ✅ Pure Go crypto/networking (standard library)
- ✅ modernc.org/sqlite
- ❌ github.com/mattn/go-sqlite3

**ONLY Exception**: Race detector (`-race`) requires CGO_ENABLED=1 (Go toolchain limitation)

## Import Aliases

`cryptoutil<Package>` for internal
`<vendor><Package>` for external

## Magic Values Locations

- **Shared**: `internal/shared/magic/magic_*.go`
- **Domain-Specific**: `internal/shared/magic/magic_domain*.go`

---

## Go Project Structure

The patterns in **Command Line Patterns for Cryptoutil Services** and the structures in **Go Project Structure** are intended to be closely aligned, for intuitive organization of suite-level, product-level, and service-level CLI executable interfaces and implementations.

This section describes **Go Project Structure** for organizing CLI executable implementations in cmd/ and internal/apps/.

This structure builds upon **Golang Standard Project Layout** (follow [golang-standards/project-layout](https://github.com/golang-standards/project-layout)):

Expanded View:

```
cryptoutil/
├── cmd/                                   # Applications (external entry points for binary executables)
│   ├── cryptoutil/main.go                 # Cryptoutil suite: cmd/cryptoutil/main.go -> internal/apps/cryptoutil/cryptoutil.go
│   ├── cipher/main.go                     # Cipher product: cmd/cipher/main.go -> internal/apps/cipher/cipher.go
│   │── cipher-im/main.go                  # Cipher product, Instant Messaging service: cmd/cipher-im/main.go -> internal/apps/cipher/im/im.go
│   ├── jose/main.go                       # JOSE product: cmd/jose/main.go -> internal/apps/jose/jose.go
│   │── jose-ja/main.go                    # JOSE product, JWK Authority service: cmd/jose-ja/main.go -> internal/apps/jose/ja/ja.go
│   ├── pki/main.go                        # PKI product: cmd/pki/main.go -> internal/apps/pki/pki.go
│   │── pki-ca/main.go                     # PKI product, Certificate Authority service: cmd/pki-ca/main.go -> internal/apps/pki/ca/ca.go
│   ├── identity/main.go                   # Identity product: cmd/identity/main.go -> internal/apps/identity/identity.go
│   │── identity-authz/main.go             # Identity product, Authorization service: cmd/identity-authz/main.go -> internal/apps/identity/authz/authz.go
│   │── identity-idp/main.go               # Identity product, Identity Provider service: cmd/identity-idp/main.go -> internal/apps/identity/idp/idp.go
│   │── identity-rp/main.go                # Identity product, Relying Party service: cmd/identity-rp/main.go -> internal/apps/identity/rp/rp.go
│   │── identity-rs/main.go                # Identity product, Resource Server service: cmd/identity-rs/main.go -> internal/apps/identity/rs/rs.go
│   │── identity-spa/main.go               # Identity product, Single Page Application service: cmd/identity-spa/main.go -> internal/apps/identity/spa/spa.go
│   │── sm/main.go                         # Secrets Manager product: cmd/sm/main.go -> internal/apps/sm/sm.go
│   └── sm-kms/main.go                     # Secrets Manager product, Key Management service: cmd/sm-kms/main.go -> internal/apps/sm/kms/kms.go
├── internal/                              # Private application code
│   │── apps/                              # Applications (Internal) - used by cmd/, organized as PRODUCT/SERVICE/
│   │   ├── cryptoutil/cryptoutil.go       # Cryptoutil suite: cmd/cryptoutil/main.go -> internal/apps/cryptoutil/cryptoutil.go
│   │   ├── cipher/cipher.go               # Cipher product: cmd/cipher/main.go -> internal/apps/cipher/cipher.go
│   │   │── cipher-im/im.go                # Cipher product, Instant Messaging service: cmd/cipher-im/main.go -> internal/apps/cipher/im/im.go
│   │   ├── jose/jose.go                   # JOSE product: cmd/jose/main.go -> internal/apps/jose/jose.go
│   │   │── jose-ja/ja.go                  # JOSE product, JWK Authority service: cmd/jose-ja/main.go -> internal/apps/jose/ja/ja.go
│   │   ├── pki/pki.go                     # PKI product: cmd/pki/main.go -> internal/apps/pki/pki.go
│   │   │── pki-ca/ca.go                   # PKI product, Certificate Authority service: cmd/pki-ca/main.go -> internal/apps/pki/ca/ca.go
│   │   ├── identity/identity.go           # Identity product: cmd/identity/main.go -> internal/apps/identity/identity.go
│   │   │── identity-authz/authz.go        # Identity product, Authorization service: cmd/identity-authz/main.go -> internal/apps/identity/authz/authz.go
│   │   │── identity-idp/idp.go            # Identity product, Identity Provider service: cmd/identity-idp/main.go -> internal/apps/identity/idp/idp.go
│   │   │── identity-rp/rp.go              # Identity product, Relying Party service: cmd/identity-rp/main.go -> internal/apps/identity/rp/rp.go
│   │   │── identity-rs/rs.go              # Identity product, Resource Server service: cmd/identity-rs/main.go -> internal/apps/identity/rs/rs.go
│   │   │── identity-spa/spa.go            # Identity product, Single Page Application service: cmd/identity-spa/main.go -> internal/apps/identity/spa/spa.go
│   │   │── sm/sm.go                       # Secrets Manager product: cmd/sm/main.go -> internal/apps/sm/sm.go
│   │   └── sm-kms/kms.go                  # Secrets Manager product, Key Management service: cmd/sm-kms/main.go -> internal/apps/sm/kms/kms.go
│   ├── shared/                  # Shared utilities
│   │   ├── apperr/
│   │   ├── barrier/         # Encryption-at-rest (Unseal service, Hierarchal root+intermediate+content services)
│   │   ├── config/
│   │   ├── container/       # PostgreSQL, Otel Collector Contrib, Grafana LGTM
│   │   ├── crypto/
│   │   │   ├── asn1/
│   │   │   ├── certificate/ # Offline Root CA, Online Root CA, Intermediate CA, Policy CA, Leaf certificates
│   │   │   ├── digests/     # SHA2
│   │   │   ├── hash/        # Hashing utilities: {Low|High}Entropy{Random|Fixed} based on {PBKDF2|HKDF}withSHA2
│   │   │   ├── jose/        # JOSE (JWK, JWS, JWE) utilities
│   │   │   ├── keygen/
│   │   │   ├── keygenpool/  # RSA, EC, ED, AES, AESHS, HMAC, UUIDv7
│   │   │   ├── tls/         # Encryption-in-transit (TLS) utilities
│   │   ├── magic/
│   │   ├── pool/            # High-performance service for keygenpool/
│   │   ├── telemetry/       # OpenTelemetry (tracing, metrics, logging)
│   │   ├── testutil/
│   │   └── util/
├── api/                     # OpenAPI specs, generated code
├── configs/                 # Configuration files
├── deployments/             # Docker Compose, Kubernetes manifests
└── docs/                    # Documentation
├── pkg/                     # Public library code (empty)
├── scripts/                 # Build/test scripts (minimal, prefer Go applications)
├── test/                    # Additional test files: Gatling (Load tests)
```

**Key Rules**: ❌ Avoid `/src` directory (redundant in Go), ❌ Avoid deep nesting (>8 levels indicates design issue), ✅ Use `/internal` for private code (enforced by compiler), ✅ Use `/pkg` for public libraries (safe for external import)

---

## Command Line Patterns for Cryptoutil Services

The patterns in **Command Line Patterns for Cryptoutil Services** and the structures in **Go Project Structure** are intended to be closely aligned, for intuitive organization of suite-level, product-level, and service-level CLI executable interfaces and implementations.

This section describes **Command Line Patterns for Cryptoutil Services** for CLI executable interfaces.

## Patterns

### 1. Product-Service Pattern

**Description**: Separate executables for each product-service combination that routes to service entry point, then subcommand.

Every service executable supports these SUBCOMMANDs: server, client, health, livez, readyz, shutdown, init, compose, demo, e2e.

**Call Flow**:

```
cmd/PRODUCT-SERVICE/main.go
  → internal/app/PRODUCT/SERVICE/SERVICE.go SUBCOMMAND
```

**Examples**:

- `cmd/cipher-im/main.go server` → `internal/app/cipher/im/im.go server`
- `cmd/jose-ja/main.go client` → `internal/app/jose/ja/ja.go client`
- `cmd/pki-ca/main.go health` → `internal/app/pki/ca/ca.go health`
- `cmd/identity-authz/main.go livez` → `internal/app/identity/authz/authz.go livez`
- `cmd/identity-idp/main.go readyz` → `internal/app/identity/idp/idp.go readyz`
- `cmd/sm-kms/main.go shutdown` → `internal/app/sm/kms/kms.go shutdown`

---

### 2. Product Pattern

**Description**: Separate executables per product that routes to product entry point, then service entry point, then subcommand.

Every product executable supports these product-level SUBCOMMANDs, that recurse to each of its services: health, readyz, livez, shutdown, init, compose, demo, e2e.

**Call Flow**:

```
cmd/PRODUCT/main.go
  → internal/app/PRODUCT/PRODUCT.go SERVICE SUBCOMMAND
    → [1-to-1] internal/app/PRODUCT/SERVICE/SERVICE.go SUBCOMMAND
  → internal/app/PRODUCT/PRODUCT.go SUBCOMMAND
    → [1-to-N] internal/app/PRODUCT/*/SERVICE.go SUBCOMMAND
```

**Examples (1-to-1)**:

- `cmd/cipher/main.go im server` → `internal/app/cipher/cipher.go im server` → `internal/app/cipher/im/im.go server`
- `cmd/jose/main.go ja client` → `internal/app/jose/jose.go ja client` → `internal/app/jose/ja/ja.go client`
- `cmd/pki/main.go ca health` → `internal/app/pki/pki.go ca health` → `internal/app/pki/ca/ca.go health`
- `cmd/identity/main.go authz livez` → `internal/app/identity/identity.go authz livez` → `internal/app/identity/authz/authz.go livez`
- `cmd/identity/main.go idp readyz` → `internal/app/identity/identity.go idp readyz` → `internal/app/identity/idp/idp.go readyz`
- `cmd/sm/main.go kms shutdown` → `internal/app/sm/sm.go kms shutdown` → `internal/app/sm/kms/kms.go shutdown`

**Examples (1-to-N)**:

- `cmd/cipher/main.go init` → `internal/app/cipher/cipher.go init` → `internal/app/cipher/*/*.go init`
- `cmd/jose/main.go compose` → `internal/app/jose/jose.go compose` → `internal/app/jose/*/*.go compose`
- `cmd/pki/main.go demo` → `internal/app/pki/pki.go demo` → `internal/app/pki/*/*.go demo`
- `cmd/identity/main.go e2e` → `internal/app/identity/identity.go main` → `internal/app/identity/*/*.go e2e`
- `cmd/sm/main.go kms health` → `internal/app/sm/sm.go health` → `internal/app/sm/*/*.go health`

---

### 3. Suite Pattern

**Description**: A single unified `cryptoutil` executable that routes to internal cryptoutil suite, then product, then service, then subcommand.

Cryptoutil suite executable supports these suite-level SUBCOMMANDs, that recurse to each of its products, and then their services: health, readyz, livez, shutdown, init, compose, demo, e2e.

**Call Flow**:

```
cmd/cryptoutil/main.go PRODUCT SERVICE SUBCOMMAND
  → internal/app/cryptoutil/cryptoutil.go PRODUCT SERVICE SUBCOMMAND
    → internal/app/PRODUCT/PRODUCT.go SERVICE SUBCOMMAND
      → [1-to-1] internal/app/PRODUCT/SERVICE/SERVICE.go SUBCOMMAND
    → internal/app/PRODUCT/PRODUCT.go SUBCOMMAND
      → [1-to-N] internal/app/PRODUCT/*/SERVICE.go SUBCOMMAND
```

**Examples (1-to-1)**:

- `cmd/cryptoutil/main.go cipher im server` → `internal/app/cryptoutil/cryptoutil.go cipher im server` → `internal/app/cipher/cipher.go im server` → `internal/app/cipher/im/im.go server`
- `cmd/cryptoutil/main.go jose ja client` → `internal/app/cryptoutil/cryptoutil.go jose ja client` → `internal/app/jose/jose.go ja client` → `internal/app/jose/ja/ja.go client`
- `cmd/cryptoutil/main.go pki ca health` → `internal/app/cryptoutil/cryptoutil.go pki ca health` → `internal/app/pki/pki.go ca health` → `internal/app/pki/ca/ca.go health`
- `cmd/cryptoutil/main.go identity authz livez` → `internal/app/cryptoutil/cryptoutil.go identity authz livez` → `internal/app/identity/identity.go authz livez` → `internal/app/identity/authz/authz.go livez`
- `cmd/cryptoutil/main.go identity idp readyz` → `internal/app/cryptoutil/cryptoutil.go identity idp readyz` → `internal/app/identity/identity.go idp readyz` → `internal/app/identity/idp/idp.go readyz`
- `cmd/cryptoutil/main.go sm kms shutdown` → `internal/app/cryptoutil/cryptoutil.go sm kms shutdown` → `internal/app/sm/sm.go kms shutdown` → `internal/app/sm/kms/kms.go shutdown`

**Examples (1-to-N)**:

- `cmd/cryptoutil/main.go init` → `internal/app/cryptoutil/cryptoutil.go init` → `internal/app/cipher/cipher.go init` → `internal/app/cipher/*/*.go init`
- `cmd/cryptoutil/main.go compose` → `internal/app/cryptoutil/cryptoutil.go compose` → `internal/app/jose/jose.go compose` → `internal/app/jose/*/*.go compose`
- `cmd/cryptoutil/main.go demo` → `internal/app/cryptoutil/cryptoutil.go demo` → `internal/app/pki/pki.go ca demo` → `internal/app/pki/*/*.go demo`
- `cmd/cryptoutil/main.go e2e` → `internal/app/cryptoutil/cryptoutil.go e2e` → `internal/app/identity/identity.go e2e` → `internal/app/identity/*/*.go e2e`
- `cmd/cryptoutil/main.go health` → `internal/app/cryptoutil/cryptoutil.go health` → `internal/app/sm/sm.go health` → `internal/app/sm/*/*.go health`

---

## Anti-Patterns

**Description**: No executables are allowed that correspond directly to subcommands.

**Suite-Level Anti-Pattern Examples**:

- `cmd/cryptoutil-health/main.go`: Not allowed
- `cmd/cryptoutil-livez/main.go`: Not allowed
- `cmd/cryptoutil-shutdown/main.go`: Not allowed
- `cmd/cryptoutil-init/main.go`: Not allowed
- `cmd/cryptoutil-compose/main.go`: Not allowed
- `cmd/cryptoutil-demo/main.go`: Not allowed
- `cmd/cryptoutil-e2e/main.go`: Not allowed
- `cmd/cryptoutil-server/main.go`: Not allowed
- `cmd/cryptoutil-client/main.go`: Not allowed

**Product-Level Anti-Pattern Examples**:

- `cmd/cipher-server/main.go`: Not allowed
- `cmd/jose-client/main.go`: Not allowed
- `cmd/pki-health/main.go`: Not allowed
- `cmd/identity-livez/main.go`: Not allowed
- `cmd/sm-shutdown/main.go`: Not allowed

**Service-Level Anti-Pattern Examples**:

- `cmd/cipher-im-server/main.go`: Not allowed
- `cmd/jose-ja-client/main.go`: Not allowed
- `cmd/pki-ca-health/main.go`: Not allowed
- `cmd/identity-authz-livez/main.go`: Not allowed
- `cmd/identity-idp-readyz/main.go`: Not allowed
- `cmd/sm-kms-shutdown/main.go`: Not allowed

---

## Application Architecture

**Layered Architecture**: main() [cmd/] → Application [internal/*/application/] → Business Logic [internal/*/service/, internal/*/domain/] → Repositories [internal/*/repository/] → Database/External Systems

**Configuration Management**: ✅ YAML files + CLI flags (explicit, version-controlled), ✅ Docker/Kubernetes secrets (sensitive data), ❌ Environment variables (NOT used for configuration)

**Design Patterns**: Constructor injection (`NewService(logger, repo, config)`), context propagation (pass `context.Context` to all long-running ops), graceful shutdown (listen for signals, close resources cleanly), factory pattern (create instances with dependencies injected), error propagation (wrap errors with context: `fmt.Errorf("failed to X: %w", err)`)

---

## Import Alias Conventions

**Internal Package Aliases** (Pattern: `cryptoutil<PackageName>` in camelCase, defined in `.golangci.yml` importas section):

```go
import (
    cryptoutilMagic "cryptoutil/internal/shared/magic"
    cryptoutilServer "cryptoutil/internal/server"
    cryptoutilCmdCicdCommon "cryptoutil/internal/cmd/cicd/common"
)
```

**Third-Party Package Aliases**:

```go
import (
    crand "crypto/rand"  // Avoid conflict with math/rand
    googleUuid "github.com/google/uuid"
    jose "github.com/go-jose/go-jose/v4"
)
```

**Crypto Acronym Conventions**: ALWAYS use ALL CAPS for crypto acronyms (RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER)

**Examples**: ✅ `func NewRSAKey() {}`, `func GenerateECDSAKeyPair() {}`, `func ParsePKCS8PrivateKey() {}`, ❌ `func NewRsaKey() {}`, `func GenerateEcdsaKeyPair() {}`

---

## Magic Values Management

**Storage Locations**:

- Shared Constants: `internal/shared/magic/magic_*.go` (network, database, cryptography, testing)
- Domain-Specific: `internal/<domain>/magic*.go`
