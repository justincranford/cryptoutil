---
description: "Instructions for Go project structure, architecture, and coding standards"
applyTo: "**"
---
# Go Project Structure, Architecture & Standards

## Go Version Consistency

- **ALWAYS use the same Go version in every part of the project** (development, CI/CD, Docker)
- Current project Go version: **1.25.5** (check go.mod file)
- Set `GO_VERSION: '1.25.5'` in workflow environment variables
- Use `go-version: ${{ env.GO_VERSION }}` in setup-go actions

## CGO Ban - CRITICAL

**!!! CRITICAL: CGO IS BANNED EXCEPT FOR RACE DETECTOR !!!**

- **CGO_ENABLED=0** is MANDATORY for builds, tests, Docker, production deployments
- **ONLY EXCEPTION**: Race detector workflow (`-race` flag) requires CGO_ENABLED=1 (Go toolchain limitation)
- **ALWAYS** use CGO-free alternatives (e.g., `modernc.org/sqlite`)
- **NEVER** use dependencies that require CGO (e.g., `github.com/mattn/go-sqlite3`)
- User has CGO_ENABLED=0 in settings.json for normal development

**Go Toolchain Limitation**: Go's race detector (`go test -race`) requires CGO because it uses C-based ThreadSanitizer library from LLVM. This is a fundamental Go toolchain constraint, not a project choice.

**Rationale**: Maximum portability, static linking, cross-compilation, no C toolchain dependencies for production

### Detect and Reject CGO as Transitive Dependency

- Check: `go list -u -m all | grep '\[.*\]$'`
- Update incrementally, test after each, sync ecosystem packages

## Build Flags and Linking

### Static Linking Requirement

- **ALWAYS use static linking** to ensure maximum portability
- Use `-extldflags '-static'` in ldflags for static linking
- Validate static linking with `ldd` check
- **ALWAYS retain debug symbols** for troubleshooting

## Go Project Structure

Follow the [Standard Go Project Layout](https://github.com/golang-standards/project-layout) patterns:

- `/cmd` - Main applications (minimal main functions)
- `/internal` - Private code enforced by compiler
- `/pkg` - Library code safe for external use
- `/api` - OpenAPI specs, protocol definitions
- `/configs`, `/scripts`, `/deployments`, `/test`, `/docs`, `/tools`
- **Avoid**: `/src` directory, deep nesting

## Application Architecture

- Layered: main → app → business logic → repositories
- Config: YAML files & CLI only (no env vars; use Docker/K8s secrets)
- Dependency injection, context propagation, graceful shutdown
- Factory pattern, error propagation, config validation

## Import Alias Conventions

**ALL `cryptoutil/**` imports MUST use camelCase aliases with "cryptoutil" prefix:**

- Pattern: `cryptoutil<PackageName>` (e.g., `cryptoutilMagic`, `cryptoutilCmdCicdCommon`)
- Defined in `.golangci.yml` importas section (source of truth)
- Common third-party: `googleUuid`, `joseJwa/Jwe/Jwk/Jws`, `crand "crypto/rand"`

**Crypto acronyms ALL CAPS**: RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER

## Magic Values Management

- Shared: `internal/common/magic/magic_*.go`
- Identity-specific: `/internal/identity/<package>/magic*.go`
- Group by category (buffers, timeouts, network); use descriptive names
