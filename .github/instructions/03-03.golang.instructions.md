---
description: "Go project structure and standards"
applyTo: "**"
---
# Go Project Standards

## Quick Reference

**Go Version**: 1.25.5 (ALWAYS same everywhere: dev, CI/CD, Docker)
**CGO**: BANNED (CGO_ENABLED=0) except race detector
**Project Layout**: cmd, internal, pkg, api (avoid /src)

## Go Version Consistency

**MANDATORY: Use same Go version everywhere** (development, CI/CD, Docker, documentation)

**Enforcement Locations**: `go.mod`, `.github/workflows/*.yml`, `Dockerfile`, `README.md`

## CGO Ban - CRITICAL

**CGO_ENABLED=0 is MANDATORY** (except race detector `-race` which requires CGO_ENABLED=1).

**Rationale**: Maximum portability, static linking, cross-compilation.

**CGO-free alternatives**: modernc.org/sqlite (NOT mattn/go-sqlite3).

## Import Aliases

`cryptoutil<Package>` for internal, `<vendor><Package>` for external.

## Magic Values Locations

- **Shared**: `internal/shared/magic/magic_*.go`
- **Domain-Specific**: `internal/shared/magic/magic_domain*.go`

## Go Project Structure

```
cryptoutil/
+-- cmd/                                   # Binary entry points
|   +-- cryptoutil/main.go                 # Suite: -> internal/apps/cryptoutil/
|   +-- cipher-im/main.go                  # Service: -> internal/apps/cipher/im/
|   +-- jose-ja/main.go                    # Service: -> internal/apps/jose/ja/
|   +-- pki-ca/main.go                     # Service: -> internal/apps/pki/ca/
|   +-- identity-{authz,idp,rp,rs,spa}/    # Service: -> internal/apps/identity/{svc}/
|   +-- sm-kms/main.go                     # Service: -> internal/apps/sm/kms/
|   +-- cipher/main.go                     # Product: -> internal/apps/cipher/
|   +-- jose/main.go                       # Product: -> internal/apps/jose/
|   +-- pki/main.go                        # Product: -> internal/apps/pki/
|   +-- identity/main.go                   # Product: -> internal/apps/identity/
|   +-- sm/main.go                         # Product: -> internal/apps/sm/
+-- internal/
|   +-- apps/                              # Applications: PRODUCT/SERVICE/
|   +-- shared/                            # Shared utilities
|   |   +-- barrier/                       # Encryption-at-rest (Unseal, Root, Intermediate, Content)
|   |   +-- crypto/{asn1,certificate,digests,hash,jose,keygen,keygenpool,tls}/
|   |   +-- magic/                         # Named constants
|   |   +-- pool/                          # High-performance key gen pool
|   |   +-- telemetry/                     # OpenTelemetry
+-- api/                                   # OpenAPI specs, generated code
+-- pkg/                                   # Public library code
```

**Key Rules**: No `/src` directory, no deep nesting (>8 levels), use `/internal` for private code.

## CLI Patterns

### Product-Service Pattern

`cmd/PRODUCT-SERVICE/main.go SUBCOMMAND` -> `internal/app/PRODUCT/SERVICE/SERVICE.go SUBCOMMAND`

SUBCOMMANDs: server, client, health, livez, readyz, shutdown, init, compose, demo, e2e.

### Product Pattern

`cmd/PRODUCT/main.go SERVICE SUBCOMMAND` -> 1-to-1 or 1-to-N recursion to services.

Product-level SUBCOMMANDs (recurse to all services): health, readyz, livez, shutdown, init, compose, demo, e2e.

### Suite Pattern

`cmd/cryptoutil/main.go PRODUCT SERVICE SUBCOMMAND` -> product -> service -> subcommand.

### Anti-Patterns

**NO executables for subcommands**: `cmd/cryptoutil-health/main.go` NOT allowed. `cmd/cipher-im-server/main.go` NOT allowed.

## Application Architecture

**Layers**: main() [cmd/] -> Application [internal/*/application/] -> Business Logic [internal/*/service/, domain/] -> Repositories [internal/*/repository/] -> Database

**Configuration**: YAML + CLI flags + Docker/K8s secrets. NO environment variables.

**Design Patterns**: Constructor injection, context propagation, graceful shutdown, factory pattern, error wrapping (`fmt.Errorf("failed to X: %w", err)`).

## Import Alias Conventions

```go
import (
    cryptoutilMagic "cryptoutil/internal/shared/magic"
    cryptoutilServer "cryptoutil/internal/server"
    crand "crypto/rand"
    googleUuid "github.com/google/uuid"
    jose "github.com/go-jose/go-jose/v4"
)
```

**Crypto Acronyms**: ALWAYS ALL CAPS: RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER.
