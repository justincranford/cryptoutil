---
description: "Service federation configuration patterns"
applyTo: "**"
---
# Service Federation Configuration - Tactical Guidance

## CRITICAL: User Has Answered This Multiple Times

**User feedback from QUIZME-v3 Q2.1**: "i have answered this question multiple times before. document it, and add to the appropriate copilot instructions file, so you don't have to ask me this question over and over again."

## Core Pattern - MANDATORY

**ALWAYS use static YAML configuration for federated services (NEVER dynamic discovery)**

### Federation Service Discovery

**Pattern**: Static configuration file specifies all federated service URLs

**Configuration**:
```yaml
federation:
  identity_url: "https://identity-authz:8180"  # Static service name (Docker) or FQDN (K8s)
  identity_enabled: true
  identity_timeout: 10s
  jose_url: "https://jose-ja:8280"
  jose_enabled: true
  ca_url: "https://ca-server:8380"
  ca_enabled: false  # Optional services
```

**Deployment-Specific URLs**:
- **Docker Compose**: Use service names (e.g., `identity-authz:8180`)
- **Kubernetes**: Use FQDN (e.g., `identity-authz.cryptoutil-ns.svc.cluster.local:8180`)
- **Development**: Use localhost with specific ports (e.g., `127.0.0.1:8180`)

**NO Dynamic Discovery Mechanisms**:
- ❌ NO service mesh discovery (Istio, Linkerd, Consul)
- ❌ NO DNS-SD (DNS Service Discovery)
- ❌ NO Kubernetes Service discovery beyond static FQDN
- ❌ NO automatic failover to other instances
- ❌ NO load balancing across multiple instances
- ✅ ONLY static URLs in YAML configuration
- ✅ Service restart REQUIRED to change federated service URLs

### Federation Fallback Pattern (QUIZME-v3 Q2.2)

**User Answer**: "What are you talking about? Static config for federated services, per-service DB realms, and per-service config realms. If federated is down, the per-service realms are always available for operator fallback."

**NO Circuit Breakers for Federation**:
- ❌ NO automatic failover to fallback mode
- ❌ NO health check-based circuit breaking
- ❌ NO percentage-based error thresholds
- ❌ NO consecutive failure counting
- ✅ Static configuration determines which services are federated
- ✅ If federated service is down, per-service realms provide operator fallback

**Fallback Mechanism - Per-Service Realms**:
```yaml
realms:
  - type: federated
    provider: identity-authz
    url: "https://identity-authz:8180"
  - type: database
    name: local-fallback
    enabled: true  # ALWAYS enabled for operator access
  - type: config
    name: emergency-operators
    users: ["admin@localhost"]
```

**When Federated Service Down**:
- Per-service **database realms** remain available (operator can use local credentials)
- Per-service **config realms** remain available (emergency operators can use config-based credentials)
- NO automatic failover (operator manually uses fallback realm)
- NO service degradation (service continues operating for non-federated users)

### Key Takeaways

1. **Static Config ONLY**: All federated service URLs are static in YAML (NO dynamic discovery)
2. **Restart to Change**: Changing federated service URLs requires service restart
3. **Per-Service Realms**: Database and config realms provide operator fallback when federated services down
4. **NO Circuit Breakers**: Static configuration, NOT health-based automatic failover
5. **Deployment-Specific**: Docker Compose uses service names, K8s uses FQDN, dev uses localhost

## Cross-References

**Related Documentation**:
- [02-01.architecture.instructions.md](.github/instructions/02-01.architecture.instructions.md) - Service architecture patterns
- [02-02.service-template.instructions.md](.github/instructions/02-02.service-template.instructions.md) - Service template configuration
- [02-10.authn.instructions.md](.github/instructions/02-10.authn.instructions.md) - Authentication realms
