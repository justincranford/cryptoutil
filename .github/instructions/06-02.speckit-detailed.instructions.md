---
description: "Instructions for Speckit methodology workflow integration, evidence requirements, and feedback loops"
applyTo: "**"
---
# Speckit Workflow Integration - CRITICAL

## Core Principles

### Iterative Development Reality - CRITICAL

Speckit presents as sequential workflow (constitution → specify → clarify → plan → tasks → analyze → implement). It is useful for non-interactive SDLC using LLM Agents. Human SDLC is iterative.

**Constitution, spec, and plan are LIVING DOCUMENTS** that evolve through implementation feedback, not static prerequisites.

**Balance**: Follow Speckit structure for organization, but embrace continuous refinement of earlier documents based on implementation discoveries.

---

## CLARIFY-QUIZME.md Rules - CRITICAL

### Known Answers NEVER Belong in CLARIFY-QUIZME.md

**MANDATORY**: CLARIFY-QUIZME.md is ONLY for questions with UNKNOWN answers requiring user input.

**NEVER include questions to which you know the answer**:

- ❌ Questions with definitive answers from codebase analysis
- ❌ Questions answered in constitution.md, spec.md, or copilot instructions
- ❌ Questions you can answer by reading existing documentation

**ALWAYS move known information to clarify.md**:

- ✅ Document known answers in clarify.md topical Q&A format
- ✅ Backport corrections to constitution.md and spec.md
- ✅ Keep CLARIFY-QUIZME.md lean with only genuine unknowns

**NEVER pre-fill answers in Write-in questions**:

- ❌ Don't include example answers or hints
- ❌ Don't suggest preferred answers
- ✅ Leave E) Write-in: [blank for user input]

**Example Violation**:

```markdown
### Question 1: Port Range Conflicts
**Correct Answer**: A, all port ranges are unique...  ❌ WRONG
```

**Correct Pattern**:

```markdown
### Question 1: Unknown Federation Pattern
- A) Use consul for service discovery
- B) Use etcd for service discovery
- C) Use DNS-SD for service discovery
- D) Use static configuration only
- E) Write-in:

**Answer**: [User must provide]
```

### CLARIFY-QUIZME.md Workflow

1. **Before adding question**: Search codebase, read constitution.md, spec.md, copilot instructions
2. **If answer is known**: Add to clarify.md, update constitution.md/spec.md
3. **If answer is unknown**: Add to CLARIFY-QUIZME.md with NO pre-filled answers
4. **After user answers**: Move Q&A to clarify.md, update constitution.md/spec.md

---

## Continuous Document Evolution - MANDATORY

### Update Specs Immediately During Implementation

**NEVER wait until phase/iteration complete to update specifications**

**ALWAYS update constitution/spec/plan when discovering constraints, clarifications, or architectural insights**

### Mini-Cycle Feedback Pattern (Every 2-3 Tasks)

```
1. Complete task group (2-3 related tasks)
2. Identify learnings affecting requirements/constraints
3. Update constitution.md/spec.md/plan.md immediately
4. Commit changes with traceability
5. Continue to next task
```

**Rationale**: Waiting until phase complete causes:

- Accumulated technical debt
- Forgotten context for decisions
- Misalignment between spec and implementation
- Costly rework when contradictions discovered late

---

## Implementation-Driven Constraints - MANDATORY

### Living Section Pattern for Constitution.md

Add implementation-driven constraints as they're discovered:

```markdown
## Implementation-Driven Constraints (LIVING SECTION)
*Updated continuously during implementation*

### [Category] (e.g., Database Layer, Testing, Security)

- **Constraint**: [Brief description]
  - **Rationale**: [Why this constraint exists]
  - **Source**: [DETAILED.md entry, commit hash, EXECUTIVE.md section]
  - **Impact**: [What code/config must follow this]
  - **Date Discovered**: YYYY-MM-DD

#### Example Entry

- **Constraint**: SQLite requires MaxOpenConns=5 with GORM transactions
  - **Rationale**: GORM explicit transactions require multiple connections; MaxOpenConns=1 causes deadlock
  - **Source**: DETAILED.md 2025-12-14 timeline, commit abc1234, EXECUTIVE.md Known Issues
  - **Impact**: All repositories using GORM transactions must configure connection pool ≥5
  - **Date Discovered**: 2025-12-14
```

---

## Workflow Gates - MANDATORY

### Gate 1: Constitution Complete

**Evidence Required**:

- ✅ All sections completed with no TBD placeholders
- ✅ All terminology defined
- ✅ All quality gates specified (coverage, mutation, timing)
- ✅ File size limits documented (300/400/500)

**Validation**:

```bash
# Check for TBD/TODO/FIXME in constitution
grep -i "TBD\|TODO\|FIXME" .specify/memory/constitution.md

# Must return 0 matches to proceed
```

---

### Gate 2: Specification Complete

**Evidence Required**:

- ✅ Functional requirements documented
- ✅ Non-functional requirements specified
- ✅ Architecture diagrams included
- ✅ API contracts defined (OpenAPI references)
- ✅ Security requirements explicit

**Validation**:

- Read spec.md for completeness
- Verify all constitution requirements mapped to spec sections

---

### Gate 3: Clarification Complete (Optional, Highly Recommended)

**Evidence Required**:

- ✅ Topical organization (not chronological)
- ✅ All ambiguities resolved in clarify.md
- ✅ Human interaction is done via Question & Answers in clarify-QUIZME#.md documents whose content is refactored into clarify.md
- ✅ Cross-references to constitution/spec sections

**Validation**:

- Verify clarify.md exists if ambiguities discovered
- Verify no Questions remain unanswered in any and all existing clarify-QUIZME#.md documents
- Check topical organization (Architecture, Testing, Cryptography, etc.)

---

### Gate 4: Plan Complete

**Evidence Required**:

- ✅ Phase breakdown with clear boundaries
- ✅ Task dependencies mapped
- ✅ Completion criteria per phase
- ✅ Risk assessment included
- ✅ All constitution/spec/clarify requirements covered
- ✅ All constitution/spec/clarify/plan align with copilot instructions

**Validation**:

```bash
# Verify plan covers all requirements
# Compare plan.md sections against constitution/spec/clarify
```

---

### Gate 5: Tasks Complete

**Evidence Required**:

- ✅ Task checklist with clear descriptions
- ✅ Completion criteria per task
- ✅ Phase assignments explicit
- ✅ Dependencies identified
- ✅ Estimated effort (S/M/L) per task

**Validation**:

- Verify tasks.md matches plan.md phases
- Check task numbering sequential

---

### Gate 6: Analysis Complete (Optional, Highly Recommended)

**Evidence Required**:

- ✅ Complexity analysis per task
- ✅ Risk assessment per phase
- ✅ Dependency graph validated
- ✅ Resource requirements estimated

**Validation**:

- Verify analyze.md exists if complexity high
- Check risk mitigation strategies documented

---

### Gate 7: Implementation Progress Tracking

**Evidence Required**:

- ✅ DETAILED.md Section 1: Task checklist (❌/⚠️/✅ status)
- ✅ DETAILED.md Section 2: Append-only timeline
- ✅ EXECUTIVE.md: Stakeholder summary (status, risks, lessons)
- ✅ Code coverage ≥95% production, ≥98% infrastructure
- ✅ Mutation score ≥85% and ≥98% in separate Phases; ≥98% Phase must be later than ≥85% phase
- ✅ All tests passing
- ✅ Unit+integration tests <15s per-package; <120s total for all packages
- ✅ End-to-end tests <45s per-package; <240s total for all packages

**Validation**:

```bash
# Check coverage
go test ./... -coverprofile=./test-output/coverage.out
go tool cover -func ./test-output/coverage.out | grep "total"

# Check tests pass
go test ./...

# Check mutation score (Phase 5+)
gremlins unleash --tags=!integration
```

---

## Evidence-Based Completion - MANDATORY

### Never Mark Tasks Complete Without Objective Evidence

**Code Evidence**:

- `go build ./...` clean
- `golangci-lint run` clean
- No new TODOs without tracking
- Coverage ≥95%/98% per package

**Test Evidence**:

- `go test ./...` passes
- No skips without tracking in todos-*.md
- Mutation score ≥80%/98% (phase-dependent)

**Git Evidence**:

- Conventional commit format
- Clean working tree
- Changes align with task description

---

## Feedback Loop Patterns - MANDATORY

### Pattern 1: Implementation Discovers Missing Requirement

**Scenario**: Implementing database layer, discover SQLite MaxOpenConns=5 requirement

**Actions**:

1. Document discovery in DETAILED.md Section 2 timeline
2. Add constraint to constitution.md (Living Section)
3. Update spec.md Database section with requirement
4. Add Q&A to clarify.md explaining rationale
5. Commit with reference: `docs(constitution): add SQLite connection pool constraint (DETAILED.md 2025-12-14)`

---

### Pattern 2: Implementation Contradicts Spec

**Scenario**: Spec says "use bcrypt for passwords", but FIPS 140-3 requires PBKDF2

**Actions**:

1. Document contradiction in EXECUTIVE.md Risks
2. Update spec.md to require PBKDF2-HMAC-SHA256
3. Add Q&A to clarify.md explaining FIPS requirement
4. Update constitution.md cryptography section
5. Commit with reference: `docs(spec): change password hashing to PBKDF2 for FIPS compliance`

---

### Pattern 3: Lessons Learned From Post-Mortem

**Scenario**: P0 post-mortem identifies format_go self-modification regression

**Actions**:

1. Extract lessons to copilot instructions (coding.instructions.md or new anti-patterns.instructions.md)
2. Add CRITICAL warning to constitution.md (if fundamental requirement)
3. Add Q&A to clarify.md (if affects design decisions)
4. Document in EXECUTIVE.md Post-Mortem section
5. Commit with reference: `docs(instructions): add format_go self-modification prevention (P0.X post-mortem)`

---

## DETAILED.md Structure - MANDATORY

### Section 1: Task Checklist

Maintain task list from tasks.md with status indicators:

```markdown
## Section 1: Task Status

### Phase 1: Foundation

- ❌ **Task 1.1**: Create domain models (internal/jose/domain/)
  - Status: Not started
  - Blockers: None
  - Notes: Waiting for Phase 0 completion

- ⚠️ **Task 1.2**: Implement repository layer (internal/jose/server/repository/)
  - Status: In progress (70% complete)
  - Blockers: SQLite MaxOpenConns issue under investigation
  - Notes: PostgreSQL working, SQLite deadlocking

- ✅ **Task 1.3**: Add database migrations (migrations/*.sql)
  - Status: Complete
  - Coverage: 98%
  - Commit: abc1234
  - Notes: SQLite and PostgreSQL migrations tested
```

---

### Section 2: Append-Only Timeline

Record all significant implementation events chronologically:

```markdown
## Section 2: Implementation Timeline

### 2025-12-14: Task 1.3 Database Migrations

**Work Completed**:
- Created migrations/*.sql for SQLite and PostgreSQL
- Implemented migration runner in repository package
- Added migration tests with embedded SQL files

**Coverage**: 98% (repository/migrations_test.go)

**Lessons Learned**:
- SQLite TEXT type required for UUID columns (not native UUID type)
- PostgreSQL supports both UUID and TEXT for UUIDs (TEXT is cross-DB compatible)

**Constraints Discovered**:
- Cross-database UUID compatibility: Always use TEXT type
- Added to constitution.md Living Section (commit def5678)

**Related Commits**:
- [abc1234] feat(jose): add database migrations for SQLite and PostgreSQL
- [def5678] docs(constitution): add cross-database UUID type constraint
```

---

## EXECUTIVE.md Structure - MANDATORY

### Stakeholder Overview

```markdown
## Stakeholder Overview

**Current Phase**: Phase 1 (Foundation)
**Progress**: 15/23 tasks complete (65%)
**Coverage**: 94.2% (target: 95%)
**Mutation Score**: 87.3% (target: 85% Phase 4)
**Known Blockers**: 2 (SQLite connection pooling, Windows Firewall exceptions)
```

---

### Customer Demonstrability

```markdown
## Customer Demonstrability

**Docker Compose Stack**:
```bash
# Start all services
docker compose -f ./deployments/compose/compose.yml up -d

# Verify health
curl -k https://localhost:8080/admin/v1/livez  # KMS SQLite
curl -k https://localhost:8081/admin/v1/livez  # KMS PostgreSQL 1
curl -k https://localhost:8082/admin/v1/livez  # KMS PostgreSQL 2
```

**E2E Demo**:

- Create elastic key → Encrypt payload → Decrypt payload
- Sign payload → Verify signature
- Rotate material key → Verify old ciphertexts still decrypt

```

---

### Risk Tracking

```markdown
## Known Issues and Risks

### SQLite Connection Pool Deadlock (HIGH)
- **Issue**: SQLite MaxOpenConns=1 with GORM transactions causes deadlock
- **Impact**: All tests using SQLite transactions hang
- **Workaround**: Set MaxOpenConns=5 for GORM transaction support
- **Root Cause**: GORM transaction wrapper requires separate connection
- **Resolution**: Document in constitution.md, update all repositories
- **Status**: Resolved (2025-12-14)

### Windows Firewall Exception Prompts (MEDIUM)
- **Issue**: Binding to 0.0.0.0 in tests triggers Windows Firewall prompts
- **Impact**: CI/CD automation blocked, developer friction
- **Workaround**: ALWAYS bind to 127.0.0.1 in unit/integration tests
- **Root Cause**: 0.0.0.0 exposes service to all network interfaces
- **Resolution**: Added to copilot instructions, security.instructions.md
- **Status**: Resolved (2025-12-18)
```

---

### Post-Mortem Lessons

```markdown
## Post-Mortem Lessons Learned

### P0.1: format_go Self-Modification Regression (2025-11-17)
- **Lesson**: LLM agents lose exclusion context during narrow-focus refactoring
- **Prevention**: ALWAYS read complete package context before refactoring
- **Applied**: Added to copilot-instructions.md and coding.instructions.md
- **Reference**: docs/P0.1-format-go-self-modification.md

### P0.2: Coverage Improvement Without Baseline Analysis (2025-12-14)
- **Lesson**: Writing tests without baseline HTML analysis = 0% improvement
- **Prevention**: MANDATORY baseline → HTML analysis → targeted tests → verify
- **Applied**: Added to testing.instructions.md
- **Reference**: DETAILED.md 2025-12-14 timeline entry
```

---

## Speckit Feedback Loop Timing - MANDATORY

### Continuous Feedback (During Implementation)

**Update constitution/spec/clarify when**:

- Implementation discovers missing constraint
- Spec contradicts implementation reality
- Post-mortem identifies fundamental issue
- Clarification resolves ambiguity

**Don't wait for phase completion** - update immediately to maintain alignment.

---

### Periodic Review (End of Phase)

**Review at phase completion**:

- Verify all phase requirements met
- Extract lessons learned to EXECUTIVE.md
- Update plan.md with revised estimates
- Identify technical debt for future phases

---

## Key Takeaways

1. **Iterative, not sequential** - Update constitution/spec/clarify continuously
2. **Evidence-based completion** - Never mark tasks done without objective proof
3. **Feedback loops immediate** - Don't wait for phase completion
4. **Living documents** - Constitution/spec/plan evolve through implementation
5. **DETAILED.md Section 2** - Append-only timeline is authoritative implementation log
6. **EXECUTIVE.md** - Stakeholder summary with risks, lessons, demonstrability
7. **Mini-cycle feedback** - Update specs every 3-5 tasks, not end of phase
