---
description: "Products and services architecture patterns"
applyTo: "**"
---
# Products & Services Architecture - CRITICAL

**cryptoutil** is a production-ready suite of four cryptographic-based products, designed with enterprise-grade security, **FIPS 140-3** standards compliance, Zero-Trust principles, and security-on-by-default.

## Product Suite Architecture - CRITICAL

| Service Alias | Product | Service | Public Ports | Admin Port | Description |
|---------------|-----------|-------------|------------|-------------|
| **sm-kms** | Secrets Manager | Key Management Service (KMS) | 8080-8089 | 127.0.0.1:9090 | REST APIs for per-tenant Elastic Keys |
| **pki-ca** | Public Key Infrastructure | Certificate Authority (CA) | 8443-8449 | 127.0.0.1:9090 | X.509 certificate lifecycle, EST, SCEP, OCSP, CRLDP, CMPv2, CMC, time-stamping |
| **jose-ja** | JOSE | JWK Authority (JA) | 9443-9449 | 127.0.0.1:9090 | JWK, JWKS, JWE, JWS, JWT operations |
| **identity-authz** | Identity | Authorization Server (authz) | 18000-18009 | 127.0.0.1:9090 | OAuth 2.1 authorization server, OIDC Discovery |
| **identity-idp** | Identity | Identity Provider (IdP) | 18100-18109 | 127.0.0.1:9090 | OIDC 1.0 authentication, login/consent UI, MFA enrollment |
| **identity-rs** | Identity | Resource Server (RS) | 18200-18209 | 127.0.0.1:9090 | Protected API with token validation (reference implementation) |
| **identity-rp** | Identity | Relying Party (RP) | 18300-18309 | 127.0.0.1:9090 | Backend-for-Frontend pattern (reference implementation) |
| **identity-spa** | Identity  Single Page Application (SPA) | 18400-18409 | 127.0.0.1:9090 | Static hosting for SPA clients (reference implementation) |
| **learn-ps** | Learn | Pet Store | 8888-8889 | 127.0.0.1:9090 | Educational service demonstrating service template usage |

## Service Template Requirement - MANDATORY

**CRITICAL: NEVER duplicate service infrastructure code - ALWAYS use extracted template**

See `02-02.service-template.instructions.md` for details.

## Microservices Architecture - CRITICAL

**MANDATORY: All Services in All Products MUST support run as containers; containers are mandatory for production and end-to-end testing**

**MANDATORY: All Services in All Products MUST support Two HTTPS Endpoints**

Separate HTTPS endpoints for public exposed operations vs private administration MUST be supported. See `02-03.https-ports.instructions.md` for comprehensive details on:

- HTTPS bind addresses and port configuration (production vs test/dev)
- TLS certificate configuration options
- Private HTTPS endpoint (admin server) configuration
- Public HTTPS endpoint (public server) configuration
- Request path prefixes (`/service/**` vs `/browser/**`)
- Middleware stacks and security patterns

### CA Architecture Pattern

See `02-10.pki.instructions.md` for comprehensive CA architecture patterns and TLS Issuing CA configurations

---

## Service Federation - CRITICAL

**MANDATORY: Services MUST support configurable federation for cross-service communication**

### Federation Configuration Pattern

Services discover and communicate with other cryptoutil services via configuration (NEVER hardcoded URLs):

```yaml
federation:
  identity_url: "https://identity-authz:8180"
  identity_enabled: true
  identity_timeout: 10s
  jose_url: "https://jose-server:8280"
  ca_url: "https://ca-server:8380"
  ca_enabled: false  # Optional

federation_fallback:
  identity_fallback_mode: "local_validation"  # or "reject_all", "allow_all" (dev)
  jose_fallback_mode: "internal_crypto"
  ca_fallback_mode: "self_signed"
```

### Service Discovery Mechanisms

**1. Configuration File**: `identity_url: "https://identity.example.com:8180"`
**2. Docker Compose**: `identity_url: "https://identity-authz:8180"` (service name from compose.yml)
**3. Kubernetes**: `identity_url: "https://identity-authz.cryptoutil-ns.svc.cluster.local:8180"` (K8s DNS)
**4. Environment Variables**: `CRYPTOUTIL_FEDERATION_IDENTITY_URL="https://identity:8180"`

### Graceful Degradation Patterns

**Circuit Breaker**: Automatically disable federated service after N consecutive failures

**Fallback Modes**:

- **Identity Unavailable**: Local token validation (cached public keys), reject all (strict), allow all (development only)
- **JOSE Unavailable**: Internal crypto implementation (use KMS's own JWE/JWS)
- **CA Unavailable**: Self-signed TLS certificates (development), cached certificates (production)

**Retry Strategies**:

- **Exponential Backoff**: 1s, 2s, 4s, 8s, 16s (max 5 retries)
- **Timeout Escalation**: Increase timeout 1.5x per retry (10s → 15s → 22.5s)
- **Health Check Before Retry**: Poll `/admin/v1/livez` endpoint (fast liveness check) before resuming traffic

### Federation Health Monitoring

**Regular Health Checks**: Poll federated services every 30 seconds, activate fallback on errors

**Metrics and Alerts**:

- `federation_request_duration_seconds{service="identity"}` - Latency tracking
- `federation_request_failures_total{service="identity"}` - Error rate
- `federation_circuit_breaker_state{service="identity"}` - Circuit state

### Cross-Service Authentication

**Service-to-Service mTLS** (Preferred): Configure client cert, key, and CA cert via file paths or Docker secrets

**OAuth 2.1 Client Credentials** (Alternative): Configure client ID, secret, and token endpoint

### Federation Testing Requirements

**Integration Tests MUST**:

- Test each federated service independently (mock others)
- Test graceful degradation when federated service unavailable
- Test circuit breaker behavior (failure thresholds, timeouts, recovery)
- Test retry logic (exponential backoff, max retries)
- Verify timeout configurations prevent cascade failures

**E2E Tests MUST**:

- Deploy full stack (all federated services)
- Test cross-service communication paths
- Test federation with Docker Compose service discovery
- Verify health checks detect service failures
- Test failover and recovery scenarios
