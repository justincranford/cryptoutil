---
description: "Architecture, service template, and HTTPS patterns"
applyTo: "**"
---
# Architecture & Service Template

## Quick Reference

- **5 products, 9 services**: PKI (CA), JOSE (JA), Cipher (IM), SM (KMS), Identity (Authz, IdP, RS, RP, SPA)
- **Dual HTTPS**: Public (:8080) + Admin (:9090) per service
- **Dual Paths**: `/service/**` (headless) + `/browser/**` (browser)
- **Config Priority**: Docker secrets > YAML > CLI (NO environment variables)
- **Template**: ALL services MUST use `internal/apps/template/service/`
- **Migration priority**: cipher-im FIRST (validation) -> jose-ja -> pki-ca -> identity -> sm-kms LAST

See [ARCHITECTURE.md Section 3 Product Suite Architecture](../../docs/ARCHITECTURE.md#3-product-suite-architecture) and [Section 4 System Architecture](../../docs/ARCHITECTURE.md#4-system-architecture) for comprehensive product suite and system architecture.

## Service Catalog

| Product | Service | ID | Host Ports | Container Public | Container Admin |
|---------|---------|-----|-----------|-----------------|----------------|
| SM | Key Management Service | sm-kms | 8000-8099 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| PKI | Certificate Authority | pki-ca | 8100-8199 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| Identity | Authorization Server | identity-authz | 8200-8299 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| Identity | Identity Provider | identity-idp | 8300-8399 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| Identity | Resource Server | identity-rs | 8400-8499 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| Identity | Relying Party | identity-rp | 8500-8599 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| Identity | Single Page App | identity-spa | 8600-8699 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| Cipher | Instant Messenger | cipher-im | 8700-8799 | 0.0.0.0:8080 | 127.0.0.1:9090 |
| JOSE | JWK Authority | jose-ja | 8800-8899 | 0.0.0.0:8080 | 127.0.0.1:9090 |

**PostgreSQL Ports**: pki-ca:54320, jose-ja:54321, cipher-im:54322, sm-kms:54323, identity-authz:54324, identity-idp:54325, identity-rs:54326, identity-rp:54327, identity-spa:54328 (all container 0.0.0.0:5432)

**Telemetry**: otel-collector-contrib (4317 gRPC, 4318 HTTP), grafana-otel-lgtm (3000 UI, 4317/4318 OTLP)

See [ARCHITECTURE.md Section 3.4 Port Assignments & Networking](../../docs/ARCHITECTURE.md#34-port-assignments--networking) for complete service and port catalog.

## Port Design Principles

- HTTPS for all public and admin bindings
- 127.0.0.1:9090 admin inside containers (never exposed outside)
- 0.0.0.0:8080 public inside containers
- Different host port ranges per service (avoid conflicts)
- **Three deployment types**: Service (8XXX), Product (18XXX = service + 10000), Suite (28XXX = service + 20000)
- Health paths: `/browser/api/v1/health`, `/service/api/v1/health` (public), `/admin/api/v1/livez`, `/admin/api/v1/readyz` (admin)

See [ARCHITECTURE.md Section 3.4.1 Port Design Principles](../../docs/ARCHITECTURE.md#341-port-design-principles) and [Section 5.3 Dual HTTPS Endpoint Pattern](../../docs/ARCHITECTURE.md#53-dual-https-endpoint-pattern) for port and binding standards.

## Service Template Components

1. **Two HTTPS Listeners**: Public (business) + Admin (health checks)
2. **Two Public Paths**: `/browser/**` (sessions) vs `/service/**` (tokens)
3. **Three Admin APIs**: `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
4. **Database**: PostgreSQL || SQLite with GORM
5. **Telemetry**: OTLP -> otel-collector-contrib -> Grafana LGTM
6. **Config**: Docker secrets > YAML > CLI (NO environment variables)

**Eliminates 48,000+ lines boilerplate per service**. Constructor injection for OpenAPI specs, handlers, middleware.

See [ARCHITECTURE.md Section 5.1 Service Template Pattern](../../docs/ARCHITECTURE.md#51-service-template-pattern) for template components and benefits.

## Dual HTTPS Endpoints

**ServerSettings Pattern**:

```go
type ServerSettings struct {
    BindPublicProtocol    string   // "https"
    BindPublicAddress     string   // "127.0.0.1" (dev), "0.0.0.0" (containers)
    BindPublicPort        uint16   // 8080 (prod), 0 (tests - MANDATORY dynamic)
    BindPrivateProtocol   string   // "https"
    BindPrivateAddress    string   // "127.0.0.1" (ALWAYS)
    BindPrivatePort       uint16   // 9090 (prod), 0 (tests - MANDATORY dynamic)
    TLSPublicDNSNames     []string // ["localhost"]
    TLSPublicIPAddresses  []string // ["127.0.0.1", "::1", "::ffff:127.0.0.1"]
    TLSPrivateDNSNames    []string // ["localhost"]
    TLSPrivateIPAddresses []string // ["127.0.0.1", "::1", "::ffff:127.0.0.1"]
    CORSAllowedOrigins    []string // http/https x localhost/127.0.0.1/[::1] x :8080
}
```

**CRITICAL: Tests MUST use port 0**: Hardcoded ports cause Windows TIME_WAIT delays (2-4 min), breaking sequential tests.

**Environment Binding**:

| Environment | Public Bind | Private Bind | Port |
|-------------|-------------|--------------|------|
| Unit/Integration Tests | 127.0.0.1 | 127.0.0.1 | 0 (dynamic) |
| Docker Containers | 0.0.0.0 | 127.0.0.1 | 8080/9090 |
| Production | Configurable | 127.0.0.1 | Service-specific |

See [ARCHITECTURE.md Section 5.3 Dual HTTPS Endpoint Pattern](../../docs/ARCHITECTURE.md#53-dual-https-endpoint-pattern) for comprehensive dual HTTPS endpoint documentation.

## Dual API Paths - CRITICAL

**`/service/**`** (Headless): Service clients ONLY, Bearer/mTLS auth. Middleware: IP allowlist -> Rate limiting -> Logging -> AuthN -> AuthZ (scope-based). Browser clients BLOCKED.

**`/browser/**`** (Browser): Browser clients ONLY, session/cookie auth. Middleware: IP allowlist -> CSRF -> CORS -> CSP -> Rate limiting -> Logging -> AuthN -> AuthZ (resource-level). Service clients BLOCKED.

**SAME OpenAPI spec** at both paths; only middleware/auth differs. E2E tests MUST verify BOTH.

**NO service name in paths**: `/service/api/v1/elastic-jwks` (correct), NOT `/service/api/v1/jose/elastic-jwks`.

See [ARCHITECTURE.md Section 5.4 Dual API Path Pattern](../../docs/ARCHITECTURE.md#54-dual-api-path-pattern) for dual path design and middleware requirements.

## Health Checks

| Endpoint | Purpose | Check Type | Failure Action |
|----------|---------|------------|----------------|
| `/admin/api/v1/livez` | Process alive? | Lightweight | Restart container |
| `/admin/api/v1/readyz` | Ready for traffic? | Heavyweight (DB, deps) | Remove from LB |
| `/admin/api/v1/shutdown` | Graceful shutdown | Drain + close | N/A |

See [ARCHITECTURE.md Section 5.5 Health Check Patterns](../../docs/ARCHITECTURE.md#55-health-check-patterns) for health check endpoint specifications.

## Federation & Service Discovery

- **Discovery**: Config file -> Docker Compose DNS -> Kubernetes DNS (MUST NOT cache DNS)
- **Multi-Level Failover**: FEDERATED -> DATABASE -> FILE realms (no circuit breakers, no retry logic)
- **FILE Realms**: Local, always available, MANDATORY minimum 1 FACTOR + 1 SESSION realm
- **Cross-Service Auth**: mTLS (preferred) or OAuth 2.1 client credentials
- **Federation Timeout**: Configurable per-service (default: 10s)
- **API Versioning**: MUST support N-1 backward compatibility

See [ARCHITECTURE.md Section 2.2 Architecture Strategy](../../docs/ARCHITECTURE.md#22-architecture-strategy) for federation and service discovery patterns.

## Multi-Tenancy - MANDATORY

- `tenant_id`: Scopes ALL data access (keys, sessions, audit logs). Every DB query MUST filter by tenant_id.
- `realm_id`: Authentication context ONLY (NOT data filtering). Defines authn policies, session lifetimes.
- **Registration**: tenant_id absent -> create new tenant; tenant_id present -> join existing tenant.

See [ARCHITECTURE.md Section 2.2 Architecture Strategy](../../docs/ARCHITECTURE.md#22-architecture-strategy) and [Section 7. Data Architecture](../../docs/ARCHITECTURE.md#7-data-architecture) for multi-tenancy patterns and data isolation.

## TLS Certificate Configuration

| Environment | Cert Chain | TLS Key | Issuing CA Key | Outcome |
|-------------|-----------|---------|----------------|---------|
| Production | Provided | Docker Secret | Not provided | Use as-is |
| E2E Dev | Provided | Not provided | Docker Secret | Generate + sign TLS cert |
| Unit/Integration | Not provided | Not provided | Not provided | Auto-create all certs |

See [ARCHITECTURE.md Section 6. Security Architecture](../../docs/ARCHITECTURE.md#6-security-architecture) for TLS certificate configuration and generation patterns.

## Migration Versioning

- **Template migrations**: 1001-1999 (shared: sessions, barrier, realms, tenants, pending users)
- **Domain migrations**: 2001+ (application-specific, never conflicts with template)
- Domain FS registered via `builder.WithDomainMigrations(MigrationsFS, "migrations")`

See [ARCHITECTURE.md Section 5.2 Service Builder Pattern](../../docs/ARCHITECTURE.md#52-service-builder-pattern) and [Section 7. Data Architecture](../../docs/ARCHITECTURE.md#7-data-architecture) for migration versioning and merged migrations.

## Key Rotation - MANDATORY

**Per-Message Rotation**: New JWK per message for maximum security.
**Elastic Key Ring**: Active key encrypts/signs, historical keys decrypt/verify. Key ID embedded with ciphertext for deterministic lookup.

See [ARCHITECTURE.md Section 6.4 Cryptographic Architecture](../../docs/ARCHITECTURE.md#64-cryptographic-architecture) and [Section 6.7 Key Management System Architecture](../../docs/ARCHITECTURE.md#67-key-management-system-architecture) for key rotation strategies and elastic key ring patterns.

## Config File Architecture

**Schema Strategy**: Config file schema is HARDCODED in Go (`validate_schema.go`). No external schema files.

**Config Types**: Service template configs (`config-*.yml`, flat kebab-case), domain-specific configs (nested YAML), environment configs (`development.yml`, `production.yml`), certificate profiles (`profiles/`), auth policies (`policies/`).

See [ARCHITECTURE.md Section 12.5 Config File Architecture](../../docs/ARCHITECTURE.md#125-config-file-architecture) for directory structure and file type details.
