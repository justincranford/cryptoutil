---
description: "Products and services architecture patterns"
applyTo: "**"
---
# Architecture

# Products & Services Architecture - Tactical Guidance

## Suite Overview - Product and Services - Complete Reference

This section provides the authoritative address and port bindings for all 9 services in 5 products.

| Product | Service | Product-Service Identifier | Host Public Address | Host Port Range | Container Public Address | Container Public Port Range | Container Admin Private Address | Container Admin Port Range | Description |
|---------|----------------|-----------------|------------|----------|------------|----------------|-------------------|----------|
| **Private Key Infrastructure (PKI)** | **Certificate Authority (CA)** | **pki-ca** | 127.0.0.1 | 8050-8059 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | X.509 certificates, EST, SCEP, OCSP, CRL |
| **JSON Object Signing and Encryption (JOSE)** | **JWK Authority (JA)** | **jose-ja** | 127.0.0.1 | 8060-8069 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | JWK/JWS/JWE/JWT operations |
| **Cipher** | **Instant Messenger (IM)** | **cipher-im** | 127.0.0.1 | 8070-8079 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | E2E encrypted messaging, encryption-at-rest |
| **Secrets Manager (SM)** | **Key Management Service (KMS)** | **sm-kms** | 127.0.0.1 | 8080-8089 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | Elastic key management, encryption-at-rest |
| **Identity** | **Authorization Server (Authz)** | **identity-authz** | 127.0.0.1 | 8100-8109 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | OAuth 2.1 authorization server |
| **Identity** | **Identity Provider (IdP)** | **identity-idp** | 127.0.0.1 | 8110-8119 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | OIDC 1.0 Identity Provider |
| **Identity** | **Resource Server (RS)** | **identity-rs** | 127.0.0.1 | 8120-8129 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | OAuth 2.1 Resource Server |
| **Identity** | **Relying Party (RP)** | **identity-rp** | 127.0.0.1 | 8130-8139 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | OAuth 2.1 Relying Party |
| **Identity** | **Single Page Application (SPA)** | **identity-spa** | 127.0.0.1 | 8140-8149 | 0.0.0.0 | 8080 | 127.0.0.1 | 9090 | OAuth 2.1 Single Page Application |

### Product-Service Port Design Principles

- HTTPS protocol for all public and admin port bindings.
- Same HTTPS 127.0.0.1:9090 for Private HTTPS Admin APIs inside Docker Compose and Kubernetes; never localhost due to IPv4 vs IPv6 dual stack issues; never exposed outside of containers.
- Same HTTPS 0.0.0.0:8080 for Public HTTPS APIs inside Docker Compose and Kubernetes.
- Different HTTPS 127.0.0.1 port range mappings for Public APIs on Docker host, to avoid conflicts.
- Same health check paths (`/browser/api/v1/health`, `/service/api/v1/health`) on Public HTTPS listeners.
- Same health check paths (`/admin/api/v1/livez`, `/admin/api/v1/readyz`) on Private HTTPS Admin listeners.
- Same graceful shutdown path (`/admin/api/v1/shutdown`) on Private HTTPS Admin listeners.

### PostgreSQL Ports

| Product-Service Identifier | Host Address | Host Port | Container Address | Container Port |
|---------|-----------|----------------|----------|----------------|
| **pki-ca** | 127.0.0.1 | 54320 | 0.0.0.0 | 5432 |
| **jose-ja** | 127.0.0.1 | 54321 | 0.0.0.0 | 5432 |
| **cipher-im** | 127.0.0.1 | 54322 | 0.0.0.0 | 5432 |
| **sm-kms** | 127.0.0.1 | 54323 | 0.0.0.0 | 5432 |
| **identity-authz** | 127.0.0.1 | 54324 | 0.0.0.0 | 5432 |
| **identity-idp** | 127.0.0.1 | 54325 | 0.0.0.0 | 5432 |
| **identity-rs** | 127.0.0.1 | 54326 | 0.0.0.0 | 5432 |
| **identity-rp** | 127.0.0.1 | 54327 | 0.0.0.0 | 5432 |
| **identity-spa** | 127.0.0.1 | 54328 | 0.0.0.0 | 5432 |

### PostgreSQL Port Design Principles for Product-Service Databases

- Same 0.0.0.0:5432 inside Docker Compose and Kubernetes.
- Same 127.0.0.1 host address on Docker host.
- Different host port mappings (54320-54329) for each product-service to avoid conflicts on Docker host.

### Telemetry Ports (Shared)

| Service | Host Port | Container Port | Protocol |
|---------|-----------|----------------|----------|
| opentelemetry-collector-contrib | 4317 | 4317 | OTLP gRPC |
| opentelemetry-collector-contrib | 4318 | 4318 | OTLP HTTP |
| grafana-otel-lgtm | 3000 | 3000 | HTTP (UI) |
| grafana-otel-lgtm | 4317 | 4317 | OTLP gRPC |
| grafana-otel-lgtm | 4318 | 4318 | OTLP HTTP |

## Federation Configuration Example

```yaml
federation:
  identity_url: "https://identity-authz:8180"
  identity_enabled: true
  identity_timeout: 10s
  jose_url: "https://jose-ja:8280"

federation_fallback:
  identity_fallback_mode: "local_validation"
  jose_fallback_mode: "internal_crypto"
```

## Key Patterns

- **Service Discovery**: Config file → Docker Compose → Kubernetes DNS (MUST NOT cache DNS results)
- **Graceful Degradation**: Circuit breakers + fallback modes + retry strategies
- **Health Monitoring**: Poll federated services every 30s, activate fallback on errors
- **Cross-Service Auth**: mTLS (preferred) or OAuth 2.1 client credentials
- **Federation Timeout**: MUST be configurable per-service (default: 10s)
- **API Versioning**: MUST support N-1 backward compatibility (current + previous version)

## Product Suite Overview

**cryptoutil** is a production-ready suite of five cryptographic-based products, designed with enterprise-grade security, **FIPS 140-3** standards compliance, Zero-Trust principles, and security-on-by-default.

## Microservices Architecture Requirements

### Container Support - MANDATORY

**MANDATORY: All Services in All Products MUST support run as containers**

- Containers are mandatory for production deployments
- Containers are mandatory for end-to-end testing
- All services MUST provide Dockerfiles with multi-stage builds
- All services MUST support Docker Compose orchestration

### Dual HTTPS Endpoint Requirement - MANDATORY

**MANDATORY: All Services in All Products MUST support Two HTTPS Endpoints**

- **Private HTTPS Endpoint (Admin Server)**: Bind to 127.0.0.1:9090 by default
  - Purpose: Administration, health checks, graceful shutdown
  - APIs: `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
  - Access: Local only (NOT external access)

- **Public HTTPS Endpoint (Public Server)**: Service-specific port ranges
  - Purpose: Business APIs, browser UIs, external client access
  - Request paths: `/service/**` (headless clients) vs `/browser/**` (browser clients)
  - Access: External clients (browsers, services)

**See**: `02-03.https-ports.instructions.md` for comprehensive HTTPS binding patterns, TLS configuration, middleware stacks

## Key Takeaways

1. **Service Catalog**: 9 services across 5 products
2. **Dual HTTPS**: All services MUST support public (business) + admin (health checks, shutdown) endpoints
3. **Container-First**: Mandatory Docker support for production and E2E testing
4. **Service Template**: See [02-02.service-template.instructions.md](./02-02.service-template.instructions.md) for reusable infrastructure pattern
