---
description: "Instructions for Go project structure, architecture, and coding standards"
applyTo: "**"
---
# Go Project Structure, Architecture & Standards

## Go Version Consistency
- **ALWAYS use the same Go version in every part of the project** (development, CI/CD, Docker)
- Current project Go version: **1.25.4** (check go.mod file)
- Set `GO_VERSION: '1.25.4'` in workflow environment variables
- Use `go-version: ${{ env.GO_VERSION }}` in setup-go actions
- Never enable CGO; assume I set CGO_ENABLED=0 in User settings.json, because I did
- Avoid Go dependencies that require CGO

## Build Flags and Linking

### Static Linking Requirement
- **ALWAYS use static linking** to ensure maximum portability
- Use `-extldflags '-static'` in ldflags for static linking
- Validate static linking with `ldd` check
- **ALWAYS retain debug symbols** for troubleshooting

## Go Project Structure

Follow the [Standard Go Project Layout](https://github.com/golang-standards/project-layout) patterns:


**Go Directories:**
- `/cmd` - Main applications for this project. Keep `main` functions minimal, importing from `/internal` and `/pkg`
- `/internal` - Private application and library code enforced by Go compiler. Use `/internal/app` for application code, `/internal/pkg` for shared internal code
- `/pkg` - Library code safe for external use. Optional pattern for explicitly public APIs
- `/vendor` - Application dependencies (use `go mod vendor` when needed)

**Service Application Directories:**
- `/api` - OpenAPI/Swagger specs, JSON schema files, protocol definitions

**Common Application Directories:**
- `/configs` - Configuration file templates or default configs
- `/scripts` - Build, install, analysis, and other automation scripts
- `/deployments` - IaaS, PaaS, container orchestration configs (docker-compose, kubernetes/helm, terraform)
- `/test` - Additional external test apps and test data

**Other Directories:**
- `/docs` - Design and user documents (in addition to godoc)
- `/tools` - Supporting tools for this project

**Avoid:**
- `/src` - Don't use project-level `/src` directory (Java pattern, not Go)
- Deep nesting - Keep structure simple and flat when possible

**Key Principles:**
- This is NOT an official Go standard, but a community pattern
- Use what you need, delete what you don't
- Small projects can start simple (single `main.go`)
- Scale structure as project grows
- See [Organizing a Go module](https://go.dev/doc/modules/layout) for official guidance

## Application Architecture

- Use layered arch: main → app → business logic → repositories
- Config: YAML files & CLI only (no env vars for configuration; use Docker/Kubernetes secrets for sensitive data)
- Dependency injection with context propagation
- Structured config with validation/defaults
- Lifecycle: graceful startup/shutdown, resource cleanup
- Service layer: clear separation of concerns
- Error propagation through layers
- Factory pattern for service init with error handling
- Support local/dev, Docker, prod configs
- Atomic ops for critical state
- Timeout/retry for external deps
- Validate config before startup
- Hot-reload config if needed

## Import Alias Conventions

### CRITICAL: Import Alias Rules

**ALL `cryptoutil/**` imports MUST use camelCase aliases starting with "cryptoutil" prefix:**

1. **Pattern**: `cryptoutil<PackageName>` where `<PackageName>` is the full package path in camelCase
2. **Examples**:
   - `cryptoutil/internal/cmd/cicd/common` → `cryptoutilCmdCicdCommon`
   - `cryptoutil/internal/common/magic` → `cryptoutilMagic`
   - `cryptoutil/api/client` → `cryptoutilOpenapiClient`

3. **When adding new packages**: ALWAYS add corresponding importas entry to `.golangci.yml`
4. **Linter enforcement**: The `importas` linter enforces these rules; mismatches cause build failures

### Synchronization with .golangci.yml

**The importas rules are defined in `.golangci.yml` - that is the source of truth.**

When working with Go code:
- Check `.golangci.yml` importas section for current aliases
- If a `cryptoutil/**` package is missing from importas config, ADD IT following the camelCase pattern
- All internal packages (`cryptoutil/internal/**`) must have importas entries
- Run `golangci-lint run` to verify compliance

### Common Third-Party Aliases

Frequently used third-party package aliases (see `.golangci.yml` for complete list):
- `googleUuid "github.com/google/uuid"` - ALWAYS use `uuid.NewV7()` for time-ordered UUIDs
- `joseJwa/joseJwe/joseJwk/joseJws` for JOSE operations
- `crand "crypto/rand"` - Use for cryptographic randomness (NOT math/rand)

### Crypto Acronym Exceptions
**Use ALL CAPS for these terms anywhere in identifiers:**
- RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, ED448, PKCS8, PKIX, CSR, PEM, DER

**Examples:** `PEMTypeRSAPrivateKey`, `GenerateECDSAKeyPair`, `ValidateJWKHeaders`

## Magic Values Management

- Define all magic numbers/values in `cryptoutilMagic` package files (`internal/common/magic/magic_*.go`) for shared constants
- Define identity-specific magic values in `/internal/identity/<package>/magic*.go` files
- Group related constants by category: `magic_buffers.go`, `magic_timeouts.go`, `magic_network.go`
- Use descriptive constant names indicating purpose and units
- Magic value files automatically ignored by mnd exclude-files filter
- Update `.golangci.yml` importas configuration to include `cryptoutilMagic` alias
- Remove numbers from mnd ignored-numbers list once defined as constants

**Examples:**
```go
const (
    defaultPort = 8080
    adminPort = 9090
    timeout = 30 * time.Second
    maxRetries = 3
    bufferSize1KB = 1024
)
```

## Dependency Management

### Go Dependencies
- **ALWAYS use modernc.org/sqlite for SQLite** because it is CGO-free (required when CGO_ENABLED=0)

### Updates
- Check updates: `go list -u -m all | grep '\[.*\]$'`
- Update incrementally: `go get <package>@<version>`
- Clean up: `go mod tidy`
- Test after each: `go test ./... --count=1 -timeout=10m`

### Version Synchronization
- **Synchronize ecosystem packages**: Update related packages to latest stable and compatible version
- **Example**: OpenTelemetry packages (`go.opentelemetry.io/*`), GORM ecosystem
- **Ignore unrelated transients**: Let Go's MVS handle unrelated dependencies
- Use `go mod why <package>` to understand indirect dependencies

### Best Practices
- Update direct dependencies first, then ecosystem-related indirect ones
- Keep related packages at consistent versions
- Review changelog/release notes for breaking changes
- Prefer stable releases; avoid pre-releases
- Update in small batches to isolate issues

## Code Patterns

- **Default Values**: Always declare default values as named variables (e.g., `var defaultConfigFiles = []string{}`) rather than inline literals, following the established pattern in config.go
- **Pass-through Calls**: When making pass-through calls to helper functions, prefer using the same parameter order and return value order as the helper function to maintain API consistency and reduce confusion
- **NEVER invoke os.Exit() in library or test code** - ONLY in main() functions or cmd pattern entry functions
  - ALWAYS return wrapped errors all the way up the call stack
  - os.Exit() should ONLY be called at the command entry point (main function)
  - REASON: Supports maximum unit testing, because os.Exit() calls halt unit tests which is undesirable
  - Library functions must return errors instead of calling os.Exit()
