---
description: "Instructions for Go project structure, architecture, and coding standards"
applyTo: "**"
---
# Go Project Structure, Architecture & Standards

## Go Version Consistency

- **ALWAYS use the same Go version in every part of the project** (development, CI/CD, Docker)
- Current project Go version: **1.25.4** (check go.mod file)
- Set `GO_VERSION: '1.25.4'` in workflow environment variables
- Use `go-version: ${{ env.GO_VERSION }}` in setup-go actions
- Never enable CGO; assume I set CGO_ENABLED=0 in User settings.json, because I did
- Avoid Go dependencies that require CGO

## Build Flags and Linking

### Static Linking Requirement

- **ALWAYS use static linking** to ensure maximum portability
- Use `-extldflags '-static'` in ldflags for static linking
- Validate static linking with `ldd` check
- **ALWAYS retain debug symbols** for troubleshooting

## Go Project Structure

Follow the [Standard Go Project Layout](https://github.com/golang-standards/project-layout) patterns:

- `/cmd` - Main applications (minimal main functions)
- `/internal` - Private code enforced by compiler
- `/pkg` - Library code safe for external use
- `/api` - OpenAPI specs, protocol definitions
- `/configs`, `/scripts`, `/deployments`, `/test`, `/docs`, `/tools`
- **Avoid**: `/src` directory, deep nesting

## Application Architecture

- Layered: main → app → business logic → repositories
- Config: YAML files & CLI only (no env vars; use Docker/K8s secrets)
- Dependency injection, context propagation, graceful shutdown
- Factory pattern, error propagation, config validation

## Import Alias Conventions

**ALL `cryptoutil/**` imports MUST use camelCase aliases with "cryptoutil" prefix:**

- Pattern: `cryptoutil<PackageName>` (e.g., `cryptoutilMagic`, `cryptoutilCmdCicdCommon`)
- Defined in `.golangci.yml` importas section (source of truth)
- Common third-party: `googleUuid`, `joseJwa/Jwe/Jwk/Jws`, `crand "crypto/rand"`

**Crypto acronyms ALL CAPS**: RSA, EC, ECDSA, ECDH, HMAC, AES, JWA, JWK, JWS, JWE, ED25519, PKCS8, PEM, DER

## Magic Values Management

- Shared: `internal/common/magic/magic_*.go`
- Identity-specific: `/internal/identity/<package>/magic*.go`
- Group by category (buffers, timeouts, network); use descriptive names

## Dependency Management

- Use `modernc.org/sqlite` (CGO-free)
- Check: `go list -u -m all | grep '\[.*\]$'`
- Update incrementally, test after each, sync ecosystem packages

## Code Patterns

- Declare defaults as named variables, not inline literals
- Same param/return order as helper functions
- **NEVER os.Exit() in library/test code** - return errors; only main() calls os.Exit()
