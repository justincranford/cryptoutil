---
description: "Instructions for products and services architecture"
applyTo: "**"
---
# Products & Services Architecture - CRITICAL

**cryptoutil** is a production-ready suite of four cryptographic-based services, designed with enterprise-grade security, **FIPS 140-3** standards compliance, Zero-Trust principles, and security-on-by-default.

## Product Suite Architecture - CRITICAL

Each product can be used independently, or together as a comprehensive security solution. The four services are:

1. **Key Management Service (KMS)** - One service. Elastic Keys per tenant support Encrypt/Decrypt or Sign/Verify (depending on algorithm). Each Elastic Key is a key ring of 1-N Material Keys of specified algorithm. Latest Material Key is always used for Encrypt||Sign, and historical Material Key is always used for Decrypt||Verify. Encrypt/Decrypt payload is JWE. Sign/Verify payload is JWS.
2. **Identity Service** - Five services. Authorization server supports OAuth 2.1 and OIDC 1.0. IdP server supports multi-factor authentication (e.g. Username/Password, mTLS, WebAuthn, Passkeys, TOTP, HOTP, Magic Link, Yubikey). Relying Party, Resource Server, and Single Page Application, are all security-on-by-default reference implementations for customers to use as the basis for their custom services.
3. **Certificate Authority (CA)** - One service. Collection of APIs/UI for Administration, CMP, CMPv2, SCEP, EST, RA, CRLDP, OSCP, TimeStamping
4. **JSON Object Signing and Encryption (JOSE)** - One service. Collection of APIs/UI for Administration, JWK, JWKSet, JWE, JWS, JWT

Examples of using multiple services together:

- KMS with CA+Identity+JOSE: KMS Product uses CA Product for TLS, Identity Product for authentication and authorization, and JOSE Product for API-based Encrypt/Decrypt JWE operations and Sign/Verify JWS operations.
- CA with Identity+JOSE: CA Product uses Identity Product for authentication and authorization, and JOSE Product for internal-based Encrypt/Decrypt JWE operations and Sign/Verify JWS operations.
- Identity with JOSE: Identity Product uses internal-based Encrypt/Decrypt JWE operations and Sign/Verify JWS operations.

## Microservices Architecture - CRITICAL

**MANDATORY: All Services in All Four Products MUST support Dual HTTPS**

- **HTTPS ONLY** - All Services MUST use TLS 1.3 by default; never use HTTP
- **HTTPS Certificates** - All Services MUST support configurable dynamic or static TLS server cert chains and private key:
  - Dynamic TLS server cert chain; leaf cert, intermediate CA certs, and root CA cert all auto-generated by a private CA scoped to per-Product or per-Suite.
  - Static TLS server cert cain; Docker Secrets for Private Keys, and Public File Paths or Public PEM data for TLS Server cert chain and Trusted CA certs
- **Private HTTPS Endpoint**: All Services MUST support configurable dynamic or static HTTPS port for administration-only
  - Default is 0 (dynamic port), can be set to a static port like 9090+
  - /admin/v1/** prefix for all endpoints: `/admin/v1/livez`, `/admin/v1/readyz`, `/admin/v1/healthz`, `/admin/v1/shutdown`
  - Not externally accessible; IPv4 127.0.0.1 only, never IPv6, never localhost
  - Used by Docker health checks, Kubernetes probes, monitoring, testing
- **Public HTTPS Endpoint**: All Services MUST support configurable dynamic or static HTTPS port for clients and users, but different prefixes and middlewares for browser-based vs non-browser-based clients
  - Default is 0 (dynamic port), can be set to a static port like 8080+
  - /service/** prefix for non-browser clients: Access token (HTTP Authorization header) enforces /service/ path prefix, and uses non-browser client middlewares (e.g. IP Allowlist, Rate Limiting)
  - /browser/** prefix for browser-based clients: Session token (HTTP Cookie header) enforces /browser/ path prefix, and browser-based client middleware (e.g. CSRF, CORS, CSP, IP Allowlist, Rate Limiting, etc)
  - /service/** access tokens must be obtained via OAuth 2.0 Client Authorization Flow; these are HTTP Authorization header bear tokens
  - /browser/** access tokens must be obtained via OAuth 2.0 Authorization Code + PKCE flow; these are HTTP Cookie header session tokens
  - /browser/**and /service/** must service the same APIs via a shared OpenAPI spec for API consistency, but under two different request paths with mutually exclusive access and middlewares
  - /browser/** must also service UI-only requests via HTML pages, JavaScript, CSS, images, fonts, etc
- **Example Dual Ports for Services** (Source: SPECKIT-CONFLICTS-ANALYSIS C4 answer D, 2025-12-19):
  - KMS:            Public HTTPS APIs/UI: 127.0.0.1:8080 (unit/integration tests) or 0.0.0.0:8080 (docker compose), Private HTTPS Admin: 127.0.0.1:9090
  - Identity AuthZ: Public HTTPS APIs/UI: 127.0.0.1:8180 (unit/integration tests) or 0.0.0.0:8180 (docker compose), Private HTTPS Admin: 127.0.0.1:9091
  - Identity IdP:   Public HTTPS APIs/UI: 127.0.0.1:8181 (unit/integration tests) or 0.0.0.0:8181 (docker compose), Private HTTPS Admin: 127.0.0.1:9091
  - Identity RS:    Public HTTPS APIs/UI: 127.0.0.1:8182 (unit/integration tests) or 0.0.0.0:8182 (docker compose), Private HTTPS Admin: 127.0.0.1:9091
  - Identity RP:    Public HTTPS APIs/UI: 127.0.0.1:8183 (unit/integration tests) or 0.0.0.0:8183 (docker compose), Private HTTPS Admin: 127.0.0.1:9091
  - Identity SPA:   Public HTTPS APIs/UI: 127.0.0.1:8184 (unit/integration tests) or 0.0.0.0:8184 (docker compose), Private HTTPS Admin: 127.0.0.1:9091
  - CA:             Public HTTPS APIs/UI: 127.0.0.1:8380 (unit/integration tests) or 0.0.0.0:8380 (docker compose), Private HTTPS Admin: 127.0.0.1:9092
  - JOSE:           Public HTTPS APIs/UI: 127.0.0.1:8280 (unit/integration tests) or 0.0.0.0:8280 (docker compose), Private HTTPS Admin: 127.0.0.1:9093

**Admin Port Assignments** (unique per product to prevent collisions in unified deployment):

- **KMS**: 9090 (all KMS instances share same admin port, bound to 127.0.0.1)
- **Identity**: 9091 (all 5 Identity services share same admin port)
- **CA**: 9092 (all CA instances share same admin port)
- **JOSE**: 9093 (all JOSE instances share same admin port)

**Rationale**: Admin ports bound to 127.0.0.1 only (not externally accessible). In Docker Compose, each service instance is a separate container with isolated network namespace, so same admin port (9090/9091/9092/9093) can be reused across instances of same product without collision.

IMPORTANT: Use 127.0.0.1 in unit/integration tests to avoid Windows Firewall exception popups
