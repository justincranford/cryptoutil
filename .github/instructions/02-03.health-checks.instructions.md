---
description: "Health check endpoint patterns for proprietary and third-party services"
applyTo: "**"
---
# Health Check Endpoint Pattern - MANDATORY

**MANDATORY: All 9 proprietary services MUST use `/admin/v1/livez` and `/admin/v1/readyz` - NEVER `/admin/v1/healthz`**

## Proprietary Services Pattern (KMS Reference Implementation)

**Admin HTTPS Endpoint** (127.0.0.1:9090):

- `/admin/v1/livez` - Liveness probe (lightweight check: service running, process alive)
- `/admin/v1/readyz` - Readiness probe (heavyweight check: dependencies healthy, ready for traffic)
- `/admin/v1/shutdown` - Graceful shutdown trigger

**Health Check Semantics**:

- **livez**: Fast, lightweight check (~1ms) - verifies process is alive, TLS server responding
- **readyz**: Slow, comprehensive check (~100ms+) - verifies database connectivity, downstream services, resource availability
- **Use livez for**: Docker healthchecks (fast, frequent), liveness probes (restart on failure)
- **Use readyz for**: Kubernetes readiness probes (remove from load balancer), deployment validation

**Why Two Separate Endpoints** (Kubernetes standard):

- Liveness: Process alive but stuck? Restart container
- Readiness: Process alive but dependencies down? Remove from load balancer, don't restart
- Combined healthz endpoint can't distinguish these two failure modes

**Implementation Source**: KMS uses gofiber middleware which provides livez/readyz pattern out-of-box

## Third-Party Services (Different Patterns)

| Service | Health Check Type | Port | Endpoint | Exposed to Host? |
|---------|------------------|------|----------|------------------|
| OpenTelemetry Collector | OTEL standard | 13133 | Internal | ❌ No (container-only) |
| PostgreSQL | pg_isready | N/A | N/A | N/A |
| Grafana OTEL LGTM | Grafana standard | 3000 | Varies | ✅ Yes |

**Third-party services MAY use their own standard health check patterns - document them explicitly**

## CA Service Alignment Required

**Current CA Status**: Uses `/health`, `/livez`, `/readyz` without `/admin/v1` prefix

**Action Required**: Migrate CA to standard `/admin/v1/livez` and `/admin/v1/readyz` pattern for consistency

## Reference

- Implementation: `internal/kms/server/application/application_listener.go`
- Magic constants: `internal/shared/magic/magic_network.go`
- Analysis: `docs/HEALTH-CHECK-ANALYSIS.md`
