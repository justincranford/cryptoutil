---
description: "Server builder pattern and merged migrations"
applyTo: "**"
---
# Server Builder

# Server Builder Pattern - Tactical Guidance

## Quick Reference

**Builder eliminates 260+ lines per service**: TLS setup, admin/public servers, database, migrations, sessions, barrier
**Merged migrations**: Combines template (1001-1004) + domain (2001+) for golang-migrate validation
**Usage**: `NewServerBuilder(ctx, cfg).WithDomainMigrations(...).WithDefaultTenant(...).WithPublicRouteRegistration(...).Build()`

## Core Pattern

```go
// Create builder with template config
builder := cryptoutilTemplateBuilder.NewServerBuilder(ctx, cfg.ServiceTemplateServerSettings)

// Register domain migrations (2001+)
builder.WithDomainMigrations(repository.MigrationsFS, "migrations")

// Ensure default tenant/realm
builder.WithDefaultTenant(
    cryptoutilMagic.DefaultTenantID,
    cryptoutilMagic.DefaultRealmID,
)

// Register domain-specific routes
builder.WithPublicRouteRegistration(func(
    base *cryptoutilTemplateServer.PublicServerBase,
    res *cryptoutilTemplateBuilder.ServiceResources,
) error {
    // Create domain repositories
    // Create domain public server
    // Register routes
    return nil
})

// Build complete infrastructure
resources, err := builder.Build()
```

## Merged Migrations Pattern - CRITICAL

**Problem**: golang-migrate validates ALL database versions against source filesystem
- Template migrations create 1001-1004 in schema_migrations table
- Domain migrations FS only contains 2001+
- Validation fails: "no migration found for version 1004"

**Solution**: Implement `mergedMigrations` type with `fs.FS` interface

```go
type mergedMigrations struct {
    templateFS   fs.FS    // 1001-1004: tenants, sessions, barrier, realms
    templatePath string
    domainFS     fs.FS    // 2001+: application-specific tables
    domainPath   string
}

// Implement fs.FS interface
func (m *mergedMigrations) Open(name) (fs.File, error)
func (m *mergedMigrations) ReadDir(name) ([]fs.DirEntry, error)
func (m *mergedMigrations) ReadFile(name) ([]byte, error)
func (m *mergedMigrations) Stat(name) (fs.FileInfo, error)
```

**Pattern**: Try domain FS first, fallback to template FS. golang-migrate sees unified migration stream.

## ServiceResources

Builder returns initialized infrastructure:

```go
type ServiceResources struct {
    DB               *gorm.DB
    TelemetryService *cryptoutilTelemetry.TelemetryService
    JWKGenService    *cryptoutilJose.JWKGenService
    BarrierService   *cryptoutilBarrier.BarrierService
    SessionManager   *cryptoutilTemplateBusinessLogic.SessionManagerService
    RealmService     cryptoutilTemplateService.RealmService
    RealmRepository  cryptoutilTemplateRepository.TenantRealmRepository
    Application      *cryptoutilTemplateServer.Application
    ShutdownCore     func()
    ShutdownContainer func()
}
```

## Test Compatibility

Services using builder MUST provide accessor methods for tests:

```go
func (s *Server) JWKGen() *cryptoutilJose.JWKGenService { return s.jwkGenService }
func (s *Server) Telemetry() *cryptoutilTelemetry.TelemetryService { return s.telemetryService }
func (s *Server) PublicPort() int { return s.app.PublicPort() }
func (s *Server) AdminPort() int { return s.app.AdminPort() }
func (s *Server) SetReady(ready bool) { s.app.SetReady(ready) }
func (s *Server) PublicBaseURL() string { return s.app.PublicBaseURL() }
func (s *Server) AdminBaseURL() string { return s.app.AdminBaseURL() }
```

## Migration Versioning

**Template migrations**: 1001-1004 (shared infrastructure)
- 1001: Sessions tables
- 1002: Barrier encryption keys
- 1003: Realm tables
- 1004: Multi-tenancy (tenants, tenant_realms)

**Domain migrations**: 2001+ (application-specific)
- cipher-im: 2001 (messages, message_recipients, message_recipient_jwks)
- jose-ja: 2001+ (JWK storage tables)
- pki-ca: 2001+ (certificate storage tables)

## Key Takeaways

1. **Builder Pattern**: Eliminates 260+ lines of boilerplate per service
2. **Merged Migrations**: Solves golang-migrate validation for template + domain migrations
3. **ServiceResources**: Provides all initialized infrastructure to domain code
4. **Test Accessors**: Required delegation methods for test compatibility
5. **Migration Numbering**: Template 1001-1004, domain 2001+ (avoids conflicts)
6. **fs.FS Interface**: mergedMigrations implements Open/ReadDir/ReadFile/Stat for unified view
