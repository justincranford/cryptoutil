---
description: "Instructions for database operations and ORM patterns"
applyTo: "**"
---
# Database and ORM Instructions

- Use [GORM ORM](https://gorm.io/) (never sql.DB directly)
- Use transactions, error mapping, migrations, pooling, pagination, filters, UUIDv7 PKs, FKs, debug logging as needed
- Implement proper error mapping from GORM errors to application HTTP errors in `toAppErr` methods
- Use embedded SQL migrations with golang-migrate for schema changes
- Support both PostgreSQL (production) and SQLite (development/testing) backends
- Always apply database migrations on startup
- Use proper pagination with offset/limit patterns for large result sets
- Log database schema information in debug mode for troubleshooting

## SQLite Concurrent Write Operations - CRITICAL

**ALWAYS configure these SQLite settings to handle concurrent writes and parallel testing:**

### Required PRAGMA Settings

```go
// Enable WAL mode for better concurrency (allows multiple readers + 1 writer)
if _, err := sqlDB.Exec("PRAGMA journal_mode=WAL;"); err != nil {
    return fmt.Errorf("failed to enable WAL mode: %w", err)
}

// Set busy timeout for handling concurrent write operations (30 seconds)
if _, err := sqlDB.Exec("PRAGMA busy_timeout = 30000;"); err != nil {
    return fmt.Errorf("failed to set busy timeout: %w", err)
}
```

### Connection Pool Configuration

```go
// For SQLite, limit connection pool to prevent write contention
// SQLite only supports 1 concurrent writer (even in WAL mode)
sqlDB.SetMaxOpenConns(1)  // Use magic constant: cryptoutilMagic.SQLiteMaxOpenConnections
sqlDB.SetMaxIdleConns(1)
```

### Why This Matters

- **WAL mode** (Write-Ahead Logging) allows multiple concurrent readers and one writer
- **busy_timeout** makes SQLite retry when database is locked instead of immediately failing
- **MaxOpenConns=1** prevents connection pool from trying concurrent writes (which would fail)
- **Without these settings**, parallel Go tests using `t.Parallel()` will fail with database locking errors

### Reference Implementation

See `internal/server/repository/sqlrepository/sql_provider.go` lines 201-213 for the canonical SQLite configuration pattern used in the KMS server code.

### Magic Constants

Use these constants from `internal/common/magic/magic_database.go`:
- `cryptoutilMagic.DBSQLiteBusyTimeout` = 30 seconds
- `cryptoutilMagic.SQLiteMaxOpenConnections` = 1

## Database DSN Usage

**Database DSN (Use localhost):**
```go
dsn := "postgres://user:pass@localhost:5432/dbname?sslmode=disable"
```
