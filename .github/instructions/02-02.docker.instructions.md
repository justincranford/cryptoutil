---
description: "Instructions for Docker and Docker Compose configuration"
applyTo: "**"
---
# Docker Configuration Instructions

## Core Rules

- Use `docker compose` (not `docker-compose`)
- NEVER use absolute paths in compose.yml - breaks cross-platform compatibility
- ALWAYS use relative paths: `file: ./postgres/postgres_username.secret`

## Multi-Stage Builds

- Global ARGs at top of Dockerfile for visibility
- Redeclare ARGs in stages using them for LABELs
- WORKDIR: `/src` for builder, `/app` for runtime
- All LABELs on final published image only
- Enforce required ARGs (VCS_REF, BUILD_DATE) via validation stage

## Docker Secrets - CRITICAL

- NEVER modify Docker Compose secrets - breaks cryptographic key hierarchy
- ALL cryptoutil instances MUST use SAME unseal secrets for interoperability
- Use secrets directly with file:// URLs, not environment variables

```yaml
secrets:
  - database_url_secret
command: ["app", "--database-url=file:///run/secrets/database_url_secret"]
```

## Networking

- ALWAYS use `127.0.0.1` in containers (not `localhost` - resolves to IPv6 `::1` in Alpine)
- Use `wget` for healthchecks (available in Alpine), not `curl`

```yaml
healthcheck:
  test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/livez"]
```

## Sidecar Health Checks

For containers without shell/utilities (e.g., otel-collector-contrib):

```yaml
minimal-service-health-check:
  image: alpine:latest
  command: ["wget", "--quiet", "--tries=1", "--spider", "http://minimal-service:13133/"]
  depends_on:
    minimal-service:
      condition: service_started
```

## Service Ports Quick Reference

| Service | Public API | Admin API | Backend |
|---------|-----------|-----------|---------|
| cryptoutil-sqlite | 8080 | 9090 | SQLite in-memory |
| cryptoutil-postgres-1 | 8081 | 9090 | PostgreSQL |
| cryptoutil-postgres-2 | 8082 | 9090 | PostgreSQL |
| postgres | 5432 | - | - |
| otel-collector | 4317 (gRPC), 4318 (HTTP) | 13133 | - |
| grafana-otel-lgtm | 3000 | - | Loki/Tempo/Prometheus |

## Config Files

- `cryptoutil-common.yml`: Shared settings (TLS, unseal, security) - affects ALL instances
- `cryptoutil-sqlite.yml`, `cryptoutil-postgresql-{1,2}.yml`: Instance-specific (CORS, OTLP service/hostname)
- Instance config values MUST be unique and match service name in compose.yml
