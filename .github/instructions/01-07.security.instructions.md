---
description: "Instructions for security implementation patterns"
applyTo: "**"
---
# Security Implementation Instructions

- Monitor Go security vulnerabilities at <https://pkg.go.dev/vuln/list> and update promptly
- Multi-layer barrier: unseal → root → intermediate → content keys
- Hierarchical key management, encrypted at rest
- IP allowlisting (IPs & CIDR), per-IP rate limiting
- CORS, CSRF, strict HTTP headers, audit logging
- Multiple unseal modes, key versioning/rotation, secure failure modes
- Always use crypto/rand, never math/rand
- Full cert chain validation, MinVersion: TLS 1.3+, never InsecureSkipVerify
- Use proper secret management for Docker, Kubernetes, CI/CD
- **ALWAYS prefer Docker secrets or Kubernetes secrets over environment variables for sensitive data**
- **NEVER use environment variables for secrets in production or tests**
- Use Docker secrets mounted to `/run/secrets/` with file:// URLs in command arguments
- Use Kubernetes secrets mounted as files or referenced directly, not via environment variables

# Crypto Instructions

- **CRITICAL: FIPS 140-3 mode is ALWAYS enabled by default and MUST NEVER be disabled** - all cryptographic operations use FIPS-approved algorithms
- **CRITICAL: ONLY use NIST FIPS 140-3 approved algorithms** - RSA ≥ 2048 bits, AES ≥ 128 bits, EC NIST curves, EdDSA, PBKDF2-HMAC-SHA256
- **CRITICAL: NEVER use non-FIPS algorithms** - Examples of BANNED algorithms:
  - ❌ **bcrypt** - NOT FIPS-approved, use PBKDF2-HMAC-SHA256 instead
  - ❌ **scrypt** - NOT FIPS-approved, use PBKDF2-HMAC-SHA256 instead
  - ❌ **Argon2** - NOT FIPS-approved, use PBKDF2-HMAC-SHA256 instead
  - ❌ **MD5** - NOT FIPS-approved, use SHA-256 or SHA-512 instead
  - ❌ **SHA-1** - NOT FIPS-approved, use SHA-256 or SHA-512 instead
- **CRITICAL: Password hashing MUST use PBKDF2-HMAC-SHA256** - NEVER use bcrypt, scrypt, or Argon2
- **Algorithm agility required**: All crypto operations (hashing, encryption, signing, MAC, key derivation) must support configurable algorithms with FIPS-approved defaults
- Use keygen package for generating RSA, ECDSA, ECDH, EdDSA, AES, HMAC, and UUIDv7 keys
- Avoid fallback values for cryptographic operations
- Use provided pool and keygen abstractions for concurrent cryptographic key generation operations
- Review cryptographic practices for compliance and security
- Periodically audit cryptographic code for compliance
- **CRITICAL**: All cryptoutil instances using the same set of shared, unseal secrets MUST derive the same unseal JWKs, including the KIDs and key materials, for cryptographic interoperability between instances
- **CRITICAL**: If only key materials were derived deterministically, using different KIDs would break interoperability

# CA/Browser Forum Baseline Requirements

- Adhere to latest CA/Browser Forum Baseline Requirements for TLS Server Certificates
- Follow certificate profile requirements in Section 7
- Implement proper certificate serial number generation (Section 7.1): minimum 64 bits CSPRNG, non-sequential, >0, <2^159
- Use only approved cryptographic algorithms and key sizes (Section 6.1.5, 6.1.6)
- Follow validity period requirements (max 398 days for subscriber certificates post-2020-09-01)
- Implement required certificate extensions (Section 7.1.2)
- Ensure proper subject/issuer name encoding (Section 7.1.4)
- Use approved signature algorithms (Section 7.1.3.2)
- Follow CRL and OCSP profile requirements (Sections 7.2, 7.3)
- Implement proper audit logging for certificate lifecycle events (Section 5.4.1)
- Ensure compliance with validation requirements (Section 3.2.2)

# Network Security Patterns

- **ALWAYS use HTTPS 127.0.0.1:9090 for admin APIs** (/shutdown, /livez, /readyz) - private server endpoints

## CRITICAL: Windows Firewall Exception Prevention

**MANDATORY: ALWAYS bind to 127.0.0.1 (NEVER 0.0.0.0) in tests and local development**

**Why This Matters**:

- Binding to `0.0.0.0` (all network interfaces) triggers Windows Firewall exception prompts
- Binding to `127.0.0.1` (loopback only) does NOT trigger firewall prompts
- Tests MUST run without user interaction or security prompts

**Violation Impact**:

- ❌ Each `0.0.0.0` binding = 1 Windows Firewall popup
- ❌ Blocks CI/CD automation (requires manual approval)
- ❌ Security risk (accidentally exposing test services to network)

**Correct Patterns**:

```go
// ✅ CORRECT: Bind to loopback only (no firewall prompt)
addr := fmt.Sprintf("%s:%d", cryptoutilMagic.IPv4Loopback, port) // "127.0.0.1"
listener, err := net.Listen("tcp", addr)

// ❌ WRONG: Bind to all interfaces (triggers firewall prompt)
listener, err := net.Listen("tcp", fmt.Sprintf("0.0.0.0:%d", port))
```

**Configuration Files**:

```yaml
# ✅ CORRECT: Test configs use loopback
bind_address: 127.0.0.1

# ❌ WRONG: Production pattern in test configs
bind_address: 0.0.0.0  # Only for Docker containers, NEVER for local tests
```

**Docker vs Local Development**:

- **Docker containers**: Use `0.0.0.0` (containers isolated by default)
- **Local tests**: Use `127.0.0.1` (avoid firewall prompts)
- **Integration tests**: Use hardcoded ports on `127.0.0.1` (18080, 18081, 18082)

## Localhost vs 127.0.0.1 Usage

### Decision Rules by Environment

| Environment | localhost | 127.0.0.1 | Preferred |
|-------------|-----------|-----------|-----------|
| **Local Windows Dev** | ✅ | ✅ | `127.0.0.1` (avoid firewall) |
| **GitHub Workflows** | ✅ | ✅ | `127.0.0.1` |
| **Act Containers** | ✅ | ✅ | `127.0.0.1` |
| **Docker Containers (internal)** | ❌ | ✅ | `127.0.0.1` |
| **Docker Compose (host→container)** | ✅ | ✅ | `localhost` |
| **Go Code (bind addresses)** | ❌ | ✅ | `127.0.0.1` |
| **Go Code (database DSN)** | ✅ | ✅ | `localhost` |

### Quick Reference

**Go Server Binding (ALWAYS use 127.0.0.1):**

```go
bindAddress := cryptoutilMagic.IPv4Loopback // "127.0.0.1"
```
