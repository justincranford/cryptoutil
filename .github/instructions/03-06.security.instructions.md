---
description: "Instructions for security implementation patterns"
applyTo: "**"
---
# Security Implementation Patterns - Tactical Guidance

**Reference**: See `.specify/memory/security.md` for complete specifications (key hierarchy, secret management, network security, audit logging)

**This file contains ONLY tactical implementation patterns**

## Quick Reference Checklist

- ✅ Monitor Go vulnerabilities: <https://pkg.go.dev/vuln/list>
- ✅ Multi-layer key barrier: unseal → root → intermediate → content
- ✅ IP allowlist + per-IP rate limiting + CORS + CSRF + CSP headers
- ✅ Docker secrets (NEVER environment variables)
- ✅ crypto/rand ALWAYS (NEVER math/rand)
- ✅ TLS 1.3+ with full cert chain validation
- ✅ Audit log security events (90-day retention minimum)
- ✅ Elastic key rotation (active key + historical keys)

## CRITICAL: Windows Firewall Exception Prevention

**MANDATORY: ALWAYS bind to 127.0.0.1 (NEVER 0.0.0.0) in tests and local development**

```go
// ✅ CORRECT: Bind to loopback only (no firewall prompt)
addr := fmt.Sprintf("%s:%d", cryptoutilMagic.IPv4Loopback, port)  // "127.0.0.1"
listener, err := net.Listen("tcp", addr)

// ❌ WRONG: Bind to all interfaces (triggers firewall prompt)
listener, err := net.Listen("tcp", fmt.Sprintf("0.0.0.0:%d", port))
```

**Impact**: Each `0.0.0.0` binding = 1 Windows Firewall popup, blocks CI/CD

## Localhost vs 127.0.0.1 Decision Matrix

| Environment | Preferred | Rationale |
|-------------|-----------|-----------|
| Local Windows Dev | `127.0.0.1` | Avoid firewall prompts |
| GitHub Workflows | `127.0.0.1` | Explicit IPv4, no DNS resolution |
| Docker Containers (internal) | `127.0.0.1` | Alpine resolves localhost to ::1 (IPv6) |
| Docker Compose (host→container) | `localhost` | Docker DNS handles resolution |
| Go Code (bind addresses) | `127.0.0.1` | Explicit IPv4, no ambiguity |
| Go Code (database DSN) | `localhost` | PostgreSQL driver handles resolution |

## Secret Management Pattern

**Docker Secrets (MANDATORY)**:

```yaml
# docker-compose.yml
services:
  cryptoutil:
    secrets:
      - database_url
      - unseal_key
    command:
      - "--database-url=file:///run/secrets/database_url"
      - "--unseal-key=file:///run/secrets/unseal_key"

secrets:
  database_url:
    file: ./deployments/compose/secrets/database_url.secret
```

**Secret File Permissions**: **440 (r--r-----)**

```bash
chmod 440 deployments/compose/*/secrets/*.secret
```

## Key Takeaways

1. **Windows Firewall**: ALWAYS bind to 127.0.0.1 in tests (NEVER 0.0.0.0)
2. **Secrets**: Docker/K8s secrets only (NEVER environment variables)
3. **Crypto**: crypto/rand ALWAYS (NEVER math/rand), TLS 1.3+ with full validation
4. **Network**: IP allowlist + rate limiting + CORS + CSRF + CSP
5. **Audit**: Log all security events, 90-day retention minimum
