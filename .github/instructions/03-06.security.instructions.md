---
description: "Instructions for security implementation patterns"
applyTo: "**"
---
# Security Implementation Instructions

- Monitor Go security vulnerabilities at <https://pkg.go.dev/vuln/list> and update promptly
- Multi-layer barrier: unseal → root → intermediate → content keys
- Hierarchical key management, encrypted at rest
- IP allowlisting (IPs & CIDR), per-IP rate limiting
- CORS, CSRF, strict HTTP headers, audit logging
- Multiple unseal modes, key versioning/rotation, secure failure modes
- Always use crypto/rand, never math/rand (see `02-08.cryptography.instructions.md`)
- Full cert chain validation, MinVersion: TLS 1.3+ (see `02-10.pki.instructions.md`)
- Use proper secret management for Docker, Kubernetes, CI/CD
- **ALWAYS prefer Docker secrets or Kubernetes secrets over environment variables for sensitive data**
- **NEVER use environment variables for secrets in production or tests**
- Use Docker secrets mounted to `/run/secrets/` with file:// URLs in command arguments
- Use Kubernetes secrets mounted as files or referenced directly, not via environment variables

# Network Security Patterns

- **ALWAYS use HTTPS 127.0.0.1:9090 for admin APIs** (/shutdown, /livez, /readyz) - private server endpoints

## CRITICAL: Windows Firewall Exception Prevention

**MANDATORY: ALWAYS bind to 127.0.0.1 (NEVER 0.0.0.0) in tests and local development**

**Why This Matters**:

- Binding to `0.0.0.0` (all network interfaces) triggers Windows Firewall exception prompts
- Binding to `127.0.0.1` (loopback only) does NOT trigger firewall prompts
- Tests MUST run without user interaction or security prompts

**Violation Impact**:

- ❌ Each `0.0.0.0` binding = 1 Windows Firewall popup
- ❌ Blocks CI/CD automation (requires manual approval)
- ❌ Security risk (accidentally exposing test services to network)

**Correct Patterns**:

```go
// ✅ CORRECT: Bind to loopback only (no firewall prompt)
addr := fmt.Sprintf("%s:%d", cryptoutilMagic.IPv4Loopback, port) // "127.0.0.1"
listener, err := net.Listen("tcp", addr)

// ❌ WRONG: Bind to all interfaces (triggers firewall prompt)
listener, err := net.Listen("tcp", fmt.Sprintf("0.0.0.0:%d", port))
```

**Configuration Files**:

```yaml
# ✅ CORRECT: Test configs use loopback
bind_address: 127.0.0.1

# ❌ WRONG: Production pattern in test configs
bind_address: 0.0.0.0  # Only for Docker containers, NEVER for local tests
```

**Docker vs Local Development**:

- **Docker containers**: Use `0.0.0.0` (containers isolated by default)
- **Local tests**: Use `127.0.0.1` (avoid firewall prompts)
- **Integration tests**: Use hardcoded ports on `127.0.0.1` (18080, 18081, 18082)

## Localhost vs 127.0.0.1 Usage

### Decision Rules by Environment

| Environment | localhost | 127.0.0.1 | Preferred |
|-------------|-----------|-----------|-----------|
| **Local Windows Dev** | ✅ | ✅ | `127.0.0.1` (avoid firewall) |
| **GitHub Workflows** | ✅ | ✅ | `127.0.0.1` |
| **Act Containers** | ✅ | ✅ | `127.0.0.1` |
| **Docker Containers (internal)** | ❌ | ✅ | `127.0.0.1` |
| **Docker Compose (host→container)** | ✅ | ✅ | `localhost` |
| **Go Code (bind addresses)** | ❌ | ✅ | `127.0.0.1` |
| **Go Code (database DSN)** | ✅ | ✅ | `localhost` |

### Quick Reference

**Go Server Binding (ALWAYS use 127.0.0.1):**

```go
bindAddress := cryptoutilMagic.IPv4Loopback // "127.0.0.1"
```
