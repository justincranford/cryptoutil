---
description: "Instructions for security implementation patterns"
applyTo: "**"
---
# Security Implementation Instructions

- Monitor Go security vulnerabilities at https://pkg.go.dev/vuln/list and update promptly
- Multi-layer barrier: unseal → root → intermediate → content keys
- Hierarchical key management, encrypted at rest
- IP allowlisting (IPs & CIDR), per-IP rate limiting
- CORS, CSRF, strict HTTP headers, audit logging
- Multiple unseal modes, key versioning/rotation, secure failure modes
- Always use crypto/rand, never math/rand
- Full cert chain validation, MinVersion: TLS 1.2+, never InsecureSkipVerify
- Use proper secret management for Docker, Kubernetes, CI/CD
- **ALWAYS prefer Docker secrets or Kubernetes secrets over environment variables for sensitive data**
- **NEVER use environment variables for secrets in production deployments**
- Use Docker secrets mounted to `/run/secrets/` with file:// URLs in command arguments
- Use Kubernetes secrets mounted as files or referenced directly, not via environment variables

# CA/Browser Forum Baseline Requirements

- Adhere to latest CA/Browser Forum Baseline Requirements for TLS Server Certificates
- Follow certificate profile requirements in Section 7
- Implement proper certificate serial number generation (Section 7.1): minimum 64 bits CSPRNG, non-sequential, >0, <2^159
- Use only approved cryptographic algorithms and key sizes (Section 6.1.5, 6.1.6)
- Follow validity period requirements (max 398 days for subscriber certificates post-2020-09-01)
- Implement required certificate extensions (Section 7.1.2)
- Ensure proper subject/issuer name encoding (Section 7.1.4)
- Use approved signature algorithms (Section 7.1.3.2)
- Follow CRL and OCSP profile requirements (Sections 7.2, 7.3)
- Implement proper audit logging for certificate lifecycle events (Section 5.4.1)
- Ensure compliance with validation requirements (Section 3.2.2)

# Network Security Patterns

## Localhost vs 127.0.0.1 Usage

### Decision Rules by Environment

| Environment | localhost | 127.0.0.1 | Preferred |
|-------------|-----------|-----------|-----------|
| **Local Windows Dev** | ✅ | ✅ | Either |
| **GitHub Workflows** | ✅ | ✅ | `127.0.0.1` |
| **Act Containers** | ✅ | ✅ | `127.0.0.1` |
| **Docker Containers (internal)** | ❌ | ✅ | `127.0.0.1` |
| **Docker Compose (host→container)** | ✅ | ✅ | `localhost` |
| **Go Code (bind addresses)** | ❌ | ✅ | `127.0.0.1` |
| **Go Code (database DSN)** | ✅ | ✅ | `localhost` |

### Quick Reference

**Go Server Binding (ALWAYS use 127.0.0.1):**
```go
bindAddress := cryptoutilMagic.IPv4Loopback // "127.0.0.1"
```
