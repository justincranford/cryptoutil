---
description: "Security, cryptography, hashing, and PKI patterns"
applyTo: "**"
---
# Security & Cryptography

## FIPS 140-3 Compliance - ALWAYS Enabled

**Approved Algorithms**:
- **Asymmetric**: RSA >=2048, ECDSA (P-256/384/521), ECDH (P-256/384/521), EdDSA (25519/448)
- **Symmetric**: AES >=128 (GCM, CBC+HMAC)
- **Digest**: SHA-256/384/512, HMAC-SHA256/384/512
- **KDF**: PBKDF2-HMAC-SHA256/384/512, HKDF-SHA256/384/512

**BANNED**: bcrypt, scrypt, Argon2, MD5, SHA-1, RSA <2048, DES, 3DES

**Algorithm Agility**: ALL crypto operations MUST support configurable algorithms with FIPS-approved defaults. Use config structs with Algorithm and KeySize fields.

See [ARCHITECTURE.md Section 6.1 FIPS 140-3 Compliance Strategy](../../docs/ARCHITECTURE.md#61-fips-140-3-compliance-strategy) and [Section 6.4.1 FIPS 140-3 Compliance (ALWAYS Enabled)](../../docs/ARCHITECTURE.md#641-fips-140-3-compliance-always-enabled) for comprehensive compliance documentation.

## Cryptographic Libraries

**Prefer standard library**: crypto/rand, crypto/rsa, crypto/ecdsa, crypto/ed25519, crypto/aes, crypto/cipher, crypto/sha256, crypto/sha512, crypto/hmac, crypto/tls, golang.org/x/crypto/pbkdf2, golang.org/x/crypto/hkdf.

**MANDATORY**: crypto/rand ALWAYS (NEVER math/rand). TLS 1.3+ minimum. NEVER InsecureSkipVerify: true.

See [ARCHITECTURE.md Section 6.4 Cryptographic Architecture](../../docs/ARCHITECTURE.md#64-cryptographic-architecture) for comprehensive cryptographic library usage patterns.

## Multi-Layer Key Hierarchy

**Unseal -> Root -> Intermediate -> Content Keys**:
- **Unseal Key**: Never stored in app, Docker secrets at runtime (HKDF deterministic derivation for interoperability)
- **Root Key**: Encrypted with unseal key, rotated annually
- **Intermediate Keys**: Encrypted with root key, rotated quarterly
- **Content Keys**: Encrypted with intermediate keys, rotated per-operation

**Elastic Key Ring**: Active key encrypts/signs, historical keys decrypt/verify. Key ID embedded with ciphertext. Rotation: new key as active, keep old keys.

See [ARCHITECTURE.md Section 6.4.2 Key Hierarchy (Barrier Service)](../../docs/ARCHITECTURE.md#642-key-hierarchy-barrier-service) and [Section 6.7 Key Management System Architecture](../../docs/ARCHITECTURE.md#67-key-management-system-architecture) for comprehensive key hierarchy documentation.

## Hash Service Architecture

### Version-Based Policy Framework

Each version = (4 registries based on NIST/OWASP policy) + unique pepper.

**Supported Versions**: v1 (2020 NIST), v2 (2023 NIST), v3 (2025 OWASP). New version on policy change OR pepper rotation.

**Hash Output Format**: `{version}:{algorithm}:{iterations}:base64(salt):base64(hash)`

### Registry Selection

| Registry | Input Type | Algorithm | Use Cases |
|----------|-----------|-----------|-----------|
| LowEntropyDeterministic | PII (<128 bits) | PBKDF2 + fixedSalt | Username lookup, email dedup |
| LowEntropyRandom | Passwords | PBKDF2 + randomSalt | User passwords, client secrets |
| HighEntropyDeterministic | Config (>=128 bits) | HKDF + fixedSalt | Config integrity, dedup |
| HighEntropyRandom | API keys | HKDF + randomSalt | API key storage, bearer tokens |

### Pepper Requirements - MANDATORY

- ALL inputs MUST be peppered before hashing.
- Storage: Docker/K8s secrets (NEVER in DB or source code).
- Pepper rotation requires version bump + lazy re-hash on next auth.
- Salt is public (OK in hash output); pepper provides protection.

### Deterministic Hash Protections

**LowEntropyDeterministicHashRegistry MUST have**: query rate limits, abuse detection, audit logs, strict access control (prevents oracle attacks).

See [ARCHITECTURE.md Section 6.4.3 Hash Service (Version-Based)](../../docs/ARCHITECTURE.md#643-hash-service-version-based) for complete hash service architecture and version-based policy framework.

## PKI & Certificate Compliance

### CA/Browser Forum Baseline Requirements

**Serial Number**: >=64 bits CSPRNG, non-sequential, >0, <2^159.
**Key Sizes**: RSA >=2048 (recommend 3072/4096), ECDSA P-256+ (recommend P-384), EdDSA Ed25519+.
**Validity**: Subscriber <=398 days, Intermediate 5-10 years, Root 20-25 years.
**Required Extensions**: Key Usage (critical), EKU, SAN, AKI, SKI, CRL Distribution Points, AIA.
**Prohibited**: MD5, SHA-1 signatures.

### TLS Configuration

```go
tlsConfig := &tls.Config{
    MinVersion:         tls.VersionTLS13,
    InsecureSkipVerify: false,  // ALWAYS validate certs
    RootCAs:            certPool,
    ClientCAs:          certPool,
    ClientAuth:         tls.RequireAndVerifyClientCert,
}
```

### CA Architecture Tiers

1. **Offline Root -> Online Root -> Online Issuing** (Recommended: max security)
2. **Online Root -> Online Issuing** (Balanced: simpler ops)
3. **Online Root** (Dev/test only)

### Certificate Lifecycle

- **Issuance**: CSR validation, identity verification, signing, publication.
- **Renewal**: Pre-expiration notification (60/30/7 days), re-validation, new serial.
- **Revocation**: CRL update <=7 days, OCSP response <=7 days validity.

### mTLS Revocation Checking

MUST check BOTH CRLDP and OCSP. Fail if BOTH unreachable. Cache CRLs with TTL.

See [ARCHITECTURE.md Section 6.5 PKI Architecture & Strategy](../../docs/ARCHITECTURE.md#65-pki-architecture--strategy) for comprehensive PKI patterns including CA/Browser Forum compliance and certificate lifecycle management.

## Network Security

**IP Allowlisting**: 127.0.0.1, ::1, private ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).

**Per-IP Rate Limiting** (token bucket): Public 100 req/min (burst 20), Admin 10 req/min (burst 5), Login 5 req/min (burst 2).

**Web Security Headers**: CORS (restrict origins, credentials, 1h preflight), CSRF (double-submit cookie, exempt /service/**), CSP (default-src 'self', object-src 'none').

See [ARCHITECTURE.md Section 6.3 Product Security Strategy](../../docs/ARCHITECTURE.md#63-product-security-strategy) for network security patterns including IP allowlisting, rate limiting, and web security headers.

## Secret Management - MANDATORY

**Priority**: Docker/K8s secrets (ALWAYS) > YAML config > CLI args. NEVER inline env vars.
**File Permissions**: 440 (r--r-----) on all .secret files.
**Usage**: `file:///run/secrets/secret_name`

See [ARCHITECTURE.md Section 12.3.3 Secrets Coordination Strategy](../../docs/ARCHITECTURE.md#1233-secrets-coordination-strategy) for deployment-level secrets management across SUITE/PRODUCT/SERVICE levels.

## Windows Firewall Prevention

**ALWAYS bind to 127.0.0.1 in tests/local dev** (NEVER 0.0.0.0). Each 0.0.0.0 binding = Windows Firewall popup blocking CI/CD.

| Environment | Preferred | Rationale |
|-------------|-----------|-----------|
| Go code / tests | 127.0.0.1 | Explicit IPv4, no firewall |
| Docker internal | 127.0.0.1 | Alpine resolves localhost to ::1 |
| Docker Compose host | localhost | Docker DNS handles resolution |

See [ARCHITECTURE.md Section 10.2 Unit Testing Strategy](../../docs/ARCHITECTURE.md#102-unit-testing-strategy) for testing patterns that avoid Windows Firewall prompts.

## Audit Logging

**Events**: Auth attempts, authz denials, key generation/rotation, cert issuance/revocation, admin API access, rate limit violations.
**Retention**: 90 days minimum (security), 7 years (cert audit per CA/BF).
**Rules**: NEVER log passwords, keys, PII, tokens. Safe: key IDs, user IDs, operation types, durations.

See [ARCHITECTURE.md Section 6.3 Product Security Strategy](../../docs/ARCHITECTURE.md#63-product-security-strategy) for audit logging requirements and retention policies.

## Secrets Detection Strategy

**Detection**: Length-based threshold (≥32 bytes / ≥43 base64 chars) for inline secrets in compose files. NO entropy calculation (too many false positives). Safe references (`/run/secrets/`, short dev defaults) excluded. Infrastructure deployments excluded.

See [ARCHITECTURE.md Section 6.10 Secrets Detection Strategy](../../docs/ARCHITECTURE.md#610-secrets-detection-strategy) for detection approach and trade-offs.

See [ARCHITECTURE.md Section 12.6 Secrets Management in Deployments](../../docs/ARCHITECTURE.md#126-secrets-management-in-deployments) for Docker secrets enforcement in compose files.

## Cross-References

See [ARCHITECTURE.md Section 6. Security Architecture](../../docs/ARCHITECTURE.md#6-security-architecture) for comprehensive security architecture including FIPS 140-3 compliance, multi-layer key hierarchy, PKI patterns, and TLS configuration.

See [ARCHITECTURE.md Section 12.3.3 Secrets Coordination Strategy](../../docs/ARCHITECTURE.md#1233-secrets-coordination-strategy) for deployment-level secrets management (SUITE/PRODUCT/SERVICE coordination).
