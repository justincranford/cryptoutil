---
description: "Observability and monitoring"
applyTo: "**"
---
# Observability

## Telemetry Flow - MANDATORY

`cryptoutil -> otel-collector (sidecar, OTLP gRPC:4317 or HTTP:4318) -> grafana-otel-lgtm (OTLP gRPC:14317 or HTTP:14318)`

**ALWAYS forward through sidecar** (NEVER bypass to grafana directly).

See [ARCHITECTURE.md Section 9.4 Telemetry Strategy](../../docs/ARCHITECTURE.md#94-telemetry-strategy) for telemetry flow and OpenTelemetry configuration.

## Configuration

```yaml
observability:
  otlp:
    protocol: grpc             # grpc (default) or http
    endpoint: opentelemetry-collector:4317
    service_name: cryptoutil-kms
    insecure: true             # dev only, false for prod
```

See [ARCHITECTURE.md Section 9.4 Telemetry Strategy](../../docs/ARCHITECTURE.md#94-telemetry-strategy) for observability configuration patterns.

## Structured Logging - MANDATORY

Key-value pairs, JSON format, trace correlation. Standard fields: `timestamp`, `level`, `message`, `trace_id`, `span_id`, `service.name`.

```go
logger.Info("Key created", zap.String("key_id", keyID), zap.String("algorithm", "RSA-2048"), zap.Duration("duration", elapsed))
```

See [ARCHITECTURE.md Section 9.4 Telemetry Strategy](../../docs/ARCHITECTURE.md#94-telemetry-strategy) for structured logging patterns and trace correlation.

## Log Levels

| Level | Usage |
|-------|-------|
| DEBUG | Detailed diagnostics (dev only) |
| INFO | Significant events (startup, key created/rotated) |
| WARN | Degraded mode, recoverable errors |
| ERROR | Unrecoverable errors, request failures |
| FATAL | Unrecoverable startup errors, process termination |

See [ARCHITECTURE.md Section 9.4 Telemetry Strategy](../../docs/ARCHITECTURE.md#94-telemetry-strategy) for log level definitions and usage patterns.

## Prometheus Metrics

**HTTP**: `http_requests_total`, `http_request_duration_seconds`, `http_requests_in_flight`
**Database**: `db_connections_open`, `db_query_duration_seconds`, `db_errors_total`
**Crypto**: `crypto_operations_total`, `crypto_operation_duration_seconds`
**Keys**: `keys_total`, `key_rotations_total`, `key_usage_total`

See [ARCHITECTURE.md Section 9.4 Telemetry Strategy](../../docs/ARCHITECTURE.md#94-telemetry-strategy) for Prometheus metrics naming and exposition.

## Sensitive Data - MANDATORY

**NEVER log**: Passwords, API keys, tokens, private keys, PII, session IDs.
**Safe to log**: Key IDs, user IDs, resource IDs, operation types, durations, counts, errors.

See [ARCHITECTURE.md Section 6.3 Product Security Strategy](../../docs/ARCHITECTURE.md#63-product-security-strategy) for sensitive data handling and audit logging requirements.

## Sampling Strategy

Configurable (default: probabilistic 10% sampling rate). Pattern: `sampling_rate: 0.1`

See [ARCHITECTURE.md Section 9.4 Telemetry Strategy](../../docs/ARCHITECTURE.md#94-telemetry-strategy) for sampling strategies and trace configuration.

## OTel Collector Processor Constraints

| Processor | Requirement | Dev/CI | Production |
|-----------|------------|--------|------------|
| resourcedetection/docker | Docker socket `/var/run/docker.sock` | NEVER use | Use when socket available |
| resourcedetection/env | Environment variables | ALWAYS | ALWAYS |
| resourcedetection/system | OS hostname, IP | ALWAYS | ALWAYS |

**MANDATORY for dev/CI**: Use `detectors: [env, system]`. NEVER include `docker` detector without verified socket access.

**CRITICAL**: NEVER defer OTel or infrastructure configuration issues as "pre-existing." Infrastructure blockers are ALWAYS MANDATORY BLOCKING.

See [ARCHITECTURE.md Section 9.4.1 OTel Collector Processor Constraints](../../docs/ARCHITECTURE.md#941-otel-collector-processor-constraints) for processor requirements and anti-patterns.

## Docker Desktop and Testcontainers Compatibility

Docker Desktop upgrades MAY introduce API version mismatches with testcontainers-go. Symptoms: socket errors, container startup failures, E2E test flakes.

**MANDATORY**: After ANY Docker Desktop upgrade, run the full E2E test suite. If failures appear, check the Docker API version compatibility with the testcontainers-go version in `go.mod`.

See [ARCHITECTURE.md Section 9.4.2 Docker Desktop and Testcontainers API Compatibility](../../docs/ARCHITECTURE.md#942-docker-desktop-and-testcontainers-api-compatibility) for diagnosis checklist and resolution guidance.
