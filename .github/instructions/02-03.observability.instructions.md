---
description: "Observability and monitoring"
applyTo: "**"
---
# Observability

## Telemetry Flow - MANDATORY

`cryptoutil -> otel-collector (sidecar, OTLP gRPC:4317 or HTTP:4318) -> grafana-otel-lgtm (OTLP gRPC:14317 or HTTP:14318)`

**ALWAYS forward through sidecar** (NEVER bypass to grafana directly).

## Configuration

```yaml
observability:
  otlp:
    protocol: grpc             # grpc (default) or http
    endpoint: opentelemetry-collector:4317
    service_name: cryptoutil-kms
    insecure: true             # dev only, false for prod
```

## Structured Logging - MANDATORY

Key-value pairs, JSON format, trace correlation. Standard fields: `timestamp`, `level`, `message`, `trace_id`, `span_id`, `service.name`.

```go
logger.Info("Key created", zap.String("key_id", keyID), zap.String("algorithm", "RSA-2048"), zap.Duration("duration", elapsed))
```

## Log Levels

| Level | Usage |
|-------|-------|
| DEBUG | Detailed diagnostics (dev only) |
| INFO | Significant events (startup, key created/rotated) |
| WARN | Degraded mode, recoverable errors |
| ERROR | Unrecoverable errors, request failures |
| FATAL | Unrecoverable startup errors, process termination |

## Prometheus Metrics

**HTTP**: `http_requests_total`, `http_request_duration_seconds`, `http_requests_in_flight`
**Database**: `db_connections_open`, `db_query_duration_seconds`, `db_errors_total`
**Crypto**: `crypto_operations_total`, `crypto_operation_duration_seconds`
**Keys**: `keys_total`, `key_rotations_total`, `key_usage_total`

## Sensitive Data - MANDATORY

**NEVER log**: Passwords, API keys, tokens, private keys, PII, session IDs.
**Safe to log**: Key IDs, user IDs, resource IDs, operation types, durations, counts, errors.

## Sampling Strategy

Configurable (default: probabilistic 10% sampling rate). Pattern: `sampling_rate: 0.1`
