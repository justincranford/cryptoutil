---
description: "Instructions for OpenAPI"
applyTo: "**"
---
# Openapi

# OpenAPI and Code Generation - Tactical Guidance

## Quick Reference

**Version**: OpenAPI 3.0.3 | **Structure**: components.yaml + paths.yaml | **Gen**: oapi-codegen strict-server | **Content**: application/json only

## Key Patterns

**Strict Server Pattern**:

```yaml
# openapi-gen_config_server.yaml
generate:
  strict-server: true  # Type safety + validation
```

**Error Schema** (consistent format):

```json
{
  "code": "ERR_INVALID_REQUEST",
  "message": "Validation failed",
  "details": {...},
  "requestId": "uuid"
}
```

**Pagination Support**:

```yaml
parameters:
  - name: page
    in: query
    schema: {type: integer, default: 1}
  - name: size
    in: query
    schema: {type: integer, default: 20}
```

## Version - MANDATORY

**ALWAYS use OpenAPI 3.0.3** (NOT 2.0/Swagger, NOT 3.1.x) - Mature ecosystem, oapi-codegen support, stable spec

---

## File Organization Pattern

**Split specifications**:

- `openapi_spec_components.yaml` - Reusable components (schemas, responses, parameters, etc.)
- `openapi_spec_paths.yaml` - API endpoints and operations

**Benefits**: Easier reviews, smaller diffs, reduces git conflicts, enables reuse, better IDE performance

```yaml
openapi: 3.0.3
info:
  title: Cryptoutil API
  version: 1.0.0
servers:
  - url: https://localhost:8080/service/api/v1
components:
  $ref: './openapi_spec_components.yaml#/components'
paths:
  $ref: './openapi_spec_paths.yaml#/paths'
```

---

## Code Generation with oapi-codegen

**Tool**: <https://github.com/deepmap/oapi-codegen> - Generates Go code from OpenAPI 3.0 specs

**Three Config Files**:

1. **Server** (`openapi-gen_config_server.yaml`): `strict-server: true`, `models: false`, output `api/server/server.gen.go`
2. **Model** (`openapi-gen_config_model.yaml`): `models: true`, output `api/model/models.gen.go`
3. **Client** (`openapi-gen_config_client.yaml`): `client: true`, `models: false`, output `api/client/client.gen.go`

**Benefits**: Single source of truth for models, prevents drift, clear separation

---

## Strict Server Pattern - MANDATORY

**ALWAYS use `strict-server: true`**: Type safety, request validation before handler, separation of concerns, consistent error responses

```go
type StrictServerInterface interface {
    CreateKey(ctx context.Context, request CreateKeyRequest) (CreateKeyResponse, error)
}

func (h *Handler) CreateKey(ctx context.Context, request CreateKeyRequest) (CreateKeyResponse, error) {
    // Request already validated - business logic only
    key, err := h.keyService.Create(ctx, request)
    if err != nil {
        return CreateKey500Response{}, err
    }
    return CreateKey200Response{Key: key}, nil
}
```

---

## Validation Rules - MANDATORY

**String**: `format: uuid`, `enum: [...]`, `minLength/maxLength`, `pattern: '^[a-zA-Z0-9_-]+$'`
**Number**: `minimum/maximum`, `multipleOf`
**Array**: `minItems/maxItems`, `uniqueItems: true`, `items: {...}`
**Object**: `required: [...]`, nested `properties`

---

## HTTP Status Codes - MANDATORY

| Code | Usage |
|------|-------|
| **200 OK** | GET, PUT, PATCH successful |
| **201 Created** | POST successful (resource created) |
| **204 No Content** | DELETE successful, PATCH successful (no content) |
| **400 Bad Request** | Validation error, malformed request |
| **401 Unauthorized** | Missing/invalid authentication |
| **403 Forbidden** | Valid auth but insufficient permissions |
| **404 Not Found** | Resource does not exist |
| **409 Conflict** | Duplicate resource, optimistic lock failure |
| **422 Unprocessable Entity** | Semantic validation error |
| **500 Internal Server Error** | Unhandled server error |
| **503 Service Unavailable** | Temporary unavailability |

---

## REST Conventions - MANDATORY

**Resource Naming**: Plural nouns (`/keys`, `/certificates`), singular for singletons (`/config`, `/health`), kebab-case (`/api-keys`)

**HTTP Method Semantics**:

- `GET /keys` - List (with pagination)
- `POST /keys` - Create
- `GET /keys/{id}` - Get
- `PUT /keys/{id}` - Replace (full update)
- `PATCH /keys/{id}` - Update (partial)
- `DELETE /keys/{id}` - Delete

**Idempotency**: GET, PUT, DELETE are idempotent; POST is NOT

**Content Type**: ALWAYS `application/json` (NEVER `text/plain`, `application/xml`)

---

## Error Schemas - MANDATORY

**Consistent format**:

```yaml
Error:
  type: object
  required: [code, message]
  properties:
    code: {type: string, example: INVALID_KEY_SIZE}
    message: {type: string, example: "Key size must be 2048, 3072, or 4096 bits"}
    details: {type: object, additionalProperties: true}
    requestId: {type: string, format: uuid}
```

---

## Pagination - MANDATORY

**All list endpoints MUST support pagination**:

**Query Parameters**: `page` (default: 1, minimum: 1), `size` (default: 50, min: 1, max: 1000)

**Response Schema**:

```yaml
KeyListResponse:
  type: object
  required: [items, pagination]
  properties:
    items: {type: array, items: {$ref: '#/components/schemas/Key'}}
    pagination:
      type: object
      required: [page, size, total]
      properties:
        page: {type: integer, minimum: 1}
        size: {type: integer, minimum: 1}
        total: {type: integer, minimum: 0, description: "Total items across all pages"}
```

---

## Cross-References

Service template: [02-02.service-template.instructions.md](.github/instructions/02-02.service-template.instructions.md), HTTPS ports: [02-03.https-ports.instructions.md](.github/instructions/02-03.https-ports.instructions.md), Testing: [03-02.testing.instructions.md](.github/instructions/03-02.testing.instructions.md)
Tools: <https://github.com/deepmap/oapi-codegen>, <https://spec.openapis.org/oas/v3.0.3>, <https://editor.swagger.io/>
