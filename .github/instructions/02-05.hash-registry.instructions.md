---
description: "Hash registry pepper and salt requirements for all 4 registries"
applyTo: "**"
---
# Hash Registry Pepper and Salt Requirements - MANDATORY

## Pepper Requirements (ALL 4 Registries)

**MANDATORY: All 4 hash registries MUST use pepper for additional security layer**

**Pepper Storage** (NEVER store pepper in DB or source code):

- VALID OPTIONS IN ORDER OF PREFERENCE: 1. Docker Secret, 2. Configuration file, 3. Environment variable
- MUST be mutually exclusive from hashed values storage (pepper in secrets/config, hashes in DB)
- MUST be associated with hash version (different pepper per version)

**Pepper Rotation**:

- Pepper CANNOT be rotated silently (requires re-hash all records)
- Changing pepper REQUIRES version bump, even if no other hash parameters changed
- Example: v1 pepper compromised â†’ bump to v2 with new pepper, re-hash all v1 records

**Additional Protections for LowEntropyDeterministicHashRegistry** (deterministic PII hashing):

- MANDATORY (prevents deterministic hashing oracle attacks):
  - Query rate limits (prevent brute-force enumeration)
  - Abuse detection (detect suspicious query patterns)
  - Audit logs (track all hash queries for forensics)
  - Strict access control (limit who can query hashes)
- RECOMMENDED: Apply same protections to all 4 registries for consistency

## Hash Registry Implementations

**LowEntropyDeterministicHashRegistry** (PII Lookup):

```go
hash = PBKDF2(input || pepper, fixedSalt, HIGH_iterations, 256)
// Format: {version}:base64(hash)
// Rationale: Deterministic for PII lookup, pepper prevents rainbow tables, high iteration cost mitigates brute force
```

**HighEntropyDeterministicHashRegistry** (Config Blob Hash):

```go
PRK = HKDF-Extract(fixedSalt, input || pepper)
hash = HKDF-Expand(PRK, "config-blob-hash", 256)
// Format: {version}:base64(hash)
// Rationale: High-entropy inputs, HKDF faster than PBKDF2, pepper provides domain separation
```

**LowEntropyRandomHashRegistry** (Password Hashing):

```go
hash = PBKDF2(password || pepper, randomSalt, OWASP_MIN_iterations, 256)
// Format: {version}:{algorithm}:{iterations}:base64(randomSalt):base64(hash)
// Rationale: Random salt prevents rainbow tables, pepper adds secret key layer, OWASP iterations
```

**HighEntropyRandomHashRegistry** (API Key Hashing):

```go
PRK = HKDF-Extract(randomSalt, apiKey || pepper)
hash = HKDF-Expand(PRK, "api-key-hash", 256)
// Format: {version}:{algorithm}:base64(randomSalt):base64(hash)
// Rationale: High-entropy inputs, HKDF faster than PBKDF2, random salt + pepper for defense in depth
```

## Cross-References

- FIPS compliance: See `02-05.cryptography.instructions.md`
- Password hashing patterns: See `02-05.cryptography.instructions.md`
- Hash versioning: See `02-05.cryptography.instructions.md`
