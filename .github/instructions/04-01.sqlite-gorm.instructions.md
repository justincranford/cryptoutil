---
description: "Instructions for SQLite configuration with GORM, transaction patterns, and concurrent operations"
applyTo: "**"
---
# SQLite Configuration for GORM

## Critical Architecture

- GORM explicit transactions require multiple connections (MaxOpenConns=1 causes deadlock)
- Use `sql.Open("sqlite", dsn)` + `sqlite.Dialector{Conn: sqlDB}` (NOT `sqlite.Open(dsn)` - requires CGO)

## Required Configuration

```go
// 1. Open with modernc driver (CGO-free)
sqlDB, _ := sql.Open("sqlite", dsn)
sqlDB.Exec("PRAGMA journal_mode=WAL;")
sqlDB.Exec("PRAGMA busy_timeout = 30000;")

// 2. Pass to GORM with auto-transactions disabled
dialector := sqlite.Dialector{Conn: sqlDB}
db, _ := gorm.Open(dialector, &gorm.Config{SkipDefaultTransaction: true})

// 3. Configure connection pool for GORM transactions
sqlDB, _ = db.DB()
sqlDB.SetMaxOpenConns(5)  // Allows tx + operations concurrently
sqlDB.SetMaxIdleConns(5)
sqlDB.SetConnMaxLifetime(0)  // In-memory: never close
```

## In-Memory Shared Cache

```go
// Convert :memory: to shared cache (all connections share same DB)
if dsn == ":memory:" { dsn = "file::memory:?cache=shared" }
```

## Transaction Context Pattern

```go
// Store tx in context so repositories auto-use it
func getDB(ctx context.Context, baseDB *gorm.DB) *gorm.DB {
    if tx, ok := ctx.Value(txKey).(*gorm.DB); ok { return tx }
    return baseDB
}
// Repositories: return getDB(ctx, r.db).WithContext(ctx).Create(user).Error
```

## Comparison: KMS (database/sql) vs Identity (GORM)

| Aspect | KMS Server | Identity Server |
|--------|------------|-----------------|
| ORM | No (database/sql) | Yes (GORM) |
| MaxOpenConns | 1 | 5 |
| Reason | Single operation/connection | Transaction wraps operations |

## Troubleshooting

- "go-sqlite3 requires cgo": Use `sql.Open("sqlite")` not `sqlite.Open()`
- Tests hang: MaxOpenConns=1 + GORM tx = deadlock. Set MaxOpenConns=5
- "database is locked": Repositories must use `getDB(ctx, r.db)` pattern
- **"SQLite doesn't support read-only transactions"**: SQLite does NOT support `sql.TxOptions{ReadOnly: true}`. Use standard transactions or direct queries for read operations. See 01-04.database.instructions.md for details.
