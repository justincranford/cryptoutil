---
description: "Hash registry pepper/salt requirements, password hashing patterns, and hash service architecture"
applyTo: "**"
---
# Hash Registry and Password Hashing Instructions - MANDATORY

**Reference**: See `.specify/memory/hashes.md` for complete specifications (version-based policies, 4 registry implementations, pepper/salt requirements)

**This file contains ONLY tactical implementation patterns**

## Quick Reference: Registry Selection

- **PBKDF2**: Low-entropy inputs (<128 bits) - PII, passwords
- **HKDF**: High-entropy inputs (â‰¥128 bits) - API keys, config blobs

## Pepper Requirements - MANDATORY

All inputs must be peppered before input into hash functions. See `https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#peppering` for details.

## Hash Service Architecture - MANDATORY

### Version-Based Policy Framework

**Versions are tuple of 5 things: Four Registries based on NIST || OWASP Policy Revisions, and a Unique Pepper**: Each version represents a specific security policy snapshot.

**Supported Versions**:

- **v1**: 2020 NIST guidelines
- **v2**: 2023 NIST guidelines
- **v3**: 2025 OWASP recommendations

**Supports Registries**:

- LowEntropyDeterministicHashRegistry
- LowEntropyRandomHashRegistry
- HighEntropyDeterministicHashRegistry
- HighEntropyRandomHashRegistry

**New Version Requirements**:

If a new policy is published by NIST || OWASP, the version must be incremented to differentiate it from previous versions.

If a new pepper is needed (e.g. 1 year rotation policy, old pepper compromised), the version must be incremented to differentiate it from previous pepper, even if NIST || OWASP policy remains unchanged.

### Hash Output Format - MANDATORY

```
{version}:{algorithm}:{iterations}:base64(randomSalt):base64(hash)
```

**Examples**:

```
{1}:PBKDF2-HMAC-SHA256:rounds=600000:abcd1234...
{2}:PBKDF2-HMAC-SHA384:rounds=600000:efgh5678...
{3}:HKDF-SHA512:info=api-key,salt=xyz:ijkl9012...
```

### Version Update Pattern

**Trigger**: Manual operator decision (update config, restart service)

```yaml
# config.yaml
hash_service:
  password_registry:
    current_version: 4  # New passwords use v4
    # Old v3, v2, v1 passwords still verified correctly; rehashed with v4 and updated in DB
```

**Migration Strategy**:

- Old hashes stay on original version (v1, v2, etc.)
- New hashes use current_version
- Gradual migration (no forced re-hash); rehash next time the cleartext value is presented (e.g. username/password authentication)
- Version prefix enables correct verification

### Backward Compatibility - MANDATORY

**Reject Unprefixed Hashes**: Force re-hash on next authentication

## Salt & Pepper Requirements

**Salt**: ALWAYS public (OK to encode in hash output)
**Pepper**: ALWAYS secret (Docker/K8s secrets, config file, env var | NEVER in DB/source)
**Pepper Storage**: MUST be separate from hashes | MUST be version-specific
**Pepper Rotation**: Lazy migration (version bump + re-hash on next authentication, NEVER bulk re-hash)

## Registry Implementations

**LowEntropyDeterministic** (PII): `PBKDF2(input||pepper, fixedSalt, HIGH_iter, 256)`
**LowEntropyRandom** (Passwords): `PBKDF2(password||pepper, randomSalt, OWASP_iter, 256)`
**HighEntropyDeterministic** (Configs): `HKDF-Extract+Expand(input||pepper, fixedSalt, info, 256)`
**HighEntropyRandom** (API Keys): `HKDF-Extract+Expand(key||pepper, randomSalt, info, 256)`
