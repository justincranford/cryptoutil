# $schema: https://json.schemastore.org/github-action.json
# Doc: https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions

name: 'security-scan-trivy'
description: 'Comprehensive security scanning using Trivy for repositories, containers, and dependencies'

inputs:
  scan-name:
    description: 'Name for the security scan (used in SARIF metadata and reporting)'
    required: true
  scan-type:
    description: 'Trivy scan type: fs (filesystem), image (container), repo (repository), config (config files)'
    required: true
  scan-ref:
    description: 'Reference to scan (path, image name, etc.)'
    required: false
  trivy-sarif-output:
    description: 'Output filename for Trivy SARIF results'
    required: true
  severity:
    description: 'Minimum severity level to report (CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN)'
    required: true
  format:
    description: 'Output format (sarif, json, table, etc.)'
    required: false
    default: 'sarif'
  scan-files:
    description: 'Optional space-separated list of specific files to scan (overrides scan-ref when provided)'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Install Trivy
      shell: bash
      run: |
        echo "ðŸ”§ Installing Trivy..."

        # Check if trivy is already installed
        if command -v trivy &> /dev/null; then
          echo "âœ… Trivy is already installed"
          trivy version
        else
          echo "ðŸ“¦ Installing Trivy using official installation script..."

          # Install Trivy using the official installation script (with verbose output)
          if curl -fL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin; then
            echo "âœ… Trivy installation completed"
          else
            echo "âŒ Trivy installation failed, trying alternative method..."
            # Alternative: download binary directly
            TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
            echo "ðŸ“¦ Downloading Trivy ${TRIVY_VERSION}..."
            curl -L -o trivy.tar.gz "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VERSION}/trivy_${TRIVY_VERSION#v}_Linux-64bit.tar.gz"
            tar -xzf trivy.tar.gz
            sudo mv trivy /usr/local/bin/
            rm trivy.tar.gz
          fi

          # Verify installation and add to PATH if needed
          if command -v trivy &> /dev/null; then
            echo "âœ… Trivy installed successfully"
            trivy version
            export PATH="/usr/local/bin:$PATH"
            echo "ðŸ“‹ PATH updated: $PATH"
          else
            echo "âŒ Trivy installation failed"
            echo "ðŸ“‹ Current PATH: $PATH"
            ls -la /usr/local/bin/trivy || echo "Trivy binary not found in /usr/local/bin"
            exit 1
          fi
        fi

        echo "âœ… Trivy installation completed"

    - name: Run Trivy comprehensive security scan
      shell: bash
      env:
        PATH: /usr/local/bin:$PATH
      run: |
        echo "ðŸ” Running Trivy ${{ inputs.scan-type }} security scan..."
        echo "ðŸ“‹ Scan Type: ${{ inputs.scan-type }}"
        echo "ðŸ“‹ Output: ${{ inputs.trivy-sarif-output }}"
        echo "ðŸ“‹ Severity: ${{ inputs.severity }}"

        # Validate that either scan-ref or scan-files is provided
        if [ -z "${{ inputs.scan-files }}" ] && [ -z "${{ inputs.scan-ref }}" ]; then
          echo "âŒ Error: Either scan-files or scan-ref must be provided"
          exit 1
        fi

        # Run Trivy scan with specified parameters
        if [ -n "${{ inputs.scan-files }}" ]; then
          echo "ðŸ“‹ Using specific files: ${{ inputs.scan-files }}"
          trivy ${{ inputs.scan-type }} \
            --format ${{ inputs.format }} \
            --output ${{ inputs.trivy-sarif-output }} \
            --severity ${{ inputs.severity }} \
            ${{ inputs.scan-files }}
        else
          echo "ðŸ“‹ Using scan reference: ${{ inputs.scan-ref }}"
          trivy ${{ inputs.scan-type }} \
            --format ${{ inputs.format }} \
            --output ${{ inputs.trivy-sarif-output }} \
            --severity ${{ inputs.severity }} \
            ${{ inputs.scan-ref }}
        fi

        echo "âœ… Trivy scan completed"

    - name: Upload Trivy results to GitHub Security tab
      # https://github.com/github/codeql-action/releases (v3.28.19, 2025-11-06)
      uses: github/codeql-action/upload-sarif@v3.28.19
      with:
        sarif_file: ${{ inputs.trivy-sarif-output }}
        category: "${{ inputs.scan-name }}-trivy"
      if: always() && hashFiles('${{ inputs.trivy-sarif-output }}') != ''

    - name: Security scan summary
      shell: bash
      run: |
        echo "## ðŸ”’ ${{ inputs.scan-name }} Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scan Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Type**: ${{ inputs.scan-type }}" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.scan-files }}" ]; then
          echo "- **Files**: \`${{ inputs.scan-files }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Reference**: \`${{ inputs.scan-ref }}\`" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Severity**: ${{ inputs.severity }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Format**: ${{ inputs.format }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check if SARIF file was generated and has content
        if [ -f "${{ inputs.trivy-sarif-output }}" ]; then
          RESULT_COUNT=$(jq '.runs[0].results | length' ${{ inputs.trivy-sarif-output }} 2>/dev/null || echo "0")
          echo "### Trivy Results" >> $GITHUB_STEP_SUMMARY
          echo "- SARIF file: \`${{ inputs.trivy-sarif-output }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Findings: $RESULT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
        else
          echo "### Trivy Results" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âŒ No SARIF file generated" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: Results are available in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning) for detailed analysis." >> $GITHUB_STEP_SUMMARY
