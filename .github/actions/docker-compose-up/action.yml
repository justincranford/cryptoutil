# $schema: https://json.schemastore.org/github-action.json
# Doc: https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions

name: 'docker-compose-up'
description: 'Start Docker Compose services and wait for health checks'
inputs:
  compose-file:
    description: 'Path to the docker-compose file'
    required: false
    default: './deployments/cryptoutil-suite/compose.yml'
  profiles:
    description: 'Comma-separated list of Docker Compose profiles to activate (e.g., "postgres")'
    required: false
    default: ''
runs:
  using: 'composite'
  steps:
    - name: Start Docker Compose services
      shell: bash
      run: |
        echo "ðŸš€ Starting Docker Compose services..."
        START_TIME=$(date +%s)
        echo "ðŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

        # Build docker compose command with optional profiles
        COMPOSE_CMD="docker compose -f ${{ inputs.compose-file }}"
        if [ -n "${{ inputs.profiles }}" ]; then
          echo "ðŸŽ¯ Activating profiles: ${{ inputs.profiles }}"
          # Split comma-separated profiles and add --profile flag for each
          IFS=',' read -ra PROFILE_ARRAY <<< "${{ inputs.profiles }}"
          for profile in "${PROFILE_ARRAY[@]}"; do
            COMPOSE_CMD="$COMPOSE_CMD --profile $(echo $profile | xargs)"
          done
        fi

        # Start services
        $COMPOSE_CMD up -d

        echo "â³ Waiting for services to be healthy..."
        timeout 120s bash -c "until $COMPOSE_CMD ps | grep -q 'healthy'; do echo 'Waiting for healthy services...'; sleep 5; done"

        echo "ðŸ“‹ Service status:"
        $COMPOSE_CMD ps
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ðŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Docker Compose services startup completed in: ${DURATION}s"
