# $schema: https://json.schemastore.org/github-action.json
# Doc: https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions

name: 'custom-cicd-lint'
description: 'Build cicd binary and run custom linting and validation checks'
runs:
  using: 'composite'
  steps:
    - name: Build cicd binary for quality checks
      shell: bash
      run: |
        echo "ğŸ”¨ Building cicd binary..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        go build -o cicd ./cmd/cicd
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ cicd binary built in: ${DURATION}s"

    - name: Enforce file encoding (UTF-8 without BOM)
      shell: bash
      run: |
        echo "ğŸ”¤ Enforcing UTF-8 file encoding..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd lint-text
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ UTF-8 enforcement completed in: ${DURATION}s"

    - name: Check for circular Go package dependencies
      shell: bash
      run: |
        echo "ğŸ”„ Checking for circular Go package dependencies..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd lint-go
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Circular dependency check completed in: ${DURATION}s"

    - name: Run Go code formatters (interface{} to any, copyloopvar)
      shell: bash
      run: |
        echo "ğŸ”§ Running Go code formatters..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd format-go
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Go code formatters completed in: ${DURATION}s"

    - name: Enforce Go test patterns
      shell: bash
      run: |
        echo "ğŸ§ª Enforcing Go test patterns..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd lint-go-test
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Test pattern enforcement completed in: ${DURATION}s"

    - name: Run Go test file formatters (t.Helper)
      shell: bash
      run: |
        echo "ğŸ”§ Running Go test file formatters..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd format-go-test
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Go test formatters completed in: ${DURATION}s"

    - name: Check GitHub Actions versions
      shell: bash
      run: |
        echo "ğŸ”„ Checking GitHub Actions versions..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd lint-workflow
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ GitHub Actions version check completed in: ${DURATION}s"

    - name: Check Go direct dependencies
      shell: bash
      run: |
        echo "ğŸ“¦ Checking Go direct dependencies..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd lint-go-mod
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Direct dependencies check completed in: ${DURATION}s"

    - name: Check port assignments (informational)
      shell: bash
      continue-on-error: true  # Informational until all violations fixed
      run: |
        echo "ğŸ”Œ Checking port assignments..."
        START_TIME=$(date +%s)
        echo "ğŸ“… Start: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        ./cicd lint-ports || echo "âš ï¸ Port violations found (informational - does not fail build)"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ğŸ“… End: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸ Port assignment check completed in: ${DURATION}s"
