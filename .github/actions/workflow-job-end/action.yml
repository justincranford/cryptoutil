# $schema: https://json.schemastore.org/github-action.json
# Doc: https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions
# Doc: https://docs.github.com/en/actions/reference/workflows-and-actions/variables

# NOTE: This action depends on workflow-job-begin being run first.

name: 'workflow-job-end'
description: 'Add a standardized summary to GitHub Actions workflow runs'

# No inputs required - uses built-in GITHUB_WORKFLOW and GITHUB_JOB environment variables

runs:
  using: 'composite'
  steps:
    # Use GitHub Actions' environment variable persistence mechanism ($GITHUB_ENV) to pass variables to workflow-job-end action
    - name: Set workflow job end environment variables
      shell: bash
      run: |
        if [ "$WORKFLOW_JOB_START_TIME" == "" ]; then
          echo "::error::WORKFLOW_JOB_START_TIME is not set. Ensure that workflow-job-begin action is used before this action."
          exit 1
        fi

        WORKFLOW_JOB_END_TIME=$(date +%s)
        WORKFLOW_JOB_DURATION=$((WORKFLOW_JOB_END_TIME - WORKFLOW_JOB_START_TIME))

        echo "WORKFLOW_JOB_END_TIME=$WORKFLOW_JOB_END_TIME" >> $GITHUB_ENV
        echo "WORKFLOW_JOB_DURATION=$WORKFLOW_JOB_DURATION" >> $GITHUB_ENV

        # Format duration more robustly (handles seconds-only durations better)
        MINUTES=$((WORKFLOW_JOB_DURATION / 60))
        SECONDS=$((WORKFLOW_JOB_DURATION % 60))
        if [ $MINUTES -gt 0 ]; then
          FORMATTED_WORKFLOW_JOB_DURATION="${MINUTES}m ${SECONDS}s"
        else
          FORMATTED_WORKFLOW_JOB_DURATION="${SECONDS}s"
        fi
        echo "FORMATTED_WORKFLOW_JOB_DURATION=$FORMATTED_WORKFLOW_JOB_DURATION" >> $GITHUB_ENV

    - name: Workflow job end summary
      shell: bash
      run: |
        echo "=========================================="
        echo "Workflow: $GITHUB_WORKFLOW"
        echo "Workflow Ref: $GITHUB_WORKFLOW_REF"
        echo "Job: $GITHUB_JOB"
        echo "Run URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "Actor: $GITHUB_ACTOR"
        echo "Branch/Tag: $GITHUB_REF"
        echo "Commit: $GITHUB_SHA"
        echo "Run ID: $GITHUB_RUN_ID"
        echo "Runner: $RUNNER_OS ($RUNNER_ENVIRONMENT)"
        echo "Triggered by: ${{ github.event_name }}"
        echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC' -d "@$WORKFLOW_JOB_START_TIME")"
        echo "End Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC' -d "@$WORKFLOW_JOB_END_TIME")"
        echo "Duration: $FORMATTED_WORKFLOW_JOB_DURATION"
        echo "=========================================="

        echo "## $GITHUB_JOB Results" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… Duration: $FORMATTED_WORKFLOW_JOB_DURATION" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸ“Š Status: âœ… Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“Š Status: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "- Check the job logs above for detailed error messages" >> $GITHUB_STEP_SUMMARY
          echo "- Review the workflow run at: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_STEP_SUMMARY
        fi
