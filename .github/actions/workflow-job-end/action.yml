# $schema: https://json.schemastore.org/github-action.json
# Doc: https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions

# NOTE: This action depends on workflow-job-begin being run first.
# It expects WORKFLOW_JOB_START_TIME and WORKFLOW_JOB_FILE_NAME environment variables to be set.
# Changes to environment variables or naming conventions must be synchronized between both actions.

name: 'workflow-job-end'
description: 'Add a standardized summary to GitHub Actions workflow runs'

inputs:
  workflow-name:
    description: 'Name of the workflow (e.g., "CI - Quality Testing")'
    required: true
  job-name:
    description: 'Name of the job (e.g., "code-quality", "build")'
    required: true

runs:
  using: 'composite'
  steps:
    # Use GitHub Actions' environment variable persistence mechanism ($GITHUB_ENV) to pass variables to workflow-job-end action
    - name: Set workflow job end environment variables
      shell: bash
      run: |
        if [ "$WORKFLOW_JOB_START_TIME" == "" ]; then
          echo "::error::WORKFLOW_JOB_START_TIME is not set. Ensure that workflow-job-begin action is used before this action."
          exit 1
        elif [ "$WORKFLOW_JOB_FILE_NAME" == "" ]; then
          echo "::error::WORKFLOW_JOB_FILE_NAME is not set. Ensure that workflow-job-begin action is used before this action."
          exit 1
        fi

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - WORKFLOW_JOB_START_TIME))

        # Format duration more robustly (handles seconds-only durations better)
        MINUTES=$((DURATION / 60))
        SECONDS=$((DURATION % 60))
        if [ $MINUTES -gt 0 ]; then
          FORMATTED_DURATION="${MINUTES}m ${SECONDS}s"
        else
          FORMATTED_DURATION="${SECONDS}s"
        fi

        echo "END_TIME=$END_TIME" >> $GITHUB_ENV
        echo "DURATION=$DURATION" >> $GITHUB_ENV
        echo "FORMATTED_DURATION=$FORMATTED_DURATION" >> $GITHUB_ENV

    - name: Workflow job end summary
      shell: bash
      run: |
        echo "=========================================="
        echo "${{ inputs.workflow-name }} ($WORKFLOW_JOB_FILE_NAME)"
        echo "Job: ${{ inputs.job-name }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo "Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC' -d "@$WORKFLOW_JOB_START_TIME")"
        echo "End Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC' -d "@$END_TIME")"
        echo "Duration: $FORMATTED_DURATION"
        echo "=========================================="

        echo "## ${{ inputs.job-name }} Results" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… Duration: $FORMATTED_DURATION" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸ“Š Status: âœ… Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“Š Status: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "- Check the job logs above for detailed error messages" >> $GITHUB_STEP_SUMMARY
          echo "- Review the workflow run at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        fi
