# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
#
# CRYPTOUTIL SUITE Deployment (SUITE-Level)
#
# Purpose: Complete suite deployment with ALL 9 services across 5 products.
# Deployment Level: SUITE (port range 28000-28999, SERVICE base + 20000 offset)
# Each service has 3 instances (1 SQLite + 2 PostgreSQL).
#
# Services (9 total):
#   1. pki-ca (PKI Certificate Authority) - 28100-28102
#   2. jose-ja (JOSE JWK Authority) - 28800-28802
#   3. cipher-im (Cipher Instant Messenger) - 28700-28702
#   4. sm-kms (Secret Manager Key Management Service) - 28000-28002
#   5. identity-authz (Identity Authorization Server) - 28200-28202
#   6. identity-idp (Identity Provider) - 28300-28302
#   7. identity-rs (Resource Server) - 28400-28402
#   8. identity-rp (Relying Party) - 28500-28502
#   9. identity-spa (Single Page App) - 28600-28602
#
# Port allocation (SUITE-level, base + 20000 offset):
#   - sm-kms:         28000 (SQLite), 28001-28002 (PostgreSQL)
#   - pki-ca:         28100 (SQLite), 28101-28102 (PostgreSQL)
#   - identity-authz: 28200 (SQLite), 28201-28202 (PostgreSQL)
#   - identity-idp:   28300 (SQLite), 28301-28302 (PostgreSQL)
#   - identity-rs:    28400 (SQLite), 28401-28402 (PostgreSQL)
#   - identity-rp:    28500 (SQLite), 28501-28502 (PostgreSQL)
#   - identity-spa:   28600 (SQLite), 28601-28602 (PostgreSQL)
#   - cipher-im:      28700 (SQLite), 28701-28702 (PostgreSQL)
#   - jose-ja:        28800 (SQLite), 28801-28802 (PostgreSQL)
#
# Database ports (PostgreSQL leader/follower):
#   - postgres-leader:      5432
#   - postgres-follower:    5433
#   - citus-coordinator:    5434
#   - citus-worker-1:       5435
#   - citus-worker-2:       5436
#
# Usage:
#   docker compose -f compose-cryptoutil.yml up -d                        # SQLite instances only (default: dev profile)
#   docker compose -f compose-cryptoutil.yml --profile postgres up -d     # All instances (SQLite + 2x PostgreSQL per service)
#   docker compose -f compose-cryptoutil.yml --profile demo up -d         # Demo mode with seed data
#   docker compose -f compose-cryptoutil.yml --profile ci up -d           # CI mode for testing
#   docker compose -f compose-cryptoutil.yml logs -f                      # View logs
#   docker compose -f compose-cryptoutil.yml down -v                      # Stop and clean up
#
# Health Checks:
#   - Public health endpoints: https://localhost:28XXX/browser/api/v1/health (external clients, XX = service)
#   - Admin livez endpoints: https://127.0.0.1:9090/admin/api/v1/livez (internal container only, NEVER exposed)
#
# Profiles:
#   - dev: Development mode (default) - SQLite backend, minimal services
#   - demo: Demo mode with seeded data, SQLite backend
#   - ci: CI mode for testing, SQLite backend
#   - postgres: PostgreSQL backend with multiple instances (2x app per service + shared infrastructure)
#
include:
  - path: ../shared-telemetry/compose.yml
  - path: ../shared-postgres/compose.yml

services:
  # Healthcheck for Docker secrets availability.
  # Ephemeral job that validates all secrets are mounted before any service starts.
  healthcheck-secrets:
    image: alpine:latest
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - hash-pepper_v3.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    command: ["sh", "-c", "ls -l /run/secrets/*.secret"]
    networks:
      - cryptoutil-network

  # Build cryptoutil image from source (shared by all services).
  # Ephemeral job that builds Docker image once, reused by all service instances.
  builder-cryptoutil:
    image: cryptoutil:dev
    build:
      context: ../..
      dockerfile: deployments/cryptoutil-suite/Dockerfile
      args:
        APP_VERSION: "dev"
        VCS_REF: "local"
        BUILD_DATE: "2026-02-14T00:00:00Z"
    entrypoint: ["sh", "-c"]
    command: ["echo 'Build completed successfully'"]
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully

  # ========================================================================
  # PKI-CA (Certificate Authority)
  # ========================================================================

  pki-ca-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["pki", "ca", "start", "--config=/app/config/pki-ca-app-sqlite-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28100:8000"  # HTTPS public
    volumes:
      - ../pki-ca/config/pki-ca-app-sqlite-1.yml:/app/config/pki-ca-app-sqlite-1.yml:ro
      - ../pki-ca/config/pki-ca-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  pki-ca-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["pki", "ca", "start", "--config=/app/config/pki-ca-app-postgresql-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28101:8000"
    volumes:
      - ../pki-ca/config/pki-ca-app-postgresql-1.yml:/app/config/pki-ca-app-postgresql-1.yml:ro
      - ../pki-ca/config/pki-ca-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  pki-ca-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["pki", "ca", "start", "--config=/app/config/pki-ca-app-postgresql-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28102:8000"
    volumes:
      - ../pki-ca/config/pki-ca-app-postgresql-1.yml:/app/config/pki-ca-app-postgresql-1.yml:ro
      - ../pki-ca/config/pki-ca-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # JOSE-JA (JWK Authority)
  # ========================================================================

  jose-ja-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["jose", "ja", "start", "--config=/app/config/jose-ja-app-sqlite-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28800:8000"
    volumes:
      - ../jose-ja/config/jose-ja-app-sqlite-1.yml:/app/config/jose-ja-app-sqlite-1.yml:ro
      - ../jose-ja/config/jose-ja-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  jose-ja-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["jose", "ja", "start", "--config=/app/config/jose-ja-app-postgresql-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28801:8000"
    volumes:
      - ../jose-ja/config/jose-ja-app-postgresql-1.yml:/app/config/jose-ja-app-postgresql-1.yml:ro
      - ../jose-ja/config/jose-ja-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  jose-ja-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["jose", "ja", "start", "--config=/app/config/jose-ja-app-postgresql-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28802:8000"
    volumes:
      - ../jose-ja/config/jose-ja-app-postgresql-1.yml:/app/config/jose-ja-app-postgresql-1.yml:ro
      - ../jose-ja/config/jose-ja-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # CIPHER-IM (Instant Messenger)
  # ========================================================================

  cipher-im-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["cipher", "im", "start", "--config=/app/config/cipher-im-app-sqlite-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28700:8000"
    volumes:
      - ../cipher-im/config/cipher-im-app-sqlite-1.yml:/app/config/cipher-im-app-sqlite-1.yml:ro
      - ../cipher-im/config/cipher-im-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  cipher-im-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["cipher", "im", "start", "--config=/app/config/cipher-im-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28701:8000"
    volumes:
      - ../cipher-im/config/cipher-im-postgres.yml:/app/config/cipher-im-postgres.yml:ro
      - ../cipher-im/config/cipher-im-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  cipher-im-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["cipher", "im", "start", "--config=/app/config/cipher-im-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28702:8000"
    volumes:
      - ../cipher-im/config/cipher-im-postgres.yml:/app/config/cipher-im-postgres.yml:ro
      - ../cipher-im/config/cipher-im-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # SM-KMS (Key Management Service)
  # ========================================================================

  sm-kms-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["sm", "kms", "start", "--config=/app/config/sm-kms-app-sqlite-1.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28000:8000"
    volumes:
      - ../sm-kms/config/sm-kms-app-sqlite-1.yml:/app/config/sm-kms-app-sqlite-1.yml:ro
      - ../sm-kms/config/sm-kms-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  sm-kms-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["sm", "kms", "start", "--config=/app/config/sm-kms-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28001:8000"
    volumes:
      - ../sm-kms/config/sm-kms-postgres.yml:/app/config/sm-kms-postgres.yml:ro
      - ../sm-kms/config/sm-kms-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  sm-kms-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["sm", "kms", "start", "--config=/app/config/sm-kms-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28002:8000"
    volumes:
      - ../sm-kms/config/sm-kms-postgres.yml:/app/config/sm-kms-postgres.yml:ro
      - ../sm-kms/config/sm-kms-app-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # IDENTITY-AUTHZ (Authorization Server)
  # ========================================================================

  identity-authz-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["identity", "authz", "start", "--config=/app/config/identity-authz-sqlite.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28200:8000"
    volumes:
      - ../identity-authz/config/identity-authz-sqlite.yml:/app/config/identity-authz-sqlite.yml:ro
      - ../identity-authz/config/identity-authz-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-authz-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "authz", "start", "--config=/app/config/identity-authz-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28201:8000"
    volumes:
      - ../identity-authz/config/identity-authz-postgres.yml:/app/config/identity-authz-postgres.yml:ro
      - ../identity-authz/config/identity-authz-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-authz-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "authz", "start", "--config=/app/config/identity-authz-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28202:8000"
    volumes:
      - ../identity-authz/config/identity-authz-postgres.yml:/app/config/identity-authz-postgres.yml:ro
      - ../identity-authz/config/identity-authz-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # IDENTITY-IDP (Identity Provider)
  # ========================================================================

  identity-idp-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["identity", "idp", "start", "--config=/app/config/identity-idp-sqlite.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28300:8000"
    volumes:
      - ../identity-idp/config/identity-idp-sqlite.yml:/app/config/identity-idp-sqlite.yml:ro
      - ../identity-idp/config/identity-idp-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-idp-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "idp", "start", "--config=/app/config/identity-idp-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28301:8000"
    volumes:
      - ../identity-idp/config/identity-idp-postgres.yml:/app/config/identity-idp-postgres.yml:ro
      - ../identity-idp/config/identity-idp-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-idp-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "idp", "start", "--config=/app/config/identity-idp-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28302:8000"
    volumes:
      - ../identity-idp/config/identity-idp-postgres.yml:/app/config/identity-idp-postgres.yml:ro
      - ../identity-idp/config/identity-idp-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # IDENTITY-RS (Resource Server)
  # ========================================================================

  identity-rs-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["identity", "rs", "start", "--config=/app/config/identity-rs-sqlite.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28400:8000"
    volumes:
      - ../identity-rs/config/identity-rs-sqlite.yml:/app/config/identity-rs-sqlite.yml:ro
      - ../identity-rs/config/identity-rs-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-rs-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "rs", "start", "--config=/app/config/identity-rs-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28401:8000"
    volumes:
      - ../identity-rs/config/identity-rs-postgres.yml:/app/config/identity-rs-postgres.yml:ro
      - ../identity-rs/config/identity-rs-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-rs-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "rs", "start", "--config=/app/config/identity-rs-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28402:8000"
    volumes:
      - ../identity-rs/config/identity-rs-postgres.yml:/app/config/identity-rs-postgres.yml:ro
      - ../identity-rs/config/identity-rs-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # IDENTITY-RP (Relying Party)
  # ========================================================================

  identity-rp-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["identity", "rp", "start", "--config=/app/config/identity-rp-sqlite.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28500:8000"
    volumes:
      - ../identity-rp/config/identity-rp-sqlite.yml:/app/config/identity-rp-sqlite.yml:ro
      - ../identity-rp/config/identity-rp-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-rp-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "rp", "start", "--config=/app/config/identity-rp-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28501:8000"
    volumes:
      - ../identity-rp/config/identity-rp-postgres.yml:/app/config/identity-rp-postgres.yml:ro
      - ../identity-rp/config/identity-rp-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-rp-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "rp", "start", "--config=/app/config/identity-rp-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28502:8000"
    volumes:
      - ../identity-rp/config/identity-rp-postgres.yml:/app/config/identity-rp-postgres.yml:ro
      - ../identity-rp/config/identity-rp-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ========================================================================
  # IDENTITY-SPA (Single Page App)
  # ========================================================================

  identity-spa-app-sqlite-1:
    profiles: ["dev", "demo", "ci"]
    image: cryptoutil:dev
    command: ["identity", "spa", "start", "--config=/app/config/identity-spa-sqlite.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28600:8000"
    volumes:
      - ../identity-spa/config/identity-spa-sqlite.yml:/app/config/identity-spa-sqlite.yml:ro
      - ../identity-spa/config/identity-spa-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-spa-app-postgres-1:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "spa", "start", "--config=/app/config/identity-spa-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28601:8000"
    volumes:
      - ../identity-spa/config/identity-spa-postgres.yml:/app/config/identity-spa-postgres.yml:ro
      - ../identity-spa/config/identity-spa-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  identity-spa-app-postgres-2:
    profiles: ["postgres"]
    image: cryptoutil:dev
    command: ["identity", "spa", "start", "--config=/app/config/identity-spa-postgres.yml", "--config=/app/config/common.yml", "--config=/app/otel/otel.yml"]
    working_dir: /tmp
    ports:
      - "28602:8000"
    volumes:
      - ../identity-spa/config/identity-spa-postgres.yml:/app/config/identity-spa-postgres.yml:ro
      - ../identity-spa/config/identity-spa-common.yml:/app/config/common.yml:ro
      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    depends_on:
      healthcheck-secrets:
        condition: service_completed_successfully
      builder-cryptoutil:
        condition: service_completed_successfully
      postgres-leader:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]
      start_period: 60s
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - cryptoutil-network
      - postgres-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

# ========================================================================
# Networks
# ========================================================================

networks:
  cryptoutil-network:
    driver: bridge
  postgres-network:
    driver: bridge
  telemetry-network:
    driver: bridge

# ========================================================================
# Secrets
# ========================================================================

secrets:
  hash-pepper_v3.secret:
    file: ./secrets/cryptoutil-hash-pepper.secret
  unseal-1of5.secret:
    file: ./secrets/unseal-1of5.secret
  unseal-2of5.secret:
    file: ./secrets/unseal-2of5.secret
  unseal-3of5.secret:
    file: ./secrets/unseal-3of5.secret
  unseal-4of5.secret:
    file: ./secrets/unseal-4of5.secret
  unseal-5of5.secret:
    file: ./secrets/unseal-5of5.secret
  postgres-url.secret:
    file: ./secrets/postgres-url.secret
