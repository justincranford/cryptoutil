# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json

#

# E2E Testing Compose Configuration

#

# This compose file provides services for E2E testing with service names matching test expectations.

# It reuses service definitions from KMS and telemetry compose files but with E2E-specific names.

#

# Usage:

#   docker compose -f compose.yml up -d           # Start all E2E services

#   docker compose -f compose.yml down -v         # Stop and clean up

#   docker compose -f compose.yml --profile postgres up -d  # Include PostgreSQL instances

#

# Services:

#   - cryptoutil-sqlite:     https://localhost:8080 (public), https://localhost:9090 (admin)

#   - cryptoutil-postgres-1: https://localhost:8081 (public), https://localhost:9091 (admin)

#   - cryptoutil-postgres-2: https://localhost:8082 (public), https://localhost:9092 (admin)

#   - postgres:              localhost:5432

#   - grafana-otel-lgtm:     http://localhost:3000

#   - opentelemetry-collector-contrib: localhost:4317 (gRPC), localhost:4318 (HTTP), localhost:13133 (health)



include:

  - path: ../telemetry/compose.yml



services:

  # Override otel collector from telemetry/compose.yml to expose ports for E2E tests.
  # The base definition has ports commented out for multi-deployment support,
  # but E2E tests run from host and need to reach the health endpoint.
  opentelemetry-collector-contrib:
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "13133:13133" # Health check endpoint for E2E tests
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:13133/"]
      start_period: 10s
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - e2e-network
      - telemetry-network

  # Healthcheck for Docker secrets availability.

  healthcheck-secrets:

    image: alpine:latest

    secrets:

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

      - postgres_url.secret

      - postgres_username.secret

      - postgres_password.secret

      - postgres_database.secret

      - hash_pepper_v3.secret

    command: ["sh", "-c", "ls -l /run/secrets/*.secret"]

    networks:

      - e2e-network



  # Build cryptoutil image from source.

  builder-cryptoutil:

    image: cryptoutil:dev

    build:

      context: ../..

      dockerfile: deployments/kms/Dockerfile.kms

      args:

        APP_VERSION: "dev"

        VCS_REF: "local"

        BUILD_DATE: "2025-11-30T00:00:00Z"

    entrypoint: ["sh", "-c"]

    command: ["echo 'Build completed successfully'"]

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully



  # PostgreSQL database for KMS persistence.

  postgres:

    profiles: ["postgres"]

    image: postgres:18

    environment:

      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret

      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret

      POSTGRES_DB_FILE: /run/secrets/postgres_database.secret

    shm_size: 256mb

    ports:

      - "5432:5432"

    volumes:

      - postgres_data:/var/lib/postgresql

    secrets:

      - postgres_username.secret

      - postgres_password.secret

      - postgres_database.secret

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully

    healthcheck:

      test: ["CMD-SHELL", "pg_isready -U $(cat /run/secrets/postgres_username.secret) -d $(cat /run/secrets/postgres_database.secret)"]

      start_period: 5s

      interval: 5s

      timeout: 3s

      retries: 5

    networks:

      - e2e-network

    deploy:

      resources:

        limits:

          memory: 512M

        reservations:

          memory: 256M



  # KMS server with SQLite backend (default for E2E).

  cryptoutil-sqlite:

    image: cryptoutil:dev

    command:

      - "kms"

      - "start"

      - "--config=/app/config/sqlite.yml"

      - "--config=/app/config/common.yml"

      - "--config=/app/otel/otel.yml"

    working_dir: /tmp

    ports:

      - "8080:8080"  # Public API
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../kms/config/sqlite.yml:/app/config/sqlite.yml:ro

      - ../kms/config/common.yml:/app/config/common.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 10s

      interval: 5s

      timeout: 3s

      retries: 5

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

    networks:

      - e2e-network

      - telemetry-network



  # KMS server with PostgreSQL backend (instance 1).

  cryptoutil-postgres-1:

    profiles: ["postgres"]

    image: cryptoutil:dev

    command:

      - "kms"

      - "start"

      - "--config=/app/config/postgresql-1.yml"

      - "--config=/app/config/common.yml"

      - "--config=/app/otel/otel.yml"

      - "-u"

      - "file:///run/secrets/postgres_url.secret"

    working_dir: /tmp

    ports:

      - "8081:8080"  # Public API (host:container)
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../kms/config/postgresql-1.yml:/app/config/postgresql-1.yml:ro

      - ../kms/config/common.yml:/app/config/common.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

      - postgres_url.secret

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 30s

      interval: 5s

      timeout: 3s

      retries: 5

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

      postgres:

        condition: service_healthy

    networks:

      - e2e-network

      - telemetry-network



  # KMS server with PostgreSQL backend (instance 2).

  cryptoutil-postgres-2:

    profiles: ["postgres"]

    image: cryptoutil:dev

    command:

      - "kms"

      - "start"

      - "--config=/app/config/postgresql-2.yml"

      - "--config=/app/config/common.yml"

      - "--config=/app/otel/otel.yml"

      - "-u"

      - "file:///run/secrets/postgres_url.secret"

    working_dir: /tmp

    ports:

      - "8082:8080"  # Public API (host:container)
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../kms/config/postgresql-2.yml:/app/config/postgresql-2.yml:ro

      - ../kms/config/common.yml:/app/config/common.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

      - postgres_url.secret

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 30s

      interval: 5s

      timeout: 3s

      retries: 5

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

      postgres:

        condition: service_healthy

    networks:

      - e2e-network

      - telemetry-network



  # CA server with SQLite backend for E2E testing.

  ca-e2e:

    image: cryptoutil:dev

    command:

      - "ca"

      - "start"

      - "--config=/app/config/ca-sqlite.yml"

      - "--config=/app/config/ca-common.yml"

      - "--config=/app/otel/otel.yml"

    working_dir: /tmp

    ports:

      - "8050:8050"  # HTTPS public (CA uses 8050, not 8080)
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../ca/config/ca-sqlite.yml:/app/config/ca-sqlite.yml:ro

      - ../ca/config/ca-common.yml:/app/config/ca-common.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

      - ../ca/ca-crls:/app/crls  # CRL distribution point

    secrets:

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      # CA uses wget and /livez endpoint (not /admin/api/v1/livez).

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:8050/livez"]

      start_period: 60s

      interval: 5s

      timeout: 5s

      retries: 10

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

    networks:

      - e2e-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



  jose-e2e:

    image: cryptoutil:dev

    command:

      - "jose"

      - "start"

      - "--config=/app/config/jose-sqlite.yml"

      - "--config=/app/config/jose-common.yml"

      - "--config=/app/otel/otel.yml"

    working_dir: /tmp

    ports:

      - "8060:8060"  # HTTPS public
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../jose/config/jose-sqlite.yml:/app/config/jose-sqlite.yml:ro

      - ../jose/config/jose-common.yml:/app/config/jose-common.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:8060/admin/api/v1/livez"]

      start_period: 30s

      interval: 5s

      timeout: 5s

      retries: 5

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

    networks:

      - e2e-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



  identity-postgres-e2e:

    image: postgres:18

    environment:

      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret

      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret

      POSTGRES_DB_FILE: /run/secrets/postgres_database.secret

    shm_size: 256mb

    ports:

      - "5433:5432"

    volumes:

      - identity_postgres_data:/var/lib/postgresql

    secrets:

      - postgres_username.secret

      - postgres_password.secret

      - postgres_database.secret

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully

    healthcheck:

      test: ["CMD-SHELL", "pg_isready -U $(cat /run/secrets/postgres_username.secret) -d $(cat /run/secrets/postgres_database.secret)"]

      start_period: 5s

      interval: 5s

      timeout: 3s

      retries: 5

    networks:

      - e2e-network

    deploy:

      resources:

        limits:

          memory: 512M

        reservations:

          memory: 256M



  identity-authz-e2e:

    image: cryptoutil:dev

    command:

      - "identity"

      - "start"

      - "--service=authz"

      - "--config=/app/config/authz-e2e.yml"

    working_dir: /tmp

    ports:

      - "18000:18000"  # OAuth 2.1 authorization endpoints (config uses 18000)
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../identity/config/authz-e2e.yml:/app/config/authz-e2e.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 10s

      interval: 5s

      timeout: 5s

      retries: 5

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

      identity-postgres-e2e:

        condition: service_healthy

    networks:

      - e2e-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



  identity-idp-e2e:

    image: cryptoutil:dev

    command:

      - "identity"

      - "start"

      - "--service=idp"

      - "--config=/app/config/idp-e2e.yml"

      - "-u"

      - "file:///run/secrets/postgres_url.secret"

    working_dir: /tmp

    ports:

      - "18100:18100"  # OIDC identity provider endpoints (config uses 18100)
      # Admin API (9090) NOT exposed - internal container use only (per 02-03.https-ports.instructions.md)

    volumes:

      - ../identity/config/idp-e2e.yml:/app/config/idp-e2e.yml:ro

      - ../telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      - postgres_url.secret

    environment:

      - OTLP_GRPC_ENDPOINT=opentelemetry-collector-contrib:4317

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 10s

      interval: 5s

      timeout: 5s

      retries: 5

    depends_on:

      builder-cryptoutil:

        condition: service_completed_successfully

      identity-postgres-e2e:

        condition: service_healthy

      identity-authz-e2e:

        condition: service_healthy

    networks:

      - e2e-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



networks:

  e2e-network:

    driver: bridge



volumes:

  postgres_data:

  identity_postgres_data:



secrets:

  postgres_username.secret:

    file: ../kms/secrets/postgres_username.secret

  postgres_password.secret:

    file: ../kms/secrets/postgres_password.secret

  postgres_database.secret:

    file: ../kms/secrets/postgres_database.secret

  postgres_url.secret:

    file: ../kms/secrets/postgres_url.secret



  # Unseal secrets (CRITICAL: shared across ALL cryptoutil instances for key hierarchy interoperability).

  unseal_1of5.secret:

    file: ../kms/secrets/unseal_1of5.secret

  unseal_2of5.secret:

    file: ../kms/secrets/unseal_2of5.secret

  unseal_3of5.secret:

    file: ../kms/secrets/unseal_3of5.secret

  unseal_4of5.secret:

    file: ../kms/secrets/unseal_4of5.secret

  unseal_5of5.secret:

    file: ../kms/secrets/unseal_5of5.secret



  # Hash service pepper secret (MANDATORY per OWASP Password Storage Cheat Sheet).

  # Version-specific pepper for PBKDF2/HKDF operations.

  # CRITICAL: Changing pepper requires version bump and re-hash all records.

  hash_pepper_v3.secret:

    file: ../kms/secrets/hash_pepper_v3.secret
