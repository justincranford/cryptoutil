# Service Template Docker Compose Configuration
#
# NOTE: The service-template is an INTERNAL LIBRARY, not a standalone service.
# It provides reusable infrastructure patterns for all cryptoutil services:
#   - Two HTTPS servers (public + admin)
#   - PostgreSQL/SQLite dual-database support with GORM
#   - OpenTelemetry integration
#   - Session management, multi-tenancy, barrier encryption
#
# E2E Testing Strategy:
# ---------------------
# The service-template is tested through cipher-im, which is the reference
# implementation built on the template. To run E2E tests:
#
#   # Start cipher-im stack (tests template infrastructure)
#   docker compose -f ../../../cmd/cipher-im/docker-compose.yml up -d
#
#   # Run cipher-im E2E tests
#   go test -tags=e2e ./internal/apps/cipher/im/e2e/...
#
# This compose file provides a MINIMAL stack for template validation only.
# For production-like testing, use the cipher-im compose file.
#
# Services:
#   - template-sqlite: https://localhost:8880 (public) - Standalone SQLite
#   - template-pg-1: https://localhost:8881 (public) - Shared PostgreSQL
#   - template-pg-2: https://localhost:8882 (public) - Shared PostgreSQL
#   - postgres: localhost:5433 (PostgreSQL 18.1 - note: different port to avoid conflicts)
#   - otel-collector: (internal only, no host ports)
#
# Health Checks:
#   - Admin livez endpoint: https://127.0.0.1:9090/admin/api/v1/livez (internal only)
#
# Usage:
#   docker compose up -d                        # Start all services
#   docker compose ps                           # Check status
#   docker compose logs -f template-sqlite      # View SQLite instance logs
#   docker compose down                         # Stop and remove
#   docker compose down -v                      # Stop and remove volumes

name: template

services:
  # PostgreSQL 18.1 Database (shared by template-pg-1 and template-pg-2)
  postgres:
    image: postgres:18.1-alpine
    container_name: template-postgres
    hostname: template-postgres
    secrets:
      - postgres_database.secret
      - postgres_username.secret
      - postgres_password.secret
    environment:
      POSTGRES_DB_FILE: /run/secrets/postgres_database.secret
      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret
    ports:
      - "5433:5432"  # Note: Different host port (5433) to avoid conflicts with other services
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U template_user -d template"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - template-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # OpenTelemetry Collector
  # Note: No healthcheck - otel-collector-contrib image is minimal (no curl/wget).
  # Services depend on it with service_started (not service_healthy).
  opentelemetry-collector-contrib:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: template-otel-collector
    hostname: template-otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    networks:
      - template-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'

  # Template Service - SQLite Standalone Instance
  # Uses cipher-im binary as reference implementation of the template pattern.
  template-sqlite:
    image: cipher-im:local
    container_name: template-sqlite
    hostname: template-sqlite
    ports:
      - "8870:8070"  # Public HTTPS API ONLY - external access
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file::memory:?cache=shared"
      - "--config=/etc/template/config-sqlite.yml"
    volumes:
      - ../../configs/template/config-sqlite.yml:/etc/template/config-sqlite.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - template-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "template"
      com.cryptoutil.backend: "sqlite"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Template Service - PostgreSQL Instance 1
  template-pg-1:
    image: cipher-im:local
    container_name: template-pg-1
    hostname: template-pg-1
    secrets:
      - postgres_url.secret
    ports:
      - "8871:8070"  # Public HTTPS API ONLY - external access
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/template/config-pg-1.yml"
    volumes:
      - ../../configs/template/config-pg-1.yml:/etc/template/config-pg-1.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      template-sqlite:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - template-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "template"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Template Service - PostgreSQL Instance 2
  template-pg-2:
    image: cipher-im:local
    container_name: template-pg-2
    hostname: template-pg-2
    secrets:
      - postgres_url.secret
    ports:
      - "8872:8070"  # Public HTTPS API ONLY - external access
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/template/config-pg-2.yml"
    volumes:
      - ../../configs/template/config-pg-2.yml:/etc/template/config-pg-2.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      template-pg-1:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - template-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "template"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "2"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

secrets:
  postgres_database.secret:
    file: ./secrets/postgres_database.secret
  postgres_username.secret:
    file: ./secrets/postgres_username.secret
  postgres_password.secret:
    file: ./secrets/postgres_password.secret
  postgres_url.secret:
    file: ./secrets/postgres_url.secret

networks:
  template-network:
    driver: bridge
    name: template-network

volumes:
  postgres_data:
    name: template-postgres-data
