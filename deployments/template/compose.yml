# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
#
# GENERIC Service Template Docker Compose Configuration
#
# This is the TEMPLATE file for ANY cryptoutil service deployment.
# Replace PRODUCT, SERVICE, XXXX placeholders with actual values.
#
# The service-template is an INTERNAL LIBRARY providing reusable infrastructure:
#   - Two HTTPS servers (public + admin)
#   - PostgreSQL/SQLite dual-database support with GORM
#   - OpenTelemetry integration
#   - Session management, multi-tenancy, barrier encryption
#
# Example substitutions:
#   - PRODUCT: cipher, jose, pki, sm, identity
#   - SERVICE: im, ja, ca, kms, authz, idp, rs, rp, spa
#   - XXXX: Service base port (8000, 8100, 8200, 8300, 8400, 8500, 8600, 8700, 8800)
#
# E2E Testing Strategy:
# ---------------------
# The service-template is tested through concrete implementations:
#   docker compose -f ../PRODUCT/compose.yml up -d
#   go test -tags=e2e ./internal/apps/PRODUCT/SERVICE/e2e/...
#
# Recommended reference implementation: cipher-im (migration priority FIRST)
#
# Services:
#   - PRODUCT-SERVICE-sqlite: https://localhost:XXXX (public) - Standalone SQLite
#   - PRODUCT-SERVICE-pg-1: https://localhost:XXXX+1 (public) - Shared PostgreSQL
#   - PRODUCT-SERVICE-pg-2: https://localhost:XXXX+2 (public) - Shared PostgreSQL
#   - postgres: localhost:5432 (PostgreSQL 18 - use postgres-leader from include)
#   - otel-collector: (internal only, no host ports - from telemetry include)
#
# Health Checks:
#   - Admin livez endpoint: https://127.0.0.1:9090/admin/api/v1/livez (internal only)
#
# Usage:
#   docker compose up -d                        # Start all services
#   docker compose ps                           # Check status
#   docker compose logs -f PRODUCT-SERVICE-sqlite      # View SQLite instance logs
#   docker compose down                         # Stop and remove
#   docker compose down -v                      # Stop and remove volumes

name: PRODUCT-SERVICE

include:
  - path: ../telemetry/compose.yml
  - path: ../postgres/compose.yml

services:
  # PRODUCT-SERVICE - SQLite Standalone Instance
  # Replace PRODUCT-SERVICE with actual service name (e.g., cipher-im, jose-ja)
  # Replace XXXX with service base port (e.g., 8700, 8800)
  PRODUCT-SERVICE-sqlite:
    image: PRODUCT-SERVICE:local
    container_name: PRODUCT-SERVICE-sqlite
    hostname: PRODUCT-SERVICE-sqlite
    secrets:
      - unseal_1of5.secret
      - unseal_2of5.secret
      - unseal_3of5.secret
      - unseal_4of5.secret
      - unseal_5of5.secret
    ports:
      - "XXXX:8000"  # Public HTTPS API ONLY - external access (XXXX = base port)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file::memory:?cache=shared"
      - "--config=/etc/PRODUCT-SERVICE/config-sqlite.yml"
    volumes:
      - ../../configs/PRODUCT/SERVICE-sqlite.yml:/etc/PRODUCT-SERVICE/config-sqlite.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - PRODUCT-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "PRODUCT-SERVICE"
      com.cryptoutil.backend: "sqlite"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # PRODUCT-SERVICE - PostgreSQL Instance 1
  PRODUCT-SERVICE-pg-1:
    image: PRODUCT-SERVICE:local
    container_name: PRODUCT-SERVICE-pg-1
    hostname: PRODUCT-SERVICE-pg-1
    secrets:
      - unseal_1of5.secret
      - unseal_2of5.secret
      - unseal_3of5.secret
      - unseal_4of5.secret
      - unseal_5of5.secret
      - postgres_url.secret
      - postgres_username.secret
      - postgres_password.secret
      - postgres_database.secret
    ports:
      - "XXXX+1:8000"  # Public HTTPS API ONLY - external access (XXXX+1)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/PRODUCT-SERVICE/config-pg-1.yml"
    volumes:
      - ../../configs/PRODUCT/SERVICE-pg-1.yml:/etc/PRODUCT-SERVICE/config-pg-1.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres-leader:
        condition: service_healthy
      PRODUCT-SERVICE-sqlite:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - PRODUCT-network
      - postgres-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "PRODUCT-SERVICE"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # PRODUCT-SERVICE - PostgreSQL Instance 2
  PRODUCT-SERVICE-pg-2:
    image: PRODUCT-SERVICE:local
    container_name: PRODUCT-SERVICE-pg-2
    hostname: PRODUCT-SERVICE-pg-2
    secrets:
      - unseal_1of5.secret
      - unseal_2of5.secret
      - unseal_3of5.secret
      - unseal_4of5.secret
      - unseal_5of5.secret
      - postgres_url.secret
      - postgres_username.secret
      - postgres_password.secret
      - postgres_database.secret
    ports:
      - "XXXX+2:8000"  # Public HTTPS API ONLY - external access (XXXX+2)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/PRODUCT-SERVICE/config-pg-2.yml"
    volumes:
      - ../../configs/PRODUCT/SERVICE-pg-2.yml:/etc/PRODUCT-SERVICE/config-pg-2.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres-leader:
        condition: service_healthy
      PRODUCT-SERVICE-pg-1:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - PRODUCT-network
      - postgres-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "PRODUCT-SERVICE"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "2"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

secrets:
  unseal_1of5.secret:
    file: ./secrets/unseal_1of5.secret
  unseal_2of5.secret:
    file: ./secrets/unseal_2of5.secret
  unseal_3of5.secret:
    file: ./secrets/unseal_3of5.secret
  unseal_4of5.secret:
    file: ./secrets/unseal_4of5.secret
  unseal_5of5.secret:
    file: ./secrets/unseal_5of5.secret
  postgres_database.secret:
    file: ./secrets/postgres_database.secret
  postgres_username.secret:
    file: ./secrets/postgres_username.secret
  postgres_password.secret:
    file: ./secrets/postgres_password.secret
  postgres_url.secret:
    file: ./secrets/postgres_url.secret

networks:
  PRODUCT-network:
    driver: bridge
    name: PRODUCT-network
  postgres-network:
    driver: bridge
  telemetry-network:
    driver: bridge

# Note: Volumes are defined in ../postgres/compose.yml (included above)
# No local volumes needed for this template
