# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
#
# Citus Distributed Database Services for cryptoutil
# This compose file provides Citus coordinator and worker nodes for distributed row-level sharding.
#
# Architecture:
#   - citus-coordinator: Citus 13 coordinator node (distributes queries to workers)
#   - citus-worker-1:    Citus 13 worker node 1 (stores distributed table shards)
#   - citus-worker-2:    Citus 13 worker node 2 (stores distributed table shards)
#
# Usage:
#   docker compose -f deployments/citus/compose.yml up -d
#   docker compose -f deployments/citus/compose.yml down -v
#
# Integration with PostgreSQL:
#   Citus can complement PostgreSQL by providing horizontal scaling for specific
#   high-volume tables while PostgreSQL handles OLTP/OLAP workloads.

name: cryptoutil-citus

services:
  citus-coordinator:
    image: citusdata/citus:13.0-pg17
    container_name: cryptoutil-citus-coordinator
    hostname: citus-coordinator
    environment:
      POSTGRES_USER: cryptoutil_admin
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret
      PGUSER: cryptoutil_admin
      PGPASSWORD_FILE: /run/secrets/postgres_password.secret
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
    command:
      - postgres
      - -c
      - max_connections=300
      - -c
      - shared_buffers=512MB
      - -c
      - citus.shard_count=32
      - -c
      - citus.shard_replication_factor=2
    shm_size: 512mb
    ports:
      - "5434:5432"
    volumes:
      - citus_coordinator_data:/var/lib/postgresql/data
      - ./postgres/init-citus.sql:/docker-entrypoint-initdb.d/01-init-citus.sql:ro
    secrets:
      - postgres_password.secret
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cryptoutil_admin -d postgres"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - postgres-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Citus Worker Node 1
  citus-worker-1:
    image: citusdata/citus:13.0-pg17
    container_name: cryptoutil-citus-worker-1
    hostname: citus-worker-1
    environment:
      POSTGRES_USER: cryptoutil_admin
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret
      PGUSER: cryptoutil_admin
      PGPASSWORD_FILE: /run/secrets/postgres_password.secret
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
    command: ["postgres", "-c", "max_connections=300", "-c", "shared_buffers=512MB"]
    shm_size: 512mb
    volumes:
      - citus_worker_1_data:/var/lib/postgresql/data
    secrets:
      - postgres_password.secret
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cryptoutil_admin -d postgres"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - postgres-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Citus Worker Node 2
  citus-worker-2:
    image: citusdata/citus:13.0-pg17
    container_name: cryptoutil-citus-worker-2
    hostname: citus-worker-2
    environment:
      POSTGRES_USER: cryptoutil_admin
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret
      PGUSER: cryptoutil_admin
      PGPASSWORD_FILE: /run/secrets/postgres_password.secret
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
    command: ["postgres", "-c", "max_connections=300", "-c", "shared_buffers=512MB"]
    shm_size: 512mb
    volumes:
      - citus_worker_2_data:/var/lib/postgresql/data
    secrets:
      - postgres_password.secret
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cryptoutil_admin -d postgres"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - postgres-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Citus Setup Job - Registers worker nodes with coordinator
  citus-setup:
    image: citusdata/citus:13.0-pg17
    container_name: cryptoutil-citus-setup
    environment:
      PGUSER: cryptoutil_admin
      PGPASSWORD_FILE: /run/secrets/postgres_password.secret
      PGHOST: citus-coordinator
      PGDATABASE: postgres
    command:
      - sh
      - -c
      - |
        sleep 10
        psql -c "SELECT * FROM citus_add_node('citus-worker-1', 5432);"
        psql -c "SELECT * FROM citus_add_node('citus-worker-2', 5432);"
        psql -c "SELECT * FROM citus_get_active_worker_nodes();"
        echo "Citus cluster setup complete"
    secrets:
      - postgres_password.secret
    depends_on:
      citus-coordinator:
        condition: service_healthy
      citus-worker-1:
        condition: service_healthy
      citus-worker-2:
        condition: service_healthy
    networks:
      - postgres-network


volumes:
  - citus_coordinator_data:/var/lib/postgresql/data
  - citus_worker_1_data:/var/lib/postgresql/data
  - citus_worker_2_data:/var/lib/postgresql/data
  citus_coordinator_data:
  name: cryptoutil_citus_coordinator_volume
  citus_worker_1_data:
  name: cryptoutil_citus_worker_1_volume
  citus_worker_2_data:
  name: cryptoutil_citus_worker_2_volume