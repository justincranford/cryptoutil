# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
#
# GENERIC Service Template Docker Compose Configuration
#
# This is the TEMPLATE file for ANY cryptoutil service deployment.
# Replace identity, spa, 8600 placeholders with actual values.
#
# The service-template is an INTERNAL LIBRARY providing reusable infrastructure:
#   - Two HTTPS servers (public + admin)
#   - PostgreSQL/SQLite dual-database support with GORM
#   - OpenTelemetry integration
#   - Session management, multi-tenancy, barrier encryption
#
# Example substitutions:
#   - identity: cipher, jose, pki, sm, identity
#   - spa: im, ja, ca, kms, authz, idp, rs, rp, spa
#   - 8600: Service base port (8000, 8100, 8200, 8300, 8400, 8500, 8600, 8700, 8800)
#
# E2E Testing Strategy:
# ---------------------
# The service-template is tested through concrete implementations:
#   docker compose -f ../identity/compose.yml up -d
#   go test -tags=e2e ./internal/apps/identity/spa/e2e/...
#
# Recommended reference implementation: cipher-im (migration priority FIRST)
#
# Services:
#   - identity-spa-sqlite: https://localhost:8600 (public) - Standalone SQLite
#   - identity-spa-pg-1: https://localhost:8600+1 (public) - Shared PostgreSQL
#   - identity-spa-pg-2: https://localhost:8600+2 (public) - Shared PostgreSQL
#   - postgres: localhost:5432 (PostgreSQL 18 - use postgres-leader from include)
#   - otel-collector: (internal only, no host ports - from telemetry include)
#
# Health Checks:
#   - Admin livez endpoint: https://127.0.0.1:9090/admin/api/v1/livez (internal only)
#
# Usage:
#   docker compose up -d                        # Start all services
#   docker compose ps                           # Check status
#   docker compose logs -f identity-spa-sqlite      # View SQLite instance logs
#   docker compose down                         # Stop and remove
#   docker compose down -v                      # Stop and remove volumes

name: identity-spa

include:
  - path: ../shared-telemetry/compose.yml
  - path: ../shared-postgres/compose.yml

services:
  # identity-spa - SQLite Standalone Instance
  # Replace identity-spa with actual service name (e.g., cipher-im, jose-ja)
  # Replace 8600 with service base port (e.g., 8700, 8800)
  identity-spa-sqlite:
    image: identity-spa:local
    container_name: identity-spa-sqlite
    hostname: identity-spa-sqlite
    secrets:
      - unseal_1of5.secret
      - unseal_2of5.secret
      - unseal_3of5.secret
      - unseal_4of5.secret
      - unseal_5of5.secret
    ports:
      - "8600:8000"  # Public HTTPS API ONLY - external access (8600 = base port)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file::memory:?cache=shared"
      - "--config=/etc/identity-spa/config-sqlite.yml"
    volumes:
      - ../../configs/identity/spa-sqlite.yml:/etc/identity-spa/config-sqlite.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - identity-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "identity-spa"
      com.cryptoutil.backend: "sqlite"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # identity-spa - PostgreSQL Instance 1
  identity-spa-pg-1:
    image: identity-spa:local
    container_name: identity-spa-pg-1
    hostname: identity-spa-pg-1
    secrets:
      - unseal_1of5.secret
      - unseal_2of5.secret
      - unseal_3of5.secret
      - unseal_4of5.secret
      - unseal_5of5.secret
      - postgres_url.secret
      - postgres_username.secret
      - postgres_password.secret
      - postgres_database.secret
    ports:
      - "8601:8000"  # Public HTTPS API ONLY - external access (8601)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/identity-spa/config-pg-1.yml"
    volumes:
      - ../../configs/identity/spa-pg-1.yml:/etc/identity-spa/config-pg-1.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres-leader:
        condition: service_healthy
      identity-spa-sqlite:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - identity-network
      - postgres-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "identity-spa"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # identity-spa - PostgreSQL Instance 2
  identity-spa-pg-2:
    image: identity-spa:local
    container_name: identity-spa-pg-2
    hostname: identity-spa-pg-2
    secrets:
      - unseal_1of5.secret
      - unseal_2of5.secret
      - unseal_3of5.secret
      - unseal_4of5.secret
      - unseal_5of5.secret
      - postgres_url.secret
      - postgres_username.secret
      - postgres_password.secret
      - postgres_database.secret
    ports:
      - "8602:8000"  # Public HTTPS API ONLY - external access (8602)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres_url.secret"
      - "--config=/etc/identity-spa/config-pg-2.yml"
    volumes:
      - ../../configs/identity/spa-pg-2.yml:/etc/identity-spa/config-pg-2.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres-leader:
        condition: service_healthy
      identity-spa-pg-1:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - identity-network
      - postgres-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "identity-spa"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "2"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

secrets:
  unseal_1of5.secret:
    file: ./secrets/unseal_1of5.secret
  unseal_2of5.secret:
    file: ./secrets/unseal_2of5.secret
  unseal_3of5.secret:
    file: ./secrets/unseal_3of5.secret
  unseal_4of5.secret:
    file: ./secrets/unseal_4of5.secret
  unseal_5of5.secret:
    file: ./secrets/unseal_5of5.secret
  postgres_url.secret:

  # Browser authentication credentials (web UI access)
  browser_username.secret:
    file: ./secrets/browser_username.secret
  browser_password.secret:
    file: ./secrets/browser_password.secret

  # Service authentication credentials (headless/API access)
  service_username.secret:
    file: ./secrets/service_username.secret
  service_password.secret:
    file: ./secrets/service_password.secret
    file: ./secrets/postgres_url.secret

networks:
  identity-network:
    driver: bridge
    name: identity-network
  postgres-network:
    driver: bridge
  telemetry-network:
    driver: bridge

# Note: Volumes are defined in ../shared-postgres/compose.yml (included above)
# No local volumes needed for this template
