# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
#
# GENERIC Service Template Docker Compose Configuration
#
# This is the TEMPLATE file for ANY cryptoutil service deployment.
# Replace identity, idp, 8300 placeholders with actual values.
#
# The service-template is an INTERNAL LIBRARY providing reusable infrastructure:
#   - Two HTTPS servers (public + admin)
#   - PostgreSQL/SQLite dual-database support with GORM
#   - OpenTelemetry integration
#   - Session management, multi-tenancy, barrier encryption
#
# Example substitutions:
#   - identity: cipher, jose, pki, sm, identity
#   - idp: im, ja, ca, kms, authz, idp, rs, rp, spa
#   - 8300: Service base port (8000, 8100, 8200, 8300, 8400, 8500, 8600, 8700, 8800)
#
# E2E Testing Strategy:
# ---------------------
# The service-template is tested through concrete implementations:
#   docker compose -f ../identity/compose.yml up -d
#   go test -tags=e2e ./internal/apps/identity/idp/e2e/...
#
# Recommended reference implementation: cipher-im (migration priority FIRST)
#
# Services:
#   - identity-idp-sqlite: https://localhost:8300 (public) - Standalone SQLite
#   - identity-idp-pg-1: https://localhost:8300+1 (public) - Shared PostgreSQL
#   - identity-idp-pg-2: https://localhost:8300+2 (public) - Shared PostgreSQL
#   - postgres: localhost:5432 (PostgreSQL 18 - use postgres-leader from include)
#   - otel-collector: (internal only, no host ports - from telemetry include)
#
# Health Checks:
#   - Admin livez endpoint: https://127.0.0.1:9090/admin/api/v1/livez (internal only)
#
# Usage:
#   docker compose up -d                        # Start all services
#   docker compose ps                           # Check status
#   docker compose logs -f identity-idp-sqlite      # View SQLite instance logs
#   docker compose down                         # Stop and remove
#   docker compose down -v                      # Stop and remove volumes

name: identity-idp

include:
  - path: ../shared-telemetry/compose.yml
  - path: ../shared-postgres/compose.yml

services:
  # identity-idp - SQLite Standalone Instance
  # Replace identity-idp with actual service name (e.g., cipher-im, jose-ja)
  # Replace 8300 with service base port (e.g., 8700, 8800)
  identity-idp-sqlite:
    image: identity-idp:local
    container_name: identity-idp-sqlite
    hostname: identity-idp-sqlite
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
    ports:
      - "8300:8000"  # Public HTTPS API ONLY - external access (8300 = base port)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file::memory:?cache=shared"
      - "--config=/etc/identity-idp/config-sqlite.yml"
    volumes:
      - ../../configs/identity/idp-sqlite.yml:/etc/identity-idp/config-sqlite.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - identity-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "identity-idp"
      com.cryptoutil.backend: "sqlite"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # identity-idp - PostgreSQL Instance 1
  identity-idp-pg-1:
    image: identity-idp:local
    container_name: identity-idp-pg-1
    hostname: identity-idp-pg-1
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    ports:
      - "8301:8000"  # Public HTTPS API ONLY - external access (8301)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres-url.secret"
      - "--config=/etc/identity-idp/config-pg-1.yml"
    volumes:
      - ../../configs/identity/idp-pg-1.yml:/etc/identity-idp/config-pg-1.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres-leader:
        condition: service_healthy
      identity-idp-sqlite:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - identity-network
      - postgres-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "identity-idp"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "1"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # identity-idp - PostgreSQL Instance 2
  identity-idp-pg-2:
    image: identity-idp:local
    container_name: identity-idp-pg-2
    hostname: identity-idp-pg-2
    secrets:
      - unseal-1of5.secret
      - unseal-2of5.secret
      - unseal-3of5.secret
      - unseal-4of5.secret
      - unseal-5of5.secret
      - postgres-url.secret
      - postgres-username.secret
      - postgres-password.secret
      - postgres-database.secret
    ports:
      - "8302:8000"  # Public HTTPS API ONLY - external access (8302)
      # Admin API (9090) NOT exposed - internal 127.0.0.1 only
    command:
      - "server"
      - "--database-url=file:///run/secrets/postgres-url.secret"
      - "--config=/etc/identity-idp/config-pg-2.yml"
    volumes:
      - ../../configs/identity/idp-pg-2.yml:/etc/identity-idp/config-pg-2.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet",
             "--tries=1", "--spider",
             "https://127.0.0.1:9090/admin/api/v1/livez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      postgres-leader:
        condition: service_healthy
      identity-idp-pg-1:
        condition: service_healthy
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - identity-network
      - postgres-network
      - telemetry-network
    restart: unless-stopped
    labels:
      com.cryptoutil.service: "identity-idp"
      com.cryptoutil.backend: "postgresql"
      com.cryptoutil.instance: "2"
      com.cryptoutil.environment: "development"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

secrets:
  unseal-1of5.secret:
    file: ./secrets/unseal-1of5.secret
  unseal-2of5.secret:
    file: ./secrets/unseal-2of5.secret
  unseal-3of5.secret:
    file: ./secrets/unseal-3of5.secret
  unseal-4of5.secret:
    file: ./secrets/unseal-4of5.secret
  unseal-5of5.secret:
    file: ./secrets/unseal-5of5.secret
  postgres-url.secret:

  # Browser authentication credentials (web UI access)
  browser-username.secret:
    file: ./secrets/browser-username.secret
  browser-password.secret:
    file: ./secrets/browser-password.secret

  # Service authentication credentials (headless/API access)
  service-username.secret:
    file: ./secrets/service-username.secret
  service-password.secret:
    file: ./secrets/service-password.secret
    file: ./secrets/postgres-url.secret

networks:
  identity-network:
    driver: bridge
    name: identity-network
  postgres-network:
    driver: bridge
  telemetry-network:
    driver: bridge

# Note: Volumes are defined in ../shared-postgres/compose.yml (included above)
# No local volumes needed for this template
