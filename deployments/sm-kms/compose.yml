# $schema: https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json

#

# KMS Docker Compose Configuration

#

# This compose file provides the KMS (Key Management System) services.

# It includes shared telemetry services from deploymen../shared-telemetry/compose.yml.

#

# Usage:

#   docker compose -f compose.yml up -d

#

# Profiles:

#   - dev: Development mode (default) - SQLite backend, minimal services

#   - demo: Demo mode with seeded data, SQLite backend

#   - ci: CI mode for testing, SQLite backend

#   - postgres: PostgreSQL backend with multiple instances

#

include:

  - path: ../shared-telemetry/compose.yml
    - path: ../shared-postgres/compose.yml



services:

  # Healthcheck for Docker secrets availability.

  healthcheck-secrets:

    image: alpine:latest

    secrets:

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

      - postgres_url.secret

      - postgres_username.secret

      - postgres_password.secret

      - postgres_database.secret

    command: ["sh", "-c", "ls -l /run/secrets/*.secret"]

    networks:

      - kms-network



  # Build cryptoutil image from source.

  builder-cryptoutil:

    image: cryptoutil:dev

    build:

      context: ../../..

      dockerfile: deployments/sm-kms/Dockerfile

      args:

        APP_VERSION: "dev"

        VCS_REF: "local"

        BUILD_DATE: "2025-11-30T00:00:00Z"

    entrypoint: ["sh", "-c"]

    command: ["echo 'Build completed successfully'"]

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully



  # PostgreSQL database for KMS persistence.

  # See https://hub.docker.com/_/postgres#how-to-use-this-image

  sm-kms-db-postgres-1:

    image: postgres:18

    environment:

      POSTGRES_USER_FILE: /run/secrets/postgres_username.secret

      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password.secret

      POSTGRES_DB_FILE: /run/secrets/postgres_database.secret

    shm_size: 256mb

    ports:

      - "5432:5432"

    volumes:

      - postgres_data:/var/lib/postgresql

    secrets:

      - postgres_username.secret

      - postgres_password.secret

      - postgres_database.secret

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully

    healthcheck:

      test: ["CMD-SHELL", "pg_isready -U $(cat /run/secrets/postgres_username.secret) -d $(cat /run/secrets/postgres_database.secret)"]

      start_period: 5s

      interval: 5s

      timeout: 3s

      retries: 5

    networks:

      - kms-network

    deploy:

      resources:

        limits:

          memory: 512M

        reservations:

          memory: 256M



  # KMS server with SQLite backend (dev/demo/ci mode).

  kms-sqlite-1:

    image: cryptoutil:dev

    command: ["server", "start", "--config=/app/config/sm-kms-app-sqlite-1.yml", "--config=/app/config/sm-kms-app-common.yml", "--config=/app/otel/otel.yml"]

    working_dir: /tmp

    ports:

      - "8080:8080"  # HTTPS public

    volumes:

      - ./config/sm-kms-app-sqlite-1.yml:/app/config/sm-kms-app-sqlite-1.yml:ro

      - ./config/sm-kms-app-common.yml:/app/config/sm-kms-app-common.yml:ro

      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      # CRITICAL: ALL KMS instances MUST use the SAME unseal secrets

      # for shared encryption/decryption. NEVER use instance-specific secrets.

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully

      builder-cryptoutil:

        condition: service_completed_successfully

      opentelemetry-collector-contrib:

        condition: service_started

      healthcheck-opentelemetry-collector-contrib:

        condition: service_completed_successfully

    healthcheck:

      # Use wget (available in Alpine), not curl.

      # Use 127.0.0.1 (not localhost) - localhost may resolve to ::1 (IPv6) in containers.

      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 60s

      interval: 5s

      timeout: 5s

      retries: 10

    networks:

      - kms-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



  # KMS server with PostgreSQL backend (instance 1).

  kms-postgres-1:

    image: cryptoutil:dev

    command: ["server", "start", "--config=/app/config/sm-kms-app-postgresql-1.yml", "--config=/app/config/sm-kms-app-common.yml", "--config=/app/otel/otel.yml", "-u", "file:///run/secrets/postgres_url.secret"]

    working_dir: /tmp

    ports:

      - "8081:8080"  # HTTPS public

    volumes:

      - ./config/sm-kms-app-postgresql-1.yml:/app/config/sm-kms-app-postgresql-1.yml:ro

      - ./config/sm-kms-app-common.yml:/app/config/sm-kms-app-common.yml:ro

      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      # CRITICAL: ALL KMS instances MUST use the SAME unseal secrets.

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

      # PostgreSQL connection URL.

      - postgres_url.secret

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully

      builder-cryptoutil:

        condition: service_completed_successfully

      sm-kms-postgres-1:

        condition: service_healthy

      opentelemetry-collector-contrib:

        condition: service_started

      healthcheck-opentelemetry-collector-contrib:

        condition: service_completed_successfully

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 60s

      interval: 5s

      timeout: 5s

      retries: 5

    networks:

      - kms-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



  # KMS server with PostgreSQL backend (instance 2 - shared DB with instance 1).

  sm-kms-postgres-2:

    image: cryptoutil:dev

    command: ["server", "start", "--config=/app/config/sm-kms-app-postgresql-2.yml", "--config=/app/config/sm-kms-app-common.yml", "--config=/app/otel/otel.yml", "-u", "file:///run/secrets/postgres_url.secret"]

    working_dir: /tmp

    ports:

      - "8082:8080"  # HTTPS public

    volumes:

      - ./config/sm-kms-app-postgresql-2.yml:/app/config/sm-kms-app-postgresql-2.yml:ro

      - ./config/sm-kms-app-common.yml:/app/config/sm-kms-app-common.yml:ro

      - ../shared-telemetry/otel/cryptoutil-otel.yml:/app/otel/otel.yml:ro

    secrets:

      # CRITICAL: ALL KMS instances MUST use the SAME unseal secrets.

      - unseal_1of5.secret

      - unseal_2of5.secret

      - unseal_3of5.secret

      - unseal_4of5.secret

      - unseal_5of5.secret

      # PostgreSQL connection URL (shared with instance 1).

      - postgres_url.secret

    depends_on:

      healthcheck-secrets:

        condition: service_completed_successfully

      builder-cryptoutil:

        condition: service_completed_successfully

      sm-kms-postgres-2:

        condition: service_healthy

      opentelemetry-collector-contrib:

        condition: service_started

      healthcheck-opentelemetry-collector-contrib:

        condition: service_completed_successfully

      # Wait for instance 1 to initialize shared database.

      kms-postgres-1:

        condition: service_healthy

    healthcheck:

      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9090/admin/api/v1/livez"]

      start_period: 60s

      interval: 5s

      timeout: 5s

      retries: 5

    networks:

      - kms-network

      - telemetry-network

    deploy:

      resources:

        limits:

          memory: 256M

        reservations:

          memory: 128M



networks:

  kms-network:

    driver: bridge



volumes:

  postgres_data:

    name: kms-postgres-volume



secrets:

  # PostgreSQL secrets.

  postgres_username.secret:

    file: ./secrets/postgres_username.secret

  postgres_password.secret:

    file: ./secrets/postgres_password.secret

  postgres_database.secret:

    file: ./secrets/postgres_database.secret

  postgres_url.secret:

    file: ./secrets/postgres_url.secret



  # Unseal secrets (MUST be identical across all KMS instances).

  # CRITICAL: ALL cryptoutil instances MUST use the SAME unseal secrets

  # to enable shared encryption/decryption of data in the database.

  # NEVER create instance-specific secrets - breaks cryptographic interoperability.

  unseal_1of5.secret:

    file: ./secrets/unseal_1of5.secret # pragma: allowlist secret

  unseal_2of5.secret:

    file: ./secrets/unseal_2of5.secret

  unseal_3of5.secret:

    file: ./secrets/unseal_3of5.secret

  unseal_4of5.secret:

    file: ./secrets/unseal_4of5.secret

  unseal_5of5.secret:

    file: ./secrets/unseal_5of5.secret
