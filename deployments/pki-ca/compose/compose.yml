# CA Infrastructure Docker Compose
# For development and testing only - not for production use

services:
  # PostgreSQL database for certificate storage
  ca-database:
    image: postgres:18
    container_name: ca-database
    environment:
      POSTGRES_DB: ca
      POSTGRES_USER: ca
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - ca-db-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ca -d ca"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ca-network

  # Intermediate CA service
  ca-intermediate:
    build:
      context: ../../../
      dockerfile: deployments/pki-ca/compose/Dockerfile.pki-ca
      args:
        CA_TYPE: intermediate
    container_name: ca-intermediate
    depends_on:
      ca-database:
        condition: service_healthy
    environment:
      - CA_TYPE=intermediate
      - CA_DATABASE_HOST=ca-database
      - CA_DATABASE_PORT=5432
      - CA_DATABASE_NAME=ca
      - CA_DATABASE_USER=ca
    secrets:
      - db_password
      - ca_key_password
    volumes:
      - ca-intermediate-data:/app/data
      - ../../../configs/ca:/app/configs:ro
    ports:
      - "8443:8443"
      - "9443:9443"
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9443/livez"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ca-network

  # Issuing CA service
  ca-issuing:
    build:
      context: ../../../
      dockerfile: deployments/pki-ca/compose/Dockerfile.pki-ca
      args:
        CA_TYPE: issuing
    container_name: ca-issuing
    depends_on:
      ca-intermediate:
        condition: service_healthy
    environment:
      - CA_TYPE=issuing
      - CA_DATABASE_HOST=ca-database
      - CA_DATABASE_PORT=5432
      - CA_DATABASE_NAME=ca
      - CA_DATABASE_USER=ca
      - CA_PARENT_URL=https://ca-intermediate:8443
    secrets:
      - db_password
      - ca_key_password
    volumes:
      - ca-issuing-data:/app/data
      - ../../../configs/ca:/app/configs:ro
    ports:
      - "8444:8443"
      - "9444:9443"
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "-q", "-O", "/dev/null", "https://127.0.0.1:9443/livez"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ca-network

  # OCSP Responder
  ca-ocsp:
    build:
      context: ../../../
      dockerfile: deployments/pki-ca/compose/Dockerfile.ocsp
    container_name: ca-ocsp
    depends_on:
      ca-database:
        condition: service_healthy
    environment:
      - CA_DATABASE_HOST=ca-database
      - CA_DATABASE_PORT=5432
      - CA_DATABASE_NAME=ca
      - CA_DATABASE_USER=ca
    secrets:
      - db_password
      - ocsp_key_password
    volumes:
      - ca-ocsp-data:/app/data
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ca-network

  # CRL Distribution Point
  ca-crl:
    image: nginx:alpine
    container_name: ca-crl
    volumes:
      - ca-crl-data:/usr/share/nginx/html:ro
      - ./nginx-crl.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8081:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ca-network

networks:
  ca-network:
    driver: bridge

volumes:
  ca-db-data:
  ca-intermediate-data:
  ca-issuing-data:
  ca-ocsp-data:
  ca-crl-data:

secrets:
  db_password:
    file: ./secrets/db_password.secret
  ca_key_password:
    file: ./secrets/ca_key_password.secret
  ocsp_key_password:
    file: ./secrets/ocsp_key_password.secret
