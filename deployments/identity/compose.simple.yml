# Identity Simple Compose Configuration
#
# Usage: docker compose -f deployments/identity/compose.simple.yml up -d
#
# This configuration is for demonstration purposes only.
# It includes SQLite backend with demo data auto-seeding.
#
# Demo credentials (WARNING: Never use in production):
# - demo-client / demo-secret (OAuth client)
# - demo-user / demo-password (User login)
#
# Demo endpoints:
# - AuthZ Server: https://localhost:8100
# - Token Endpoint: https://localhost:8100/oauth2/token
# - JWKS Endpoint: https://localhost:8100/.well-known/jwks.json
# - Grafana: http://localhost:3000 (admin/admin)

name: cryptoutil-identity-demo

include:
  - path: ../telemetry/compose.yml

services:
  # Identity AuthZ Demo Server (SQLite backend with demo seeding).
  identity-authz-demo:
    build:
      context: ../..
      dockerfile: deployments/identity/Dockerfile.authz
      args:
        APP_VERSION: demo
        VCS_REF: demo
        BUILD_DATE: "2025-01-01T00:00:00Z"
    image: cryptoutil-identity-authz:demo
    container_name: identity-authz-demo
    hostname: identity-authz-demo
    command:
      - --config=/etc/identity/authz-demo.yml
    ports:
      - "8100:8100"  # AuthZ API (HTTPS)
    volumes:
      - ./config/authz-demo.yml:/etc/identity/authz-demo.yml:ro
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://opentelemetry-collector-contrib:4317
      - OTEL_SERVICE_NAME=identity-authz-demo
      - OTEL_RESOURCE_ATTRIBUTES=service.version=demo,deployment.environment=demo
    healthcheck:
      test:
        - CMD
        - wget
        - --no-check-certificate
        - -q
        - -O
        - /dev/null
        - https://127.0.0.1:9090/admin/api/v1/livez
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    profiles:
      - demo

  # Identity IdP Demo Server (SQLite backend with demo seeding).
  identity-idp-demo:
    build:
      context: ../..
      dockerfile: deployments/identity/Dockerfile.idp
      args:
        APP_VERSION: demo
        VCS_REF: demo
        BUILD_DATE: "2025-01-01T00:00:00Z"
    image: cryptoutil-identity-idp:demo
    container_name: identity-idp-demo
    hostname: identity-idp-demo
    command:
      - --config=/etc/identity/idp-demo.yml
    ports:
      - "8101:8100"  # IdP API (HTTPS) - uses different host port to avoid conflict with authz
    volumes:
      - ./config/idp-demo.yml:/etc/identity/idp-demo.yml:ro
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://opentelemetry-collector-contrib:4317
      - OTEL_SERVICE_NAME=identity-idp-demo
      - OTEL_RESOURCE_ATTRIBUTES=service.version=demo,deployment.environment=demo
    healthcheck:
      test:
        - CMD
        - wget
        - --no-check-certificate
        - -q
        - -O
        - /dev/null
        - https://127.0.0.1:9090/admin/api/v1/livez
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    profiles:
      - demo

  # Identity RS Demo Server (SQLite backend with demo seeding).
  identity-rs-demo:
    build:
      context: ../..
      dockerfile: deployments/identity/Dockerfile.rs
      args:
        APP_VERSION: demo
        VCS_REF: demo
        BUILD_DATE: "2025-01-01T00:00:00Z"
    image: cryptoutil-identity-rs:demo
    container_name: identity-rs-demo
    hostname: identity-rs-demo
    command:
      - --config=/etc/identity/rs-demo.yml
    ports:
      - "8110:8110"  # RS API (HTTPS)
    volumes:
      - ./config/rs-demo.yml:/etc/identity/rs-demo.yml:ro
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://opentelemetry-collector-contrib:4317
      - OTEL_SERVICE_NAME=identity-rs-demo
      - OTEL_RESOURCE_ATTRIBUTES=service.version=demo,deployment.environment=demo
    healthcheck:
      test:
        - CMD
        - wget
        - --no-check-certificate
        - -q
        - -O
        - /dev/null
        - https://127.0.0.1:9090/admin/api/v1/livez
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      opentelemetry-collector-contrib:
        condition: service_started
    networks:
      - cryptoutil-network
      - telemetry-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    profiles:
      - demo

networks:
  cryptoutil-network:
    driver: bridge
