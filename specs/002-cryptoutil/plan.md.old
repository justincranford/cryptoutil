# cryptoutil Implementation Plan

**Version**: 2.0
**Date**: December 24, 2025
**Status**: Active
**Source Documents**: constitution.md, spec.md, clarify.md

---

## Table of Contents

1. [Overview](#overview)
2. [Current State Assessment](#current-state-assessment)
3. [Phase 1: Foundation (Completed)](#phase-1-foundation-completed)
4. [Phase 2: Service Template Extraction](#phase-2-service-template-extraction)
5. [Phase 3: Cipher-InstantMessenger Demonstration Service](#phase-3-cipher-instantmessenger-demonstration-service)
6. [Phase 4: Migrate jose-ja to Template](#phase-4-migrate-jose-ja-to-template)
7. [Phase 5: Migrate pki-ca to Template](#phase-5-migrate-pki-ca-to-template)
8. [Phase 6: Identity Services Enhancement](#phase-6-identity-services-enhancement)
9. [Phase 7: Advanced Identity Features](#phase-7-advanced-identity-features)
10. [Phase 8: Scale & Multi-Tenancy](#phase-8-scale--multi-tenancy)
11. [Phase 9: Production Readiness](#phase-9-production-readiness)
12. [Dependencies & Critical Path](#dependencies--critical-path)
13. [Success Criteria](#success-criteria)
14. [Risk Management](#risk-management)

---

## Overview

### Project Goals

cryptoutil delivers four working products (9 services total) that can be deployed independently or together:

| Product | Services | Status |
|---------|----------|--------|
| **P1: JOSE** | 1 service (jose-ja) | ⚠️ PARTIAL - Missing admin server |
| **P2: Identity** | 5 services (authz, idp, rs, rp, spa) | ⚠️ MIXED - authz/idp/rs complete, rp/spa not started |
| **P3: KMS** | 1 service (sm-kms) | ✅ COMPLETE - Reference implementation |
| **P4: CA** | 1 service (pki-ca) | ⚠️ PARTIAL - Missing admin server |
| **Demo: Cipher** | 1 service (cipher-im) | ❌ NOT STARTED - Phase 3 deliverable |

**Total**: 9 services across 5 products

**Notes**:

- jose-ja is the service name for "JWK Authority" (JA), part of the JOSE product family
- cipher-im is the service name for "Cipher-InstantMessenger" (IM), encrypted messaging demonstration

### Architecture Mandates (Constitution)

**CGO Ban** (CRITICAL):

- CGO_ENABLED=0 MANDATORY for all builds, tests, Docker, production
- ONLY EXCEPTION: Race detector workflow requires CGO_ENABLED=1
- NEVER use CGO-dependent packages (e.g., github.com/mattn/go-sqlite3)
- ALWAYS use CGO-free alternatives (e.g., modernc.org/sqlite)

**Dual-Server Architecture** (ALL Services):

- Public HTTPS Server: `<configurable_address>:<configurable_port>` (default: 127.0.0.1 in tests, 0.0.0.0 in containers)
- Private HTTPS Server: 127.0.0.1:9090 (admin endpoints, ALL services use same port)
- Admin Port Configuration: 127.0.0.1:9090 inside container (NEVER exposed to host), or 127.0.0.1:0 for tests (dynamic allocation)
- Admin Endpoints: `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
- Note: Admin port is configurable but low priority - focus on public server configurability

**Session State Management**:

- SQL-backed ONLY (PostgreSQL or SQLite) - NO Redis
- Three formats: JWS (stateless signed), OPAQUE (database lookup), JWE (encrypted)
- Implementation priority: JWS → OPAQUE → JWE
- Deployment priority: JWE → OPAQUE → JWS

**Database Architecture**:

- PostgreSQL (multi-service deployments in prod||dev) + SQLite (standalone-service deployments in prod||dev)
- Choice based on deployment type (multi-service vs standalone), NOT environment (prod vs dev)
- Database sharding: Phase 8 with tenant ID partitioning
- Multi-tenancy (Dual-Layer Isolation):
  - Layer 1 (PostgreSQL + SQLite): Per-row tenant_id column (UUIDv4, FK to tenants.id) in all tables
  - Layer 2 (PostgreSQL only): Schema-level isolation (CREATE SCHEMA tenant_<UUID>)
  - NEVER use row-level security (RLS) - per-row tenant_id + schema isolation provides sufficient protection
- Connection pools: Configurable, hot-reloadable
- Read replicas: NOT SUPPORTED - all reads to primary only

**mTLS Revocation Checking**:

- BOTH CRLDP and OCSP REQUIRED
- CRLDP: Immediate sign and publish to HTTPS URL (NOT batched), one serial number per URL
  - URL format: `https://crl.example.com/<base64-url-encoded-serial>.crl`
  - NEVER batch multiple serials into one CRL file
- OCSP: Responder required, stapling nice-to-have

**Unseal Secrets**:

- Support BOTH strategies: (1) Key derivation via HKDF, (2) Pre-generated JWKs
- Configuration-driven selection per deployment

**Pepper Rotation**:

- Lazy migration strategy: Re-hash ONLY on re-authentication
- NO forced batch migration or user re-authentication

**Testing Requirements**:

- Test concurrency: ALWAYS concurrent (NEVER `-p=1`)
- Race detector: Keep probabilistic execution enabled
- E2E coverage: BOTH `/service/*` and `/browser/*` paths
- Mutation exemptions: OpenAPI + GORM + protobuf

**Federation**:

- Timeouts: Per-service configurable (identity_timeout, jose_timeout, ca_timeout)
- API versioning: N-1 backward compatibility required
- DNS: NO caching - lookup every request
- Fallback mode (production): `reject_all` MANDATORY

**Health Checks**:

- Kubernetes: livez failure → restart pod, readyz failure → remove from LB
- Docker: livez/readyz failure → mark unhealthy, continue running

**Telemetry**:

- Sampling: Tail-based default (errors + slow requests + 10% random)
- All strategies in OTLP config (head-based, attribute-based commented)
- Push-only via OTLP (NEVER scrape/pull patterns)

---

## Current State Assessment

### Service Catalog Status

| Service | Public Server | Admin Server | Unified CMD | Docker Compose | Tests | Coverage |
|---------|---------------|--------------|-------------|----------------|-------|----------|
| **sm-kms** | ✅ Complete | ✅ Port 9090 | ✅ cryptoutil kms | ✅ 3 instances | ✅ All pass | ≥95% |
| **pki-ca** | ✅ Complete | ❌ Missing | ❌ No cmd | ⚠️ Dev only | ✅ All pass | ≥95% |
| **jose-ja** | ✅ Complete | ❌ Missing | ❌ No cmd | ⚠️ Needs update | ✅ All pass | ≥95% |
| **identity-authz** | ✅ Complete | ✅ Port 9090 | ❌ No cmd | ✅ Working | ✅ All pass | ≥95% |
| **identity-idp** | ✅ Complete | ✅ Port 9090 | ❌ No cmd | ✅ Working | ✅ All pass | ≥95% |
| **identity-rs** | ✅ Complete | ✅ Port 9090 | ❌ No cmd | ✅ Working | ✅ All pass | ≥95% |
| **identity-rp** | ❌ Not started | ❌ Not started | ❌ No cmd | ❌ No compose | ❌ No tests | 0% |
| **identity-spa** | ❌ Not started | ❌ Not started | ❌ No cmd | ❌ No compose | ❌ No tests | 0% |
| **cipher-im** | ❌ Not started | ❌ Not started | ❌ No cmd | ❌ No compose | ❌ No tests | 0% |

### Infrastructure Status

| Component | Status | Notes |
|-----------|--------|-------|
| Dual HTTPS servers | ✅ KMS, ⚠️ Identity (partial), ❌ JOSE/CA | Admin servers missing for JOSE/CA |
| PostgreSQL + SQLite | ✅ Complete | Test-containers for CI/CD |
| OpenTelemetry | ✅ Complete | OTLP push, tail-based sampling |
| Docker Compose | ⚠️ Partial | KMS/Identity complete, JOSE/CA need updates |
| Health checks | ✅ Complete | livez/readyz on 127.0.0.1:909x |
| Unified CLI | ⚠️ KMS only | Need jose/ca/identity/cipher-im cmds |

### Quality Metrics

| Metric | Target | Current Status |
|--------|--------|----------------|
| Production coverage | ≥95% | ✅ Most packages meet target |
| Infrastructure coverage | ≥98% | ⚠️ cicd packages ~90% |
| Mutation score (Phase 4) | ≥85% | ⚠️ Not yet measured |
| Mutation score (Phase 5) | ≥98% | ⏳ Future phase |
| Test execution | <15s/package, <180s suite | ✅ Meeting targets |
| E2E tests | BOTH paths | ⚠️ `/service/*` only |

---

## Phase 1: Foundation (Completed)

**Timeline**: COMPLETED
**Objective**: Establish infrastructure, CGO-free architecture, dual-server pattern

### Completed Deliverables

#### 1.1 CGO-Free Architecture ✅

- **Status**: COMPLETE
- **Evidence**: All packages use modernc.org/sqlite
- **Validation**: All tests pass with CGO_ENABLED=0

#### 1.2 Dual-Server Pattern (KMS Reference) ✅

- **Status**: COMPLETE
- **Evidence**: sm-kms implements public (8080-8082) + admin (9090) servers
- **Components**:
  - Public HTTPS: `/browser/api/v1/*` and `/service/api/v1/*`
  - Admin HTTPS: `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
  - Docker health checks via admin endpoints

#### 1.3 Database Abstraction ✅

- **Status**: COMPLETE
- **Evidence**: PostgreSQL + SQLite dual support with GORM
- **Features**:
  - Test-containers for CI/CD
  - SQLite WAL mode, busy_timeout for concurrency
  - Migrations via golang-migrate

#### 1.4 OpenTelemetry Integration ✅

- **Status**: COMPLETE
- **Evidence**: OTLP push to collector, Grafana LGTM stack
- **Configuration**: Tail-based sampling (errors + slow + 10% random)

#### 1.5 Test Infrastructure ✅

- **Status**: COMPLETE
- **Evidence**: Table-driven tests, t.Parallel(), concurrent execution
- **Metrics**: <15s/package, <180s suite

### Gaps Identified

1. **Admin servers missing**: JOSE and CA lack admin servers (Phase 2.1)
2. **Unified CLI incomplete**: Only KMS has `cryptoutil kms` command (Phase 2.2)

## Phase 2: Service Template Extraction

**Timeline**: CURRENT PHASE
**Objective**: Extract reusable template from KMS, validate with cipher-im

**CRITICAL**: This phase MUST complete before any service migrations (Phases 3-6).

### Phase 2.1: Template Extraction

**Priority**: CRITICAL - Enables service consistency and reusability

#### Task 2.1.1: ServerTemplate Abstraction

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 14-21 days
- **Dependencies**: Phase 1 complete (KMS reference implementation)

**Deliverables**:

1. Template Packages

   ```
   internal/template/
   ├── server/
   │   ├── dual_https.go       # Public + Admin server management
   │   ├── router.go           # Route registration framework
   │   ├── middleware.go       # Pipeline builder
   │   └── lifecycle.go        # Start/stop/reload
   ├── client/
   │   ├── http_client.go      # HTTP client with mTLS/retry
   │   ├── auth.go             # OAuth 2.1/mTLS strategies
   │   └── codegen.go          # OpenAPI client generation
   └── repository/
       ├── dual_db.go          # PostgreSQL + SQLite
       ├── gorm_patterns.go    # Model registration
       └── transaction.go      # Transaction handling
   ```

2. Parameterization Points
   - Constructor injection for configuration, handlers, middleware
   - Interface-based customization for business logic
   - Configuration-driven behavior (YAML, CLI flags, Docker secrets)
   - Service-specific OpenAPI specs

3. Documentation
   - Template usage guide (README.md)
   - Customization examples (examples/)
   - Migration guide for existing services
   - Architecture decision records (ADRs)

**Acceptance Criteria**:

- [ ] Template extracted from KMS reference implementation
- [ ] All common patterns abstracted (dual HTTPS, database, telemetry, config)
- [ ] Documentation complete with examples
- [ ] Coverage ≥98% (infrastructure code)
- [ ] Mutation score ≥98%
- [ ] Ready for cipher-im validation (Phase 3)

---

## Phase 3: Cipher-IM Demonstration Service

**Timeline**: After Phase 2 complete
**Objective**: Validate template reusability with encrypted instant messaging service

**CRITICAL**: This is the FIRST real-world validation of the service template. All production service migrations (Phases 4-6) depend on successful cipher-im implementation.

### Phase 3.1: Cipher-IM Implementation

**Priority**: CRITICAL - Validates template before production migrations

#### Task 3.1.1: Instant Messenger Service

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 21-28 days
- **Dependencies**: Phase 2 complete (service template extracted)

**Deliverables**:

1. Service Implementation
   - **Service name**: cipher-im
   - **Ports**: 8888-8889 (public), 9090 (admin)
   - Encrypted messaging between users
   - PUT /tx API (send encrypted message)
   - GET /rx API (retrieve encrypted messages)
   - DELETE /tx and /rx APIs (delete messages)

2. Encryption Architecture
   - Message encryption: AES-256-GCM
   - Key agreement: ECDH (Elliptic Curve Diffie-Hellman)
   - Key wrapping: ECDH-AESGCMKW (JWE algorithm)
   - Password hashing: PBKDF2-HMAC-SHA256
   - Crypto libraries: internal/jose (JWE), internal/crypto (ECDH, AES-GCM, PBKDF2)

3. Database Schema

   ```sql
   CREATE TABLE users (
       id UUID PRIMARY KEY,
       username TEXT UNIQUE NOT NULL,
       password_hash TEXT NOT NULL,
       public_key_jwk JSONB NOT NULL,
       created_at TIMESTAMP NOT NULL,
       updated_at TIMESTAMP NOT NULL
   );

   CREATE TABLE messages (
       id UUID PRIMARY KEY,
       sender_id UUID NOT NULL REFERENCES users(id),
       encrypted_content TEXT NOT NULL,  -- JWE compact serialization
       created_at TIMESTAMP NOT NULL,
       expires_at TIMESTAMP NOT NULL
   );

   CREATE TABLE message_receivers (
       id UUID PRIMARY KEY,
       message_id UUID NOT NULL REFERENCES messages(id),
       receiver_id UUID NOT NULL REFERENCES users(id),
       read_at TIMESTAMP,
       deleted_at TIMESTAMP,
       UNIQUE(message_id, receiver_id)
   );
   ```

4. Service Template Usage
   - Instantiate ServerTemplate with cipher-im config
   - Register OpenAPI-generated routes
   - Apply middleware (CORS, CSRF, rate limiting)
   - Start dual HTTPS servers (public + admin)
   - Database abstraction (PostgreSQL || SQLite)
   - OpenTelemetry integration (traces, metrics, logs)

5. Docker Compose Deployment
   - `deployments/compose/cipher-im/compose.yml`
   - Health checks via admin endpoints
   - PostgreSQL + SQLite support
   - Grafana LGTM stack integration

6. Documentation
   - README with quick start guide
   - API documentation (OpenAPI spec)
   - Encryption architecture diagram
   - Tutorial: Building a service with the template (4 parts)
   - Video demonstration (optional)

**Template Validation Criteria**:

- [ ] cipher-im uses ONLY template infrastructure (NO custom dual-server code)
- [ ] All business logic cleanly separated from template
- [ ] Template supports different API patterns (PUT/GET/DELETE vs CRUD)
- [ ] No template blockers discovered during implementation
- [ ] Coverage ≥95% (service code), ≥98% (template usage)
- [ ] Mutation score ≥85%
- [ ] All E2E tests pass (BOTH `/service/**` and `/browser/**` paths)
- [ ] Docker Compose deployment works
- [ ] Deep analysis confirms template ready for production service migrations

---

## Phase 4: Migrate jose-ja to Template

**Timeline**: After Phase 3 complete (cipher-im validates template)
**Objective**: Migrate JOSE JWK Authority service to use extracted template

**CRITICAL**: First production service migration. Will drive template refinements for JOSE patterns.

### Phase 4.1: JA Service Migration

**Priority**: HIGH - First production template adoption

#### Task 4.1.1: JA Admin Server Implementation

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 5-7 days
- **Dependencies**: Phase 3 complete (template validated)

**Deliverables**:

1. Admin Server Using Template
   - Create `internal/jose/server/admin/` package
   - Use template for admin server (bind 127.0.0.1:9090)
   - Implement admin endpoints via template
     - `/admin/api/v1/livez` - Lightweight check
     - `/admin/api/v1/readyz` - Database + JWK validation
     - `/admin/api/v1/shutdown` - Graceful termination

2. Unified CLI Command
   - `cmd/cryptoutil/jose.go` - Main command
   - `cryptoutil jose start` - Start JA service
   - `cryptoutil jose version` - Version info
   - Configuration: YAML files + CLI flags + Docker secrets

3. Update Docker Compose
   - `deployments/compose/jose/compose.yml`
   - Health check: `wget --no-check-certificate -q -O /dev/null https://127.0.0.1:9090/admin/api/v1/livez`
   - start_period: 30s, interval: 5s, retries: 10

4. Template Refinements (if needed)
   - Document any JOSE-specific patterns
   - Update template if blockers discovered
   - Add ADRs for design decisions

**Acceptance Criteria**:

- [ ] JA admin server uses template
- [ ] `cryptoutil jose start` command works
- [ ] Docker health checks pass
- [ ] All tests pass (unit, integration, E2E)
- [ ] Coverage ≥95%, mutation ≥85%
- [ ] Template refined if needed (ADRs documented)

---

## Phase 5: Migrate pki-ca to Template

**Timeline**: After Phase 4 complete (JOSE migration)
**Objective**: Migrate PKI Certificate Authority service to use extracted template

**CRITICAL**: Second production service migration. Will drive template refinements for CA/PKI patterns.

### Phase 5.1: CA Service Migration

**Priority**: HIGH - Second production template adoption

#### Task 5.1.1: CA Admin Server Implementation

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 5-7 days
- **Dependencies**: Phase 4 complete (JOSE migrated)

**Deliverables**:

1. Admin Server Using Template
   - Create `internal/ca/server/admin/` package
   - Use template for admin server (bind 127.0.0.1:9090)
   - Implement admin endpoints via template
     - `/admin/api/v1/livez` - Lightweight check
     - `/admin/api/v1/readyz` - CA chain validation, OCSP responder check
     - `/admin/api/v1/shutdown` - Graceful termination

2. Unified CLI Command
   - `cmd/cryptoutil/ca.go` - Main command
   - `cryptoutil ca start` - Start CA service
   - `cryptoutil ca version` - Version info
   - Configuration: YAML files + CLI flags + Docker secrets

3. Update Docker Compose
   - `deployments/compose/ca/compose.yml`
   - Health check: `wget --no-check-certificate -q -O /dev/null https://127.0.0.1:9090/admin/api/v1/livez`
   - start_period: 30s, interval: 5s, retries: 10

4. Template Refinements (if needed)
   - Document any CA/PKI-specific patterns
   - Update template if blockers discovered
   - Add ADRs for design decisions

**Acceptance Criteria**:

- [ ] CA admin server uses template
- [ ] `cryptoutil ca start` command works
- [ ] Docker health checks pass
- [ ] All tests pass (unit, integration, E2E)
- [ ] Coverage ≥95%, mutation ≥85%
- [ ] Template refined if needed (ADRs documented)
- [ ] Template now battle-tested with 3 different service patterns (cipher-im, JOSE, CA)

---

## Phase 6: Identity Services Enhancement

**Timeline**: After Phases 2-5 complete (template mature)
**Objective**: Complete identity services admin servers, unified CLI, E2E coverage, migrate to template

**CRITICAL**: Identity services migrate LAST to benefit from mature, battle-tested template refined by cipher-im, JOSE, and CA migrations.

### Phase 6.1: Admin Server Implementation

**Priority**: HIGH - Blocking unified CLI and production deployments

#### Task 6.1.1: Identity Service Admin Servers

- **Status**: ⚠️ PARTIAL - authz, idp, rs have admin servers
- **Estimated Effort**: 7-10 days (rp + spa admin servers)
- **Dependencies**: Phase 5 complete (CA migrated, template mature)

**Deliverables**:

1. RP (Relying Party) Admin Server
   - Use template for admin server (bind 127.0.0.1:9090)
   - `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
   - Readyz: OAuth 2.1 provider connectivity check

2. SPA (Single Page Application) Admin Server
   - Use template for admin server (bind 127.0.0.1:9090)
   - `/admin/api/v1/livez`, `/admin/api/v1/readyz`, `/admin/api/v1/shutdown`
   - Readyz: Backend API connectivity check

3. Migrate Existing Identity Services (authz, idp, rs) to Template
   - Refactor to use template infrastructure
   - Remove duplicate dual-server code
   - Use template database, telemetry, config patterns

**Acceptance Criteria**:

- [ ] All 5 identity services use template
- [ ] All admin servers bind to 127.0.0.1:9090
- [ ] Docker health checks pass for all services
- [ ] Coverage ≥95%, mutation ≥85%

### Phase 6.2: Unified CLI

**Priority**: MEDIUM - Improves developer experience

#### Task 6.2.1: Identity CLI Commands

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 3-5 days
- **Dependencies**: Phase 6.1 complete

**Deliverables**:

1. CLI Commands
   - `cryptoutil identity-authz start`
   - `cryptoutil identity-idp start`
   - `cryptoutil identity-rs start`
   - `cryptoutil identity-rp start`
   - `cryptoutil identity-spa start`

2. Unified Configuration
   - YAML config files
   - CLI flags override
   - Docker secrets support

**Acceptance Criteria**:

- [ ] All identity services startable via `cryptoutil` CLI
- [ ] Configuration hierarchy works (YAML < CLI < secrets)
- [ ] Documentation updated

### Phase 6.3: E2E Path Coverage

**Priority**: MEDIUM - Compliance requirement

#### Task 6.3.1: Browser Path Tests

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 5-7 days

**Deliverables**:

1. `/browser/**` E2E Tests
   - CSRF protection validation
   - CORS policy enforcement
   - CSP header verification
   - Session cookie handling

2. Middleware Verification
   - IP allowlist (both paths)
   - Rate limiting (both paths)
   - Request logging (both paths)

**Acceptance Criteria**:

- [ ] BOTH `/service/**` and `/browser/**` paths tested
- [ ] Middleware behavior verified for each path
- [ ] Coverage ≥95%

---

## Phase 7: Advanced Identity Features

**Timeline**: After Phase 6 complete
**Objective**: MFA, WebAuthn, advanced authn/authz features

### Phase 7.1: Multi-Factor Authentication

**Priority**: HIGH - Security requirement

#### Task 7.1.1: TOTP (Time-Based One-Time Password)

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 7-10 days

**Deliverables**:

1. TOTP Implementation
   - QR code enrollment
   - Code verification
   - Backup codes
   - Recovery flow

**Acceptance Criteria**:

- [ ] TOTP enrollment works
- [ ] 6-digit codes validated
- [ ] 30-minute MFA step-up enforced
- [ ] Coverage ≥95%

### Phase 7.2: WebAuthn

**Priority**: MEDIUM - Modern authn

#### Task 7.2.1: WebAuthn Registration & Authentication

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 14-21 days

**Deliverables**:

1. WebAuthn Support
   - Registration ceremony
   - Authentication ceremony
   - Credential management
   - Browser compatibility

**Acceptance Criteria**:

- [ ] WebAuthn registration works
- [ ] WebAuthn authentication works
- [ ] Cross-browser tested
- [ ] Coverage ≥95%

---

## Phase 8: Scale & Multi-Tenancy

**Timeline**: After Phase 7 complete
**Objective**: Database sharding, connection pool tuning, multi-tenant isolation

### Phase 8.1: Database Sharding

**Priority**: MEDIUM - Performance optimization

#### Task 8.1.1: Tenant ID Partitioning

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 14-21 days

**Deliverables**:

1. Sharding Implementation
   - Tenant ID-based sharding
   - Shard routing logic
   - Cross-shard queries (if needed)

2. Multi-Tenancy Enhancements
   - Per-row tenant_id (PostgreSQL + SQLite)
   - Schema-level isolation (PostgreSQL only)
   - Tenant provisioning APIs

**Acceptance Criteria**:

- [ ] Sharding reduces query latency
- [ ] Multi-tenancy isolation verified
- [ ] Coverage ≥95%

---

## Phase 9: Production Readiness

**Timeline**: After Phase 8 complete
**Objective**: Production hardening, monitoring, compliance

### Phase 9.1: Security Hardening

**Priority**: CRITICAL - Production requirement

#### Task 9.1.1: Security Audit

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 7-10 days

**Deliverables**:

1. SAST/DAST Scanning
   - Nuclei scans (info, low, medium, high, critical)
   - OWASP ZAP active scans
   - Dependency vulnerability scans

2. Penetration Testing
   - Authentication bypass attempts
   - Authorization escalation attempts
   - Injection attacks (SQL, command, etc.)

**Acceptance Criteria**:

- [ ] Zero HIGH/CRITICAL vulnerabilities
- [ ] All MEDIUM vulnerabilities mitigated or accepted with risk assessment
- [ ] Penetration test report clean

### Phase 9.2: Production Monitoring

**Priority**: HIGH - Operational requirement

#### Task 9.2.1: Observability Enhancement

- **Status**: ❌ NOT STARTED
- **Estimated Effort**: 5-7 days

**Deliverables**:

1. Dashboards
   - Service health (livez/readyz status)
   - Request rates, latencies
   - Error rates by endpoint
   - Database connection pool metrics

2. Alerting
   - SLA violations (p95 latency > threshold)
   - Error rate spikes
   - Health check failures

**Acceptance Criteria**:

- [ ] Grafana dashboards deployed
- [ ] Alerts configured
- [ ] Runbooks documented

---

## Dependencies & Critical Path

### Phase Dependencies

```
Phase 1 (Foundation) ✅
  ↓
Phase 2 (Template Extraction) ← CURRENT PHASE, BLOCKING ALL MIGRATIONS
  ↓
Phase 3 (cipher-im) ← VALIDATES TEMPLATE, CRITICAL BLOCKER FOR PRODUCTION MIGRATIONS
  ↓
Phase 4 (jose-ja Migration) ← First production migration
  ↓
Phase 5 (pki-ca Migration) ← Second production migration
  ↓
Phase 6 (Identity Enhancement) ← Third production migration (LAST, benefits from mature template)
  ↓
Phase 7 (Advanced Features) ← MFA, WebAuthn
  ↓
Phase 8 (Scale & Multi-Tenancy) ← Performance optimization
  ↓
Phase 9 (Production Readiness) ← Security hardening, monitoring
```

### Critical Path

1. **Phase 2 Template Extraction** (BLOCKING) - 14-21 days
   - Blocks ALL service migrations (Phases 3-6)
   - Highest priority after Phase 1 completion

2. **Phase 3 cipher-im Validation** (CRITICAL) - 21-28 days
   - MUST succeed before any production service migrations
   - Validates template with real-world service
   - Drives template refinements

3. **Phases 4-5 Production Migrations** - 10-14 days (sequential)
   - jose-ja (Phase 4): 5-7 days
   - pki-ca (Phase 5): 5-7 days
   - Sequential to allow template refinements between migrations

4. **Phase 6 Identity Migration** - 15-22 days
   - Benefits from mature template (refined by cipher-im, JOSE, CA)
   - Largest migration (5 services)

**Total Critical Path**: ~60-85 days (Phases 2-6)

---

## Success Criteria

### Phase 2 Success Criteria

- [ ] Service template extracted and documented
- [ ] Coverage ≥98%, mutation ≥98%
- [ ] Ready for cipher-im validation

### Phase 3 Success Criteria

- [ ] cipher-im service implemented using template
- [ ] NO template blockers discovered
- [ ] Coverage ≥95%, mutation ≥85%
- [ ] E2E tests pass (BOTH paths)

### Phases 4-5 Success Criteria

- [ ] jose-ja and pki-ca migrated to template
- [ ] Template refined based on migration learnings
- [ ] Coverage ≥95%, mutation ≥85%

### Phase 6 Success Criteria

- [ ] All 5 identity services migrated to template
- [ ] Unified CLI complete
- [ ] E2E coverage complete (BOTH paths)
- [ ] Coverage ≥95%, mutation ≥85%

### Overall Success Criteria

- [ ] All 8 production services use template
- [ ] Coverage ≥95% (production), ≥98% (infrastructure)
- [ ] Mutation score ≥85% (early phases), ≥98% (later phases)
- [ ] Docker Compose deployments work for all services
- [ ] Unified CLI for all services
- [ ] Production ready (security, monitoring, compliance)

---

## Risk Management

### High Risks

1. **Template Extraction Complexity** (Phase 2)
   - Risk: Abstraction too rigid or too flexible
   - Mitigation: cipher-im validation (Phase 3) before production migrations
   - Impact: Could delay all migrations (Phases 4-6)

2. **cipher-im Validation Failures** (Phase 3)
   - Risk: Template blockers discovered during implementation
   - Mitigation: Deep analysis and template refinement cycle
   - Impact: Could require Phase 2 rework

3. **Migration Coordination** (Phases 4-6)
   - Risk: Services drift from template during sequential migrations
   - Mitigation: Sequential migrations with template updates between phases
   - Impact: Inconsistent service implementations

### Medium Risks

1. **E2E Path Coverage** (Phase 6.3)
   - Risk: `/browser/**` middleware interactions complex
   - Mitigation: Reference KMS implementation
   - Impact: Could delay Phase 6 completion

2. **MFA Integration** (Phase 7)
   - Risk: 30-minute step-up conflicts with session duration
   - Mitigation: Configurable step-up window
   - Impact: Could require session architecture changes

### Low Risks

1. **Database Sharding** (Phase 8)
   - Risk: Cross-shard queries impact performance
   - Mitigation: Minimize cross-shard operations
   - Impact: Limited to multi-tenant deployments

### Risk Monitoring

- Weekly risk review during Phases 2-6
- Template refinement ADRs documented
- Migration post-mortems after each phase
