openapi: 3.0.3
info:
  title: OAuth 2.1 Authorization Server API
  version: 1.0.0
  description: |
    OAuth 2.1 and OpenID Connect Authorization Server providing:
    - Authorization code flow with mandatory PKCE
    - Token endpoint for code/refresh/client_credentials grants
    - Health check endpoint for monitoring
  contact:
    name: Identity Team
    email: identity@cryptoutil.local

servers:
  - url: https://localhost:8080
    description: Local Development (SQLite)
  - url: https://localhost:8081
    description: Local Development (PostgreSQL Instance 1)
  - url: https://localhost:8082
    description: Local Development (PostgreSQL Instance 2)
  - url: https://authz.cryptoutil.local
    description: Production

paths:
  /oauth2/v1/authorize:
    get:
      summary: OAuth 2.1 Authorization Request (Initial)
      description: |
        Initiate OAuth 2.1 authorization code flow with mandatory PKCE.
        Accepts authorization parameters as query parameters.
        Validates client, redirect_uri, and code_challenge.
        Redirects to IdP login if user not authenticated, or to consent form if authenticated.
        This is the standard OAuth 2.1 authorization endpoint used by clients to start the flow.
      operationId: authorizeGET
      tags:
        - OAuth 2.1
      parameters:
        - name: response_type
          in: query
          required: true
          schema:
            type: string
            enum: [code]
          description: Must be "code" for authorization code flow
          example: code
        - name: client_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: Registered OAuth 2.0 client identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        - name: redirect_uri
          in: query
          required: true
          schema:
            type: string
            format: uri
          description: Client redirect URI (must match registered value)
          example: "https://client.example.com/callback"
        - name: scope
          in: query
          required: false
          schema:
            type: string
          description: Space-delimited scope values (e.g., "openid profile email")
          example: "openid profile email"
        - name: state
          in: query
          required: false
          schema:
            type: string
          description: Opaque value for CSRF protection
          example: "xyz"
        - name: code_challenge
          in: query
          required: true
          schema:
            type: string
            minLength: 43
            maxLength: 128
          description: PKCE code challenge (base64url-encoded SHA256 hash of code_verifier)
          example: "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM"
        - name: code_challenge_method
          in: query
          required: true
          schema:
            type: string
            enum: [S256]
          description: Must be "S256" (SHA256 hash)
          example: S256
      responses:
        '302':
          description: |
            Redirect to IdP login (if user not authenticated) or consent form (if authenticated).
            Location header contains target URL with return_url parameter for continuation.
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: IdP login URL or consent form URL with return_url parameter
              example: "https://idp.example.com/oidc/v1/login?return_url=https://authz.example.com/oauth2/v1/continue"
        '400':
          $ref: '#/components/responses/OAuth2Error'
        '401':
          $ref: '#/components/responses/OAuth2Error'

    post:
      summary: OAuth 2.1 Authorization Request
      description: |
        Initiate OAuth 2.1 authorization code flow with mandatory PKCE.
        Validates client, redirect_uri, and code_challenge.
        Redirects to IdP login if user not authenticated, or to redirect_uri with authorization code if authenticated.
      operationId: authorize
      tags:
        - OAuth 2.1
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - response_type
                - client_id
                - redirect_uri
                - code_challenge
                - code_challenge_method
              properties:
                response_type:
                  type: string
                  enum: [code]
                  description: Must be "code" for authorization code flow
                  example: code
                client_id:
                  type: string
                  format: uuid
                  description: Registered OAuth 2.0 client identifier
                  example: "550e8400-e29b-41d4-a716-446655440000"
                redirect_uri:
                  type: string
                  format: uri
                  description: Client redirect URI (must match registered value)
                  example: "https://client.example.com/callback"
                scope:
                  type: string
                  description: Space-delimited scope values (e.g., "openid profile email")
                  example: "openid profile email"
                state:
                  type: string
                  description: Opaque value for CSRF protection
                  example: "xyz"
                code_challenge:
                  type: string
                  minLength: 43
                  maxLength: 128
                  description: PKCE code challenge (base64url-encoded SHA256 hash of code_verifier)
                  example: "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM"
                code_challenge_method:
                  type: string
                  enum: [S256]
                  description: Must be "S256" (SHA256 hash)
                  example: S256
      responses:
        '302':
          description: |
            Redirect to IdP login (if user not authenticated) or redirect_uri with authorization code (if authenticated)
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: IdP login URL or redirect_uri with code and state parameters
              example: "https://idp.example.com/login?return_url=https://authz.example.com/continue"
        '400':
          $ref: '#/components/responses/OAuth2Error'
        '401':
          $ref: '#/components/responses/OAuth2Error'

  /oauth2/v1/token:
    post:
      summary: OAuth 2.1 Token Endpoint
      description: |
        Exchange authorization code, refresh token, or client credentials for access token.
        Supports grant types: authorization_code, refresh_token, client_credentials.
        Validates PKCE code_verifier for authorization_code grants.
      operationId: token
      tags:
        - OAuth 2.1
      security:
        - clientBasicAuth: []
        - clientSecretPost: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - grant_type
              properties:
                grant_type:
                  type: string
                  enum: [authorization_code, refresh_token, client_credentials]
                  description: OAuth 2.0 grant type
                  example: authorization_code
                code:
                  type: string
                  description: Authorization code (required for authorization_code grant)
                  example: "auth_code_example_1234567890"
                redirect_uri:
                  type: string
                  format: uri
                  description: Client redirect URI (must match authorize request)
                  example: "https://client.example.com/callback"
                code_verifier:
                  type: string
                  minLength: 43
                  maxLength: 128
                  description: PKCE code verifier (required for authorization_code grant)
                  example: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"
                refresh_token:
                  type: string
                  description: Refresh token (required for refresh_token grant)
                  example: "refresh_token_example_1234567890"
                scope:
                  type: string
                  description: Space-delimited scope values (optional, for narrowing access)
                  example: "openid profile"
      responses:
        '200':
          description: Successful token response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthZTokenResponse'
        '400':
          $ref: '#/components/responses/OAuth2Error'
        '401':
          $ref: '#/components/responses/OAuth2Error'

  /oauth2/v1/introspect:
    post:
      summary: Token Introspection Endpoint (RFC 7662)
      description: |
        Validate and retrieve metadata for access/refresh tokens.
        Requires client authentication. Returns active status and token claims.
      operationId: introspect
      tags:
        - OAuth 2.1
      security:
        - clientBasicAuth: []
        - clientSecretPost: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: Access or refresh token to introspect
                  example: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
                  description: Hint about token type to optimize lookup
                  example: "access_token"
      responses:
        '200':
          description: Token introspection result (active or inactive)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntrospectionResponse'
        '401':
          description: Client authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'

  /oauth2/v1/revoke:
    post:
      summary: Token Revocation Endpoint (RFC 7009)
      description: |
        Revoke access or refresh token. Requires client authentication.
        Revoking a refresh token also revokes all associated access tokens.
      operationId: revoke
      tags:
        - OAuth 2.1
      security:
        - clientBasicAuth: []
        - clientSecretPost: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: Access or refresh token to revoke
                  example: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
                  description: Hint about token type to optimize lookup
                  example: "access_token"
      responses:
        '200':
          description: Token revocation successful or token already invalid
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Token revoked successfully"
        '401':
          description: Client authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuth2Error'

  /health:
    get:
      summary: Health Check
      description: Service health status including database connectivity
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /oidc/v1/mfa/totp/enroll:
    post:
      summary: Enroll TOTP MFA
      description: |
        Enroll Time-based One-Time Password (TOTP) multi-factor authentication for a user.
        Returns TOTP secret, QR code, and backup codes for account recovery.
      operationId: enrollTOTP
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TOTPEnrollRequest'
      responses:
        '200':
          description: TOTP MFA enrolled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TOTPEnrollResponse'
        '400':
          description: Invalid request (missing user_id or user already enrolled)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /oidc/v1/mfa/totp/verify:
    post:
      summary: Verify TOTP Code
      description: |
        Verify a 6-digit TOTP code from authenticator app.
        Updates mfa_verified_at timestamp on success.
        Implements lockout after 5 consecutive failures (locked for 15 minutes).
      operationId: verifyTOTP
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TOTPVerifyRequest'
      responses:
        '200':
          description: TOTP verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TOTPVerifyResponse'
        '400':
          description: Invalid request (missing user_id or code)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Account temporarily locked due to too many failed attempts
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "account_locked"
                  error_description:
                    type: string
                    example: "Account temporarily locked due to too many failed attempts"
        '404':
          description: TOTP secret not found for user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /oidc/v1/mfa/totp/backup-codes/generate:
    post:
      summary: Generate Backup Codes
      description: |
        Generate new set of 10 single-use backup codes for account recovery.
        Invalidates all previous backup codes. Each code can only be used once.
      operationId: generateBackupCodes
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateBackupCodesRequest'
      responses:
        '201':
          description: Backup codes generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateBackupCodesResponse'
        '400':
          description: Invalid request (missing user_id)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: TOTP secret not found for user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /oidc/v1/mfa/totp/backup-codes/verify:
    post:
      summary: Verify Backup Code
      description: |
        Verify a single-use backup code for account recovery.
        Marks code as used on successful verification.
        Returns verified=false for invalid, already-used, or non-existent codes.
      operationId: verifyBackupCode
      tags:
        - MFA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyBackupCodeRequest'
      responses:
        '200':
          description: Backup code verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyBackupCodeResponse'
        '400':
          description: Invalid request (missing user_id or code)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    AuthZTokenResponse:
      type: object
      required:
        - access_token
        - token_type
        - expires_in
      properties:
        access_token:
          type: string
          description: OAuth 2.0 access token (opaque or JWT)
          example: "access_token_example_1234567890"
        token_type:
          type: string
          enum: [Bearer]
          description: Token type (always "Bearer")
          example: Bearer
        expires_in:
          type: integer
          description: Token lifetime in seconds
          example: 3600
        refresh_token:
          type: string
          description: Refresh token (optional, for authorization_code and refresh_token grants)
          example: "refresh_token_example_0987654321"
        id_token:
          type: string
          description: OpenID Connect ID Token (if openid scope requested)
          example: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        scope:
          type: string
          description: Space-delimited granted scopes
          example: "openid profile email"

    OAuth2Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          enum:
            - invalid_request
            - invalid_client
            - invalid_grant
            - unauthorized_client
            - unsupported_grant_type
            - invalid_scope
            - server_error
            - temporarily_unavailable
          description: OAuth 2.0 error code
          example: invalid_request
        error_description:
          type: string
          description: Human-readable error description
          example: "The request is missing a required parameter"
        error_uri:
          type: string
          format: uri
          description: URI for error documentation
          example: "https://docs.example.com/oauth2/errors/invalid_request"

    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Overall service health status
          example: healthy
        database:
          type: string
          enum: [ok, error]
          description: Database connectivity status
          example: ok
        uptime:
          type: integer
          description: Service uptime in seconds
          example: 86400

    IntrospectionResponse:
      type: object
      required:
        - active
      properties:
        active:
          type: boolean
          description: Whether the token is currently active
          example: true
        scope:
          type: string
          description: Space-separated list of scopes
          example: "openid profile email"
        client_id:
          type: string
          description: Client ID that token was issued to
          example: "client123"
        username:
          type: string
          description: Username of resource owner
          example: "johndoe"
        token_type:
          type: string
          enum: [Bearer]
          description: Token type
          example: "Bearer"
        exp:
          type: integer
          description: Expiration timestamp (Unix epoch)
          example: 1735689600
        iat:
          type: integer
          description: Issued-at timestamp (Unix epoch)
          example: 1735603200
        sub:
          type: string
          description: Subject identifier
          example: "01932e4d-1234-5678-9abc-def012345678"
        aud:
          type: string
          description: Audience (intended recipient)
          example: "https://api.example.com"
        iss:
          type: string
          description: Issuer (authorization server)
          example: "https://authz.example.com"

  securitySchemes:
    clientBasicAuth:
      type: http
      scheme: basic
      description: |
        Client ID and secret via HTTP Basic Authentication.
        Header format: Authorization: Basic base64(client_id:client_secret)

    clientSecretPost:
      type: http
      scheme: bearer
      description: |
        Client authentication using client_secret in request body.
        Note: OpenAPI 3.0 uses bearer scheme for form-based authentication.
        Actual implementation uses client_secret as form parameter per OAuth 2.1.

  schemas:
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error code or message
          example: "invalid_request"
        error_description:
          type: string
          description: Human-readable error description
          example: "Missing required parameter: user_id"

    TOTPEnrollRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          format: uuid
          description: User ID to enroll TOTP MFA
          example: "550e8400-e29b-41d4-a716-446655440000"

    TOTPEnrollResponse:
      type: object
      required:
        - secret
        - qr_code
        - backup_codes
      properties:
        secret:
          type: string
          description: Base32-encoded TOTP secret for manual entry
          example: "JBSWY3DPEHPK3PXP"
        qr_code:
          type: string
          description: Data URI of QR code image for scanning
          example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
        backup_codes:
          type: array
          items:
            type: string
          minItems: 10
          maxItems: 10
          description: Single-use backup codes for account recovery
          example: ["ABC123XYZ", "DEF456UVW", "GHI789RST"]

    TOTPVerifyRequest:
      type: object
      required:
        - user_id
        - code
      properties:
        user_id:
          type: string
          format: uuid
          description: User ID to verify TOTP code for
          example: "550e8400-e29b-41d4-a716-446655440000"
        code:
          type: string
          minLength: 6
          maxLength: 6
          pattern: '^\d{6}$'
          description: 6-digit TOTP code from authenticator app
          example: "123456"

    TOTPVerifyResponse:
      type: object
      required:
        - verified
      properties:
        verified:
          type: boolean
          description: Whether TOTP code was valid
          example: true
        mfa_verified_at:
          type: string
          format: date-time
          description: Timestamp when MFA was successfully verified (only present if verified=true)
          example: "2025-01-27T10:30:00Z"

    GenerateBackupCodesRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          format: uuid
          description: User ID to generate backup codes for
          example: "550e8400-e29b-41d4-a716-446655440000"

    GenerateBackupCodesResponse:
      type: object
      required:
        - backup_codes
      properties:
        backup_codes:
          type: array
          items:
            type: string
          minItems: 10
          maxItems: 10
          description: Newly generated single-use backup codes
          example: ["ABC123XYZ", "DEF456UVW", "GHI789RST"]

    VerifyBackupCodeRequest:
      type: object
      required:
        - user_id
        - code
      properties:
        user_id:
          type: string
          format: uuid
          description: User ID to verify backup code for
          example: "550e8400-e29b-41d4-a716-446655440000"
        code:
          type: string
          description: Backup code to verify (case-sensitive)
          example: "ABC123XYZ"

    VerifyBackupCodeResponse:
      type: object
      required:
        - verified
      properties:
        verified:
          type: boolean
          description: Whether backup code was valid and unused
          example: true
        mfa_verified_at:
          type: string
          format: date-time
          description: Timestamp when MFA was successfully verified (only present if verified=true)
          example: "2025-01-27T10:30:00Z"

  responses:
    OAuth2Error:
      description: OAuth 2.0 error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/OAuth2Error'
